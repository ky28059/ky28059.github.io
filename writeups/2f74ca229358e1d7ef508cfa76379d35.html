<!DOCTYPE html><!--sdHJN6NPP2U_VySke3xOD--><html class="dark scroll-smooth jetbrains_mono_cc80ae23-module__2tkX8G__variable"><head><meta charSet="utf-8"/><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" href="/_next/static/media/70bc3e132a0a741e-s.p.15008bfb.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="preload" href="/_next/static/media/83afe278b6a6bb3c-s.p.3a6ba036.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="preload" href="https://gist.github.com/assets/60120929/d72f7b1a-b34f-40f3-a4eb-436d87250bf9" as="image"/><link rel="preload" href="https://gist.github.com/assets/60120929/6633ae65-c771-4ae6-849d-5a4f0d2d7307" as="image"/><link rel="preload" href="https://gist.github.com/assets/60120929/cdd01c46-4591-4a2f-a256-f0dae058b6cc" as="image"/><link rel="preload" href="https://gist.github.com/assets/60120929/51ee800b-06ba-4dff-ade6-5a54229096c9" as="image"/><link rel="preload" href="https://gist.github.com/assets/60120929/140d156b-d1e4-4daf-b14d-455cb56d357c" as="image"/><link rel="preload" href="https://gist.github.com/assets/60120929/93f8efee-5139-4332-967d-b226368dbbfb" as="image"/><link rel="preload" href="https://gist.github.com/assets/60120929/00cf9cdf-1315-4c30-81ba-b2d923fcf0a3" as="image"/><link rel="preload" href="https://gist.github.com/assets/60120929/8b80f3e0-ab62-446b-9dd5-41198bada2e4" as="image"/><link rel="stylesheet" href="/_next/static/chunks/0ae28dad4c293945.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/9563dab5ba30607d.js"/><script src="/_next/static/chunks/df3f54071a4ab395.js" async=""></script><script src="/_next/static/chunks/5d5c0b7cd85c39a9.js" async=""></script><script src="/_next/static/chunks/88f90e91bf073dc9.js" async=""></script><script src="/_next/static/chunks/turbopack-448117163d91e6d2.js" async=""></script><script src="/_next/static/chunks/ff1a16fafef87110.js" async=""></script><script src="/_next/static/chunks/d037381d3416c607.js" async=""></script><script src="/_next/static/chunks/44838f11011a9f2d.js" async=""></script><script src="/_next/static/chunks/03f4569ba78edab9.js" async=""></script><script src="/_next/static/chunks/44f6ea3170f4e31a.js" async=""></script><script src="/_next/static/chunks/39b99946d2be6a43.js" async=""></script><script src="/_next/static/chunks/116d3b69f07f8eb7.js" async=""></script><meta name="next-size-adjust" content=""/><title>iCTF 2023 — Stop the model thief! | kevin.fish</title><meta name="description" content="To steal an ML model, an attacker often sends &#x27;very similar versions&#x27; of the same image, which tells the attacker how the model reacts to very small changes in the input. You realized that an attacker might be trying to steal your image classification model. You&#x27;re given two files - [1::model_queries.npy] a list of images that your model received as inputs and [2::user_query_indices.txt] a list of image indices (starts from zero) in [1] sent to your model by each user-id. In [2], each line contains the indices from a different user-id (e.g., the very first line is user-id 0, the second line is user-id 1). Can you help us find the attacker&#x27;s user-ids (there are 20 of them)? Note:: if there were 4 attacker user-ids (e.g., 82,54,13,36), the flag will be &#x27;ictf{13,36,54,82}&#x27; (sorted, no quotes)."/><meta property="og:title" content="iCTF 2023 — Stop the model thief!"/><meta property="og:description" content="To steal an ML model, an attacker often sends &#x27;very similar versions&#x27; of the same image, which tells the attacker how the model reacts to very small changes in the input. You realized that an attacker might be trying to steal your image classification model. You&#x27;re given two files - [1::model_queries.npy] a list of images that your model received as inputs and [2::user_query_indices.txt] a list of image indices (starts from zero) in [1] sent to your model by each user-id. In [2], each line contains the indices from a different user-id (e.g., the very first line is user-id 0, the second line is user-id 1). Can you help us find the attacker&#x27;s user-ids (there are 20 of them)? Note:: if there were 4 attacker user-ids (e.g., 82,54,13,36), the flag will be &#x27;ictf{13,36,54,82}&#x27; (sorted, no quotes)."/><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="iCTF 2023 — Stop the model thief!"/><meta name="twitter:description" content="To steal an ML model, an attacker often sends &#x27;very similar versions&#x27; of the same image, which tells the attacker how the model reacts to very small changes in the input. You realized that an attacker might be trying to steal your image classification model. You&#x27;re given two files - [1::model_queries.npy] a list of images that your model received as inputs and [2::user_query_indices.txt] a list of image indices (starts from zero) in [1] sent to your model by each user-id. In [2], each line contains the indices from a different user-id (e.g., the very first line is user-id 0, the second line is user-id 1). Can you help us find the attacker&#x27;s user-ids (there are 20 of them)? Note:: if there were 4 attacker user-ids (e.g., 82,54,13,36), the flag will be &#x27;ictf{13,36,54,82}&#x27; (sorted, no quotes)."/><script src="/_next/static/chunks/a6dad97d9634a72d.js" noModule=""></script></head><body class="text-dark dark:text-white dark:bg-midnight" style="font-family:&#x27;Inter&#x27;, &#x27;Inter Fallback&#x27;;font-style:normal"><div hidden=""><!--$--><!--/$--></div><main class="container pt-20 pb-24"><a class="text-secondary text-sm mb-10 -ml-5 block w-max" href="/writeups">← Back to writeups</a><div><main class="text-pretty max-w-5xl mx-auto text-sm [&amp;_h1]:text-5xl [&amp;_h1]:font-semibold [&amp;_h1]:mb-8 [&amp;_blockquote]:text-secondary [&amp;_blockquote]:space-y-3 [&amp;_blockquote]:border-l-4 [&amp;_blockquote]:border-secondary [&amp;_blockquote]:pl-5 [&amp;_blockquote]:mb-5 [&amp;&gt;_p]:my-4 [&amp;_img]:my-5 [&amp;_ul]:list-disc [&amp;_ul]:pl-6 [&amp;_ol]:list-decimal [&amp;_ol]:pl-6 [&amp;_img]:rounded [&amp;_li]:my-2"><h1>iCTF 2023 — Stop the model thief!</h1>
<blockquote>
<p>To steal an ML model, an attacker often sends &#x27;very similar versions&#x27; of the same image, which tells the attacker how the model reacts to very small changes in the input. You realized that an attacker might be trying to steal your image classification model. You&#x27;re given two files - [1::model_queries.npy] a list of images that your model received as inputs and [2::user_query_indices.txt] a list of image indices (starts from zero) in [1] sent to your model by each user-id. In [2], each line contains the indices from a different user-id (e.g., the very first line is user-id 0, the second line is user-id 1). Can you help us find the attacker&#x27;s user-ids (there are 20 of them)? Note:: if there were 4 attacker user-ids (e.g., 82,54,13,36), the flag will be &#x27;ictf{13,36,54,82}&#x27; (sorted, no quotes).</p>
<p>We know that each attacker user-id has sent at least 5 near-duplicate attack images.</p>
</blockquote>
<p>We&#x27;re given a bunch of 32x32 &quot;query&quot; images, as well as a list of images sent by each user. Our goal is to find the 20 users who have been
sending malicious queries.</p>
<p>We can unzip and poke around with the images with a simple script like so:</p>
<div class="border border-white/10 rounded-lg my-2"><p class="font-jetbrains flex items-center text-xs rounded-t-lg px-3 py-0.5 text-secondary"><svg stroke="currentColor" fill="currentColor" stroke-width="0" role="img" viewBox="0 0 24 24" class="text-sm mr-1.5" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M14.25.18l.9.2.73.26.59.3.45.32.34.34.25.34.16.33.1.3.04.26.02.2-.01.13V8.5l-.05.63-.13.55-.21.46-.26.38-.3.31-.33.25-.35.19-.35.14-.33.1-.3.07-.26.04-.21.02H8.77l-.69.05-.59.14-.5.22-.41.27-.33.32-.27.35-.2.36-.15.37-.1.35-.07.32-.04.27-.02.21v3.06H3.17l-.21-.03-.28-.07-.32-.12-.35-.18-.36-.26-.36-.36-.35-.46-.32-.59-.28-.73-.21-.88-.14-1.05-.05-1.23.06-1.22.16-1.04.24-.87.32-.71.36-.57.4-.44.42-.33.42-.24.4-.16.36-.1.32-.05.24-.01h.16l.06.01h8.16v-.83H6.18l-.01-2.75-.02-.37.05-.34.11-.31.17-.28.25-.26.31-.23.38-.2.44-.18.51-.15.58-.12.64-.1.71-.06.77-.04.84-.02 1.27.05zm-6.3 1.98l-.23.33-.08.41.08.41.23.34.33.22.41.09.41-.09.33-.22.23-.34.08-.41-.08-.41-.23-.33-.33-.22-.41-.09-.41.09zm13.09 3.95l.28.06.32.12.35.18.36.27.36.35.35.47.32.59.28.73.21.88.14 1.04.05 1.23-.06 1.23-.16 1.04-.24.86-.32.71-.36.57-.4.45-.42.33-.42.24-.4.16-.36.09-.32.05-.24.02-.16-.01h-8.22v.82h5.84l.01 2.76.02.36-.05.34-.11.31-.17.29-.25.25-.31.24-.38.2-.44.17-.51.15-.58.13-.64.09-.71.07-.77.04-.84.01-1.27-.04-1.07-.14-.9-.2-.73-.25-.59-.3-.45-.33-.34-.34-.25-.34-.16-.33-.1-.3-.04-.25-.02-.2.01-.13v-5.34l.05-.64.13-.54.21-.46.26-.38.3-.32.33-.24.35-.2.35-.14.33-.1.3-.06.26-.04.21-.02.13-.01h5.84l.69-.05.59-.14.5-.21.41-.28.33-.32.27-.35.2-.36.15-.36.1-.35.07-.32.04-.28.02-.21V6.07h2.09l.14.01zm-6.47 14.25l-.23.33-.08.41.08.41.23.33.33.23.41.08.41-.08.33-.23.23-.33.08-.41-.08-.41-.23-.33-.33-.23-.41-.08-.41.08z"></path></svg> <!-- -->py<button class="ml-auto hover:underline">(copy)</button></p><div class="rounded-b-lg overflow-hidden text-xs"><pre class="prismjs"><code style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">1</span><span class="token keyword">import</span><span class=""> os
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">2</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">3</span><span class=""></span><span class="token keyword">import</span><span class=""> numpy </span><span class="token keyword">as</span><span class=""> np
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">4</span><span class=""></span><span class="token keyword">import</span><span class=""> cv2
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">5</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">6</span><span class="">queries</span><span class="token punctuation">:</span><span class=""> np</span><span class="token punctuation">.</span><span class="">ndarray </span><span class="token operator">=</span><span class=""> np</span><span class="token punctuation">.</span><span class="">load</span><span class="token punctuation">(</span><span class="token string">&#x27;model_queries.npy&#x27;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">7</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">8</span><span class="">os</span><span class="token punctuation">.</span><span class="">makedirs</span><span class="token punctuation">(</span><span class="token string">&#x27;queries&#x27;</span><span class="token punctuation">,</span><span class=""> exist_ok</span><span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">9</span><span class=""></span><span class="token keyword">for</span><span class=""> i</span><span class="token punctuation">,</span><span class=""> q </span><span class="token keyword">in</span><span class=""> </span><span class="token builtin">enumerate</span><span class="token punctuation">(</span><span class="">queries</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">10</span><span class="">    cv2</span><span class="token punctuation">.</span><span class="">imwrite</span><span class="token punctuation">(</span><span class="token string-interpolation string">f&#x27;./queries/</span><span class="token string-interpolation interpolation punctuation">{</span><span class="token string-interpolation interpolation">i</span><span class="token string-interpolation interpolation punctuation">}</span><span class="token string-interpolation string">.jpg&#x27;</span><span class="token punctuation">,</span><span class=""> q</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">11</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">12</span><span class=""></span><span class="token keyword">with</span><span class=""> </span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&#x27;./user_query_indices.txt&#x27;</span><span class="token punctuation">)</span><span class=""> </span><span class="token keyword">as</span><span class=""> f</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">13</span><span class="">    </span><span class="token keyword">for</span><span class=""> i</span><span class="token punctuation">,</span><span class=""> l </span><span class="token keyword">in</span><span class=""> </span><span class="token builtin">enumerate</span><span class="token punctuation">(</span><span class="">f</span><span class="token punctuation">.</span><span class="">readlines</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">14</span><span class="">        os</span><span class="token punctuation">.</span><span class="">makedirs</span><span class="token punctuation">(</span><span class="token string-interpolation string">f&#x27;./users/</span><span class="token string-interpolation interpolation punctuation">{</span><span class="token string-interpolation interpolation">i</span><span class="token string-interpolation interpolation punctuation">}</span><span class="token string-interpolation string">&#x27;</span><span class="token punctuation">,</span><span class=""> exist_ok</span><span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">15</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">16</span><span class="">        </span><span class="token keyword">for</span><span class=""> </span><span class="token builtin">id</span><span class=""> </span><span class="token keyword">in</span><span class=""> l</span><span class="token punctuation">.</span><span class="">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">17</span><span class="">            cv2</span><span class="token punctuation">.</span><span class="">imwrite</span><span class="token punctuation">(</span><span class="token string-interpolation string">f&#x27;./users/</span><span class="token string-interpolation interpolation punctuation">{</span><span class="token string-interpolation interpolation">i</span><span class="token string-interpolation interpolation punctuation">}</span><span class="token string-interpolation string">/</span><span class="token string-interpolation interpolation punctuation">{</span><span class="token string-interpolation interpolation builtin">id</span><span class="token string-interpolation interpolation punctuation">}</span><span class="token string-interpolation string">.jpg&#x27;</span><span class="token punctuation">,</span><span class=""> queries</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre></div></div>
<p>After some clarification, the suspicious images we are meant to detect are slightly-tampered-with duplicates of other images:</p>
<p align="center">
  <img src="https://gist.github.com/assets/60120929/d72f7b1a-b34f-40f3-a4eb-436d87250bf9"/> <img src="https://gist.github.com/assets/60120929/6633ae65-c771-4ae6-849d-5a4f0d2d7307"/> <img src="https://gist.github.com/assets/60120929/cdd01c46-4591-4a2f-a256-f0dae058b6cc"/> <img src="https://gist.github.com/assets/60120929/51ee800b-06ba-4dff-ade6-5a54229096c9"/> <img src="https://gist.github.com/assets/60120929/140d156b-d1e4-4daf-b14d-455cb56d357c"/> <img src="https://gist.github.com/assets/60120929/93f8efee-5139-4332-967d-b226368dbbfb"/> <img src="https://gist.github.com/assets/60120929/00cf9cdf-1315-4c30-81ba-b2d923fcf0a3"/> <img src="https://gist.github.com/assets/60120929/8b80f3e0-ab62-446b-9dd5-41198bada2e4"/>
</p>
<p>Because these differences are per-pixel, the brute force solution is to subtract each image from each other image and check if that sum is below
some threshold; if so, that pair of images is suspicious and can be labelled as such. Then, do one pass through the users and check their queries
against the precomputed sus ids to determine whether that user is a malicious model-stealing agent.</p>
<p>Here&#x27;s a rough implementation of the image similarity check:</p>
<div class="border border-white/10 rounded-lg my-2"><p class="font-jetbrains flex items-center text-xs rounded-t-lg px-3 py-0.5 text-secondary"><svg stroke="currentColor" fill="currentColor" stroke-width="0" role="img" viewBox="0 0 24 24" class="text-sm mr-1.5" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M14.25.18l.9.2.73.26.59.3.45.32.34.34.25.34.16.33.1.3.04.26.02.2-.01.13V8.5l-.05.63-.13.55-.21.46-.26.38-.3.31-.33.25-.35.19-.35.14-.33.1-.3.07-.26.04-.21.02H8.77l-.69.05-.59.14-.5.22-.41.27-.33.32-.27.35-.2.36-.15.37-.1.35-.07.32-.04.27-.02.21v3.06H3.17l-.21-.03-.28-.07-.32-.12-.35-.18-.36-.26-.36-.36-.35-.46-.32-.59-.28-.73-.21-.88-.14-1.05-.05-1.23.06-1.22.16-1.04.24-.87.32-.71.36-.57.4-.44.42-.33.42-.24.4-.16.36-.1.32-.05.24-.01h.16l.06.01h8.16v-.83H6.18l-.01-2.75-.02-.37.05-.34.11-.31.17-.28.25-.26.31-.23.38-.2.44-.18.51-.15.58-.12.64-.1.71-.06.77-.04.84-.02 1.27.05zm-6.3 1.98l-.23.33-.08.41.08.41.23.34.33.22.41.09.41-.09.33-.22.23-.34.08-.41-.08-.41-.23-.33-.33-.22-.41-.09-.41.09zm13.09 3.95l.28.06.32.12.35.18.36.27.36.35.35.47.32.59.28.73.21.88.14 1.04.05 1.23-.06 1.23-.16 1.04-.24.86-.32.71-.36.57-.4.45-.42.33-.42.24-.4.16-.36.09-.32.05-.24.02-.16-.01h-8.22v.82h5.84l.01 2.76.02.36-.05.34-.11.31-.17.29-.25.25-.31.24-.38.2-.44.17-.51.15-.58.13-.64.09-.71.07-.77.04-.84.01-1.27-.04-1.07-.14-.9-.2-.73-.25-.59-.3-.45-.33-.34-.34-.25-.34-.16-.33-.1-.3-.04-.25-.02-.2.01-.13v-5.34l.05-.64.13-.54.21-.46.26-.38.3-.32.33-.24.35-.2.35-.14.33-.1.3-.06.26-.04.21-.02.13-.01h5.84l.69-.05.59-.14.5-.21.41-.28.33-.32.27-.35.2-.36.15-.36.1-.35.07-.32.04-.28.02-.21V6.07h2.09l.14.01zm-6.47 14.25l-.23.33-.08.41.08.41.23.33.33.23.41.08.41-.08.33-.23.23-.33.08-.41-.08-.41-.23-.33-.33-.23-.41-.08-.41.08z"></path></svg> <!-- -->py<button class="ml-auto hover:underline">(copy)</button></p><div class="rounded-b-lg overflow-hidden text-xs"><pre class="prismjs"><code style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">1</span><span class="">THRESH </span><span class="token operator">=</span><span class=""> </span><span class="token number">20000</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">2</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">3</span><span class=""></span><span class="token comment"># ...</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">4</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">5</span><span class=""></span><span class="token keyword">def</span><span class=""> </span><span class="token function">process_query</span><span class="token punctuation">(</span><span class="">i</span><span class="token punctuation">:</span><span class=""> </span><span class="token builtin">int</span><span class="token punctuation">,</span><span class=""> q</span><span class="token punctuation">:</span><span class=""> np</span><span class="token punctuation">.</span><span class="">ndarray</span><span class="token punctuation">,</span><span class=""> queries</span><span class="token punctuation">,</span><span class=""> unique_images</span><span class="token punctuation">,</span><span class=""> sus_ids</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">6</span><span class="">    </span><span class="token keyword">for</span><span class=""> u </span><span class="token keyword">in</span><span class=""> unique_images</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">7</span><span class="">        diff </span><span class="token operator">=</span><span class=""> np</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="">cv2</span><span class="token punctuation">.</span><span class="">absdiff</span><span class="token punctuation">(</span><span class="">q</span><span class="token punctuation">,</span><span class=""> queries</span><span class="token punctuation">[</span><span class="">u</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">8</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">9</span><span class="">        </span><span class="token keyword">if</span><span class=""> diff </span><span class="token operator">&lt;</span><span class=""> THRESH</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">10</span><span class="">            </span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="">i</span><span class="token punctuation">,</span><span class=""> u</span><span class="token punctuation">,</span><span class=""> diff</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">11</span><span class="">            sus_ids</span><span class="token punctuation">[</span><span class="">i</span><span class="token punctuation">]</span><span class=""> </span><span class="token operator">=</span><span class=""> </span><span class="token number">1</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">12</span><span class="">            sus_ids</span><span class="token punctuation">[</span><span class="">u</span><span class="token punctuation">]</span><span class=""> </span><span class="token operator">=</span><span class=""> </span><span class="token number">1</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">13</span><span class="">            </span><span class="token keyword">break</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">14</span><span class="">    </span><span class="token keyword">else</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">15</span><span class="">        unique_images</span><span class="token punctuation">.</span><span class="">append</span><span class="token punctuation">(</span><span class="">i</span><span class="token punctuation">)</span></code></pre></div></div>
<p>The threshold here was obtained by running a small pass of the algorithm and printing at each iteration the minimum <code class="font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]">diff</code> of any pair of images.
The threshold value was set to an arbitrary <code class="font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]">2000</code> above the highest diff &quot;fake&quot; and below the lowest diff false positive; most fakes have diffs between
<code class="font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]">16000 - 17000</code>, with some as low as <code class="font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]">12000</code>, while the most similar pair of real images had a diff of around <code class="font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]">30000</code>.</p>
<div class="border border-white/10 rounded-lg my-2"><p class="font-jetbrains flex items-center text-xs rounded-t-lg px-3 py-0.5 text-secondary">Code<button class="ml-auto hover:underline">(copy)</button></p><div class="rounded-b-lg overflow-hidden text-xs"><pre class="prismjs"><code style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none">1</span><span class="">1666 2239 16581
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none">2</span>2307 2239 17299
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none">3</span>1999 1590 17126
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none">4</span>184 2239 16989
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none">5</span>1423 102 17159</code></pre></div></div>
<h6>(snapshot of program output, each row showing the two ids detected as fakes and their image diff, respectively)</h6>
<p>The problem with this sledgehammer solution is that comparing images an O(n²) algorithm, where n is in the order of some 10,000 images. While each image
is only 32x32 pixels and operating on any individual pair of images is cheap, doing that same diffing on on 10,000² = 100,000,000 images
might be a bit problematic.</p>
<div class="border border-white/10 rounded-lg my-2"><p class="font-jetbrains flex items-center text-xs rounded-t-lg px-3 py-0.5 text-secondary"><svg stroke="currentColor" fill="currentColor" stroke-width="0" role="img" viewBox="0 0 24 24" class="text-sm mr-1.5" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M14.25.18l.9.2.73.26.59.3.45.32.34.34.25.34.16.33.1.3.04.26.02.2-.01.13V8.5l-.05.63-.13.55-.21.46-.26.38-.3.31-.33.25-.35.19-.35.14-.33.1-.3.07-.26.04-.21.02H8.77l-.69.05-.59.14-.5.22-.41.27-.33.32-.27.35-.2.36-.15.37-.1.35-.07.32-.04.27-.02.21v3.06H3.17l-.21-.03-.28-.07-.32-.12-.35-.18-.36-.26-.36-.36-.35-.46-.32-.59-.28-.73-.21-.88-.14-1.05-.05-1.23.06-1.22.16-1.04.24-.87.32-.71.36-.57.4-.44.42-.33.42-.24.4-.16.36-.1.32-.05.24-.01h.16l.06.01h8.16v-.83H6.18l-.01-2.75-.02-.37.05-.34.11-.31.17-.28.25-.26.31-.23.38-.2.44-.18.51-.15.58-.12.64-.1.71-.06.77-.04.84-.02 1.27.05zm-6.3 1.98l-.23.33-.08.41.08.41.23.34.33.22.41.09.41-.09.33-.22.23-.34.08-.41-.08-.41-.23-.33-.33-.22-.41-.09-.41.09zm13.09 3.95l.28.06.32.12.35.18.36.27.36.35.35.47.32.59.28.73.21.88.14 1.04.05 1.23-.06 1.23-.16 1.04-.24.86-.32.71-.36.57-.4.45-.42.33-.42.24-.4.16-.36.09-.32.05-.24.02-.16-.01h-8.22v.82h5.84l.01 2.76.02.36-.05.34-.11.31-.17.29-.25.25-.31.24-.38.2-.44.17-.51.15-.58.13-.64.09-.71.07-.77.04-.84.01-1.27-.04-1.07-.14-.9-.2-.73-.25-.59-.3-.45-.33-.34-.34-.25-.34-.16-.33-.1-.3-.04-.25-.02-.2.01-.13v-5.34l.05-.64.13-.54.21-.46.26-.38.3-.32.33-.24.35-.2.35-.14.33-.1.3-.06.26-.04.21-.02.13-.01h5.84l.69-.05.59-.14.5-.21.41-.28.33-.32.27-.35.2-.36.15-.36.1-.35.07-.32.04-.28.02-.21V6.07h2.09l.14.01zm-6.47 14.25l-.23.33-.08.41.08.41.23.33.33.23.41.08.41-.08.33-.23.23-.33.08-.41-.08-.41-.23-.33-.33-.23-.41-.08-.41.08z"></path></svg> <!-- -->py<button class="ml-auto hover:underline">(copy)</button></p><div class="rounded-b-lg overflow-hidden text-xs"><pre class="prismjs"><code style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">1</span><span class="token keyword">from</span><span class=""> multiprocessing </span><span class="token keyword">import</span><span class=""> Pool</span><span class="token punctuation">,</span><span class=""> Manager
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">2</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">3</span><span class=""></span><span class="token keyword">import</span><span class=""> numpy </span><span class="token keyword">as</span><span class=""> np
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">4</span><span class=""></span><span class="token keyword">import</span><span class=""> cv2
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">5</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">6</span><span class="">PROCESSES </span><span class="token operator">=</span><span class=""> </span><span class="token number">8</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">7</span><span class="">THRESH </span><span class="token operator">=</span><span class=""> </span><span class="token number">20000</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">8</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">9</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">10</span><span class=""></span><span class="token keyword">def</span><span class=""> </span><span class="token function">process_query</span><span class="token punctuation">(</span><span class="">i</span><span class="token punctuation">:</span><span class=""> </span><span class="token builtin">int</span><span class="token punctuation">,</span><span class=""> q</span><span class="token punctuation">:</span><span class=""> np</span><span class="token punctuation">.</span><span class="">ndarray</span><span class="token punctuation">,</span><span class=""> queries</span><span class="token punctuation">,</span><span class=""> unique_images</span><span class="token punctuation">,</span><span class=""> sus_ids</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">11</span><span class="">    </span><span class="token keyword">for</span><span class=""> u </span><span class="token keyword">in</span><span class=""> unique_images</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">12</span><span class="">        diff </span><span class="token operator">=</span><span class=""> np</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="">cv2</span><span class="token punctuation">.</span><span class="">absdiff</span><span class="token punctuation">(</span><span class="">q</span><span class="token punctuation">,</span><span class=""> queries</span><span class="token punctuation">[</span><span class="">u</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">13</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">14</span><span class="">        </span><span class="token keyword">if</span><span class=""> diff </span><span class="token operator">&lt;</span><span class=""> THRESH</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">15</span><span class="">            </span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="">i</span><span class="token punctuation">,</span><span class=""> u</span><span class="token punctuation">,</span><span class=""> diff</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">16</span><span class="">            sus_ids</span><span class="token punctuation">[</span><span class="">i</span><span class="token punctuation">]</span><span class=""> </span><span class="token operator">=</span><span class=""> </span><span class="token number">1</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">17</span><span class="">            sus_ids</span><span class="token punctuation">[</span><span class="">u</span><span class="token punctuation">]</span><span class=""> </span><span class="token operator">=</span><span class=""> </span><span class="token number">1</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">18</span><span class="">            </span><span class="token keyword">break</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">19</span><span class="">    </span><span class="token keyword">else</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">20</span><span class="">        unique_images</span><span class="token punctuation">.</span><span class="">append</span><span class="token punctuation">(</span><span class="">i</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">21</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">22</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">23</span><span class=""></span><span class="token keyword">if</span><span class=""> __name__ </span><span class="token operator">==</span><span class=""> </span><span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">24</span><span class="">    queries</span><span class="token punctuation">:</span><span class=""> np</span><span class="token punctuation">.</span><span class="">ndarray </span><span class="token operator">=</span><span class=""> np</span><span class="token punctuation">.</span><span class="">load</span><span class="token punctuation">(</span><span class="token string">&#x27;model_queries.npy&#x27;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">25</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">26</span><span class="">    manager </span><span class="token operator">=</span><span class=""> Manager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">27</span><span class="">    unique_images </span><span class="token operator">=</span><span class=""> manager</span><span class="token punctuation">.</span><span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">28</span><span class="">    sus_ids </span><span class="token operator">=</span><span class=""> manager</span><span class="token punctuation">.</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">29</span><span class="">    sus_users </span><span class="token operator">=</span><span class=""> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">30</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">31</span><span class="">    </span><span class="token keyword">with</span><span class=""> Pool</span><span class="token punctuation">(</span><span class="">PROCESSES</span><span class="token punctuation">)</span><span class=""> </span><span class="token keyword">as</span><span class=""> pool</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">32</span><span class="">        pool</span><span class="token punctuation">.</span><span class="">starmap</span><span class="token punctuation">(</span><span class="">process_query</span><span class="token punctuation">,</span><span class=""> </span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="">i</span><span class="token punctuation">,</span><span class=""> q</span><span class="token punctuation">,</span><span class=""> queries</span><span class="token punctuation">,</span><span class=""> unique_images</span><span class="token punctuation">,</span><span class=""> sus_ids</span><span class="token punctuation">)</span><span class=""> </span><span class="token keyword">for</span><span class=""> </span><span class="token punctuation">(</span><span class="">i</span><span class="token punctuation">,</span><span class=""> q</span><span class="token punctuation">)</span><span class=""> </span><span class="token keyword">in</span><span class=""> </span><span class="token builtin">enumerate</span><span class="token punctuation">(</span><span class="">queries</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">33</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">34</span><span class="">    </span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="">sus_ids</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">35</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">36</span><span class="">    </span><span class="token keyword">with</span><span class=""> </span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&#x27;./user_query_indices.txt&#x27;</span><span class="token punctuation">)</span><span class=""> </span><span class="token keyword">as</span><span class=""> f</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">37</span><span class="">        </span><span class="token keyword">for</span><span class=""> i</span><span class="token punctuation">,</span><span class=""> l </span><span class="token keyword">in</span><span class=""> </span><span class="token builtin">enumerate</span><span class="token punctuation">(</span><span class="">f</span><span class="token punctuation">.</span><span class="">readlines</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">38</span><span class="">            suspicious </span><span class="token operator">=</span><span class=""> </span><span class="token punctuation">[</span><span class="">sus_ids</span><span class="token punctuation">.</span><span class="">get</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="">s</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class=""> </span><span class="token number">0</span><span class="token punctuation">)</span><span class=""> </span><span class="token keyword">for</span><span class=""> s </span><span class="token keyword">in</span><span class=""> l</span><span class="token punctuation">.</span><span class="">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">39</span><span class="">            </span><span class="token keyword">if</span><span class=""> np</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="">suspicious</span><span class="token punctuation">)</span><span class=""> </span><span class="token operator">&gt;=</span><span class=""> </span><span class="token number">5</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">40</span><span class="">                sus_users</span><span class="token punctuation">.</span><span class="">append</span><span class="token punctuation">(</span><span class="">i</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">41</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">42</span><span class="">    </span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">sorted</span><span class="token punctuation">(</span><span class="">sus_users</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div></div>
<p>Unfortunately, there doesn&#x27;t seem to be an obvious way around it. Loading up the task in <code class="font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]">multiprocessing</code> and churning away at it on
8 processes for about two hours, we get the flag:</p>
<div class="border border-white/10 rounded-lg my-2"><p class="font-jetbrains flex items-center text-xs rounded-t-lg px-3 py-0.5 text-secondary">Code<button class="ml-auto hover:underline">(copy)</button></p><div class="rounded-b-lg overflow-hidden text-xs"><pre class="prismjs"><code style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none">1</span><span class="">ictf{18,27,29,32,68,106,126,158,182,189,192,232,282,330,338,370,419,438,447,465}</span></code></pre></div></div></main></div><!--$--><!--/$--></main><script src="/_next/static/chunks/9563dab5ba30607d.js" id="_R_" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:\"$Sreact.fragment\"\n2:I[39756,[\"/_next/static/chunks/ff1a16fafef87110.js\",\"/_next/static/chunks/d037381d3416c607.js\"],\"default\"]\n3:I[37457,[\"/_next/static/chunks/ff1a16fafef87110.js\",\"/_next/static/chunks/d037381d3416c607.js\"],\"default\"]\n4:I[22016,[\"/_next/static/chunks/44838f11011a9f2d.js\"],\"\"]\n6:I[97367,[\"/_next/static/chunks/ff1a16fafef87110.js\",\"/_next/static/chunks/d037381d3416c607.js\"],\"OutletBoundary\"]\n7:\"$Sreact.suspense\"\n9:I[97367,[\"/_next/static/chunks/ff1a16fafef87110.js\",\"/_next/static/chunks/d037381d3416c607.js\"],\"ViewportBoundary\"]\nb:I[97367,[\"/_next/static/chunks/ff1a16fafef87110.js\",\"/_next/static/chunks/d037381d3416c607.js\"],\"MetadataBoundary\"]\nd:I[68027,[\"/_next/static/chunks/ff1a16fafef87110.js\",\"/_next/static/chunks/d037381d3416c607.js\"],\"default\"]\n:HL[\"/_next/static/chunks/0ae28dad4c293945.css\",\"style\"]\n:HL[\"/_next/static/media/70bc3e132a0a741e-s.p.15008bfb.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n:HL[\"/_next/static/media/83afe278b6a6bb3c-s.p.3a6ba036.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n"])</script><script>self.__next_f.push([1,"0:{\"P\":null,\"b\":\"sdHJN6NPP2U-VySke3xOD\",\"c\":[\"\",\"writeups\",\"2f74ca229358e1d7ef508cfa76379d35\"],\"q\":\"\",\"i\":false,\"f\":[[[\"\",{\"children\":[\"writeups\",{\"children\":[[\"id\",\"2f74ca229358e1d7ef508cfa76379d35\",\"d\"],{\"children\":[\"__PAGE__\",{}]}]}]},\"$undefined\",\"$undefined\",true],[[\"$\",\"$1\",\"c\",{\"children\":[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/chunks/0ae28dad4c293945.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"html\",null,{\"className\":\"dark scroll-smooth jetbrains_mono_cc80ae23-module__2tkX8G__variable\",\"children\":[[\"$\",\"head\",null,{\"children\":[\"$\",\"meta\",null,{\"charSet\":\"utf-8\"}]}],[\"$\",\"body\",null,{\"className\":\"text-dark dark:text-white dark:bg-midnight\",\"style\":{\"fontFamily\":\"'Inter', 'Inter Fallback'\",\"fontStyle\":\"normal\"},\"children\":[\"$\",\"$L2\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L3\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[\"$\",\"div\",null,{\"className\":\"h-screen flex items-center justify-center\",\"children\":[\"$\",\"main\",null,{\"className\":\"relative pl-14\",\"children\":[[\"$\",\"svg\",null,{\"stroke\":\"currentColor\",\"fill\":\"currentColor\",\"strokeWidth\":\"0\",\"viewBox\":\"0 0 512 512\",\"className\":\"absolute left-0 top-2 text-5xl text-grapefruit\",\"children\":[\"$undefined\",[[\"$\",\"path\",\"0\",{\"d\":\"M256 48C140.559 48 48 140.559 48 256c0 115.436 92.559 208 208 208 115.435 0 208-92.564 208-208 0-115.441-92.564-208-208-208zm104.002 282.881l-29.12 29.117L256 285.117l-74.881 74.881-29.121-29.117L226.881 256l-74.883-74.881 29.121-29.116L256 226.881l74.881-74.878 29.12 29.116L285.119 256l74.883 74.881z\",\"children\":[]}]]],\"style\":{\"color\":\"$undefined\"},\"height\":\"1em\",\"width\":\"1em\",\"xmlns\":\"http://www.w3.org/2000/svg\"}],[\"$\",\"h1\",null,{\"className\":\"font-bold text-7xl underline decoration-grapefruit mb-5\",\"children\":\"404.\"}],[\"$\",\"p\",null,{\"children\":\"Your requested page was not found.\"}],[\"$\",\"$L4\",null,{\"href\":\"/\",\"className\":\"font-medium text-inherit\",\"children\":\"Return to home →\"}]]}]}],[]],\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]}]]}]]}],{\"children\":[[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"main\",null,{\"className\":\"container pt-20 pb-24\",\"children\":[\"$\",\"$L2\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L3\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]}]]}],{\"children\":[[\"$\",\"$1\",\"c\",{\"children\":[[[\"$\",\"script\",\"script-0\",{\"src\":\"/_next/static/chunks/44838f11011a9f2d.js\",\"async\":true,\"nonce\":\"$undefined\"}]],[[\"$\",\"$L4\",null,{\"href\":\"/writeups\",\"className\":\"text-secondary text-sm mb-10 -ml-5 block w-max\",\"children\":\"← Back to writeups\"}],[\"$\",\"$L2\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L3\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]]}],{\"children\":[[\"$\",\"$1\",\"c\",{\"children\":[\"$L5\",[[\"$\",\"script\",\"script-0\",{\"src\":\"/_next/static/chunks/03f4569ba78edab9.js\",\"async\":true,\"nonce\":\"$undefined\"}],[\"$\",\"script\",\"script-1\",{\"src\":\"/_next/static/chunks/44f6ea3170f4e31a.js\",\"async\":true,\"nonce\":\"$undefined\"}],[\"$\",\"script\",\"script-2\",{\"src\":\"/_next/static/chunks/39b99946d2be6a43.js\",\"async\":true,\"nonce\":\"$undefined\"}],[\"$\",\"script\",\"script-3\",{\"src\":\"/_next/static/chunks/116d3b69f07f8eb7.js\",\"async\":true,\"nonce\":\"$undefined\"}]],[\"$\",\"$L6\",null,{\"children\":[\"$\",\"$7\",null,{\"name\":\"Next.MetadataOutlet\",\"children\":\"$@8\"}]}]]}],{},null,false,false]},null,false,false]},null,false,false]},null,false,false],[\"$\",\"$1\",\"h\",{\"children\":[null,[\"$\",\"$L9\",null,{\"children\":\"$@a\"}],[\"$\",\"div\",null,{\"hidden\":true,\"children\":[\"$\",\"$Lb\",null,{\"children\":[\"$\",\"$7\",null,{\"name\":\"Next.Metadata\",\"children\":\"$@c\"}]}]}],[\"$\",\"meta\",null,{\"name\":\"next-size-adjust\",\"content\":\"\"}]]}],false]],\"m\":\"$undefined\",\"G\":[\"$d\",[]],\"S\":true}\n"])</script><script>self.__next_f.push([1,"a:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"meta\",\"1\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}]]\n"])</script><script>self.__next_f.push([1,"e:I[10453,[\"/_next/static/chunks/44838f11011a9f2d.js\",\"/_next/static/chunks/03f4569ba78edab9.js\",\"/_next/static/chunks/44f6ea3170f4e31a.js\",\"/_next/static/chunks/39b99946d2be6a43.js\",\"/_next/static/chunks/116d3b69f07f8eb7.js\"],\"default\"]\n:HL[\"https://gist.github.com/assets/60120929/d72f7b1a-b34f-40f3-a4eb-436d87250bf9\",\"image\"]\n:HL[\"https://gist.github.com/assets/60120929/6633ae65-c771-4ae6-849d-5a4f0d2d7307\",\"image\"]\n:HL[\"https://gist.github.com/assets/60120929/cdd01c46-4591-4a2f-a256-f0dae058b6cc\",\"image\"]\n:HL[\"https://gist.github.com/assets/60120929/51ee800b-06ba-4dff-ade6-5a54229096c9\",\"image\"]\n:HL[\"https://gist.github.com/assets/60120929/140d156b-d1e4-4daf-b14d-455cb56d357c\",\"image\"]\n:HL[\"https://gist.github.com/assets/60120929/93f8efee-5139-4332-967d-b226368dbbfb\",\"image\"]\n:HL[\"https://gist.github.com/assets/60120929/00cf9cdf-1315-4c30-81ba-b2d923fcf0a3\",\"image\"]\n:HL[\"https://gist.github.com/assets/60120929/8b80f3e0-ab62-446b-9dd5-41198bada2e4\",\"image\"]\n"])</script><script>self.__next_f.push([1,"5:[\"$\",\"div\",null,{\"children\":[\"$\",\"main\",null,{\"className\":\"text-pretty max-w-5xl mx-auto text-sm [\u0026_h1]:text-5xl [\u0026_h1]:font-semibold [\u0026_h1]:mb-8 [\u0026_blockquote]:text-secondary [\u0026_blockquote]:space-y-3 [\u0026_blockquote]:border-l-4 [\u0026_blockquote]:border-secondary [\u0026_blockquote]:pl-5 [\u0026_blockquote]:mb-5 [\u0026\u003e_p]:my-4 [\u0026_img]:my-5 [\u0026_ul]:list-disc [\u0026_ul]:pl-6 [\u0026_ol]:list-decimal [\u0026_ol]:pl-6 [\u0026_img]:rounded [\u0026_li]:my-2\",\"children\":[[\"$\",\"h1\",\"h1-0\",{\"children\":\"iCTF 2023 — Stop the model thief!\"}],\"\\n\",[\"$\",\"blockquote\",\"blockquote-0\",{\"children\":[\"\\n\",[\"$\",\"p\",\"p-0\",{\"children\":\"To steal an ML model, an attacker often sends 'very similar versions' of the same image, which tells the attacker how the model reacts to very small changes in the input. You realized that an attacker might be trying to steal your image classification model. You're given two files - [1::model_queries.npy] a list of images that your model received as inputs and [2::user_query_indices.txt] a list of image indices (starts from zero) in [1] sent to your model by each user-id. In [2], each line contains the indices from a different user-id (e.g., the very first line is user-id 0, the second line is user-id 1). Can you help us find the attacker's user-ids (there are 20 of them)? Note:: if there were 4 attacker user-ids (e.g., 82,54,13,36), the flag will be 'ictf{13,36,54,82}' (sorted, no quotes).\"}],\"\\n\",[\"$\",\"p\",\"p-1\",{\"children\":\"We know that each attacker user-id has sent at least 5 near-duplicate attack images.\"}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",\"p-0\",{\"children\":\"We're given a bunch of 32x32 \\\"query\\\" images, as well as a list of images sent by each user. Our goal is to find the 20 users who have been\\nsending malicious queries.\"}],\"\\n\",[\"$\",\"p\",\"p-1\",{\"children\":\"We can unzip and poke around with the images with a simple script like so:\"}],\"\\n\",[\"$\",\"$Le\",\"pre-0\",{\"className\":\"my-2\",\"children\":\"import os\\n\\nimport numpy as np\\nimport cv2\\n\\nqueries: np.ndarray = np.load('model_queries.npy')\\n\\nos.makedirs('queries', exist_ok=True)\\nfor i, q in enumerate(queries):\\n    cv2.imwrite(f'./queries/{i}.jpg', q)\\n\\nwith open('./user_query_indices.txt') as f:\\n    for i, l in enumerate(f.readlines()):\\n        os.makedirs(f'./users/{i}', exist_ok=True)\\n\\n        for id in l.split(\\\",\\\"):\\n            cv2.imwrite(f'./users/{i}/{id}.jpg', queries[int(id)])\",\"language\":\"py\"}],\"\\n\",[\"$\",\"p\",\"p-2\",{\"children\":\"After some clarification, the suspicious images we are meant to detect are slightly-tampered-with duplicates of other images:\"}],\"\\n\",[\"$\",\"p\",\"p-3\",{\"align\":\"center\",\"children\":[\"\\n  \",[\"$\",\"img\",\"img-0\",{\"src\":\"https://gist.github.com/assets/60120929/d72f7b1a-b34f-40f3-a4eb-436d87250bf9\"}],\" \",[\"$\",\"img\",\"img-1\",{\"src\":\"https://gist.github.com/assets/60120929/6633ae65-c771-4ae6-849d-5a4f0d2d7307\"}],\" \",[\"$\",\"img\",\"img-2\",{\"src\":\"https://gist.github.com/assets/60120929/cdd01c46-4591-4a2f-a256-f0dae058b6cc\"}],\" \",[\"$\",\"img\",\"img-3\",{\"src\":\"https://gist.github.com/assets/60120929/51ee800b-06ba-4dff-ade6-5a54229096c9\"}],\" \",[\"$\",\"img\",\"img-4\",{\"src\":\"https://gist.github.com/assets/60120929/140d156b-d1e4-4daf-b14d-455cb56d357c\"}],\" \",[\"$\",\"img\",\"img-5\",{\"src\":\"https://gist.github.com/assets/60120929/93f8efee-5139-4332-967d-b226368dbbfb\"}],\" \",[\"$\",\"img\",\"img-6\",{\"src\":\"https://gist.github.com/assets/60120929/00cf9cdf-1315-4c30-81ba-b2d923fcf0a3\"}],\" \",[\"$\",\"img\",\"img-7\",{\"src\":\"https://gist.github.com/assets/60120929/8b80f3e0-ab62-446b-9dd5-41198bada2e4\"}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",\"p-4\",{\"children\":\"Because these differences are per-pixel, the brute force solution is to subtract each image from each other image and check if that sum is below\\nsome threshold; if so, that pair of images is suspicious and can be labelled as such. Then, do one pass through the users and check their queries\\nagainst the precomputed sus ids to determine whether that user is a malicious model-stealing agent.\"}],\"\\n\",\"$Lf\",\"\\n\",\"$L10\",\"\\n\",\"$L11\",\"\\n\",\"$L12\",\"\\n\",\"$L13\",\"\\n\",\"$L14\",\"\\n\",\"$L15\",\"\\n\",\"$L16\",\"\\n\",\"$L17\"]}]}]\n"])</script><script>self.__next_f.push([1,"f:[\"$\",\"p\",\"p-5\",{\"children\":\"Here's a rough implementation of the image similarity check:\"}]\n10:[\"$\",\"$Le\",\"pre-1\",{\"className\":\"my-2\",\"children\":\"THRESH = 20000\\n\\n# ...\\n\\ndef process_query(i: int, q: np.ndarray, queries, unique_images, sus_ids):\\n    for u in unique_images:\\n        diff = np.sum(cv2.absdiff(q, queries[u]))\\n\\n        if diff \u003c THRESH:\\n            print(i, u, diff)\\n            sus_ids[i] = 1\\n            sus_ids[u] = 1\\n            break\\n    else:\\n        unique_images.append(i)\",\"language\":\"py\"}]\n11:[\"$\",\"p\",\"p-6\",{\"children\":[\"The threshold here was obtained by running a small pass of the algorithm and printing at each iteration the minimum \",[\"$\",\"code\",\"code-0\",{\"className\":\"font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"diff\"}],\" of any pair of images.\\nThe threshold value was set to an arbitrary \",[\"$\",\"code\",\"code-1\",{\"className\":\"font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"2000\"}],\" above the highest diff \\\"fake\\\" and below the lowest diff false positive; most fakes have diffs between\\n\",[\"$\",\"code\",\"code-2\",{\"className\":\"font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"16000 - 17000\"}],\", with some as low as \",[\"$\",\"code\",\"code-3\",{\"className\":\"font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"12000\"}],\", while the most similar pair of real images had a diff of around \",[\"$\",\"code\",\"code-4\",{\"className\":\"font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"30000\"}],\".\"]}]\n12:[\"$\",\"$Le\",\"pre-2\",{\"className\":\"my-2\",\"children\":\"1666 2239 16581\\n2307 2239 17299\\n1999 1590 17126\\n184 2239 16989\\n1423 102 17159\",\"language\":\"$undefined\"}]\n13:[\"$\",\"h6\",\"h6-0\",{\"children\":\"(snapshot of program output, each row showing the two ids detected as fakes and their image diff, respectively)\"}]\n14:[\"$\",\"p\",\"p-7\",{\"children\":\"The problem with this sledgehammer solution is that comparing images an O(n²) algorithm, where n is in the order of some 10,000 images. While each image\\nis only 32x32 pixels and operating on any individual pair of images is cheap, doing that same diffing on on 10,000² = 100,000,000 images\\nmight be a bit problematic.\"}]\n18:T424,from multiprocessing import Pool, Manager\n\nimport numpy as np\nimport cv2\n\nPROCESSES = 8\nTHRESH = 20000\n\n\ndef process_query(i: int, q: np.ndarray, queries, unique_images, sus_ids):\n    for u in unique_images:\n        diff = np.sum(cv2.absdiff(q, queries[u]))\n\n        if diff \u003c THRESH:\n            print(i, u, diff)\n            sus_ids[i] = 1\n            sus_ids[u] = 1\n            break\n    else:\n        unique_images.append(i)\n\n\nif __name__ == \"__main__\":\n    queries: np.ndarray = np.load('model_queries.npy')\n\n    manager = Manager()\n    unique_images = manager.list()\n    sus_ids = manager.dict()\n    sus_users = []\n\n    with Pool(PROCESSES) as pool:\n        pool.starmap(process_query, [(i, q, queries, unique_images, sus_ids) for (i, q) in enumerate(queries)])\n\n    print(sus_ids)\n\n    with open('./user_query_indices.txt') as f:\n        for i, l in enumerate(f.readlines()):\n            suspicious = [sus_ids.get(int(s), 0) for s in l.split(\",\")]\n            if np.sum(suspicious) \u003e= 5:\n                sus_users.append(i)\n\n    print(sorted(sus_users))15:[\"$\",\"$Le\",\"pre-3\",{\"className\":\"my-2\",\"children\":\"$18\",\"language\":\"py\"}]\n16:[\"$\",\"p\",\"p-8\",{\"children\":[\"Unfortunately, there doesn't seem to be an obvious way around it. Loading up the task in \",[\"$\",\"code\",\"code-0\",{\"className\":\"font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"multiprocessing\"}],\" and churning away at it on\\n8 processes for about two hours, we get the flag:\"]}]\n17:[\"$\",\"$Le\",\"pre-4\",{\"className\":\"my-2\",\"children\":\"ictf{18,27,29,32,68,106,126,158,182,189,192,232,282,330,338,370,419,438,447,465}\",\"language\":\"$undefined\"}]\n"])</script><script>self.__next_f.push([1,"c:[[\"$\",\"title\",\"0\",{\"children\":\"iCTF 2023 — Stop the model thief! | kevin.fish\"}],[\"$\",\"meta\",\"1\",{\"name\":\"description\",\"content\":\"To steal an ML model, an attacker often sends 'very similar versions' of the same image, which tells the attacker how the model reacts to very small changes in the input. You realized that an attacker might be trying to steal your image classification model. You're given two files - [1::model_queries.npy] a list of images that your model received as inputs and [2::user_query_indices.txt] a list of image indices (starts from zero) in [1] sent to your model by each user-id. In [2], each line contains the indices from a different user-id (e.g., the very first line is user-id 0, the second line is user-id 1). Can you help us find the attacker's user-ids (there are 20 of them)? Note:: if there were 4 attacker user-ids (e.g., 82,54,13,36), the flag will be 'ictf{13,36,54,82}' (sorted, no quotes).\"}],[\"$\",\"meta\",\"2\",{\"property\":\"og:title\",\"content\":\"iCTF 2023 — Stop the model thief!\"}],[\"$\",\"meta\",\"3\",{\"property\":\"og:description\",\"content\":\"To steal an ML model, an attacker often sends 'very similar versions' of the same image, which tells the attacker how the model reacts to very small changes in the input. You realized that an attacker might be trying to steal your image classification model. You're given two files - [1::model_queries.npy] a list of images that your model received as inputs and [2::user_query_indices.txt] a list of image indices (starts from zero) in [1] sent to your model by each user-id. In [2], each line contains the indices from a different user-id (e.g., the very first line is user-id 0, the second line is user-id 1). Can you help us find the attacker's user-ids (there are 20 of them)? Note:: if there were 4 attacker user-ids (e.g., 82,54,13,36), the flag will be 'ictf{13,36,54,82}' (sorted, no quotes).\"}],[\"$\",\"meta\",\"4\",{\"name\":\"twitter:card\",\"content\":\"summary\"}],[\"$\",\"meta\",\"5\",{\"name\":\"twitter:title\",\"content\":\"iCTF 2023 — Stop the model thief!\"}],[\"$\",\"meta\",\"6\",{\"name\":\"twitter:description\",\"content\":\"To steal an ML model, an attacker often sends 'very similar versions' of the same image, which tells the attacker how the model reacts to very small changes in the input. You realized that an attacker might be trying to steal your image classification model. You're given two files - [1::model_queries.npy] a list of images that your model received as inputs and [2::user_query_indices.txt] a list of image indices (starts from zero) in [1] sent to your model by each user-id. In [2], each line contains the indices from a different user-id (e.g., the very first line is user-id 0, the second line is user-id 1). Can you help us find the attacker's user-ids (there are 20 of them)? Note:: if there were 4 attacker user-ids (e.g., 82,54,13,36), the flag will be 'ictf{13,36,54,82}' (sorted, no quotes).\"}]]\n"])</script><script>self.__next_f.push([1,"8:null\n"])</script></body></html>