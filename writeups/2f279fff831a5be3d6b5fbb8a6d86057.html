<!DOCTYPE html><!--ic9cUZ2jC3lu1TLpy1mjN--><html class="dark scroll-smooth"><head><meta charSet="utf-8"/><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" href="/_next/static/media/e4af272ccee01ff0-s.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="preload" as="image" href="https://gist.github.com/user-attachments/assets/e9359b7e-f3cf-4a25-8eea-c82b9ab65912"/><link rel="preload" as="image" href="https://gist.github.com/user-attachments/assets/8a765e88-8838-49ae-bc11-91094fc83f97"/><link rel="preload" as="image" href="https://gist.github.com/user-attachments/assets/d2a5ca54-7c35-46d8-abcf-18a8d17792f8"/><link rel="stylesheet" href="/_next/static/css/94afdc017676131d.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-d11e0b30904b49ad.js"/><script src="/_next/static/chunks/4bd1b696-9911af18dede28aa.js" async=""></script><script src="/_next/static/chunks/964-2bcac1827bbf29c7.js" async=""></script><script src="/_next/static/chunks/main-app-771e5b53791411ad.js" async=""></script><script src="/_next/static/chunks/874-3e820bd666038662.js" async=""></script><script src="/_next/static/chunks/app/writeups/%5Bid%5D/layout-2577bd3482649595.js" async=""></script><script src="/_next/static/chunks/325-655a7b8ed93161e0.js" async=""></script><script src="/_next/static/chunks/app/writeups/%5Bid%5D/page-bcc47f65bcf2ff4c.js" async=""></script><meta name="next-size-adjust" content=""/><title>corCTF 2024 — msfrogofwar3 | kevin.fish</title><meta name="description" content="![image](https://gist.github.com/user-attachments/assets/e9359b7e-f3cf-4a25-8eea-c82b9ab65912)"/><meta property="og:title" content="corCTF 2024 — msfrogofwar3"/><meta property="og:description" content="![image](https://gist.github.com/user-attachments/assets/e9359b7e-f3cf-4a25-8eea-c82b9ab65912)"/><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="corCTF 2024 — msfrogofwar3"/><meta name="twitter:description" content="![image](https://gist.github.com/user-attachments/assets/e9359b7e-f3cf-4a25-8eea-c82b9ab65912)"/><script src="/_next/static/chunks/polyfills-42372ed130431b0a.js" noModule=""></script></head><body class="text-dark dark:text-white dark:bg-midnight" style="font-family:&#x27;Inter&#x27;, &#x27;Inter Fallback&#x27;;font-style:normal"><div hidden=""><!--$--><!--/$--></div><main class="container pt-20 pb-24"><a class="text-secondary text-sm mb-10 -ml-5 block w-max" href="/writeups">← Back to writeups</a><div><main class="text-pretty max-w-5xl mx-auto text-sm [&amp;_h1]:text-5xl [&amp;_h1]:font-semibold [&amp;_h1]:mb-8 [&amp;_blockquote]:text-secondary [&amp;_blockquote]:space-y-3 [&amp;_blockquote]:border-l-4 [&amp;_blockquote]:border-secondary [&amp;_blockquote]:pl-5 [&amp;_blockquote]:mb-5 [&amp;&gt;_p]:my-4 [&amp;_img]:my-5 [&amp;_ul]:list-disc [&amp;_ul]:pl-6 [&amp;_ol]:list-decimal [&amp;_ol]:pl-6 [&amp;_img]:rounded [&amp;_li]:my-2"><h1>corCTF 2024 — msfrogofwar3</h1>
<blockquote>
<p><img src="https://gist.github.com/user-attachments/assets/e9359b7e-f3cf-4a25-8eea-c82b9ab65912" alt="image"/></p>
</blockquote>
<p>We&#x27;re given a Flask server that looks like this:</p>
<div class="border border-white/10 rounded-lg my-2"><p class="text-xs rounded-t-lg px-4 py-0.5 text-secondary">Code<!-- --> (py)<!-- -->:<!-- --> <button class="hover:underline">(copy)</button></p><div class="rounded-b-lg overflow-hidden text-xs"><pre class="prismjs"><code style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">1</span><span class="token keyword">from</span><span class=""> flask </span><span class="token keyword">import</span><span class=""> Flask</span><span class="token punctuation">,</span><span class=""> request</span><span class="token punctuation">,</span><span class=""> render_template
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">2</span><span class=""></span><span class="token keyword">from</span><span class=""> flask_socketio </span><span class="token keyword">import</span><span class=""> SocketIO</span><span class="token punctuation">,</span><span class=""> emit
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">3</span><span class=""></span><span class="token keyword">from</span><span class=""> stockfish </span><span class="token keyword">import</span><span class=""> Stockfish
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">4</span><span class=""></span><span class="token keyword">import</span><span class=""> random
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">5</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">6</span><span class=""></span><span class="token keyword">import</span><span class=""> chess
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">7</span><span class=""></span><span class="token keyword">from</span><span class=""> stockfish </span><span class="token keyword">import</span><span class=""> Stockfish
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">8</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">9</span><span class="">games </span><span class="token operator">=</span><span class=""> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">10</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">11</span><span class="">toxic_msges </span><span class="token operator">=</span><span class=""> </span><span class="token punctuation">[</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">12</span><span class="">    </span><span class="token string">&quot;?&quot;</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">13</span><span class="">    </span><span class="token string">&quot;rip bozo&quot;</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">14</span><span class="">    </span><span class="token string">&quot;so bad lmfaoo&quot;</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">15</span><span class="">    </span><span class="token string">&quot;ez&quot;</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">16</span><span class="">    </span><span class="token string">&quot;skill issue&quot;</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">17</span><span class="">    </span><span class="token string">&quot;mad cuz bad&quot;</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">18</span><span class="">    </span><span class="token string">&quot;hold this L&quot;</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">19</span><span class="">    </span><span class="token string">&quot;L + ratio + you fell off&quot;</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">20</span><span class="">    </span><span class="token string">&quot;i bet your main category is stego&quot;</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">21</span><span class="">    </span><span class="token string">&quot;have you tried alt+f4?&quot;</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">22</span><span class="">    </span><span class="token string">&quot;🤡🤡🤡&quot;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">23</span><span class=""></span><span class="token punctuation">]</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">24</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">25</span><span class="">win_msges </span><span class="token operator">=</span><span class=""> </span><span class="token punctuation">[</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">26</span><span class="">    </span><span class="token string">&quot;lmaooooooooo ur so bad&quot;</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">27</span><span class="">    </span><span class="token string">&quot;was that it?&quot;</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">28</span><span class="">    </span><span class="token string">&quot;zzzzzzzzzzzzzzzzzzzzzz&quot;</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">29</span><span class="">    </span><span class="token string">&quot;hopefully the next game wont be so quick&quot;</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">30</span><span class="">    </span><span class="token string">&quot;nice try - jk that was horrible&quot;</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">31</span><span class="">    </span><span class="token string">&quot;this aint checkers man&quot;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">32</span><span class=""></span><span class="token punctuation">]</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">33</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">34</span><span class="">TURN_LIMIT </span><span class="token operator">=</span><span class=""> </span><span class="token number">15</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">35</span><span class="">STOCKFISH_DEPTH </span><span class="token operator">=</span><span class=""> </span><span class="token number">21</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">36</span><span class="">FLAG </span><span class="token operator">=</span><span class=""> </span><span class="token string">&quot;corctf{this_is_a_fake_flag}&quot;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">37</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">38</span><span class=""></span><span class="token keyword">class</span><span class=""> </span><span class="token class-name">GameWrapper</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">39</span><span class="">    </span><span class="token keyword">def</span><span class=""> </span><span class="token function">__init__</span><span class="token punctuation">(</span><span class="">self</span><span class="token punctuation">,</span><span class=""> emit</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">40</span><span class="">        self</span><span class="token punctuation">.</span><span class="">emit </span><span class="token operator">=</span><span class=""> emit
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">41</span><span class="">        self</span><span class="token punctuation">.</span><span class="">board </span><span class="token operator">=</span><span class=""> chess</span><span class="token punctuation">.</span><span class="">Board</span><span class="token punctuation">(</span><span class="">chess</span><span class="token punctuation">.</span><span class="">STARTING_FEN</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">42</span><span class="">        self</span><span class="token punctuation">.</span><span class="">moves </span><span class="token operator">=</span><span class=""> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">43</span><span class="">        self</span><span class="token punctuation">.</span><span class="">player_turn </span><span class="token operator">=</span><span class=""> </span><span class="token boolean">True</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">44</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">45</span><span class="">    </span><span class="token keyword">def</span><span class=""> </span><span class="token function">get_player_state</span><span class="token punctuation">(</span><span class="">self</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">46</span><span class="">        legal_moves </span><span class="token operator">=</span><span class=""> </span><span class="token punctuation">[</span><span class="token string-interpolation string">f&quot;</span><span class="token string-interpolation interpolation punctuation">{</span><span class="token string-interpolation interpolation">m</span><span class="token string-interpolation interpolation punctuation">}</span><span class="token string-interpolation string">&quot;</span><span class=""> </span><span class="token keyword">for</span><span class=""> m </span><span class="token keyword">in</span><span class=""> self</span><span class="token punctuation">.</span><span class="">board</span><span class="token punctuation">.</span><span class="">legal_moves</span><span class="token punctuation">]</span><span class=""> </span><span class="token keyword">if</span><span class=""> self</span><span class="token punctuation">.</span><span class="">player_turn </span><span class="token keyword">and</span><span class=""> self</span><span class="token punctuation">.</span><span class="">board</span><span class="token punctuation">.</span><span class="">fullmove_number </span><span class="token operator">&lt;</span><span class=""> TURN_LIMIT </span><span class="token keyword">else</span><span class=""> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">47</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">48</span><span class="">        status </span><span class="token operator">=</span><span class=""> </span><span class="token string">&quot;running&quot;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">49</span><span class="">        </span><span class="token keyword">if</span><span class=""> self</span><span class="token punctuation">.</span><span class="">board</span><span class="token punctuation">.</span><span class="">fullmove_number </span><span class="token operator">&gt;=</span><span class=""> TURN_LIMIT</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">50</span><span class="">            status </span><span class="token operator">=</span><span class=""> </span><span class="token string">&quot;turn limit&quot;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">51</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">52</span><span class="">        </span><span class="token keyword">if</span><span class=""> outcome </span><span class="token operator">:=</span><span class=""> self</span><span class="token punctuation">.</span><span class="">board</span><span class="token punctuation">.</span><span class="">outcome</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">53</span><span class="">            </span><span class="token keyword">if</span><span class=""> outcome</span><span class="token punctuation">.</span><span class="">winner </span><span class="token keyword">is</span><span class=""> </span><span class="token boolean">None</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">54</span><span class="">                status </span><span class="token operator">=</span><span class=""> </span><span class="token string">&quot;draw&quot;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">55</span><span class="">            </span><span class="token keyword">else</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">56</span><span class="">                status </span><span class="token operator">=</span><span class=""> </span><span class="token string">&quot;win&quot;</span><span class=""> </span><span class="token keyword">if</span><span class=""> outcome</span><span class="token punctuation">.</span><span class="">winner </span><span class="token operator">==</span><span class=""> chess</span><span class="token punctuation">.</span><span class="">WHITE </span><span class="token keyword">else</span><span class=""> </span><span class="token string">&quot;lose&quot;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">57</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">58</span><span class="">        </span><span class="token keyword">return</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">59</span><span class="">            </span><span class="token string">&quot;pos&quot;</span><span class="token punctuation">:</span><span class=""> self</span><span class="token punctuation">.</span><span class="">board</span><span class="token punctuation">.</span><span class="">fen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">60</span><span class="">            </span><span class="token string">&quot;moves&quot;</span><span class="token punctuation">:</span><span class=""> legal_moves</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">61</span><span class="">            </span><span class="token string">&quot;your_turn&quot;</span><span class="token punctuation">:</span><span class=""> self</span><span class="token punctuation">.</span><span class="">player_turn</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">62</span><span class="">            </span><span class="token string">&quot;status&quot;</span><span class="token punctuation">:</span><span class=""> status</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">63</span><span class="">            </span><span class="token string">&quot;turn_counter&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string-interpolation string">f&quot;</span><span class="token string-interpolation interpolation punctuation">{</span><span class="token string-interpolation interpolation">self</span><span class="token string-interpolation interpolation punctuation">.</span><span class="token string-interpolation interpolation">board</span><span class="token string-interpolation interpolation punctuation">.</span><span class="token string-interpolation interpolation">fullmove_number</span><span class="token string-interpolation interpolation punctuation">}</span><span class="token string-interpolation string"> / </span><span class="token string-interpolation interpolation punctuation">{</span><span class="token string-interpolation interpolation">TURN_LIMIT</span><span class="token string-interpolation interpolation punctuation">}</span><span class="token string-interpolation string"> turns&quot;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">64</span><span class="">        </span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">65</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">66</span><span class="">    </span><span class="token keyword">def</span><span class=""> </span><span class="token function">play_move</span><span class="token punctuation">(</span><span class="">self</span><span class="token punctuation">,</span><span class=""> uci</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">67</span><span class="">        </span><span class="token keyword">if</span><span class=""> </span><span class="token keyword">not</span><span class=""> self</span><span class="token punctuation">.</span><span class="">player_turn</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">68</span><span class="">            </span><span class="token keyword">return</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">69</span><span class="">        </span><span class="token keyword">if</span><span class=""> self</span><span class="token punctuation">.</span><span class="">board</span><span class="token punctuation">.</span><span class="">fullmove_number </span><span class="token operator">&gt;=</span><span class=""> TURN_LIMIT</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">70</span><span class="">            </span><span class="token keyword">return</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">71</span>        
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">72</span><span class="">        self</span><span class="token punctuation">.</span><span class="">player_turn </span><span class="token operator">=</span><span class=""> </span><span class="token boolean">False</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">73</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">74</span><span class="">        outcome </span><span class="token operator">=</span><span class=""> self</span><span class="token punctuation">.</span><span class="">board</span><span class="token punctuation">.</span><span class="">outcome</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">75</span><span class="">        </span><span class="token keyword">if</span><span class=""> outcome </span><span class="token keyword">is</span><span class=""> </span><span class="token boolean">None</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">76</span><span class="">            </span><span class="token keyword">try</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">77</span><span class="">                move </span><span class="token operator">=</span><span class=""> chess</span><span class="token punctuation">.</span><span class="">Move</span><span class="token punctuation">.</span><span class="">from_uci</span><span class="token punctuation">(</span><span class="">uci</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">78</span><span class="">                </span><span class="token keyword">if</span><span class=""> move</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">79</span><span class="">                    </span><span class="token keyword">if</span><span class=""> move </span><span class="token keyword">not</span><span class=""> </span><span class="token keyword">in</span><span class=""> self</span><span class="token punctuation">.</span><span class="">board</span><span class="token punctuation">.</span><span class="">legal_moves</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">80</span><span class="">                        self</span><span class="token punctuation">.</span><span class="">player_turn </span><span class="token operator">=</span><span class=""> </span><span class="token boolean">True</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">81</span><span class="">                        self</span><span class="token punctuation">.</span><span class="">emit</span><span class="token punctuation">(</span><span class="token string">&#x27;state&#x27;</span><span class="token punctuation">,</span><span class=""> self</span><span class="token punctuation">.</span><span class="">get_player_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">82</span><span class="">                        self</span><span class="token punctuation">.</span><span class="">emit</span><span class="token punctuation">(</span><span class="token string">&quot;chat&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;System&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;Illegal move&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">83</span><span class="">                        </span><span class="token keyword">return</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">84</span><span class="">                    self</span><span class="token punctuation">.</span><span class="">board</span><span class="token punctuation">.</span><span class="">push_uci</span><span class="token punctuation">(</span><span class="">uci</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">85</span><span class="">            </span><span class="token keyword">except</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">86</span><span class="">                self</span><span class="token punctuation">.</span><span class="">player_turn </span><span class="token operator">=</span><span class=""> </span><span class="token boolean">True</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">87</span><span class="">                self</span><span class="token punctuation">.</span><span class="">emit</span><span class="token punctuation">(</span><span class="token string">&#x27;state&#x27;</span><span class="token punctuation">,</span><span class=""> self</span><span class="token punctuation">.</span><span class="">get_player_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">88</span><span class="">                self</span><span class="token punctuation">.</span><span class="">emit</span><span class="token punctuation">(</span><span class="token string">&quot;chat&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;System&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;Invalid move format&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">89</span><span class="">                </span><span class="token keyword">return</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">90</span><span class="">        </span><span class="token keyword">elif</span><span class=""> outcome</span><span class="token punctuation">.</span><span class="">winner </span><span class="token operator">!=</span><span class=""> chess</span><span class="token punctuation">.</span><span class="">WHITE</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">91</span><span class="">            self</span><span class="token punctuation">.</span><span class="">emit</span><span class="token punctuation">(</span><span class="token string">&quot;chat&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;🐸&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;you lost, bozo&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">92</span><span class="">            </span><span class="token keyword">return</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">93</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">94</span><span class="">        self</span><span class="token punctuation">.</span><span class="">moves</span><span class="token punctuation">.</span><span class="">append</span><span class="token punctuation">(</span><span class="">uci</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">95</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">96</span><span class="">        </span><span class="token comment"># stockfish has a habit of crashing</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">97</span><span class="">        </span><span class="token comment"># The following section is used to try to resolve this</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">98</span><span class="">        opponent_move</span><span class="token punctuation">,</span><span class=""> attempts </span><span class="token operator">=</span><span class=""> </span><span class="token boolean">None</span><span class="token punctuation">,</span><span class=""> </span><span class="token number">0</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">99</span><span class="">        </span><span class="token keyword">while</span><span class=""> </span><span class="token keyword">not</span><span class=""> opponent_move </span><span class="token keyword">and</span><span class=""> attempts </span><span class="token operator">&lt;=</span><span class=""> </span><span class="token number">10</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">100</span><span class="">            </span><span class="token keyword">try</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">101</span><span class="">                attempts </span><span class="token operator">+=</span><span class=""> </span><span class="token number">1</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">102</span><span class="">                engine </span><span class="token operator">=</span><span class=""> Stockfish</span><span class="token punctuation">(</span><span class="token string">&quot;./stockfish/stockfish-ubuntu-x86-64-avx2&quot;</span><span class="token punctuation">,</span><span class=""> parameters</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;Threads&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token number">4</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class=""> depth</span><span class="token operator">=</span><span class="">STOCKFISH_DEPTH</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">103</span><span class="">                </span><span class="token keyword">for</span><span class=""> m </span><span class="token keyword">in</span><span class=""> self</span><span class="token punctuation">.</span><span class="">moves</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">104</span><span class="">                    </span><span class="token keyword">if</span><span class=""> engine</span><span class="token punctuation">.</span><span class="">is_move_correct</span><span class="token punctuation">(</span><span class="">m</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">105</span><span class="">                        engine</span><span class="token punctuation">.</span><span class="">make_moves_from_current_position</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="">m</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">106</span><span class="">                opponent_move </span><span class="token operator">=</span><span class=""> engine</span><span class="token punctuation">.</span><span class="">get_best_move_time</span><span class="token punctuation">(</span><span class="token number">3_000</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">107</span><span class="">            </span><span class="token keyword">except</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">108</span><span class="">                </span><span class="token keyword">pass</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">109</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">110</span><span class="">        </span><span class="token keyword">if</span><span class=""> opponent_move </span><span class="token operator">!=</span><span class=""> </span><span class="token boolean">None</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">111</span><span class="">            self</span><span class="token punctuation">.</span><span class="">moves</span><span class="token punctuation">.</span><span class="">append</span><span class="token punctuation">(</span><span class="">opponent_move</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">112</span><span class="">            opponent_move </span><span class="token operator">=</span><span class=""> chess</span><span class="token punctuation">.</span><span class="">Move</span><span class="token punctuation">.</span><span class="">from_uci</span><span class="token punctuation">(</span><span class="">opponent_move</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">113</span><span class="">            </span><span class="token keyword">if</span><span class=""> self</span><span class="token punctuation">.</span><span class="">board</span><span class="token punctuation">.</span><span class="">is_capture</span><span class="token punctuation">(</span><span class="">opponent_move</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">114</span><span class="">                self</span><span class="token punctuation">.</span><span class="">emit</span><span class="token punctuation">(</span><span class="token string">&quot;chat&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;🐸&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">:</span><span class=""> random</span><span class="token punctuation">.</span><span class="">choice</span><span class="token punctuation">(</span><span class="">toxic_msges</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">115</span><span class="">            self</span><span class="token punctuation">.</span><span class="">board</span><span class="token punctuation">.</span><span class="">push</span><span class="token punctuation">(</span><span class="">opponent_move</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">116</span><span class="">            self</span><span class="token punctuation">.</span><span class="">player_turn </span><span class="token operator">=</span><span class=""> </span><span class="token boolean">True</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">117</span><span class="">            self</span><span class="token punctuation">.</span><span class="">emit</span><span class="token punctuation">(</span><span class="token string">&quot;state&quot;</span><span class="token punctuation">,</span><span class=""> self</span><span class="token punctuation">.</span><span class="">get_player_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">118</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">119</span><span class="">            </span><span class="token keyword">if</span><span class=""> </span><span class="token punctuation">(</span><span class="">outcome </span><span class="token operator">:=</span><span class=""> self</span><span class="token punctuation">.</span><span class="">board</span><span class="token punctuation">.</span><span class="">outcome</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class=""> </span><span class="token keyword">is</span><span class=""> </span><span class="token keyword">not</span><span class=""> </span><span class="token boolean">None</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">120</span><span class="">                </span><span class="token keyword">if</span><span class=""> outcome</span><span class="token punctuation">.</span><span class="">termination </span><span class="token operator">==</span><span class=""> chess</span><span class="token punctuation">.</span><span class="">Termination</span><span class="token punctuation">.</span><span class="">CHECKMATE</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">121</span><span class="">                    </span><span class="token keyword">if</span><span class=""> outcome</span><span class="token punctuation">.</span><span class="">winner </span><span class="token operator">==</span><span class=""> chess</span><span class="token punctuation">.</span><span class="">BLACK</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">122</span><span class="">                        self</span><span class="token punctuation">.</span><span class="">emit</span><span class="token punctuation">(</span><span class="token string">&quot;chat&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;🐸&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;Nice try... but not good enough 🐸&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">123</span><span class="">                    </span><span class="token keyword">else</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">124</span><span class="">                        self</span><span class="token punctuation">.</span><span class="">emit</span><span class="token punctuation">(</span><span class="token string">&quot;chat&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;🐸&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;how??????&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">125</span><span class="">                        self</span><span class="token punctuation">.</span><span class="">emit</span><span class="token punctuation">(</span><span class="token string">&quot;chat&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;System&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">:</span><span class=""> FLAG</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">126</span><span class="">                </span><span class="token keyword">else</span><span class="token punctuation">:</span><span class=""> </span><span class="token comment"># statemate, insufficient material, etc</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">127</span><span class="">                    self</span><span class="token punctuation">.</span><span class="">emit</span><span class="token punctuation">(</span><span class="token string">&quot;chat&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;🐸&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;That was close... but still not good enough 🐸&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">128</span><span class="">        </span><span class="token keyword">else</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">129</span><span class="">            self</span><span class="token punctuation">.</span><span class="">emit</span><span class="token punctuation">(</span><span class="token string">&quot;chat&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;System&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;An error occurred, please restart&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">130</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">131</span><span class="">app </span><span class="token operator">=</span><span class=""> Flask</span><span class="token punctuation">(</span><span class="">__name__</span><span class="token punctuation">,</span><span class=""> static_url_path</span><span class="token operator">=</span><span class="token string">&#x27;&#x27;</span><span class="token punctuation">,</span><span class=""> static_folder</span><span class="token operator">=</span><span class="token string">&#x27;static&#x27;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">132</span><span class="">socketio </span><span class="token operator">=</span><span class=""> SocketIO</span><span class="token punctuation">(</span><span class="">app</span><span class="token punctuation">,</span><span class=""> cors_allowed_origins</span><span class="token operator">=</span><span class="token string">&#x27;*&#x27;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">133</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">134</span><span class=""></span><span class="token decorator annotation punctuation">@app</span><span class="token decorator annotation punctuation">.</span><span class="token decorator annotation punctuation">after_request</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">135</span><span class=""></span><span class="token keyword">def</span><span class=""> </span><span class="token function">add_header</span><span class="token punctuation">(</span><span class="">response</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">136</span><span class="">    response</span><span class="token punctuation">.</span><span class="">headers</span><span class="token punctuation">[</span><span class="token string">&#x27;Cache-Control&#x27;</span><span class="token punctuation">]</span><span class=""> </span><span class="token operator">=</span><span class=""> </span><span class="token string">&#x27;max-age=604800&#x27;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">137</span><span class="">    </span><span class="token keyword">return</span><span class=""> response
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">138</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">139</span><span class=""></span><span class="token decorator annotation punctuation">@app</span><span class="token decorator annotation punctuation">.</span><span class="token decorator annotation punctuation">route</span><span class="token punctuation">(</span><span class="token string">&#x27;/&#x27;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">140</span><span class=""></span><span class="token keyword">def</span><span class=""> </span><span class="token function">index_route</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">141</span><span class="">    </span><span class="token keyword">return</span><span class=""> render_template</span><span class="token punctuation">(</span><span class="token string">&#x27;index.html&#x27;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">142</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">143</span><span class=""></span><span class="token decorator annotation punctuation">@socketio</span><span class="token decorator annotation punctuation">.</span><span class="token decorator annotation punctuation">on</span><span class="token punctuation">(</span><span class="token string">&#x27;connect&#x27;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">144</span><span class=""></span><span class="token keyword">def</span><span class=""> </span><span class="token function">on_connect</span><span class="token punctuation">(</span><span class="">_</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">145</span><span class="">    games</span><span class="token punctuation">[</span><span class="">request</span><span class="token punctuation">.</span><span class="">sid</span><span class="token punctuation">]</span><span class=""> </span><span class="token operator">=</span><span class=""> GameWrapper</span><span class="token punctuation">(</span><span class="">emit</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">146</span><span class="">    emit</span><span class="token punctuation">(</span><span class="token string">&#x27;state&#x27;</span><span class="token punctuation">,</span><span class=""> games</span><span class="token punctuation">[</span><span class="">request</span><span class="token punctuation">.</span><span class="">sid</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="">get_player_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">147</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">148</span><span class=""></span><span class="token decorator annotation punctuation">@socketio</span><span class="token decorator annotation punctuation">.</span><span class="token decorator annotation punctuation">on</span><span class="token punctuation">(</span><span class="token string">&#x27;disconnect&#x27;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">149</span><span class=""></span><span class="token keyword">def</span><span class=""> </span><span class="token function">on_disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">150</span><span class="">    </span><span class="token keyword">if</span><span class=""> request</span><span class="token punctuation">.</span><span class="">sid </span><span class="token keyword">in</span><span class=""> games</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">151</span><span class="">        </span><span class="token keyword">del</span><span class=""> games</span><span class="token punctuation">[</span><span class="">request</span><span class="token punctuation">.</span><span class="">sid</span><span class="token punctuation">]</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">152</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">153</span><span class=""></span><span class="token decorator annotation punctuation">@socketio</span><span class="token decorator annotation punctuation">.</span><span class="token decorator annotation punctuation">on</span><span class="token punctuation">(</span><span class="token string">&#x27;move&#x27;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">154</span><span class=""></span><span class="token keyword">def</span><span class=""> </span><span class="token function">onmsg_move</span><span class="token punctuation">(</span><span class="">move</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">155</span><span class="">    </span><span class="token keyword">try</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">156</span><span class="">        games</span><span class="token punctuation">[</span><span class="">request</span><span class="token punctuation">.</span><span class="">sid</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="">play_move</span><span class="token punctuation">(</span><span class="">move</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">157</span><span class="">    </span><span class="token keyword">except</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">158</span><span class="">        emit</span><span class="token punctuation">(</span><span class="token string">&quot;chat&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;System&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;An error occurred, please restart&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">159</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">160</span><span class=""></span><span class="token decorator annotation punctuation">@socketio</span><span class="token decorator annotation punctuation">.</span><span class="token decorator annotation punctuation">on</span><span class="token punctuation">(</span><span class="token string">&#x27;state&#x27;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">161</span><span class=""></span><span class="token keyword">def</span><span class=""> </span><span class="token function">onmsg_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">162</span><span class="">    emit</span><span class="token punctuation">(</span><span class="token string">&#x27;state&#x27;</span><span class="token punctuation">,</span><span class=""> games</span><span class="token punctuation">[</span><span class="">request</span><span class="token punctuation">.</span><span class="">sid</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="">get_player_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div></div>
<p>At first glance, it looks like we need to win against Stockfish in 15 moves to get the flag.</p>
<p>Obviously, winning against max-difficulty Stockfish, much less in 15 moves, is impossible. Curiously, however, the server uses <a href="https://python-chess.readthedocs.io/en/latest/">python-chess</a>&#x27;s <code class="opacity-75 bg-black/30 rounded px-1.5 py-1 text-[0.9em]">Move</code> class to verify game inputs. Reading the <a href="https://github.com/niklasf/python-chess/blob/32253d6cfdbc1939f78f03892fa848412cf4b4fa/chess/__init__.py#L686">source for <code class="opacity-75 bg-black/30 rounded px-1.5 py-1 text-[0.9em]">Move.from_uci</code></a>,</p>
<div class="border border-white/10 rounded-lg my-2"><p class="text-xs rounded-t-lg px-4 py-0.5 text-secondary">Code<!-- --> (py)<!-- -->:<!-- --> <button class="hover:underline">(copy)</button></p><div class="rounded-b-lg overflow-hidden text-xs"><pre class="prismjs"><code style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">1</span><span class="">    </span><span class="token decorator annotation punctuation">@classmethod</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">2</span><span class="">    </span><span class="token keyword">def</span><span class=""> </span><span class="token function">from_uci</span><span class="token punctuation">(</span><span class="">cls</span><span class="token punctuation">,</span><span class=""> uci</span><span class="token punctuation">:</span><span class=""> </span><span class="token builtin">str</span><span class="token punctuation">)</span><span class=""> </span><span class="token operator">-</span><span class="token operator">&gt;</span><span class=""> Move</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">3</span><span class="">        </span><span class="token triple-quoted-string string">&quot;&quot;&quot;
</span><span class="token triple-quoted-string string"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">4</span>        Parses a UCI string.
</span><span class="token triple-quoted-string string"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">5</span>
</span><span class="token triple-quoted-string string"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">6</span>        :raises: :exc:`InvalidMoveError` if the UCI string is invalid.
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">7</span><span class="token triple-quoted-string string">        &quot;&quot;&quot;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">8</span><span class="">        </span><span class="token keyword">if</span><span class=""> uci </span><span class="token operator">==</span><span class=""> </span><span class="token string">&quot;0000&quot;</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">9</span><span class="">            </span><span class="token keyword">return</span><span class=""> cls</span><span class="token punctuation">.</span><span class="">null</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">10</span><span class="">        </span><span class="token keyword">elif</span><span class=""> </span><span class="token builtin">len</span><span class="token punctuation">(</span><span class="">uci</span><span class="token punctuation">)</span><span class=""> </span><span class="token operator">==</span><span class=""> </span><span class="token number">4</span><span class=""> </span><span class="token keyword">and</span><span class=""> </span><span class="token string">&quot;@&quot;</span><span class=""> </span><span class="token operator">==</span><span class=""> uci</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">11</span><span class="">            </span><span class="token keyword">try</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">12</span><span class="">                drop </span><span class="token operator">=</span><span class=""> PIECE_SYMBOLS</span><span class="token punctuation">.</span><span class="">index</span><span class="token punctuation">(</span><span class="">uci</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="">lower</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">13</span><span class="">                square </span><span class="token operator">=</span><span class=""> SQUARE_NAMES</span><span class="token punctuation">.</span><span class="">index</span><span class="token punctuation">(</span><span class="">uci</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">14</span><span class="">            </span><span class="token keyword">except</span><span class=""> ValueError</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">15</span><span class="">                </span><span class="token keyword">raise</span><span class=""> InvalidMoveError</span><span class="token punctuation">(</span><span class="token string-interpolation string">f&quot;invalid uci: </span><span class="token string-interpolation interpolation punctuation">{</span><span class="token string-interpolation interpolation">uci</span><span class="token string-interpolation interpolation conversion-option punctuation">!r</span><span class="token string-interpolation interpolation punctuation">}</span><span class="token string-interpolation string">&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">16</span><span class="">            </span><span class="token keyword">return</span><span class=""> cls</span><span class="token punctuation">(</span><span class="">square</span><span class="token punctuation">,</span><span class=""> square</span><span class="token punctuation">,</span><span class=""> drop</span><span class="token operator">=</span><span class="">drop</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">17</span><span class="">        </span><span class="token keyword">elif</span><span class=""> </span><span class="token number">4</span><span class=""> </span><span class="token operator">&lt;=</span><span class=""> </span><span class="token builtin">len</span><span class="token punctuation">(</span><span class="">uci</span><span class="token punctuation">)</span><span class=""> </span><span class="token operator">&lt;=</span><span class=""> </span><span class="token number">5</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">18</span><span class="">            </span><span class="token keyword">try</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">19</span><span class="">                from_square </span><span class="token operator">=</span><span class=""> SQUARE_NAMES</span><span class="token punctuation">.</span><span class="">index</span><span class="token punctuation">(</span><span class="">uci</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">20</span><span class="">                to_square </span><span class="token operator">=</span><span class=""> SQUARE_NAMES</span><span class="token punctuation">.</span><span class="">index</span><span class="token punctuation">(</span><span class="">uci</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">21</span><span class="">                promotion </span><span class="token operator">=</span><span class=""> PIECE_SYMBOLS</span><span class="token punctuation">.</span><span class="">index</span><span class="token punctuation">(</span><span class="">uci</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class=""> </span><span class="token keyword">if</span><span class=""> </span><span class="token builtin">len</span><span class="token punctuation">(</span><span class="">uci</span><span class="token punctuation">)</span><span class=""> </span><span class="token operator">==</span><span class=""> </span><span class="token number">5</span><span class=""> </span><span class="token keyword">else</span><span class=""> </span><span class="token boolean">None</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">22</span><span class="">            </span><span class="token keyword">except</span><span class=""> ValueError</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">23</span><span class="">                </span><span class="token keyword">raise</span><span class=""> InvalidMoveError</span><span class="token punctuation">(</span><span class="token string-interpolation string">f&quot;invalid uci: </span><span class="token string-interpolation interpolation punctuation">{</span><span class="token string-interpolation interpolation">uci</span><span class="token string-interpolation interpolation conversion-option punctuation">!r</span><span class="token string-interpolation interpolation punctuation">}</span><span class="token string-interpolation string">&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">24</span><span class="">            </span><span class="token keyword">if</span><span class=""> from_square </span><span class="token operator">==</span><span class=""> to_square</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">25</span><span class="">                </span><span class="token keyword">raise</span><span class=""> InvalidMoveError</span><span class="token punctuation">(</span><span class="token string-interpolation string">f&quot;invalid uci (use 0000 for null moves): </span><span class="token string-interpolation interpolation punctuation">{</span><span class="token string-interpolation interpolation">uci</span><span class="token string-interpolation interpolation conversion-option punctuation">!r</span><span class="token string-interpolation interpolation punctuation">}</span><span class="token string-interpolation string">&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">26</span><span class="">            </span><span class="token keyword">return</span><span class=""> cls</span><span class="token punctuation">(</span><span class="">from_square</span><span class="token punctuation">,</span><span class=""> to_square</span><span class="token punctuation">,</span><span class=""> promotion</span><span class="token operator">=</span><span class="">promotion</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">27</span><span class="">        </span><span class="token keyword">else</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">28</span><span class="">            </span><span class="token keyword">raise</span><span class=""> InvalidMoveError</span><span class="token punctuation">(</span><span class="token string-interpolation string">f&quot;expected uci string to be of length 4 or 5: </span><span class="token string-interpolation interpolation punctuation">{</span><span class="token string-interpolation interpolation">uci</span><span class="token string-interpolation interpolation conversion-option punctuation">!r</span><span class="token string-interpolation interpolation punctuation">}</span><span class="token string-interpolation string">&quot;</span><span class="token punctuation">)</span></code></pre></div></div>
<p>we can send a &quot;null move&quot; <code class="opacity-75 bg-black/30 rounded px-1.5 py-1 text-[0.9em]">0000</code> to pass the turn to Stockfish. Afterwards, Stockfish will play white and we will play black; all we need to do is get checkmated to &quot;win&quot;!</p>
<p><img src="https://gist.github.com/user-attachments/assets/8a765e88-8838-49ae-bc11-91094fc83f97" alt="image"/></p>
<div class="border border-white/10 rounded-lg my-2"><p class="text-xs rounded-t-lg px-4 py-0.5 text-secondary">Code<!-- --> (js)<!-- -->:<!-- --> <button class="hover:underline">(copy)</button></p><div class="rounded-b-lg overflow-hidden text-xs"><pre class="prismjs"><code style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">1</span><span class="">socket</span><span class="token punctuation">.</span><span class="token method function property-access">emit</span><span class="token punctuation">(</span><span class="token string">&#x27;move&#x27;</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&#x27;0000&#x27;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">2</span><span class="">socket</span><span class="token punctuation">.</span><span class="token method function property-access">emit</span><span class="token punctuation">(</span><span class="token string">&#x27;move&#x27;</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&#x27;f7f6&#x27;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">3</span><span class="">socket</span><span class="token punctuation">.</span><span class="token method function property-access">emit</span><span class="token punctuation">(</span><span class="token string">&#x27;move&#x27;</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&#x27;g7g5&#x27;</span><span class="token punctuation">)</span></code></pre></div></div>
<p>Unfortunately, winning is only part one of the challenge; the flag printed to the chat is fake, and looking in <code class="opacity-75 bg-black/30 rounded px-1.5 py-1 text-[0.9em]">run-docker.sh</code>, the real flag lies in the <code class="opacity-75 bg-black/30 rounded px-1.5 py-1 text-[0.9em]">FLAG</code> environment variable passed to <code class="opacity-75 bg-black/30 rounded px-1.5 py-1 text-[0.9em]">docker run</code>:</p>
<div class="border border-white/10 rounded-lg my-2"><p class="text-xs rounded-t-lg px-4 py-0.5 text-secondary">Code<!-- --> (sh)<!-- -->:<!-- --> <button class="hover:underline">(copy)</button></p><div class="rounded-b-lg overflow-hidden text-xs"><pre class="prismjs"><code style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none">1</span><span class="">#!/bin/sh
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none">2</span>docker build . -t msfrogofwar3
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none">3</span>docker run --rm -it -p 8080:8080 -e FLAG=corctf{real_flag} --name msfrogofwar3 msfrogofwar3</code></pre></div></div>
<p>However, looking again at the <code class="opacity-75 bg-black/30 rounded px-1.5 py-1 text-[0.9em]">play_move</code> method in the game server,</p>
<div class="border border-white/10 rounded-lg my-2"><p class="text-xs rounded-t-lg px-4 py-0.5 text-secondary">Code<!-- --> (py)<!-- -->:<!-- --> <button class="hover:underline">(copy)</button></p><div class="rounded-b-lg overflow-hidden text-xs"><pre class="prismjs"><code style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">1</span><span class="">        outcome </span><span class="token operator">=</span><span class=""> self</span><span class="token punctuation">.</span><span class="">board</span><span class="token punctuation">.</span><span class="">outcome</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">2</span><span class="">        </span><span class="token keyword">if</span><span class=""> outcome </span><span class="token keyword">is</span><span class=""> </span><span class="token boolean">None</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">3</span><span class="">            </span><span class="token keyword">try</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">4</span><span class="">                move </span><span class="token operator">=</span><span class=""> chess</span><span class="token punctuation">.</span><span class="">Move</span><span class="token punctuation">.</span><span class="">from_uci</span><span class="token punctuation">(</span><span class="">uci</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">5</span><span class="">                </span><span class="token keyword">if</span><span class=""> move</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">6</span><span class="">                    </span><span class="token keyword">if</span><span class=""> move </span><span class="token keyword">not</span><span class=""> </span><span class="token keyword">in</span><span class=""> self</span><span class="token punctuation">.</span><span class="">board</span><span class="token punctuation">.</span><span class="">legal_moves</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">7</span><span class="">                        self</span><span class="token punctuation">.</span><span class="">player_turn </span><span class="token operator">=</span><span class=""> </span><span class="token boolean">True</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">8</span><span class="">                        self</span><span class="token punctuation">.</span><span class="">emit</span><span class="token punctuation">(</span><span class="token string">&#x27;state&#x27;</span><span class="token punctuation">,</span><span class=""> self</span><span class="token punctuation">.</span><span class="">get_player_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">9</span><span class="">                        self</span><span class="token punctuation">.</span><span class="">emit</span><span class="token punctuation">(</span><span class="token string">&quot;chat&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;System&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;Illegal move&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">10</span><span class="">                        </span><span class="token keyword">return</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">11</span><span class="">                    self</span><span class="token punctuation">.</span><span class="">board</span><span class="token punctuation">.</span><span class="">push_uci</span><span class="token punctuation">(</span><span class="">uci</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">12</span><span class="">            </span><span class="token keyword">except</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">13</span><span class="">                self</span><span class="token punctuation">.</span><span class="">player_turn </span><span class="token operator">=</span><span class=""> </span><span class="token boolean">True</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">14</span><span class="">                self</span><span class="token punctuation">.</span><span class="">emit</span><span class="token punctuation">(</span><span class="token string">&#x27;state&#x27;</span><span class="token punctuation">,</span><span class=""> self</span><span class="token punctuation">.</span><span class="">get_player_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">15</span><span class="">                self</span><span class="token punctuation">.</span><span class="">emit</span><span class="token punctuation">(</span><span class="token string">&quot;chat&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;System&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;Invalid move format&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">16</span><span class="">                </span><span class="token keyword">return</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">17</span><span class="">        </span><span class="token keyword">elif</span><span class=""> outcome</span><span class="token punctuation">.</span><span class="">winner </span><span class="token operator">!=</span><span class=""> chess</span><span class="token punctuation">.</span><span class="">WHITE</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">18</span><span class="">            self</span><span class="token punctuation">.</span><span class="">emit</span><span class="token punctuation">(</span><span class="token string">&quot;chat&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;🐸&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;you lost, bozo&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">19</span><span class="">            </span><span class="token keyword">return</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">20</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">21</span><span class="">        self</span><span class="token punctuation">.</span><span class="">moves</span><span class="token punctuation">.</span><span class="">append</span><span class="token punctuation">(</span><span class="">uci</span><span class="token punctuation">)</span></code></pre></div></div>
<p>it seems like winning lets us push unchecked moves to <code class="opacity-75 bg-black/30 rounded px-1.5 py-1 text-[0.9em]">self.moves</code>, which then get passed to <code class="opacity-75 bg-black/30 rounded px-1.5 py-1 text-[0.9em]">engine.is_move_correct</code>:</p>
<div class="border border-white/10 rounded-lg my-2"><p class="text-xs rounded-t-lg px-4 py-0.5 text-secondary">Code<!-- --> (py)<!-- -->:<!-- --> <button class="hover:underline">(copy)</button></p><div class="rounded-b-lg overflow-hidden text-xs"><pre class="prismjs"><code style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">1</span><span class="">        </span><span class="token keyword">while</span><span class=""> </span><span class="token keyword">not</span><span class=""> opponent_move </span><span class="token keyword">and</span><span class=""> attempts </span><span class="token operator">&lt;=</span><span class=""> </span><span class="token number">10</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">2</span><span class="">            </span><span class="token keyword">try</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">3</span><span class="">                attempts </span><span class="token operator">+=</span><span class=""> </span><span class="token number">1</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">4</span><span class="">                engine </span><span class="token operator">=</span><span class=""> Stockfish</span><span class="token punctuation">(</span><span class="token string">&quot;./stockfish/stockfish-ubuntu-x86-64-avx2&quot;</span><span class="token punctuation">,</span><span class=""> parameters</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;Threads&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token number">4</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class=""> depth</span><span class="token operator">=</span><span class="">STOCKFISH_DEPTH</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">5</span><span class="">                </span><span class="token keyword">for</span><span class=""> m </span><span class="token keyword">in</span><span class=""> self</span><span class="token punctuation">.</span><span class="">moves</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">6</span><span class="">                    </span><span class="token keyword">if</span><span class=""> engine</span><span class="token punctuation">.</span><span class="">is_move_correct</span><span class="token punctuation">(</span><span class="">m</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">7</span><span class="">                        engine</span><span class="token punctuation">.</span><span class="">make_moves_from_current_position</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="">m</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">8</span><span class="">                opponent_move </span><span class="token operator">=</span><span class=""> engine</span><span class="token punctuation">.</span><span class="">get_best_move_time</span><span class="token punctuation">(</span><span class="token number">3_000</span><span class="token punctuation">)</span></code></pre></div></div>
<p>The server uses the <a href="https://pypi.org/project/stockfish/">stockfish</a> python library, which <a href="https://github.com/zhelyabuzhsky/stockfish/blob/master/stockfish/models.py#L47-L53">uses a subprocess to launch and communicate with the Stockfish engine</a>.</p>
<div class="border border-white/10 rounded-lg my-2"><p class="text-xs rounded-t-lg px-4 py-0.5 text-secondary">Code<!-- --> (py)<!-- -->:<!-- --> <button class="hover:underline">(copy)</button></p><div class="rounded-b-lg overflow-hidden text-xs"><pre class="prismjs"><code style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">1</span><span class="">        self</span><span class="token punctuation">.</span><span class="">_stockfish </span><span class="token operator">=</span><span class=""> subprocess</span><span class="token punctuation">.</span><span class="">Popen</span><span class="token punctuation">(</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">2</span><span class="">            self</span><span class="token punctuation">.</span><span class="">_path</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">3</span><span class="">            universal_newlines</span><span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">4</span><span class="">            stdin</span><span class="token operator">=</span><span class="">subprocess</span><span class="token punctuation">.</span><span class="">PIPE</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">5</span><span class="">            stdout</span><span class="token operator">=</span><span class="">subprocess</span><span class="token punctuation">.</span><span class="">PIPE</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">6</span><span class="">            stderr</span><span class="token operator">=</span><span class="">subprocess</span><span class="token punctuation">.</span><span class="">STDOUT</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">7</span><span class="">        </span><span class="token punctuation">)</span></code></pre></div></div>
<p>Reading the stockfish library <a href="https://github.com/zhelyabuzhsky/stockfish/blob/master/stockfish/models.py#L420">source code for <code class="opacity-75 bg-black/30 rounded px-1.5 py-1 text-[0.9em]">is_move_correct</code></a>,</p>
<div class="border border-white/10 rounded-lg my-2"><p class="text-xs rounded-t-lg px-4 py-0.5 text-secondary">Code<!-- --> (py)<!-- -->:<!-- --> <button class="hover:underline">(copy)</button></p><div class="rounded-b-lg overflow-hidden text-xs"><pre class="prismjs"><code style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">1</span><span class="">    </span><span class="token keyword">def</span><span class=""> </span><span class="token function">is_move_correct</span><span class="token punctuation">(</span><span class="">self</span><span class="token punctuation">,</span><span class=""> move_value</span><span class="token punctuation">:</span><span class=""> </span><span class="token builtin">str</span><span class="token punctuation">)</span><span class=""> </span><span class="token operator">-</span><span class="token operator">&gt;</span><span class=""> </span><span class="token builtin">bool</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">2</span><span class="">        </span><span class="token triple-quoted-string string">&quot;&quot;&quot;Checks new move.
</span><span class="token triple-quoted-string string"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">3</span>
</span><span class="token triple-quoted-string string"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">4</span>        Args:
</span><span class="token triple-quoted-string string"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">5</span>            move_value:
</span><span class="token triple-quoted-string string"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">6</span>              New move value in algebraic notation.
</span><span class="token triple-quoted-string string"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">7</span>
</span><span class="token triple-quoted-string string"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">8</span>        Returns:
</span><span class="token triple-quoted-string string"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">9</span>            True, if new move is correct, else False.
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">10</span><span class="token triple-quoted-string string">        &quot;&quot;&quot;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">11</span><span class="">        old_self_info </span><span class="token operator">=</span><span class=""> self</span><span class="token punctuation">.</span><span class="">info
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">12</span><span class="">        self</span><span class="token punctuation">.</span><span class="">_put</span><span class="token punctuation">(</span><span class="token string-interpolation string">f&quot;go depth 1 searchmoves </span><span class="token string-interpolation interpolation punctuation">{</span><span class="token string-interpolation interpolation">move_value</span><span class="token string-interpolation interpolation punctuation">}</span><span class="token string-interpolation string">&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">13</span><span class="">        is_move_correct </span><span class="token operator">=</span><span class=""> self</span><span class="token punctuation">.</span><span class="">_get_best_move_from_sf_popen_process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class=""> </span><span class="token keyword">is</span><span class=""> </span><span class="token keyword">not</span><span class=""> </span><span class="token boolean">None</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">14</span><span class="">        self</span><span class="token punctuation">.</span><span class="">info </span><span class="token operator">=</span><span class=""> old_self_info
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">15</span><span class="">        </span><span class="token keyword">return</span><span class=""> is_move_correct</span></code></pre></div></div>
<div class="border border-white/10 rounded-lg my-2"><p class="text-xs rounded-t-lg px-4 py-0.5 text-secondary">Code<!-- --> (py)<!-- -->:<!-- --> <button class="hover:underline">(copy)</button></p><div class="rounded-b-lg overflow-hidden text-xs"><pre class="prismjs"><code style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">1</span><span class="">    </span><span class="token keyword">def</span><span class=""> </span><span class="token function">_put</span><span class="token punctuation">(</span><span class="">self</span><span class="token punctuation">,</span><span class=""> command</span><span class="token punctuation">:</span><span class=""> </span><span class="token builtin">str</span><span class="token punctuation">)</span><span class=""> </span><span class="token operator">-</span><span class="token operator">&gt;</span><span class=""> </span><span class="token boolean">None</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">2</span><span class="">        </span><span class="token keyword">if</span><span class=""> </span><span class="token keyword">not</span><span class=""> self</span><span class="token punctuation">.</span><span class="">_stockfish</span><span class="token punctuation">.</span><span class="">stdin</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">3</span><span class="">            </span><span class="token keyword">raise</span><span class=""> BrokenPipeError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">4</span><span class="">        </span><span class="token keyword">if</span><span class=""> self</span><span class="token punctuation">.</span><span class="">_stockfish</span><span class="token punctuation">.</span><span class="">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class=""> </span><span class="token keyword">is</span><span class=""> </span><span class="token boolean">None</span><span class=""> </span><span class="token keyword">and</span><span class=""> </span><span class="token keyword">not</span><span class=""> self</span><span class="token punctuation">.</span><span class="">_has_quit_command_been_sent</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">5</span><span class="">            self</span><span class="token punctuation">.</span><span class="">_stockfish</span><span class="token punctuation">.</span><span class="">stdin</span><span class="token punctuation">.</span><span class="">write</span><span class="token punctuation">(</span><span class="token string-interpolation string">f&quot;</span><span class="token string-interpolation interpolation punctuation">{</span><span class="token string-interpolation interpolation">command</span><span class="token string-interpolation interpolation punctuation">}</span><span class="token string-interpolation string">\n&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">6</span><span class="">            self</span><span class="token punctuation">.</span><span class="">_stockfish</span><span class="token punctuation">.</span><span class="">stdin</span><span class="token punctuation">.</span><span class="">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">7</span><span class="">            </span><span class="token keyword">if</span><span class=""> command </span><span class="token operator">==</span><span class=""> </span><span class="token string">&quot;quit&quot;</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">8</span><span class="">                self</span><span class="token punctuation">.</span><span class="">_has_quit_command_been_sent </span><span class="token operator">=</span><span class=""> </span><span class="token boolean">True</span></code></pre></div></div>
<p>we can see that the argument to <code class="opacity-75 bg-black/30 rounded px-1.5 py-1 text-[0.9em]">is_move_correct</code> is simply appended to a command and piped to the Stockfish process. By circumventing the <code class="opacity-75 bg-black/30 rounded px-1.5 py-1 text-[0.9em]">python-chess</code> move checking, then, we can control <code class="opacity-75 bg-black/30 rounded px-1.5 py-1 text-[0.9em]">move_value</code> and (by inserting a newline into our &quot;move&quot;) send arbitrary commands to the Stockfish process.</p>
<p>Stockfish documents its supported UCI commands and functionality <a href="https://official-stockfish.github.io/docs/stockfish-wiki/UCI-&amp;-Commands.html">here</a>. Of particular note is</p>
<div class="border border-white/10 rounded-lg my-2"><p class="text-xs rounded-t-lg px-4 py-0.5 text-secondary">Code<!-- -->:<!-- --> <button class="hover:underline">(copy)</button></p><div class="rounded-b-lg overflow-hidden text-xs"><pre class="prismjs"><code style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none">1</span><span class="">setoption name Debug Log File value [file path]</span></code></pre></div></div>
<p>which causes Stockfish to log all incoming and outbound interactions to the specified file path. We can get a simple proof-of-concept attack by making Stockfish log to the configured Flask static dir:</p>
<p><img src="https://gist.github.com/user-attachments/assets/d2a5ca54-7c35-46d8-abcf-18a8d17792f8" alt="image"/></p>
<p>As <a href="https://blog.neilhommes.xyz/docs/Writeups/2024/corctf.html">Neil&#x27;s follow-up writeup explains in more detail</a>, we can use this arbitrary file write to overwrite the contents of <code class="opacity-75 bg-black/30 rounded px-1.5 py-1 text-[0.9em]">/app/templates/index.html</code> (making sure to do this before Flask caches the template on initial page load). Then, we just need to execute a Flask SSTI attack to get the flag.</p>
<div class="border border-white/10 rounded-lg my-2"><p class="text-xs rounded-t-lg px-4 py-0.5 text-secondary">Code<!-- -->:<!-- --> <button class="hover:underline">(copy)</button></p><div class="rounded-b-lg overflow-hidden text-xs"><pre class="prismjs"><code style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none">1</span><span class="">corctf{“Whatever you do, don’t reveal all your techniques in a CTF challenge, you fool, you moron.” - Sun Tzu, The Art of War}</span></code></pre></div></div></main></div><!--$--><!--/$--></main><script src="/_next/static/chunks/webpack-d11e0b30904b49ad.js" id="_R_" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:\"$Sreact.fragment\"\n2:I[87555,[],\"\"]\n3:I[31295,[],\"\"]\n4:I[6874,[\"874\",\"static/chunks/874-3e820bd666038662.js\",\"633\",\"static/chunks/app/writeups/%5Bid%5D/layout-2577bd3482649595.js\"],\"\"]\n6:I[59665,[],\"OutletBoundary\"]\n8:I[74911,[],\"AsyncMetadataOutlet\"]\na:I[59665,[],\"ViewportBoundary\"]\nc:I[59665,[],\"MetadataBoundary\"]\nd:\"$Sreact.suspense\"\nf:I[28393,[],\"\"]\n:HL[\"/_next/static/media/e4af272ccee01ff0-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n:HL[\"/_next/static/css/94afdc017676131d.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"0:{\"P\":null,\"b\":\"ic9cUZ2jC3lu1TLpy1mjN\",\"p\":\"\",\"c\":[\"\",\"writeups\",\"2f279fff831a5be3d6b5fbb8a6d86057\"],\"i\":false,\"f\":[[[\"\",{\"children\":[\"writeups\",{\"children\":[[\"id\",\"2f279fff831a5be3d6b5fbb8a6d86057\",\"d\"],{\"children\":[\"__PAGE__\",{}]}]}]},\"$undefined\",\"$undefined\",true],[\"\",[\"$\",\"$1\",\"c\",{\"children\":[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/94afdc017676131d.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"html\",null,{\"className\":\"dark scroll-smooth\",\"children\":[[\"$\",\"head\",null,{\"children\":[\"$\",\"meta\",null,{\"charSet\":\"utf-8\"}]}],[\"$\",\"body\",null,{\"className\":\"text-dark dark:text-white dark:bg-midnight\",\"style\":{\"fontFamily\":\"'Inter', 'Inter Fallback'\",\"fontStyle\":\"normal\"},\"children\":[\"$\",\"$L2\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L3\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[\"$\",\"div\",null,{\"className\":\"h-screen flex items-center justify-center\",\"children\":[\"$\",\"main\",null,{\"className\":\"relative pl-14\",\"children\":[[\"$\",\"svg\",null,{\"stroke\":\"currentColor\",\"fill\":\"currentColor\",\"strokeWidth\":\"0\",\"viewBox\":\"0 0 512 512\",\"className\":\"absolute left-0 top-2 text-5xl text-grapefruit\",\"children\":[\"$undefined\",[[\"$\",\"path\",\"0\",{\"d\":\"M256 48C140.559 48 48 140.559 48 256c0 115.436 92.559 208 208 208 115.435 0 208-92.564 208-208 0-115.441-92.564-208-208-208zm104.002 282.881l-29.12 29.117L256 285.117l-74.881 74.881-29.121-29.117L226.881 256l-74.883-74.881 29.121-29.116L256 226.881l74.881-74.878 29.12 29.116L285.119 256l74.883 74.881z\",\"children\":\"$undefined\"}]]],\"style\":{\"color\":\"$undefined\"},\"height\":\"1em\",\"width\":\"1em\",\"xmlns\":\"http://www.w3.org/2000/svg\"}],[\"$\",\"h1\",null,{\"className\":\"font-bold text-7xl underline decoration-grapefruit mb-5\",\"children\":\"404.\"}],[\"$\",\"p\",null,{\"children\":\"Your requested page was not found.\"}],[\"$\",\"$L4\",null,{\"href\":\"/\",\"className\":\"font-medium text-inherit\",\"children\":\"Return to home →\"}]]}]}],[]],\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]}]]}]]}],{\"children\":[\"writeups\",[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"main\",null,{\"className\":\"container pt-20 pb-24\",\"children\":[\"$\",\"$L2\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L3\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]}]]}],{\"children\":[[\"id\",\"2f279fff831a5be3d6b5fbb8a6d86057\",\"d\"],[\"$\",\"$1\",\"c\",{\"children\":[null,[[\"$\",\"$L4\",null,{\"href\":\"/writeups\",\"className\":\"text-secondary text-sm mb-10 -ml-5 block w-max\",\"children\":\"← Back to writeups\"}],[\"$\",\"$L2\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L3\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]]}],{\"children\":[\"__PAGE__\",[\"$\",\"$1\",\"c\",{\"children\":[\"$L5\",null,[\"$\",\"$L6\",null,{\"children\":[\"$L7\",[\"$\",\"$L8\",null,{\"promise\":\"$@9\"}]]}]]}],{},null,false]},null,false]},null,false]},null,false],[\"$\",\"$1\",\"h\",{\"children\":[null,[[\"$\",\"$La\",null,{\"children\":\"$Lb\"}],[\"$\",\"meta\",null,{\"name\":\"next-size-adjust\",\"content\":\"\"}]],[\"$\",\"$Lc\",null,{\"children\":[\"$\",\"div\",null,{\"hidden\":true,\"children\":[\"$\",\"$d\",null,{\"fallback\":null,\"children\":\"$Le\"}]}]}]]}],false]],\"m\":\"$undefined\",\"G\":[\"$f\",[]],\"s\":false,\"S\":true}\n"])</script><script>self.__next_f.push([1,"b:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"meta\",\"1\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}]]\n7:null\n"])</script><script>self.__next_f.push([1,"10:I[50674,[\"325\",\"static/chunks/325-655a7b8ed93161e0.js\",\"134\",\"static/chunks/app/writeups/%5Bid%5D/page-bcc47f65bcf2ff4c.js\"],\"default\"]\n11:T153b,"])</script><script>self.__next_f.push([1,"from flask import Flask, request, render_template\nfrom flask_socketio import SocketIO, emit\nfrom stockfish import Stockfish\nimport random\n\nimport chess\nfrom stockfish import Stockfish\n\ngames = {}\n\ntoxic_msges = [\n    \"?\",\n    \"rip bozo\",\n    \"so bad lmfaoo\",\n    \"ez\",\n    \"skill issue\",\n    \"mad cuz bad\",\n    \"hold this L\",\n    \"L + ratio + you fell off\",\n    \"i bet your main category is stego\",\n    \"have you tried alt+f4?\",\n    \"🤡🤡🤡\"\n]\n\nwin_msges = [\n    \"lmaooooooooo ur so bad\",\n    \"was that it?\",\n    \"zzzzzzzzzzzzzzzzzzzzzz\",\n    \"hopefully the next game wont be so quick\",\n    \"nice try - jk that was horrible\",\n    \"this aint checkers man\"\n]\n\nTURN_LIMIT = 15\nSTOCKFISH_DEPTH = 21\nFLAG = \"corctf{this_is_a_fake_flag}\"\n\nclass GameWrapper:\n    def __init__(self, emit):\n        self.emit = emit\n        self.board = chess.Board(chess.STARTING_FEN)\n        self.moves = []\n        self.player_turn = True\n\n    def get_player_state(self):\n        legal_moves = [f\"{m}\" for m in self.board.legal_moves] if self.player_turn and self.board.fullmove_number \u003c TURN_LIMIT else []\n\n        status = \"running\"\n        if self.board.fullmove_number \u003e= TURN_LIMIT:\n            status = \"turn limit\"\n\n        if outcome := self.board.outcome():\n            if outcome.winner is None:\n                status = \"draw\"\n            else:\n                status = \"win\" if outcome.winner == chess.WHITE else \"lose\"\n\n        return {\n            \"pos\": self.board.fen(),\n            \"moves\": legal_moves,\n            \"your_turn\": self.player_turn,\n            \"status\": status,\n            \"turn_counter\": f\"{self.board.fullmove_number} / {TURN_LIMIT} turns\"\n        }\n\n    def play_move(self, uci):\n        if not self.player_turn:\n            return\n        if self.board.fullmove_number \u003e= TURN_LIMIT:\n            return\n        \n        self.player_turn = False\n\n        outcome = self.board.outcome()\n        if outcome is None:\n            try:\n                move = chess.Move.from_uci(uci)\n                if move:\n                    if move not in self.board.legal_moves:\n                        self.player_turn = True\n                        self.emit('state', self.get_player_state())\n                        self.emit(\"chat\", {\"name\": \"System\", \"msg\": \"Illegal move\"})\n                        return\n                    self.board.push_uci(uci)\n            except:\n                self.player_turn = True\n                self.emit('state', self.get_player_state())\n                self.emit(\"chat\", {\"name\": \"System\", \"msg\": \"Invalid move format\"})\n                return\n        elif outcome.winner != chess.WHITE:\n            self.emit(\"chat\", {\"name\": \"🐸\", \"msg\": \"you lost, bozo\"})\n            return\n\n        self.moves.append(uci)\n\n        # stockfish has a habit of crashing\n        # The following section is used to try to resolve this\n        opponent_move, attempts = None, 0\n        while not opponent_move and attempts \u003c= 10:\n            try:\n                attempts += 1\n                engine = Stockfish(\"./stockfish/stockfish-ubuntu-x86-64-avx2\", parameters={\"Threads\": 4}, depth=STOCKFISH_DEPTH)\n                for m in self.moves:\n                    if engine.is_move_correct(m):\n                        engine.make_moves_from_current_position([m])\n                opponent_move = engine.get_best_move_time(3_000)\n            except:\n                pass\n\n        if opponent_move != None:\n            self.moves.append(opponent_move)\n            opponent_move = chess.Move.from_uci(opponent_move)\n            if self.board.is_capture(opponent_move):\n                self.emit(\"chat\", {\"name\": \"🐸\", \"msg\": random.choice(toxic_msges)})\n            self.board.push(opponent_move)\n            self.player_turn = True\n            self.emit(\"state\", self.get_player_state())\n\n            if (outcome := self.board.outcome()) is not None:\n                if outcome.termination == chess.Termination.CHECKMATE:\n                    if outcome.winner == chess.BLACK:\n                        self.emit(\"chat\", {\"name\": \"🐸\", \"msg\": \"Nice try... but not good enough 🐸\"})\n                    else:\n                        self.emit(\"chat\", {\"name\": \"🐸\", \"msg\": \"how??????\"})\n                        self.emit(\"chat\", {\"name\": \"System\", \"msg\": FLAG})\n                else: # statemate, insufficient material, etc\n                    self.emit(\"chat\", {\"name\": \"🐸\", \"msg\": \"That was close... but still not good enough 🐸\"})\n        else:\n            self.emit(\"chat\", {\"name\": \"System\", \"msg\": \"An error occurred, please restart\"})\n\napp = Flask(__name__, static_url_path='', static_folder='static')\nsocketio = SocketIO(app, cors_allowed_origins='*')\n\n@app.after_request\ndef add_header(response):\n    response.headers['Cache-Control'] = 'max-age=604800'\n    return response\n\n@app.route('/')\ndef index_route():\n    return render_template('index.html')\n\n@socketio.on('connect')\ndef on_connect(_):\n    games[request.sid] = GameWrapper(emit)\n    emit('state', games[request.sid].get_player_state())\n\n@socketio.on('disconnect')\ndef on_disconnect():\n    if request.sid in games:\n        del games[request.sid]\n\n@socketio.on('move')\ndef onmsg_move(move):\n    try:\n        games[request.sid].play_move(move)\n    except:\n        emit(\"chat\", {\"name\": \"System\", \"msg\": \"An error occurred, please restart\"})\n\n@socketio.on('state')\ndef onmsg_state():\n    emit('state', games[request.sid].get_player_state())"])</script><script>self.__next_f.push([1,"5:[\"$\",\"div\",null,{\"children\":[\"$\",\"main\",null,{\"className\":\"text-pretty max-w-5xl mx-auto text-sm [\u0026_h1]:text-5xl [\u0026_h1]:font-semibold [\u0026_h1]:mb-8 [\u0026_blockquote]:text-secondary [\u0026_blockquote]:space-y-3 [\u0026_blockquote]:border-l-4 [\u0026_blockquote]:border-secondary [\u0026_blockquote]:pl-5 [\u0026_blockquote]:mb-5 [\u0026\u003e_p]:my-4 [\u0026_img]:my-5 [\u0026_ul]:list-disc [\u0026_ul]:pl-6 [\u0026_ol]:list-decimal [\u0026_ol]:pl-6 [\u0026_img]:rounded [\u0026_li]:my-2\",\"children\":[[\"$\",\"h1\",\"h1-0\",{\"children\":\"corCTF 2024 — msfrogofwar3\"}],\"\\n\",[\"$\",\"blockquote\",\"blockquote-0\",{\"children\":[\"\\n\",[\"$\",\"p\",\"p-0\",{\"children\":[\"$\",\"img\",\"img-0\",{\"src\":\"https://gist.github.com/user-attachments/assets/e9359b7e-f3cf-4a25-8eea-c82b9ab65912\",\"alt\":\"image\"}]}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",\"p-0\",{\"children\":\"We're given a Flask server that looks like this:\"}],\"\\n\",[\"$\",\"$L10\",\"pre-0\",{\"className\":\"my-2\",\"children\":\"$11\",\"language\":\"py\"}],\"\\n\",\"$L12\",\"\\n\",\"$L13\",\"\\n\",\"$L14\",\"\\n\",\"$L15\",\"\\n\",\"$L16\",\"\\n\",\"$L17\",\"\\n\",\"$L18\",\"\\n\",\"$L19\",\"\\n\",\"$L1a\",\"\\n\",\"$L1b\",\"\\n\",\"$L1c\",\"\\n\",\"$L1d\",\"\\n\",\"$L1e\",\"\\n\",\"$L1f\",\"\\n\",\"$L20\",\"\\n\",\"$L21\",\"\\n\",\"$L22\",\"\\n\",\"$L23\",\"\\n\",\"$L24\",\"\\n\",\"$L25\",\"\\n\",\"$L26\",\"\\n\",\"$L27\",\"\\n\",\"$L28\",\"\\n\",\"$L29\"]}]}]\n"])</script><script>self.__next_f.push([1,"12:[\"$\",\"p\",\"p-1\",{\"children\":\"At first glance, it looks like we need to win against Stockfish in 15 moves to get the flag.\"}]\n"])</script><script>self.__next_f.push([1,"13:[\"$\",\"p\",\"p-2\",{\"children\":[\"Obviously, winning against max-difficulty Stockfish, much less in 15 moves, is impossible. Curiously, however, the server uses \",[\"$\",\"a\",\"a-0\",{\"href\":\"https://python-chess.readthedocs.io/en/latest/\",\"children\":\"python-chess\"}],\"'s \",[\"$\",\"code\",\"code-0\",{\"className\":\"opacity-75 bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"Move\"}],\" class to verify game inputs. Reading the \",[\"$\",\"a\",\"a-1\",{\"href\":\"https://github.com/niklasf/python-chess/blob/32253d6cfdbc1939f78f03892fa848412cf4b4fa/chess/__init__.py#L686\",\"children\":[\"source for \",[\"$\",\"code\",\"code-0\",{\"className\":\"opacity-75 bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"Move.from_uci\"}]]}],\",\"]}]\n"])</script><script>self.__next_f.push([1,"2a:T4b6,"])</script><script>self.__next_f.push([1,"    @classmethod\n    def from_uci(cls, uci: str) -\u003e Move:\n        \"\"\"\n        Parses a UCI string.\n\n        :raises: :exc:`InvalidMoveError` if the UCI string is invalid.\n        \"\"\"\n        if uci == \"0000\":\n            return cls.null()\n        elif len(uci) == 4 and \"@\" == uci[1]:\n            try:\n                drop = PIECE_SYMBOLS.index(uci[0].lower())\n                square = SQUARE_NAMES.index(uci[2:])\n            except ValueError:\n                raise InvalidMoveError(f\"invalid uci: {uci!r}\")\n            return cls(square, square, drop=drop)\n        elif 4 \u003c= len(uci) \u003c= 5:\n            try:\n                from_square = SQUARE_NAMES.index(uci[0:2])\n                to_square = SQUARE_NAMES.index(uci[2:4])\n                promotion = PIECE_SYMBOLS.index(uci[4]) if len(uci) == 5 else None\n            except ValueError:\n                raise InvalidMoveError(f\"invalid uci: {uci!r}\")\n            if from_square == to_square:\n                raise InvalidMoveError(f\"invalid uci (use 0000 for null moves): {uci!r}\")\n            return cls(from_square, to_square, promotion=promotion)\n        else:\n            raise InvalidMoveError(f\"expected uci string to be of length 4 or 5: {uci!r}\")"])</script><script>self.__next_f.push([1,"14:[\"$\",\"$L10\",\"pre-1\",{\"className\":\"my-2\",\"children\":\"$2a\",\"language\":\"py\"}]\n15:[\"$\",\"p\",\"p-3\",{\"children\":[\"we can send a \\\"null move\\\" \",[\"$\",\"code\",\"code-0\",{\"className\":\"opacity-75 bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"0000\"}],\" to pass the turn to Stockfish. Afterwards, Stockfish will play white and we will play black; all we need to do is get checkmated to \\\"win\\\"!\"]}]\n16:[\"$\",\"p\",\"p-4\",{\"children\":[\"$\",\"img\",\"img-0\",{\"src\":\"https://gist.github.com/user-attachments/assets/8a765e88-8838-49ae-bc11-91094fc83f97\",\"alt\":\"image\"}]}]\n17:[\"$\",\"$L10\",\"pre-2\",{\"className\":\"my-2\",\"children\":\"socket.emit('move', '0000')\\nsocket.emit('move', 'f7f6')\\nsocket.emit('move', 'g7g5')\",\"language\":\"js\"}]\n18:[\"$\",\"p\",\"p-5\",{\"children\":[\"Unfortunately, winning is only part one of the challenge; the flag printed to the chat is fake, and looking in \",[\"$\",\"code\",\"code-0\",{\"className\":\"opacity-75 bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"run-docker.sh\"}],\", the real flag lies in the \",[\"$\",\"code\",\"code-1\",{\"className\":\"opacity-75 bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"FLAG\"}],\" environment variable passed to \",[\"$\",\"code\",\"code-2\",{\"className\":\"opacity-75 bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"docker run\"}],\":\"]}]\n19:[\"$\",\"$L10\",\"pre-3\",{\"className\":\"my-2\",\"children\":\"#!/bin/sh\\ndocker build . -t msfrogofwar3\\ndocker run --rm -it -p 8080:8080 -e FLAG=corctf{real_flag} --name msfrogofwar3 msfrogofwar3\",\"language\":\"sh\"}]\n1a:[\"$\",\"p\",\"p-6\",{\"children\":[\"However, looking again at the \",[\"$\",\"code\",\"code-0\",{\"className\":\"opacity-75 bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"play_move\"}],\" method in the game server,\"]}]\n"])</script><script>self.__next_f.push([1,"1b:[\"$\",\"$L10\",\"pre-4\",{\"className\":\"my-2\",\"children\":\"        outcome = self.board.outcome()\\n        if outcome is None:\\n            try:\\n                move = chess.Move.from_uci(uci)\\n                if move:\\n                    if move not in self.board.legal_moves:\\n                        self.player_turn = True\\n                        self.emit('state', self.get_player_state())\\n                        self.emit(\\\"chat\\\", {\\\"name\\\": \\\"System\\\", \\\"msg\\\": \\\"Illegal move\\\"})\\n                        return\\n                    self.board.push_uci(uci)\\n            except:\\n                self.player_turn = True\\n                self.emit('state', self.get_player_state())\\n                self.emit(\\\"chat\\\", {\\\"name\\\": \\\"System\\\", \\\"msg\\\": \\\"Invalid move format\\\"})\\n                return\\n        elif outcome.winner != chess.WHITE:\\n            self.emit(\\\"chat\\\", {\\\"name\\\": \\\"🐸\\\", \\\"msg\\\": \\\"you lost, bozo\\\"})\\n            return\\n\\n        self.moves.append(uci)\",\"language\":\"py\"}]\n"])</script><script>self.__next_f.push([1,"1c:[\"$\",\"p\",\"p-7\",{\"children\":[\"it seems like winning lets us push unchecked moves to \",[\"$\",\"code\",\"code-0\",{\"className\":\"opacity-75 bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"self.moves\"}],\", which then get passed to \",[\"$\",\"code\",\"code-1\",{\"className\":\"opacity-75 bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"engine.is_move_correct\"}],\":\"]}]\n1d:[\"$\",\"$L10\",\"pre-5\",{\"className\":\"my-2\",\"children\":\"        while not opponent_move and attempts \u003c= 10:\\n            try:\\n                attempts += 1\\n                engine = Stockfish(\\\"./stockfish/stockfish-ubuntu-x86-64-avx2\\\", parameters={\\\"Threads\\\": 4}, depth=STOCKFISH_DEPTH)\\n                for m in self.moves:\\n                    if engine.is_move_correct(m):\\n                        engine.make_moves_from_current_position([m])\\n                opponent_move = engine.get_best_move_time(3_000)\",\"language\":\"py\"}]\n1e:[\"$\",\"p\",\"p-8\",{\"children\":[\"The server uses the \",[\"$\",\"a\",\"a-0\",{\"href\":\"https://pypi.org/project/stockfish/\",\"children\":\"stockfish\"}],\" python library, which \",[\"$\",\"a\",\"a-1\",{\"href\":\"https://github.com/zhelyabuzhsky/stockfish/blob/master/stockfish/models.py#L47-L53\",\"children\":\"uses a subprocess to launch and communicate with the Stockfish engine\"}],\".\"]}]\n1f:[\"$\",\"$L10\",\"pre-6\",{\"className\":\"my-2\",\"children\":\"        self._stockfish = subprocess.Popen(\\n            self._path,\\n            universal_newlines=True,\\n            stdin=subprocess.PIPE,\\n            stdout=subprocess.PIPE,\\n            stderr=subprocess.STDOUT,\\n        )\",\"language\":\"py\"}]\n20:[\"$\",\"p\",\"p-9\",{\"children\":[\"Reading the stockfish library \",[\"$\",\"a\",\"a-0\",{\"href\":\"https://github.com/zhelyabuzhsky/stockfish/blob/master/stockfish/models.py#L420\",\"children\":[\"source code for \",[\"$\",\"code\",\"code-0\",{\"className\":\"opacity-75 bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"is_move_correct\"}]]}],\",\"]}]\n21:[\"$\",\"$L10\",\"pre-7\",{\"className\":\"my-2\",\"children\":\"    def is_move_correct(self, move_value: str) -\u003e bool:\\n        \\\"\\\"\\\"Checks new m"])</script><script>self.__next_f.push([1,"ove.\\n\\n        Args:\\n            move_value:\\n              New move value in algebraic notation.\\n\\n        Returns:\\n            True, if new move is correct, else False.\\n        \\\"\\\"\\\"\\n        old_self_info = self.info\\n        self._put(f\\\"go depth 1 searchmoves {move_value}\\\")\\n        is_move_correct = self._get_best_move_from_sf_popen_process() is not None\\n        self.info = old_self_info\\n        return is_move_correct\",\"language\":\"py\"}]\n22:[\"$\",\"$L10\",\"pre-8\",{\"className\":\"my-2\",\"children\":\"    def _put(self, command: str) -\u003e None:\\n        if not self._stockfish.stdin:\\n            raise BrokenPipeError()\\n        if self._stockfish.poll() is None and not self._has_quit_command_been_sent:\\n            self._stockfish.stdin.write(f\\\"{command}\\\\n\\\")\\n            self._stockfish.stdin.flush()\\n            if command == \\\"quit\\\":\\n                self._has_quit_command_been_sent = True\",\"language\":\"py\"}]\n23:[\"$\",\"p\",\"p-10\",{\"children\":[\"we can see that the argument to \",[\"$\",\"code\",\"code-0\",{\"className\":\"opacity-75 bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"is_move_correct\"}],\" is simply appended to a command and piped to the Stockfish process. By circumventing the \",[\"$\",\"code\",\"code-1\",{\"className\":\"opacity-75 bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"python-chess\"}],\" move checking, then, we can control \",[\"$\",\"code\",\"code-2\",{\"className\":\"opacity-75 bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"move_value\"}],\" and (by inserting a newline into our \\\"move\\\") send arbitrary commands to the Stockfish process.\"]}]\n24:[\"$\",\"p\",\"p-11\",{\"children\":[\"Stockfish documents its supported UCI commands and functionality \",[\"$\",\"a\",\"a-0\",{\"href\":\"https://official-stockfish.github.io/docs/stockfish-wiki/UCI-\u0026-Commands.html\",\"children\":\"here\"}],\". Of particular note is\"]}]\n25:[\"$\",\"$L10\",\"pre-9\",{\"className\":\"my-2\",\"children\":\"setoption name Debug Log File value [file path]\",\"language\":\"$undefined\"}]\n26:[\"$\",\"p\",\"p-12\",{\"children\":\"which causes Stockfish to log all incomin"])</script><script>self.__next_f.push([1,"g and outbound interactions to the specified file path. We can get a simple proof-of-concept attack by making Stockfish log to the configured Flask static dir:\"}]\n27:[\"$\",\"p\",\"p-13\",{\"children\":[\"$\",\"img\",\"img-0\",{\"src\":\"https://gist.github.com/user-attachments/assets/d2a5ca54-7c35-46d8-abcf-18a8d17792f8\",\"alt\":\"image\"}]}]\n28:[\"$\",\"p\",\"p-14\",{\"children\":[\"As \",[\"$\",\"a\",\"a-0\",{\"href\":\"https://blog.neilhommes.xyz/docs/Writeups/2024/corctf.html\",\"children\":\"Neil's follow-up writeup explains in more detail\"}],\", we can use this arbitrary file write to overwrite the contents of \",[\"$\",\"code\",\"code-0\",{\"className\":\"opacity-75 bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"/app/templates/index.html\"}],\" (making sure to do this before Flask caches the template on initial page load). Then, we just need to execute a Flask SSTI attack to get the flag.\"]}]\n29:[\"$\",\"$L10\",\"pre-10\",{\"className\":\"my-2\",\"children\":\"corctf{“Whatever you do, don’t reveal all your techniques in a CTF challenge, you fool, you moron.” - Sun Tzu, The Art of War}\",\"language\":\"$undefined\"}]\n"])</script><script>self.__next_f.push([1,"9:{\"metadata\":[[\"$\",\"title\",\"0\",{\"children\":\"corCTF 2024 — msfrogofwar3 | kevin.fish\"}],[\"$\",\"meta\",\"1\",{\"name\":\"description\",\"content\":\"![image](https://gist.github.com/user-attachments/assets/e9359b7e-f3cf-4a25-8eea-c82b9ab65912)\"}],[\"$\",\"meta\",\"2\",{\"property\":\"og:title\",\"content\":\"corCTF 2024 — msfrogofwar3\"}],[\"$\",\"meta\",\"3\",{\"property\":\"og:description\",\"content\":\"![image](https://gist.github.com/user-attachments/assets/e9359b7e-f3cf-4a25-8eea-c82b9ab65912)\"}],[\"$\",\"meta\",\"4\",{\"name\":\"twitter:card\",\"content\":\"summary\"}],[\"$\",\"meta\",\"5\",{\"name\":\"twitter:title\",\"content\":\"corCTF 2024 — msfrogofwar3\"}],[\"$\",\"meta\",\"6\",{\"name\":\"twitter:description\",\"content\":\"![image](https://gist.github.com/user-attachments/assets/e9359b7e-f3cf-4a25-8eea-c82b9ab65912)\"}]],\"error\":null,\"digest\":\"$undefined\"}\n"])</script><script>self.__next_f.push([1,"e:\"$9:metadata\"\n"])</script></body></html>